Sjasm Z80 Assembler v0.42c - www.xl2s.tk             [2025.11.01 - 20:16:04]

B-SQUARED.asm
Errors: 0

       1   00:0000                      ifexists game.cfg
       2   00:0000                      include game.cfg
       1.  00:0000                      ; Flags saved by AGD Compiler
       2.  00:0000                      
       3.  00:0000  (00:0000)           DISTYPE=0 ; Memory model & size
       4.  00:0000  (00:0020)           DISSIZE=32 ; Memory size
       5.  00:0000  (00:0000)           AFLAG=0 ; Adventure mode
       6.  00:0000  (00:0000)           MFLAG=0 ; Menu/Inventory
       7.  00:0000  (00:0001)           PFLAG=1 ; Particles
       8.  00:0000  (00:0000)           SFLAG=0 ; Scrolling
       9.  00:0000  (00:0000)           DFLAG=0 ; Digging
      10.  00:0000  (00:0000)           CFLAG=0 ; Collectables
      11.  00:0000  (00:0001)           OFLAG=1 ; Objects
      12.  00:0000  (00:0000)           LFLAG=0 ; Ladders
      13.  00:0000  (00:0001)           EFLAG=1 ; Beeper
      14.  00:0000  (00:0000)           YFLAG=0 ; PSG Music
      15.  00:0000  (00:0001)           XFLAG=1 ; PSG SFX
      16.  00:0000  (00:0000)           QFLAG=0 ; Marquee
      17.  00:0000  (00:0000)           CRFLAG=0 ; Crumbling blocks
      18.  00:0000  (00:0000)           MBFLAG=0 ; Metablocks
      19.  00:0000  (00:0000)           UFLAG=0 ; User routines
      20.  00:0000  (00:0000)           RTFLAG=0 ; Thrust for rotational control
      21.  00:0000  (00:0000)           HCFLAG=0 ; HW sprite collisions
      22.  00:0000  (00:0000)           TVFREQ=0 ; TV Mode
      23.  00:0000  (00:0000)           FX_RELATIVE=0 ; Relative SFX volume
      24.  00:0000  (00:0000)           FX_MODE=0 ; SFX replayer mode (0 = fixed channel, 1 = dynamic channel)
      25.  00:0000  (00:0001)           FX_CHANNEL=1 ; SFX fixed channel
       3   00:0000                      endif
       4   00:0000                      
       5   00:0000                          output B-SQUARED.rom
       6   00:0000                      
       7   00:0000  (00:4000)           PageSize	equ	$4000
       8   00:0000                      
       9   00:0000                          defpage 0, $8000, $8000
      10   00:0000                      
      11   00:0000                          code @ $8000, #1, page 0
      12   00:8000                      
      13   00:8000                              include "header1.asm"
       1.  00:8000                      ;--------------------------------------------------------------------------
       2.  00:8000                      ; Cartridge header part 1
       3.  00:8000                      ;--------------------------------------------------------------------------
       4.  00:8000                      
       5.  00:8000                      ; Define cartridge header
       6.  00:8000                      
       7.  00:8000  55 AA               	db $55,$aa		; Cartridge type
       8.  00:8002  00 00               	dw $0000		; LOCAL_SPR_TBL
       9.  00:8004  00 00               	dw $0000		; SPRITE_ORDER
      10.  00:8006  00 00               	dw $0000		; WORK_BUFFER
      11.  00:8008  98 40               	dw CONTROLLER_BUFFER	; CONTROLLER_MAP
      12.  00:800A  41 80               	dw init			; START_GAME
      13.  00:800C                      
      14.  00:800C                      ; Define rst vectors
      15.  00:800C                      
      16.  00:800C                      rst_8:
      17.  00:800C  ED 4D               	reti
      18.  00:800E  00                  	nop
      19.  00:800F                      rst_10:
      20.  00:800F  ED 4D               	reti
      21.  00:8011  00                  	nop
      22.  00:8012                      rst_18:
      23.  00:8012  ED 4D               	reti
      24.  00:8014  00                          nop
      25.  00:8015                      rst_20:
      26.  00:8015  ED 4D               	reti
      27.  00:8017  00                  	nop
      28.  00:8018                      rst_28:
      29.  00:8018  ED 4D               	reti
      30.  00:801A  00                  	nop
      31.  00:801B                      rst_30:
      32.  00:801B  ED 4D               	reti
      33.  00:801D  00                  	nop
      34.  00:801E                      rst_38:
      35.  00:801E  ED 4D               	reti
      36.  00:8020  00                  	nop
      37.  00:8021                      
      38.  00:8021                      ; Define NMI vector
      39.  00:8021                      
      40.  00:8021                      nmi_vec:			; NMI_INT_VECT
      41.  00:8021  C3 4D 80            	jp NMI
      42.  00:8024                      
      14   00:8024                              include "name.txt"
       1.  00:8024                            db "B-SQUARED/PRESENTS MPAGD/2025" 
       1.  00:8024  42 2D 53 51 55 41 52 45 44 2F 50 52 45 53 45 4E 
       1.  00:8034  54 53 20 4D 50 41 47 44 2F 32 30 32 35 
      15   00:8041                              include "header2.asm"
       1.  00:8041                      ;--------------------------------------------------------------------------
       2.  00:8041                      ; Cartridge header part 2
       3.  00:8041                      ;--------------------------------------------------------------------------
       4.  00:8041                      
       5.  00:8041                      ; Declare variables
       6.  00:8041                      
       7.  00:8041  (00:1FDC)           READ_REGISTER:	equ $1fdc	; Read VDP register to clear NMI flag
       8.  00:8041                      
       9.  00:8041                      ;--------------------------------------------------------------------------
      10.  00:8041                      ; Initialisation routine for Super Game Module (SGM)
      11.  00:8041                      ;--------------------------------------------------------------------------
      12.  00:8041                      
      13.  00:8041                      init:
      14.  00:8041  F3                  	di
      15.  00:8042  3E 01               	ld a,1			; Enable SGM
      16.  00:8044  D3 53               	out ($53),a
      17.  00:8046                      
      18.  00:8046  3E 1F               	ld a,00011111b		; Enable BIOS
      19.  00:8048  D3 7F               	out ($7f),a
      20.  00:804A                      
      21.  00:804A  C3 70 B0            	jp start
      22.  00:804D                      
      23.  00:804D                      ;--------------------------------------------------------------------------
      24.  00:804D                      ; NMI routine at 60 Hz
      25.  00:804D                      ;--------------------------------------------------------------------------
      26.  00:804D                      
      27.  00:804D                      NMI:
      28.  00:804D                      
      29.  00:804D                      ; Save registers
      30.  00:804D                      
      31.  00:804D  F5                  	PUSH	AF
      32.  00:804E  C5                  	PUSH	BC
      33.  00:804F  D5                  	PUSH	DE
      34.  00:8050  E5                  	PUSH	HL
      35.  00:8051  DD E5               	PUSH	IX
      36.  00:8053  FD E5               	PUSH	IY
      37.  00:8055                      ;	EX	AF,AF'
      38.  00:8055                      ;	PUSH	AF
      39.  00:8055                      ;	EXX
      40.  00:8055                      ;	PUSH	BC
      41.  00:8055                      ;	PUSH	DE
      42.  00:8055                      ;	PUSH	HL
      43.  00:8055                      
      44.  00:8055                      ; Increment time to sync framerate at 25 Hz
      45.  00:8055                      
      46.  00:8055  21 7D 40            	ld hl,time
      47.  00:8058  7E                  	ld a,(hl)
      48.  00:8059  3C                  	inc a
      49.  00:805A  77                  	ld (hl),a
      50.  00:805B                      
      51.  00:805B                      ; Increment clock
      52.  00:805B                      
      53.  00:805B  21 9E 5C            	ld hl,MSX_JIFFY
      54.  00:805E  7E                  	ld a,(hl)
      55.  00:805F  3C                  	inc a
      56.  00:8060  77                  	ld (hl),a
      57.  00:8061                      
      58.  00:8061                      ; Scan keys
      59.  00:8061                      
      60.  00:8061  CD EB 1F            	call POLLER
      61.  00:8064                      
      62.  00:8064                      ;Now restore everything
      63.  00:8064                      
      64.  00:8064                      ;	POP	HL
      65.  00:8064                      ;	POP	DE
      66.  00:8064                      ;	POP	BC
      67.  00:8064                      ;	EXX
      68.  00:8064                      ;	POP	AF
      69.  00:8064                      ;	EX	AF,AF'
      70.  00:8064  FD E1               	POP	IY
      71.  00:8066  DD E1               	POP	IX
      72.  00:8068  E1                  	POP	HL
      73.  00:8069  D1                  	POP	DE
      74.  00:806A  C1                  	POP	BC
      75.  00:806B                      
      76.  00:806B  CD DC 1F            	call READ_REGISTER	;Side effect allows another NMI to happen
      77.  00:806E  F1                  	pop af
      78.  00:806F                      
      79.  00:806F  ED 45               	retn
      80.  00:8071                      
      16   00:8071                          include "MSX_Defs.asm"
       1.  00:8071                      ; All MSX 1 BIOS calls ===========================================
       2.  00:8071                      	if (DISSIZE!=48)
       3.  00:8071                      
       4.  00:8071  (00:0000)           MSX_CHKRAM	equ $0000
       5.  00:8071  (00:0010)           MSX_CHRGTR	equ $0010
       6.  00:8071  (00:0014)           MSX_WRSLT	equ $0014
       7.  00:8071  (00:0018)           MSX_OUTDO	equ $0018
       8.  00:8071  (00:0020)           MSX_DCOMPR	equ $0020
       9.  00:8071  (00:0028)           MSX_GETYPR	equ $0028
      10.  00:8071  (00:0030)           MSX_CALLF	equ $0030
      11.  00:8071  (00:0038)           MSX_KEYINT	equ $0038
      12.  00:8071  (00:003B)           MSX_INITIO	equ $003B
      13.  00:8071  (00:003E)           MSX_INIFNK	equ $003E
      14.  00:8071  (00:005F)           MSX_CHGMOD	equ $005F
      15.  00:8071  (00:0062)           MSX_CHGCLR	equ $0062
      16.  00:8071  (00:0066)           MSX_NMI		equ $0066
      17.  00:8071  (00:0069)           MSX_CLRSPR	equ $0069
      18.  00:8071  (00:006C)           MSX_INITXT	equ $006C
      19.  00:8071  (00:006F)           MSX_INIT32	equ $006F
      20.  00:8071  (00:0075)           MSX_INIMLT	equ $0075
      21.  00:8071  (00:0078)           MSX_SETTXT	equ $0078
      22.  00:8071  (00:007B)           MSX_SETT32	equ $007B
      23.  00:8071  (00:007E)           MSX_SETGRP	equ $007E
      24.  00:8071  (00:0081)           MSX_SETMLT	equ $0081
      25.  00:8071  (00:0084)           MSX_CALPAT	equ $0084
      26.  00:8071  (00:0087)           MSX_CALATR	equ $0087
      27.  00:8071  (00:008A)           MSX_GSPSIZ	equ $008A
      28.  00:8071  (00:008D)           MSX_GRPPRT	equ $008D
      29.  00:8071  (00:0090)           MSX_GICINI	equ $0090
      30.  00:8071  (00:0093)           MSX_WRTPSG	equ $0093
      31.  00:8071  (00:0096)           MSX_RDPSG	equ $0096
      32.  00:8071  (00:0099)           MSX_STRTMS	equ $0099
      33.  00:8071  (00:009C)           MSX_CHSNS	equ $009C
      34.  00:8071  (00:009F)           MSX_CHGET	equ $009F
      35.  00:8071  (00:00A2)           MSX_CHPUT	equ $00A2
      36.  00:8071  (00:00A5)           MSX_LPTOUT	equ $00A5
      37.  00:8071  (00:00A8)           MSX_LPTSTT	equ $00A8
      38.  00:8071  (00:00AB)           MSX_CNVCHR	equ $00AB
      39.  00:8071  (00:00AE)           MSX_PINLIN	equ $00AE
      40.  00:8071  (00:00B1)           MSX_INLIN	equ $00B1
      41.  00:8071  (00:00B4)           MSX_QINLIN	equ $00B4
      42.  00:8071  (00:00B7)           MSX_BREAKX	equ $00B7
      43.  00:8071  (00:00BA)           MSX_ISCNTC	equ $00BA
      44.  00:8071  (00:00BD)           MSX_CKCNTC	equ $00BD
      45.  00:8071  (00:00C0)           MSX_BEEP	equ $00C0
      46.  00:8071  (00:00C6)           MSX_POSIT	equ $00C6
      47.  00:8071  (00:00C9)           MSX_FNKSB	equ $00C9
      48.  00:8071  (00:00CC)           MSX_ERAFNK	equ $00CC
      49.  00:8071  (00:00CF)           MSX_DSPFNK	equ $00CF
      50.  00:8071  (00:00D2)           MSX_TOTEXT	equ $00D2
      51.  00:8071  (00:00DB)           MSX_GTPAD	equ $00DB
      52.  00:8071  (00:00DE)           MSX_GTPDL	equ $00DE
      53.  00:8071  (00:00E1)           MSX_TAPION	equ $00E1
      54.  00:8071  (00:00E4)           MSX_TAPIN	equ $00E4
      55.  00:8071  (00:00E7)           MSX_TAPIOF	equ $00E7
      56.  00:8071  (00:00EA)           MSX_TAPOON	equ $00EA
      57.  00:8071  (00:00ED)           MSX_TAPOUT	equ $00ED
      58.  00:8071  (00:00F0)           MSX_TAPOOF	equ $00F0
      59.  00:8071  (00:00F3)           MSX_STMOTR	equ $00F3
      60.  00:8071  (00:00F6)           MSX_LFTQ	equ $00F6
      61.  00:8071  (00:00F9)           MSX_PUTQ	equ $00F9
      62.  00:8071  (00:00FC)           MSX_RIGHTC	equ $00FC
      63.  00:8071  (00:00FF)           MSX_LEFTC	equ $00FF
      64.  00:8071  (00:0102)           MSX_UPC		equ $0102
      65.  00:8071  (00:0105)           MSX_TUPC	equ $0105
      66.  00:8071  (00:0108)           MSX_DOWNC	equ $0108
      67.  00:8071  (00:010B)           MSX_TDOWNC	equ $010B
      68.  00:8071  (00:010E)           MSX_SCALXY	equ $010E
      69.  00:8071  (00:0111)           MSX_MAPXY	equ $0111
      70.  00:8071  (00:0114)           MSX_FETCHC	equ $0114
      71.  00:8071  (00:0117)           MSX_STOREC	equ $0117
      72.  00:8071  (00:011A)           MSX_SETATR	equ $011A
      73.  00:8071  (00:011D)           MSX_READC	equ $011D
      74.  00:8071  (00:0120)           MSX_SETC	equ $0120
      75.  00:8071  (00:0123)           MSX_NSETCX	equ $0123
      76.  00:8071  (00:0126)           MSX_GTASPC	equ $0126
      77.  00:8071  (00:0129)           MSX_PNTINI	equ $0129
      78.  00:8071  (00:012C)           MSX_SCANR	equ $012C
      79.  00:8071  (00:012F)           MSX_SCANL	equ $012F
      80.  00:8071  (00:0132)           MSX_CHGCAP	equ $0132
      81.  00:8071  (00:0135)           MSX_CHGSND	equ $0135
      82.  00:8071  (00:013B)           MSX_WSLREG	equ $013B
      83.  00:8071  (00:013E)           MSX_RDVDP	equ $013E
      84.  00:8071  (00:0144)           MSX_PHYDIO	equ $0144
      85.  00:8071  (00:0147)           MSX_FORMAT	equ $0147
      86.  00:8071  (00:014A)           MSX_ISFLIO	equ $014A
      87.  00:8071  (00:014D)           MSX_OUTDLP	equ $014D
      88.  00:8071  (00:0150)           MSX_GETVCP	equ $0150
      89.  00:8071  (00:0153)           MSX_GETVC2	equ $0153
      90.  00:8071  (00:0156)           MSX_KILBUF	equ $0156
      91.  00:8071  (00:0159)           MSX_CALBAS	equ $0159
      92.  00:8071                      	
      93.  00:8071                      	endif
      94.  00:8071                      
      95.  00:8071  (00:000C)           MSX_RDSLT	equ $000C
      96.  00:8071  (00:001C)           MSX_CALSLT	equ $001C
      97.  00:8071  (00:0138)           MSX_RSLREG	equ $0138
      98.  00:8071                      
      99.  00:8071                      ; --- end of all MSX 1 BIOS calls ---
     100.  00:8071                      ; BIOS routine - Turbo-R computers only!
     101.  00:8071  (00:0180)           MSX_CHGCPU	equ $0180
     102.  00:8071                      
     103.  00:8071                      ; Diskrom motor off entry point
     104.  00:8071  (00:4029)           MSX_MTOFF	equ	$4029
     105.  00:8071                      
     106.  00:8071                      ; VRAM addresses =================================================
     107.  00:8071                      
     108.  00:8071  (00:0000)           MSX_CHRTBL	equ $0000 ; (GRPCGP)
     109.  00:8071  (00:1800)           MSX_NAMTBL	equ $1800 ; (GRPNAM)
     110.  00:8071  (00:2000)           MSX_CLRTBL	equ $2000 ; (GRPCOL)
     111.  00:8071  (00:3800)           MSX_SPRTBL	equ $3800 ; (GRPPAT)
     112.  00:8071  (00:1B00)           MSX_SPRATR	equ $1B00 ; (GRPATR)
     113.  00:8071                      
     114.  00:8071                      ; BIOS constants =================================================
     115.  00:8071  (00:0007)           MSX_VDPPRT	equ	$0007	; VDP port 0
     116.  00:8071  (00:002D)           MSX_MSXVER	equ $002D
     117.  00:8071                      
     118.  00:8071                      ; System variables addresses =====================================
     119.  00:8071  (00:5348)           MSX_MSLOT	equ	$5348
     120.  00:8071  (00:53C7)           MSX_GRPNAM  	equ	$53C7
     121.  00:8071  (00:53C9)           MSX_GRPCOL  	equ	$53C9
     122.  00:8071  (00:53CB)           MSX_GRPCGP  	equ	$53CB
     123.  00:8071  (00:53CD)           MSX_GRPATR  	equ	$53CD
     124.  00:8071  (00:53CF)           MSX_GRPPAT  	equ	$53CF
     125.  00:8071  (00:53DB)           MSX_CLIKSW	equ	$53DB	; Keyboard click sound
     126.  00:8071  (00:53E9)           MSX_FORCLR	equ	$53E9	; Foreground colour
     127.  00:8071  (00:53EA)           MSX_BAKCLR	equ	$53EA	; Background colour
     128.  00:8071  (00:53EB)           MSX_BDRCLR	equ	$53EB	; Border colour
     129.  00:8071  (00:53DF)           MSX_RG0SAV	equ	$53DF 	; 	Mirror of VDP register 0 (Basic: VDP(0))
     130.  00:8071  (00:53E0)           MSX_RG1SAV	equ	$53E0 	; 	Mirror of VDP register 1 (Basic: VDP(1))
     131.  00:8071  (00:53E1)           MSX_RG2SAV	equ	$53E1 	; 	Mirror of VDP register 2 (Basic: VDP(2))
     132.  00:8071  (00:53E2)           MSX_RG3SAV	equ	$53E2 	; 	Mirror of VDP register 3 (Basic: VDP(3))
     133.  00:8071  (00:53E3)           MSX_RG4SAV	equ	$53E3 	; 	Mirror of VDP register 4 (Basic: VDP(4))
     134.  00:8071  (00:53E4)           MSX_RG5SAV	equ	$53E4 	; 	Mirror of VDP register 5 (Basic: VDP(5))
     135.  00:8071  (00:53E5)           MSX_RG6SAV	equ	$53E5 	; 	Mirror of VDP register 6 (Basic: VDP(6))
     136.  00:8071  (00:53E6)           MSX_RG7SAV	equ	$53E6 	; Mirror of VDP register 7 (Basic: VDP(7))
     137.  00:8071  (00:5FE7)           MSX_RG8SAV	equ	$5FE7	; Mirror of VDP register 9 (Basic: VDP(9))
     138.  00:8071  (00:5FE8)           MSX_RG9SAV	equ	$5FE8	; Mirror of VDP register 9 (Basic: VDP(9))
     139.  00:8071  (00:53E7)           MSX_STATFL	equ	$53E7 	; 	Mirror of VDP(8) status register (S#0)
     140.  00:8071  (00:53F6)           MSX_SCNCNT  	equ	$53F6
     141.  00:8071  (00:53F7)           MSX_REPCNT  	equ	$53F7
     142.  00:8071  (00:587F)           MSX_FNKSTR	equ	$587F	; Ubicacion textos teclas funcion (se reaprovecha como RAM, 160 bytes)
     143.  00:8071  (00:5BE5)           MSX_NEWKEY	equ	$5BE5
     144.  00:8071  (00:5C4A)           MSX_HIMEM	equ	$5C4A	; Highest available RAM
     145.  00:8071  (00:5C9E)           MSX_JIFFY	equ	$5C9E
     146.  00:8071  (00:5CA2)           MSX_INTCNT  	equ	$5CA2
     147.  00:8071  (00:5CC1)           MSX_EXPTBL	equ	$5CC1	; Bios Slot / Expansion Slot	
     148.  00:8071  (00:5CC5)           MSX_SLTTBL	equ	$5CC5
     149.  00:8071  (00:5D9A)           MSX_HKEYI	equ	$5D9A	 
     150.  00:8071  (00:5D9F)           MSX_HTIMI   	equ	$5D9F
     151.  00:8071  (00:5FFF)           MSX_SSSREG	equ	$5FFF	; secondary slot select register
     152.  00:8071                      
     153.  00:8071                      ; ================================================================
     154.  00:8071                      
     155.  00:8071                      ; Maximum stack address
     156.  00:8071  (00:3000)           MSX_STACK	equ $3000
     157.  00:8071                      
     158.  00:8071                      ; I/O PORTS ================================================================
     159.  00:8071  (00:0040)           MSX_DEVID	equ	$40
     160.  00:8071  (00:0041)           MSX_SWTIO	equ $41
     161.  00:8071                      
     162.  00:8071                      ; PSG PORTS
     163.  00:8071  (00:00A0)           MSX_PSGLW	equ $A0 ;A0H    latch address for PSG
     164.  00:8071  (00:00A1)           MSX_PSGDW	equ $A1 ;A1H    write data to PSG
     165.  00:8071  (00:00A2)           MSX_PSGDR	equ $A2 ;A2H    read data from PSG
     166.  00:8071                      ;
     167.  00:8071  (00:000E)           MSX_PSGPA	equ 14  ;Port A of PSG
     168.  00:8071  (00:000F)           MSX_PSGPB	equ 15  ;Port B of PSG
     169.  00:8071                      
     170.  00:8071                      
     171.  00:8071                      ; VDP PORTS
     172.  00:8071  (00:00BE)           MSX_VDPDRW	equ	$be	;98H    Read/write data VDP
     173.  00:8071  (00:00BF)           MSX_VDPCW	equ	$bf	;99H    write command to VDP
     174.  00:8071  (00:00BF)           MSX_VDPSR	equ	$bf	;99H    read status from VDP
     175.  00:8071  (00:009B)           MSX_VDPPAL	equ	$9B     ; palette register (only MSX2)
     176.  00:8071                      
     177.  00:8071                      ; PPI / Programmable Peripheral Interface / 8255 I/O ports
     178.  00:8071  (00:00A8)           MSX_PPIA	equ $A8 ; PPI- register A. Primary slot select register
     179.  00:8071  (00:00A9)           MSX_PPIB	equ $A9 ; PPI- register B. Keyboard matrix row input register (read only)
     180.  00:8071  (00:00AA)           MSX_PPIC	equ $AA ; PPI- register C. Keyboard and cassette interface
     181.  00:8071  (00:00AB)           MSX_PPICM	equ $AB ; PPI- Command register (write only)
     182.  00:8071                      
     183.  00:8071  (00:00FC)           MSX_MMAP0	equ	$FC
     184.  00:8071  (00:00FD)           MSX_MMAP1	equ	$FD
     185.  00:8071  (00:00FE)           MSX_MMAP2	equ	$FE
     186.  00:8071  (00:00FF)           MSX_MMAP3	equ	$FF
     187.  00:8071                      
     188.  00:8071                      ; ================================================================
     189.  00:8071                      
     190.  00:8071                      ; Disable sprites magic numbers
     191.  00:8071  (00:00D0)           MSX_HIDE_SPRITES	equ	208
     192.  00:8071  (00:00D1)           MSX_HIDE_SPRITE		equ	209
     193.  00:8071                      
     194.  00:8071                      ; Replaced BIOS calls
     195.  00:8071                      
     196.  00:8071                      	ifdef NOBIOS
     197.  00:8071                    ~ 
     198.  00:8071                    ~ 		include "MSX_BIOS.asm"
     199.  00:8071                    ~ 		
     200.  00:8071                    ~ MSX_SNSMAT	equ 	BIOS_SNSMAT  
     201.  00:8071                    ~ MSX_INIGRP	equ	BIOS_INIGRP  
     202.  00:8071                    ~ MSX_ENASCR	equ	BIOS_ENASCR  
     203.  00:8071                    ~ MSX_DISSCR	equ	BIOS_DISSCR  
     204.  00:8071                    ~ MSX_WRTVDP	equ	BIOS_WRTVDP
     205.  00:8071                    ~ MSX_SETRD	equ	BIOS_SETRD
     206.  00:8071                    ~ MSX_SETWRT	equ	BIOS_SETWRT
     207.  00:8071                    ~ MSX_WRTVRM	equ	BIOS_WRTVRM 
     208.  00:8071                    ~ MSX_RDVRM	equ	BIOS_RDVRM
     209.  00:8071                    ~ MSX_LDIRMV	equ	BIOS_LDIRMV
     210.  00:8071                    ~ MSX_LDIRVM	equ	BIOS_LDIRVM
     211.  00:8071                    ~ MSX_CLS		equ	BIOS_CLS
     212.  00:8071                    ~ MSX_FILVRM	equ	BIOS_FILVRM
     213.  00:8071                    ~ MSX_ENASLT	equ	BIOS_ENASLT
     214.  00:8071                    ~ MSX_GTSTCK	equ	BIOS_GTSTCK
     215.  00:8071                    ~ MSX_GTTRIG	equ	BIOS_GTTRIG
     216.  00:8071                    ~ 
     217.  00:8071                    ~ 	else
     218.  00:8071                      
     219.  00:8071  (00:0024)           MSX_ENASLT	equ $0024
     220.  00:8071  (00:0041)           MSX_DISSCR	equ $0041
     221.  00:8071  (00:0044)           MSX_ENASCR	equ $0044
     222.  00:8071  (00:1FD9)           MSX_WRTVDP	equ WRITE_REGISTER
     223.  00:8071  (00:C7AB)           MSX_RDVRM	equ CV_RDVRM	; $004A
     224.  00:8071  (00:C7A3)           MSX_WRTVRM	equ CV_WRTVRM	; $004D
     225.  00:8071  (00:0050)           MSX_SETRD	equ $0050
     226.  00:8071  (00:C796)           MSX_SETWRT	equ CV_SETWRT	; $0053
     227.  00:8071  (00:C787)           MSX_FILVRM	equ CV_FILVRM	; $0056
     228.  00:8071  (00:0059)           MSX_LDIRMV	equ $0059
     229.  00:8071  (00:005C)           MSX_LDIRVM	equ $005C
     230.  00:8071  (00:C72D)           MSX_INIGRP	equ CV_INIGRP	; $0141
     231.  00:8071  (00:C771)           MSX_CLS		equ CV_CLS	; $00C3
     232.  00:8071  (00:00D5)           MSX_GTSTCK	equ $00D5
     233.  00:8071  (00:00D8)           MSX_GTTRIG	equ $00D8
     234.  00:8071  (00:0141)           MSX_SNSMAT	equ $0141
     235.  00:8071                      		
     236.  00:8071                      	endif
     237.  00:8071                      
      17   00:8071                          include "MSX_Macros.asm"
       1.  00:8071                      ; MSX MACROS
       2.  00:8071                      
       3.  00:8071                      	macro BORDER clr
       4.  00:8071                    < 		push af
       5.  00:8071                    <         ld a,clr             ;Get data to set
       6.  00:8071                    <         di
       7.  00:8071                    <         out (MSX_VDPCW),a
       8.  00:8071                    <         ld a,$87             ;Set register #
       9.  00:8071                    <         out (MSX_VDPCW),a
      10.  00:8071                    < 		pop af
      11.  00:8071                    <         ei
      12.  00:8071                    < 	endmacro
      13.  00:8071                      
      14.  00:8071                      	; Set VDP for write (based on DE or HL)
      15.  00:8071                      	macro SETWRT reg
      16.  00:8071                    < 	ifdifi reg,de
      17.  00:8071                    < 		ld a,l
      18.  00:8071                    < 		di
      19.  00:8071                    < 		out (MSX_VDPCW),a
      20.  00:8071                    < 		ld a,h
      21.  00:8071                    < 	else
      22.  00:8071                    < 		ld a,e
      23.  00:8071                    < 		di
      24.  00:8071                    < 		out (MSX_VDPCW),a
      25.  00:8071                    < 		ld a,d
      26.  00:8071                    < 	endif
      27.  00:8071                    < 		or $40
      28.  00:8071                    < 		out (MSX_VDPCW),a
      29.  00:8071                    < 		ei		
      30.  00:8071                    < 	endmacro
      31.  00:8071                      
      32.  00:8071                      	; Set VDP for read (based on DE or HL)
      33.  00:8071                      	macro SETRD reg
      34.  00:8071                    < 	ifdifi reg,de
      35.  00:8071                    < 		ld a,l
      36.  00:8071                    < 		di
      37.  00:8071                    < 		out (MSX_VDPCW),a
      38.  00:8071                    < 		ld a,h
      39.  00:8071                    < 	else
      40.  00:8071                    < 		ld a,e
      41.  00:8071                    < 		di
      42.  00:8071                    < 		out (MSX_VDPCW),a
      43.  00:8071                    < 		ld a,d
      44.  00:8071                    < 	endif
      45.  00:8071                    < 		and $3F
      46.  00:8071                    < 		out (MSX_VDPCW),a
      47.  00:8071                    < 		ei
      48.  00:8071                    < 	endmacro
      49.  00:8071                      
      50.  00:8071                      	/*
      51.  00:8071                    ~ 	macro HALT1
      52.  00:8071                    ~ 		ld hl,clock         ; previous clock setting.		
      53.  00:8071                    ~ 		inc (hl)
      54.  00:8071                    ~ .wait:
      55.  00:8071                    ~ 		ld a,(MSX_JIFFY)        ; current clock setting.
      56.  00:8071                    ~ 		cp (hl)             ; subtract last reading.
      57.  00:8071                    ~ 		jp z,.wait        ; yes, no more processing please.
      58.  00:8071                    ~ 		ld (hl),a
      59.  00:8071                    ~ 	endmacro 
      60.  00:8071                    ~ 	*/
      61.  00:8071                      
      62.  00:8071                      	macro WAITFRAME
      63.  00:8071                    < 		ifdef DEBUG
      64.  00:8071                    < 		BORDER 13
      65.  00:8071                    < 		endif
      66.  00:8071                    < 		ei
      67.  00:8071                    < 		ld hl,MSX_JIFFY
      68.  00:8071                    < 		ld a,(hl)
      69.  00:8071                    < .wait:
      70.  00:8071                    < 		cp (hl)
      71.  00:8071                    < 		jr z,.wait
      72.  00:8071                    < 		ifdef DEBUG
      73.  00:8071                    < 		BORDER 14
      74.  00:8071                    < 		endif
      75.  00:8071                    < 	endmacro
      76.  00:8071                      
      77.  00:8071                      	macro ADD_HL_A
      78.  00:8071                    < 		add a,l			; 5
      79.  00:8071                    < 		ld l,a			; 5
      80.  00:8071                    < 		adc a,h			; 5
      81.  00:8071                    < 		sub l			; 5
      82.  00:8071                    < 		ld h,a			; 5
      83.  00:8071                    < 	endmacro
      84.  00:8071                      
      85.  00:8071                      	macro ADD_DE_A
      86.  00:8071                    < 		add a,e
      87.  00:8071                    < 		ld e,a
      88.  00:8071                    < 		adc a,d
      89.  00:8071                    < 		sub e
      90.  00:8071                    < 		ld d,a	
      91.  00:8071                    < 	endmacro
      92.  00:8071                      
      93.  00:8071                      	macro ADD_BC_A
      94.  00:8071                    < 		add a,c
      95.  00:8071                    < 		ld c,a
      96.  00:8071                    < 		adc a,b
      97.  00:8071                    < 		sub c
      98.  00:8071                    < 		ld b,a	
      99.  00:8071                    < 	endmacro
     100.  00:8071                      
     101.  00:8071                      	macro EX_SP_DE
     102.  00:8071                    < 		ex de,hl
     103.  00:8071                    < 		ex (sp),hl
     104.  00:8071                    < 		ex de,hl
     105.  00:8071                    < 	endmacro
     106.  00:8071                      	
      18   00:8071                      
      19   00:8071                      
      20   00:8071  (00:0003)           WINDOWTOP equ 3
      21   00:8071  (00:0002)           WINDOWLFT equ 2
      22   00:8071  (00:0014)           WINDOWHGT equ 20
      23   00:8071  (00:001C)           WINDOWWID equ 28
      24   00:8071  (00:000D)           MAPWID	equ 13
      25   00:8071                      mapedge: 
      26   00:8071                             db 255,255,255,255,255,255,255,255,255,255,255,255,255
      26   00:8071  FF FF FF FF FF FF FF FF FF FF FF FF FF 
      27   00:807E                      mapdat:
      28   00:807E                             db 255,0,1,2,3,4,5,6,7,8,9,10,255
      28   00:807E  FF 00 01 02 03 04 05 06 07 08 09 0A FF 
      29   00:808B                             db 255,11,12,13,14,15,16,17,18,19,20,21,255
      29   00:808B  FF 0B 0C 0D 0E 0F 10 11 12 13 14 15 FF 
      30   00:8098                             db 255,22,23,24,25,26,27,28,29,30,31,255,255
      30   00:8098  FF 16 17 18 19 1A 1B 1C 1D 1E 1F FF FF 
      31   00:80A5                             db 255,255,255,255,255,255,255,255,255,255,255,255,255
      31   00:80A5  FF FF FF FF FF FF FF FF FF FF FF FF FF 
      32   00:80B2  01                  stmap: db 1
      33   00:80B3                      
      34   00:80B3  (00:80B3)           evnt00:	equ $
      35   00:80B3  CD 18 C5                   call sfx_mute
      36   00:80B6  CD 34 B5                   call lcol
      37   00:80B9  D2 C1 80                   jp nc,a00026
      38   00:80BC  3E 01                      ld a,1
      39   00:80BE  32 29 40                   ld (varn),a
      40   00:80C1  CD 07 B8            a00026 call skobj
      41   00:80C4  32 58 40                   ld (varobj),a
      42   00:80C7  3E FF                      ld a,255
      43   00:80C9  21 58 40                   ld hl,varobj
      44   00:80CC  BE                         cp (hl)
      45   00:80CD  CA 21 81                   jp z,a00223
      46   00:80D0  3E 01                      ld a,1
      47   00:80D2  32 20 40                   ld (vare),a
      48   00:80D5  3E 06                      ld a,6
      49   00:80D7  87                         add a,a
      50   00:80D8  87                         add a,a
      51   00:80D9  87                         add a,a
      52   00:80DA  87                         add a,a
      53   00:80DB  5F                         ld e,a
      54   00:80DC  3A 39 40                   ld a,(clratt)
      55   00:80DF  E6 0F                      and $0F
      56   00:80E1  B3                         or e
      57   00:80E2  32 39 40                   ld (clratt),a
      58   00:80E5  3E 01                      ld a,1
      59   00:80E7  5F                         ld e,a
      60   00:80E8  3A 39 40                   ld a,(clratt)
      61   00:80EB  E6 F0                      and $F0
      62   00:80ED  B3                         or e
      63   00:80EE  32 39 40                   ld (clratt),a
      64   00:80F1  3E 03                      ld a,3
      65   00:80F3  32 35 40                   ld (charx),a
      66   00:80F6  3E 0A                      ld a,10
      67   00:80F8  32 36 40                   ld (chary),a
      68   00:80FB  3E 01                      ld a,1
      69   00:80FD  CD 57 BC                   call dmsg
      70   00:8100  3A 58 40                   ld a,(varobj)
      71   00:8103  CD 58 B7                   call getob
      72   00:8106  3E 05                      ld a,5
      73   00:8108  87                         add a,a
      74   00:8109  87                         add a,a
      75   00:810A  87                         add a,a
      76   00:810B  87                         add a,a
      77   00:810C  5F                         ld e,a
      78   00:810D  3A 39 40                   ld a,(clratt)
      79   00:8110  E6 0F                      and $0F
      80   00:8112  B3                         or e
      81   00:8113  32 39 40                   ld (clratt),a
      82   00:8116  AF                         xor a
      83   00:8117  5F                         ld e,a
      84   00:8118  3A 39 40                   ld a,(clratt)
      85   00:811B  E6 F0                      and $F0
      86   00:811D  B3                         or e
      87   00:811E  32 39 40                   ld (clratt),a
      88   00:8121  3E 01               a00223 ld a,1
      89   00:8123  21 29 40                   ld hl,varn
      90   00:8126  BE                         cp (hl)
      91   00:8127  C2 65 81                   jp nz,a00347
      92   00:812A  DD 36 00 FF                ld (ix+0),255
      93   00:812E  3E 20                      ld a,32
      94   00:8130  CD 9F B4                   call explod
      95   00:8133  AF                         xor a
      96   00:8134  E6 0F                      and $0F
      97   00:8136  4F                         ld c,a
      98   00:8137  CD 6C B2                   call cspr
      99   00:813A  3E 64                      ld a,100
     100   00:813C  32 16 40                   ld (sndtyp),a
     101   00:813F  DD 36 00 FF                ld (ix+0),255
     102   00:8143  3E 0A                      ld a,10
     103   00:8145  32 19 40                   ld (loopa),a
     104   00:8148  3E 0A               a00292 ld a,10
     105   00:814A  32 16 40                   ld (sndtyp),a
     106   00:814D  DD E5                      push ix
     107   00:814F  06 06                      ld b,6
     108   00:8151  CD 31 B1                   call delay
     109   00:8154  DD E1                      pop ix
     110   00:8156  21 19 40                   ld hl,loopa
     111   00:8159  35                         dec (hl)
     112   00:815A  C2 48 81                   jp nz,a00292
     113   00:815D  AF                         xor a
     114   00:815E  32 29 40                   ld (varn),a
     115   00:8161  21 53 40                   ld hl,deadf
     116   00:8164  74                         ld (hl),h
     117   00:8165  AF                  a00347 xor a
     118   00:8166  21 29 40                   ld hl,varn
     119   00:8169  BE                         cp (hl)
     120   00:816A  C2 93 83                   jp nz,a01343
     121   00:816D  AF                         xor a
     122   00:816E  21 20 40                   ld hl,vare
     123   00:8171  BE                         cp (hl)
     124   00:8172  C2 69 83                   jp nz,a01264
     125   00:8175  AF                         xor a
     126   00:8176  32 21 40                   ld (varf),a
     127   00:8179  AF                         xor a
     128   00:817A  21 1C 40                   ld hl,vara
     129   00:817D  BE                         cp (hl)
     130   00:817E  C2 12 82                   jp nz,a00663
     131   00:8181  AF                         xor a
     132   00:8182  21 1F 40                   ld hl,vard
     133   00:8185  BE                         cp (hl)
     134   00:8186  C2 12 82                   jp nz,a00663
     135   00:8189  06 06                      ld b,CUSTOM
     136   00:818B  CD 54 BB                   call tded
     137   00:818E  B8                         cp b
     138   00:818F  C2 B6 81                   jp nz,a00500
     139   00:8192  3E 08                      ld a,8
     140   00:8194  21 42 40                   ld hl,scno
     141   00:8197  BE                         cp (hl)
     142   00:8198  DA A3 81                   jp c,a00467
     143   00:819B  3E 04                      ld a,4
     144   00:819D  32 1C 40                   ld (vara),a
     145   00:81A0  C3 A8 81                   jp a00475
     146   00:81A3  3E 05               a00467 ld a,5
     147   00:81A5  32 1C 40                   ld (vara),a
     148   00:81A8  3E 0E               a00475 ld a,14
     149   00:81AA  21 42 40                   ld hl,scno
     150   00:81AD  BE                         cp (hl)
     151   00:81AE  D2 B6 81                   jp nc,a00500
     152   00:81B1  3E 04                      ld a,4
     153   00:81B3  32 1C 40                   ld (vara),a
     154   00:81B6  3A 41 40            a00500 ld a,(joyval)
     155   00:81B9  E6 01                      and 1
     156   00:81BB  CA E4 81                   jp z,a00581
     157   00:81BE  CD 24 BB                   call cangr
     158   00:81C1  C2 E4 81                   jp nz,a00581
     159   00:81C4  3E 01                      ld a,1
     160   00:81C6  32 21 40                   ld (varf),a
     161   00:81C9  DD 34 04                   inc (ix+4)
     162   00:81CC  AF                         xor a
     163   00:81CD  21 1E 40                   ld hl,varc
     164   00:81D0  BE                         cp (hl)
     165   00:81D1  C2 E4 81                   jp nz,a00581
     166   00:81D4  AF                         xor a
     167   00:81D5  CD 90 BF                   call animsp
     168   00:81D8  AF                         xor a
     169   00:81D9  DD BE 02                   cp (ix+2)
     170   00:81DC  C2 E4 81                   jp nz,a00581
     171   00:81DF  3E 05                      ld a,5
     172   00:81E1  32 16 40                   ld (sndtyp),a
     173   00:81E4  3A 41 40            a00581 ld a,(joyval)
     174   00:81E7  E6 02                      and 2
     175   00:81E9  CA 12 82                   jp z,a00663
     176   00:81EC  CD 19 BB                   call cangl
     177   00:81EF  C2 12 82                   jp nz,a00663
     178   00:81F2  3E 01                      ld a,1
     179   00:81F4  32 21 40                   ld (varf),a
     180   00:81F7  DD 35 04                   dec (ix+4)
     181   00:81FA  AF                         xor a
     182   00:81FB  21 1E 40                   ld hl,varc
     183   00:81FE  BE                         cp (hl)
     184   00:81FF  C2 06 82                   jp nz,a00641
     185   00:8202  AF                         xor a
     186   00:8203  CD A8 BF                   call animbk
     187   00:8206  AF                  a00641 xor a
     188   00:8207  DD BE 02                   cp (ix+2)
     189   00:820A  C2 12 82                   jp nz,a00663
     190   00:820D  3E 05                      ld a,5
     191   00:820F  32 16 40                   ld (sndtyp),a
     192   00:8212  AF                  a00663 xor a
     193   00:8213  21 21 40                   ld hl,varf
     194   00:8216  BE                         cp (hl)
     195   00:8217  C2 1E 82                   jp nz,a00687
     196   00:821A  AF                         xor a
     197   00:821B  DD 77 02                   ld (ix+2),a
     198   00:821E  3A 41 40            a00687 ld a,(joyval)
     199   00:8221  E6 08                      and 8
     200   00:8223  CA 69 82                   jp z,a00817
     201   00:8226  AF                         xor a
     202   00:8227  21 22 40                   ld hl,varg
     203   00:822A  BE                         cp (hl)
     204   00:822B  C2 69 82                   jp nz,a00817
     205   00:822E  3E 58                      ld a,88
     206   00:8230  DD BE 03                   cp (ix+3)
     207   00:8233  C2 40 82                   jp nz,a00747
     208   00:8236  3E 46                      ld a,70
     209   00:8238  32 16 40                   ld (sndtyp),a
     210   00:823B  3E 01                      ld a,1
     211   00:823D  32 1C 40                   ld (vara),a
     212   00:8240  3E 80               a00747 ld a,128
     213   00:8242  DD BE 03                   cp (ix+3)
     214   00:8245  C2 52 82                   jp nz,a00778
     215   00:8248  3E 46                      ld a,70
     216   00:824A  32 16 40                   ld (sndtyp),a
     217   00:824D  3E 02                      ld a,2
     218   00:824F  32 1C 40                   ld (vara),a
     219   00:8252  3E A0               a00778 ld a,160
     220   00:8254  DD BE 03                   cp (ix+3)
     221   00:8257  C2 64 82                   jp nz,a00808
     222   00:825A  3E 46                      ld a,70
     223   00:825C  32 16 40                   ld (sndtyp),a
     224   00:825F  3E 03                      ld a,3
     225   00:8261  32 1C 40                   ld (vara),a
     226   00:8264  3E 0A               a00808 ld a,10
     227   00:8266  32 22 40                   ld (varg),a
     228   00:8269  3E 01               a00817 ld a,1
     229   00:826B  21 1C 40                   ld hl,vara
     230   00:826E  BE                         cp (hl)
     231   00:826F  C2 95 82                   jp nz,a00893
     232   00:8272  DD 35 03                   dec (ix+3)
     233   00:8275  DD 35 03                   dec (ix+3)
     234   00:8278  DD 35 03                   dec (ix+3)
     235   00:827B  06 05                      ld b,DEADLY
     236   00:827D  CD 54 BB                   call tded
     237   00:8280  B8                         cp b
     238   00:8281  C2 89 82                   jp nz,a00872
     239   00:8284  3E 01                      ld a,1
     240   00:8286  32 29 40                   ld (varn),a
     241   00:8289  3E 2E               a00872 ld a,46
     242   00:828B  DD BE 03                   cp (ix+3)
     243   00:828E  DA 95 82                   jp c,a00893
     244   00:8291  AF                         xor a
     245   00:8292  32 1C 40                   ld (vara),a
     246   00:8295  3E 02               a00893 ld a,2
     247   00:8297  21 1C 40                   ld hl,vara
     248   00:829A  BE                         cp (hl)
     249   00:829B  C2 C1 82                   jp nz,a00969
     250   00:829E  DD 35 03                   dec (ix+3)
     251   00:82A1  DD 35 03                   dec (ix+3)
     252   00:82A4  DD 35 03                   dec (ix+3)
     253   00:82A7  06 05                      ld b,DEADLY
     254   00:82A9  CD 54 BB                   call tded
     255   00:82AC  B8                         cp b
     256   00:82AD  C2 B5 82                   jp nz,a00948
     257   00:82B0  3E 01                      ld a,1
     258   00:82B2  32 29 40                   ld (varn),a
     259   00:82B5  3E 56               a00948 ld a,86
     260   00:82B7  DD BE 03                   cp (ix+3)
     261   00:82BA  DA C1 82                   jp c,a00969
     262   00:82BD  AF                         xor a
     263   00:82BE  32 1C 40                   ld (vara),a
     264   00:82C1  3E 03               a00969 ld a,3
     265   00:82C3  21 1C 40                   ld hl,vara
     266   00:82C6  BE                         cp (hl)
     267   00:82C7  C2 ED 82                   jp nz,a01046
     268   00:82CA  DD 35 03                   dec (ix+3)
     269   00:82CD  DD 35 03                   dec (ix+3)
     270   00:82D0  DD 35 03                   dec (ix+3)
     271   00:82D3  06 05                      ld b,DEADLY
     272   00:82D5  CD 54 BB                   call tded
     273   00:82D8  B8                         cp b
     274   00:82D9  C2 E1 82                   jp nz,a01025
     275   00:82DC  3E 01                      ld a,1
     276   00:82DE  32 29 40                   ld (varn),a
     277   00:82E1  3E 7E               a01025 ld a,126
     278   00:82E3  DD BE 03                   cp (ix+3)
     279   00:82E6  DA ED 82                   jp c,a01046
     280   00:82E9  AF                         xor a
     281   00:82EA  32 1C 40                   ld (vara),a
     282   00:82ED  3E 04               a01046 ld a,4
     283   00:82EF  21 1C 40                   ld hl,vara
     284   00:82F2  BE                         cp (hl)
     285   00:82F3  C2 19 83                   jp nz,a01123
     286   00:82F6  06 06                      ld b,CUSTOM
     287   00:82F8  CD 54 BB                   call tded
     288   00:82FB  B8                         cp b
     289   00:82FC  C2 02 83                   jp nz,a01084
     290   00:82FF  C3 06 83                   jp a01092
     291   00:8302  AF                  a01084 xor a
     292   00:8303  32 1C 40                   ld (vara),a
     293   00:8306  CD 24 BB            a01092 call cangr
     294   00:8309  C2 0F 83                   jp nz,a01106
     295   00:830C  DD 34 04                   inc (ix+4)
     296   00:830F  CD E2 BA            a01106 call cangd
     297   00:8312  C2 19 83                   jp nz,a01123
     298   00:8315  AF                         xor a
     299   00:8316  32 1C 40                   ld (vara),a
     300   00:8319  3E 05               a01123 ld a,5
     301   00:831B  21 1C 40                   ld hl,vara
     302   00:831E  BE                         cp (hl)
     303   00:831F  C2 3B 83                   jp nz,a01183
     304   00:8322  06 06                      ld b,CUSTOM
     305   00:8324  CD 54 BB                   call tded
     306   00:8327  B8                         cp b
     307   00:8328  C2 2E 83                   jp nz,a01161
     308   00:832B  C3 32 83                   jp a01169
     309   00:832E  AF                  a01161 xor a
     310   00:832F  32 1C 40                   ld (vara),a
     311   00:8332  CD 19 BB            a01169 call cangl
     312   00:8335  C2 3B 83                   jp nz,a01183
     313   00:8338  DD 35 04                   dec (ix+4)
     314   00:833B  CD E2 BA            a01183 call cangd
     315   00:833E  C2 54 83                   jp nz,a01226
     316   00:8341  AF                         xor a
     317   00:8342  21 1C 40                   ld hl,vara
     318   00:8345  BE                         cp (hl)
     319   00:8346  C2 51 83                   jp nz,a01222
     320   00:8349  CD 68 C1                   call tfall
     321   00:834C  3E 01                      ld a,1
     322   00:834E  32 1F 40                   ld (vard),a
     323   00:8351  C3 66 83            a01222 jp a01260
     324   00:8354  3E 01               a01226 ld a,1
     325   00:8356  21 1F 40                   ld hl,vard
     326   00:8359  BE                         cp (hl)
     327   00:835A  C2 62 83                   jp nz,a01252
     328   00:835D  3E 14                      ld a,20
     329   00:835F  32 16 40                   ld (sndtyp),a
     330   00:8362  AF                  a01252 xor a
     331   00:8363  32 1F 40                   ld (vard),a
     332   00:8366  C3 93 83            a01260 jp a01343
     333   00:8369  3A 20 40            a01264 ld a,(vare)
     334   00:836C  3C                         inc a
     335   00:836D  32 20 40                   ld (vare),a
     336   00:8370  3E 32                      ld a,50
     337   00:8372  21 20 40                   ld hl,vare
     338   00:8375  BE                         cp (hl)
     339   00:8376  C2 88 83                   jp nz,a01324
     340   00:8379  AF                         xor a
     341   00:837A  32 20 40                   ld (vare),a
     342   00:837D  3A 27 40                   ld a,(varl)
     343   00:8380  3C                         inc a
     344   00:8381  32 27 40                   ld (varl),a
     345   00:8384  21 51 40                   ld hl,nexlev
     346   00:8387  74                         ld (hl),h
     347   00:8388  3A 20 40            a01324 ld a,(vare)
     348   00:838B  E6 7F                      and 127
     349   00:838D  32 16 40                   ld (sndtyp),a
     350   00:8390  CD 18 C5                   call sfx_mute
     351   00:8393  C3 84 C0            a01343 jp grav
     352   00:8396                      
     353   00:8396  (00:8396)           evnt01:	equ $
     354   00:8396  AF                         xor a
     355   00:8397  21 29 40                   ld hl,varn
     356   00:839A  BE                         cp (hl)
     357   00:839B  C2 EE 83                   jp nz,b00154
     358   00:839E  CD E2 BA                   call cangd
     359   00:83A1  C2 AA 83                   jp nz,b00038
     360   00:83A4  CD 68 C1                   call tfall
     361   00:83A7  C3 D5 83                   jp b00108
     362   00:83AA  AF                  b00038 xor a
     363   00:83AB  DD BE 0B                   cp (ix+11)
     364   00:83AE  C2 C5 83                   jp nz,b00082
     365   00:83B1  CD 19 BB                   call cangl
     366   00:83B4  C2 BD 83                   jp nz,b00069
     367   00:83B7  DD 35 04                   dec (ix+4)
     368   00:83BA  C3 C2 83                   jp b00078
     369   00:83BD  3E 01               b00069 ld a,1
     370   00:83BF  DD 77 0B                   ld (ix+11),a
     371   00:83C2  C3 D5 83            b00078 jp b00108
     372   00:83C5  CD 24 BB            b00082 call cangr
     373   00:83C8  C2 D1 83                   jp nz,b00100
     374   00:83CB  DD 34 04                   inc (ix+4)
     375   00:83CE  C3 D5 83                   jp b00108
     376   00:83D1  AF                  b00100 xor a
     377   00:83D2  DD 77 0B                   ld (ix+11),a
     378   00:83D5  AF                  b00108 xor a
     379   00:83D6  21 1E 40                   ld hl,varc
     380   00:83D9  BE                         cp (hl)
     381   00:83DA  C2 E1 83                   jp nz,b00133
     382   00:83DD  AF                         xor a
     383   00:83DE  CD 90 BF                   call animsp
     384   00:83E1  0E 00               b00133 ld c,0
     385   00:83E3  CD BE BF                   call sktyp
     386   00:83E6  D2 EE 83                   jp nc,b00154
     387   00:83E9  3E 01                      ld a,1
     388   00:83EB  32 29 40                   ld (varn),a
     389   00:83EE  C3 84 C0            b00154 jp grav
     390   00:83F1                      
     391   00:83F1  (00:83F1)           evnt02:	equ $
     392   00:83F1  AF                         xor a
     393   00:83F2  21 29 40                   ld hl,varn
     394   00:83F5  BE                         cp (hl)
     395   00:83F6  C2 57 84                   jp nz,c00180
     396   00:83F9  CD 34 B5                   call lcol
     397   00:83FC  D2 13 84                   jp nc,c00064
     398   00:83FF  3E 04                      ld a,4
     399   00:8401  CD 9F B4                   call explod
     400   00:8404  AF                         xor a
     401   00:8405  0E 00                      ld c,0
     402   00:8407  CD 20 C5                   call sfx_set
     403   00:840A  3E 64                      ld a,100
     404   00:840C  32 16 40                   ld (sndtyp),a
     405   00:840F  DD 36 00 FF                ld (ix+0),255
     406   00:8413  AF                  c00064 xor a
     407   00:8414  DD BE 0B                   cp (ix+11)
     408   00:8417  C2 2E 84                   jp nz,c00107
     409   00:841A  CD 19 BB                   call cangl
     410   00:841D  C2 26 84                   jp nz,c00095
     411   00:8420  DD 35 04                   dec (ix+4)
     412   00:8423  C3 2B 84                   jp c00103
     413   00:8426  3E 01               c00095 ld a,1
     414   00:8428  DD 77 0B                   ld (ix+11),a
     415   00:842B  C3 3E 84            c00103 jp c00134
     416   00:842E  CD 24 BB            c00107 call cangr
     417   00:8431  C2 3A 84                   jp nz,c00126
     418   00:8434  DD 34 04                   inc (ix+4)
     419   00:8437  C3 3E 84                   jp c00134
     420   00:843A  AF                  c00126 xor a
     421   00:843B  DD 77 0B                   ld (ix+11),a
     422   00:843E  AF                  c00134 xor a
     423   00:843F  21 1E 40                   ld hl,varc
     424   00:8442  BE                         cp (hl)
     425   00:8443  C2 4A 84                   jp nz,c00158
     426   00:8446  AF                         xor a
     427   00:8447  CD 90 BF                   call animsp
     428   00:844A  0E 00               c00158 ld c,0
     429   00:844C  CD BE BF                   call sktyp
     430   00:844F  D2 57 84                   jp nc,c00180
     431   00:8452  3E 01                      ld a,1
     432   00:8454  32 29 40                   ld (varn),a
     433   00:8457  C9                  c00180 ret
     434   00:8458                      
     435   00:8458  (00:8458)           evnt03:	equ $
     436   00:8458  AF                         xor a
     437   00:8459  21 29 40                   ld hl,varn
     438   00:845C  BE                         cp (hl)
     439   00:845D  C2 A4 84                   jp nz,d00136
     440   00:8460  AF                         xor a
     441   00:8461  DD BE 0B                   cp (ix+11)
     442   00:8464  C2 7B 84                   jp nz,d00064
     443   00:8467  CD C0 BA                   call cangu
     444   00:846A  C2 73 84                   jp nz,d00051
     445   00:846D  DD 35 03                   dec (ix+3)
     446   00:8470  C3 78 84                   jp d00059
     447   00:8473  3E 01               d00051 ld a,1
     448   00:8475  DD 77 0B                   ld (ix+11),a
     449   00:8478  C3 8B 84            d00059 jp d00090
     450   00:847B  CD E2 BA            d00064 call cangd
     451   00:847E  C2 87 84                   jp nz,d00082
     452   00:8481  DD 34 03                   inc (ix+3)
     453   00:8484  C3 8B 84                   jp d00090
     454   00:8487  AF                  d00082 xor a
     455   00:8488  DD 77 0B                   ld (ix+11),a
     456   00:848B  AF                  d00090 xor a
     457   00:848C  21 1E 40                   ld hl,varc
     458   00:848F  BE                         cp (hl)
     459   00:8490  C2 97 84                   jp nz,d00115
     460   00:8493  AF                         xor a
     461   00:8494  CD 90 BF                   call animsp
     462   00:8497  0E 00               d00115 ld c,0
     463   00:8499  CD BE BF                   call sktyp
     464   00:849C  D2 A4 84                   jp nc,d00136
     465   00:849F  3E 01                      ld a,1
     466   00:84A1  32 29 40                   ld (varn),a
     467   00:84A4  C9                  d00136 ret
     468   00:84A5                      
     469   00:84A5  (00:84A5)           evnt04:	equ $
     470   00:84A5  AF                         xor a
     471   00:84A6  21 29 40                   ld hl,varn
     472   00:84A9  BE                         cp (hl)
     473   00:84AA  C2 13 85                   jp nz,e00190
     474   00:84AD  AF                         xor a
     475   00:84AE  DD BE 0B                   cp (ix+11)
     476   00:84B1  C2 C8 84                   jp nz,e00064
     477   00:84B4  CD 19 BB                   call cangl
     478   00:84B7  C2 C0 84                   jp nz,e00051
     479   00:84BA  DD 35 04                   dec (ix+4)
     480   00:84BD  C3 C5 84                   jp e00059
     481   00:84C0  3E 01               e00051 ld a,1
     482   00:84C2  DD 77 0B                   ld (ix+11),a
     483   00:84C5  C3 D8 84            e00059 jp e00090
     484   00:84C8  CD 24 BB            e00064 call cangr
     485   00:84CB  C2 D4 84                   jp nz,e00082
     486   00:84CE  DD 34 04                   inc (ix+4)
     487   00:84D1  C3 D8 84                   jp e00090
     488   00:84D4  AF                  e00082 xor a
     489   00:84D5  DD 77 0B                   ld (ix+11),a
     490   00:84D8  AF                  e00090 xor a
     491   00:84D9  DD BE 0A                   cp (ix+10)
     492   00:84DC  C2 F3 84                   jp nz,e00134
     493   00:84DF  CD C0 BA                   call cangu
     494   00:84E2  C2 EB 84                   jp nz,e00121
     495   00:84E5  DD 35 03                   dec (ix+3)
     496   00:84E8  C3 F0 84                   jp e00130
     497   00:84EB  3E 01               e00121 ld a,1
     498   00:84ED  DD 77 0A                   ld (ix+10),a
     499   00:84F0  C3 03 85            e00130 jp e00160
     500   00:84F3  CD E2 BA            e00134 call cangd
     501   00:84F6  C2 FF 84                   jp nz,e00152
     502   00:84F9  DD 34 03                   inc (ix+3)
     503   00:84FC  C3 03 85                   jp e00160
     504   00:84FF  AF                  e00152 xor a
     505   00:8500  DD 77 0A                   ld (ix+10),a
     506   00:8503  AF                  e00160 xor a
     507   00:8504  CD 90 BF                   call animsp
     508   00:8507  0E 00                      ld c,0
     509   00:8509  CD BE BF                   call sktyp
     510   00:850C  D2 13 85                   jp nc,e00190
     511   00:850F  21 53 40                   ld hl,deadf
     512   00:8512  74                         ld (hl),h
     513   00:8513  C9                  e00190 ret
     514   00:8514                      
     515   00:8514  (00:8514)           evnt05:	equ $
     516   00:8514  AF                         xor a
     517   00:8515  21 29 40                   ld hl,varn
     518   00:8518  BE                         cp (hl)
     519   00:8519  C2 35 85                   jp nz,f00070
     520   00:851C  AF                         xor a
     521   00:851D  21 20 40                   ld hl,vare
     522   00:8520  BE                         cp (hl)
     523   00:8521  C2 35 85                   jp nz,f00070
     524   00:8524  AF                         xor a
     525   00:8525  21 28 40                   ld hl,varm
     526   00:8528  BE                         cp (hl)
     527   00:8529  C2 35 85                   jp nz,f00070
     528   00:852C  AF                         xor a
     529   00:852D  CD BE B3                   call shoot
     530   00:8530  3E 1E                      ld a,30
     531   00:8532  32 16 40                   ld (sndtyp),a
     532   00:8535  C9                  f00070 ret
     533   00:8536                      
     534   00:8536  (00:8536)           evnt06:	equ $
     535   00:8536  C9                         ret
     536   00:8537                      
     537   00:8537  (00:8537)           evnt07:	equ $
     538   00:8537  3E 01                      ld a,1
     539   00:8539  21 24 40                   ld hl,vari
     540   00:853C  BE                         cp (hl)
     541   00:853D  C2 52 85                   jp nz,h00053
     542   00:8540  3E 3C                      ld a,60
     543   00:8542  32 16 40                   ld (sndtyp),a
     544   00:8545  3E 01                      ld a,1
     545   00:8547  CD BE B3                   call shoot
     546   00:854A  AF                         xor a
     547   00:854B  CD BE B3                   call shoot
     548   00:854E  AF                         xor a
     549   00:854F  32 24 40                   ld (vari),a
     550   00:8552  C9                  h00053 ret
     551   00:8553                      
     552   00:8553  (00:8553)           evnt08:	equ $
     553   00:8553  0E 00                      ld c,0
     554   00:8555  CD BE BF                   call sktyp
     555   00:8558  D2 D6 87                   jp nc,i01132
     556   00:855B  AF                         xor a
     557   00:855C  21 23 40                   ld hl,varh
     558   00:855F  BE                         cp (hl)
     559   00:8560  C2 D6 87                   jp nz,i01132
     560   00:8563  AF                         xor a
     561   00:8564  21 1D 40                   ld hl,varb
     562   00:8567  BE                         cp (hl)
     563   00:8568  C2 73 85                   jp nz,i00062
     564   00:856B  3E 01                      ld a,1
     565   00:856D  32 1D 40                   ld (varb),a
     566   00:8570  C3 77 85                   jp i00070
     567   00:8573  AF                  i00062 xor a
     568   00:8574  32 1D 40                   ld (varb),a
     569   00:8577  3E 32               i00070 ld a,50
     570   00:8579  32 23 40                   ld (varh),a
     571   00:857C  3A 1D 40                   ld a,(varb)
     572   00:857F  DD 77 02                   ld (ix+2),a
     573   00:8582  3E 37                      ld a,55
     574   00:8584  32 16 40                   ld (sndtyp),a
     575   00:8587  3E 05                      ld a,5
     576   00:8589  21 42 40                   ld hl,scno
     577   00:858C  BE                         cp (hl)
     578   00:858D  C2 18 86                   jp nz,i00347
     579   00:8590  3E 08                      ld a,8
     580   00:8592  32 35 40                   ld (charx),a
     581   00:8595  3E 0A                      ld a,10
     582   00:8597  32 36 40                   ld (chary),a
     583   00:859A  3E 01                      ld a,1
     584   00:859C  21 1D 40                   ld hl,varb
     585   00:859F  BE                         cp (hl)
     586   00:85A0  C2 BD 85                   jp nz,i00191
     587   00:85A3  21 39 9C                   ld hl,chgfx
     588   00:85A6  22 3F 40                   ld (grbase),hl
     589   00:85A9  2A 35 40                   ld hl,(charx)
     590   00:85AC  22 55 40                   ld (dispx),hl
     591   00:85AF  3E 01                      ld a,1
     592   00:85B1  CD FE B9                   call pattr
     593   00:85B4  2A 55 40                   ld hl,(dispx)
     594   00:85B7  22 35 40                   ld (charx),hl
     595   00:85BA  C3 D4 85                   jp i00230
     596   00:85BD  21 39 9C            i00191 ld hl,chgfx
     597   00:85C0  22 3F 40                   ld (grbase),hl
     598   00:85C3  2A 35 40                   ld hl,(charx)
     599   00:85C6  22 55 40                   ld (dispx),hl
     600   00:85C9  3E 03                      ld a,3
     601   00:85CB  CD FE B9                   call pattr
     602   00:85CE  2A 55 40                   ld hl,(dispx)
     603   00:85D1  22 35 40                   ld (charx),hl
     604   00:85D4  3E 08               i00230 ld a,8
     605   00:85D6  32 35 40                   ld (charx),a
     606   00:85D9  3E 0B                      ld a,11
     607   00:85DB  32 36 40                   ld (chary),a
     608   00:85DE  3E 01                      ld a,1
     609   00:85E0  21 1D 40                   ld hl,varb
     610   00:85E3  BE                         cp (hl)
     611   00:85E4  C2 01 86                   jp nz,i00308
     612   00:85E7  21 39 9C                   ld hl,chgfx
     613   00:85EA  22 3F 40                   ld (grbase),hl
     614   00:85ED  2A 35 40                   ld hl,(charx)
     615   00:85F0  22 55 40                   ld (dispx),hl
     616   00:85F3  3E 01                      ld a,1
     617   00:85F5  CD FE B9                   call pattr
     618   00:85F8  2A 55 40                   ld hl,(dispx)
     619   00:85FB  22 35 40                   ld (charx),hl
     620   00:85FE  C3 18 86                   jp i00347
     621   00:8601  21 39 9C            i00308 ld hl,chgfx
     622   00:8604  22 3F 40                   ld (grbase),hl
     623   00:8607  2A 35 40                   ld hl,(charx)
     624   00:860A  22 55 40                   ld (dispx),hl
     625   00:860D  3E 03                      ld a,3
     626   00:860F  CD FE B9                   call pattr
     627   00:8612  2A 55 40                   ld hl,(dispx)
     628   00:8615  22 35 40                   ld (charx),hl
     629   00:8618  3E 06               i00347 ld a,6
     630   00:861A  21 42 40                   ld hl,scno
     631   00:861D  BE                         cp (hl)
     632   00:861E  C2 61 86                   jp nz,i00477
     633   00:8621  3E 12                      ld a,18
     634   00:8623  32 35 40                   ld (charx),a
     635   00:8626  3E 1B                      ld a,27
     636   00:8628  32 36 40                   ld (chary),a
     637   00:862B  21 39 9C                   ld hl,chgfx
     638   00:862E  22 3F 40                   ld (grbase),hl
     639   00:8631  2A 35 40                   ld hl,(charx)
     640   00:8634  22 55 40                   ld (dispx),hl
     641   00:8637  AF                         xor a
     642   00:8638  CD FE B9                   call pattr
     643   00:863B  2A 55 40                   ld hl,(dispx)
     644   00:863E  22 35 40                   ld (charx),hl
     645   00:8641  3E 12                      ld a,18
     646   00:8643  32 35 40                   ld (charx),a
     647   00:8646  3E 1C                      ld a,28
     648   00:8648  32 36 40                   ld (chary),a
     649   00:864B  21 39 9C                   ld hl,chgfx
     650   00:864E  22 3F 40                   ld (grbase),hl
     651   00:8651  2A 35 40                   ld hl,(charx)
     652   00:8654  22 55 40                   ld (dispx),hl
     653   00:8657  AF                         xor a
     654   00:8658  CD FE B9                   call pattr
     655   00:865B  2A 55 40                   ld hl,(dispx)
     656   00:865E  22 35 40                   ld (charx),hl
     657   00:8661  3E 07               i00477 ld a,7
     658   00:8663  21 42 40                   ld hl,scno
     659   00:8666  BE                         cp (hl)
     660   00:8667  C2 F0 86                   jp nz,i00727
     661   00:866A  3E 08                      ld a,8
     662   00:866C  32 35 40                   ld (charx),a
     663   00:866F  3E 15                      ld a,21
     664   00:8671  32 36 40                   ld (chary),a
     665   00:8674  3E 01                      ld a,1
     666   00:8676  21 1D 40                   ld hl,varb
     667   00:8679  BE                         cp (hl)
     668   00:867A  C2 97 86                   jp nz,i00571
     669   00:867D  21 39 9C                   ld hl,chgfx
     670   00:8680  22 3F 40                   ld (grbase),hl
     671   00:8683  2A 35 40                   ld hl,(charx)
     672   00:8686  22 55 40                   ld (dispx),hl
     673   00:8689  3E 01                      ld a,1
     674   00:868B  CD FE B9                   call pattr
     675   00:868E  2A 55 40                   ld hl,(dispx)
     676   00:8691  22 35 40                   ld (charx),hl
     677   00:8694  C3 AD 86                   jp i00610
     678   00:8697  21 39 9C            i00571 ld hl,chgfx
     679   00:869A  22 3F 40                   ld (grbase),hl
     680   00:869D  2A 35 40                   ld hl,(charx)
     681   00:86A0  22 55 40                   ld (dispx),hl
     682   00:86A3  AF                         xor a
     683   00:86A4  CD FE B9                   call pattr
     684   00:86A7  2A 55 40                   ld hl,(dispx)
     685   00:86AA  22 35 40                   ld (charx),hl
     686   00:86AD  3E 08               i00610 ld a,8
     687   00:86AF  32 35 40                   ld (charx),a
     688   00:86B2  3E 16                      ld a,22
     689   00:86B4  32 36 40                   ld (chary),a
     690   00:86B7  3E 01                      ld a,1
     691   00:86B9  21 1D 40                   ld hl,varb
     692   00:86BC  BE                         cp (hl)
     693   00:86BD  C2 DA 86                   jp nz,i00688
     694   00:86C0  21 39 9C                   ld hl,chgfx
     695   00:86C3  22 3F 40                   ld (grbase),hl
     696   00:86C6  2A 35 40                   ld hl,(charx)
     697   00:86C9  22 55 40                   ld (dispx),hl
     698   00:86CC  3E 01                      ld a,1
     699   00:86CE  CD FE B9                   call pattr
     700   00:86D1  2A 55 40                   ld hl,(dispx)
     701   00:86D4  22 35 40                   ld (charx),hl
     702   00:86D7  C3 F0 86                   jp i00727
     703   00:86DA  21 39 9C            i00688 ld hl,chgfx
     704   00:86DD  22 3F 40                   ld (grbase),hl
     705   00:86E0  2A 35 40                   ld hl,(charx)
     706   00:86E3  22 55 40                   ld (dispx),hl
     707   00:86E6  AF                         xor a
     708   00:86E7  CD FE B9                   call pattr
     709   00:86EA  2A 55 40                   ld hl,(dispx)
     710   00:86ED  22 35 40                   ld (charx),hl
     711   00:86F0  3E 09               i00727 ld a,9
     712   00:86F2  21 42 40                   ld hl,scno
     713   00:86F5  BE                         cp (hl)
     714   00:86F6  C2 7F 87                   jp nz,i00976
     715   00:86F9  3E 08                      ld a,8
     716   00:86FB  32 35 40                   ld (charx),a
     717   00:86FE  3E 15                      ld a,21
     718   00:8700  32 36 40                   ld (chary),a
     719   00:8703  3E 01                      ld a,1
     720   00:8705  21 1D 40                   ld hl,varb
     721   00:8708  BE                         cp (hl)
     722   00:8709  C2 26 87                   jp nz,i00821
     723   00:870C  21 39 9C                   ld hl,chgfx
     724   00:870F  22 3F 40                   ld (grbase),hl
     725   00:8712  2A 35 40                   ld hl,(charx)
     726   00:8715  22 55 40                   ld (dispx),hl
     727   00:8718  3E 01                      ld a,1
     728   00:871A  CD FE B9                   call pattr
     729   00:871D  2A 55 40                   ld hl,(dispx)
     730   00:8720  22 35 40                   ld (charx),hl
     731   00:8723  C3 3C 87                   jp i00860
     732   00:8726  21 39 9C            i00821 ld hl,chgfx
     733   00:8729  22 3F 40                   ld (grbase),hl
     734   00:872C  2A 35 40                   ld hl,(charx)
     735   00:872F  22 55 40                   ld (dispx),hl
     736   00:8732  AF                         xor a
     737   00:8733  CD FE B9                   call pattr
     738   00:8736  2A 55 40                   ld hl,(dispx)
     739   00:8739  22 35 40                   ld (charx),hl
     740   00:873C  3E 08               i00860 ld a,8
     741   00:873E  32 35 40                   ld (charx),a
     742   00:8741  3E 16                      ld a,22
     743   00:8743  32 36 40                   ld (chary),a
     744   00:8746  3E 01                      ld a,1
     745   00:8748  21 1D 40                   ld hl,varb
     746   00:874B  BE                         cp (hl)
     747   00:874C  C2 69 87                   jp nz,i00937
     748   00:874F  21 39 9C                   ld hl,chgfx
     749   00:8752  22 3F 40                   ld (grbase),hl
     750   00:8755  2A 35 40                   ld hl,(charx)
     751   00:8758  22 55 40                   ld (dispx),hl
     752   00:875B  3E 01                      ld a,1
     753   00:875D  CD FE B9                   call pattr
     754   00:8760  2A 55 40                   ld hl,(dispx)
     755   00:8763  22 35 40                   ld (charx),hl
     756   00:8766  C3 7F 87                   jp i00976
     757   00:8769  21 39 9C            i00937 ld hl,chgfx
     758   00:876C  22 3F 40                   ld (grbase),hl
     759   00:876F  2A 35 40                   ld hl,(charx)
     760   00:8772  22 55 40                   ld (dispx),hl
     761   00:8775  AF                         xor a
     762   00:8776  CD FE B9                   call pattr
     763   00:8779  2A 55 40                   ld hl,(dispx)
     764   00:877C  22 35 40                   ld (charx),hl
     765   00:877F  3E 0A               i00976 ld a,10
     766   00:8781  21 42 40                   ld hl,scno
     767   00:8784  BE                         cp (hl)
     768   00:8785  C2 C8 87                   jp nz,i01106
     769   00:8788  3E 14                      ld a,20
     770   00:878A  32 35 40                   ld (charx),a
     771   00:878D  3E 12                      ld a,18
     772   00:878F  32 36 40                   ld (chary),a
     773   00:8792  21 39 9C                   ld hl,chgfx
     774   00:8795  22 3F 40                   ld (grbase),hl
     775   00:8798  2A 35 40                   ld hl,(charx)
     776   00:879B  22 55 40                   ld (dispx),hl
     777   00:879E  AF                         xor a
     778   00:879F  CD FE B9                   call pattr
     779   00:87A2  2A 55 40                   ld hl,(dispx)
     780   00:87A5  22 35 40                   ld (charx),hl
     781   00:87A8  3E 15                      ld a,21
     782   00:87AA  32 35 40                   ld (charx),a
     783   00:87AD  3E 12                      ld a,18
     784   00:87AF  32 36 40                   ld (chary),a
     785   00:87B2  21 39 9C                   ld hl,chgfx
     786   00:87B5  22 3F 40                   ld (grbase),hl
     787   00:87B8  2A 35 40                   ld hl,(charx)
     788   00:87BB  22 55 40                   ld (dispx),hl
     789   00:87BE  AF                         xor a
     790   00:87BF  CD FE B9                   call pattr
     791   00:87C2  2A 55 40                   ld hl,(dispx)
     792   00:87C5  22 35 40                   ld (charx),hl
     793   00:87C8  3E 0A               i01106 ld a,10
     794   00:87CA  21 42 40                   ld hl,scno
     795   00:87CD  BE                         cp (hl)
     796   00:87CE  D2 D6 87                   jp nc,i01132
     797   00:87D1  3E 01                      ld a,1
     798   00:87D3  32 24 40                   ld (vari),a
     799   00:87D6  C9                  i01132 ret
     800   00:87D7                      
     801   00:87D7  (00:87D7)           evnt09:	equ $
     802   00:87D7  3E 0D                      ld a,13
     803   00:87D9  87                         add a,a
     804   00:87DA  87                         add a,a
     805   00:87DB  87                         add a,a
     806   00:87DC  87                         add a,a
     807   00:87DD  5F                         ld e,a
     808   00:87DE  3A 39 40                   ld a,(clratt)
     809   00:87E1  E6 0F                      and $0F
     810   00:87E3  B3                         or e
     811   00:87E4  32 39 40                   ld (clratt),a
     812   00:87E7  3E 01                      ld a,1
     813   00:87E9  5F                         ld e,a
     814   00:87EA  3A 39 40                   ld a,(clratt)
     815   00:87ED  E6 F0                      and $F0
     816   00:87EF  B3                         or e
     817   00:87F0  32 39 40                   ld (clratt),a
     818   00:87F3  3E 02                      ld a,2
     819   00:87F5  32 35 40                   ld (charx),a
     820   00:87F8  3E 02                      ld a,2
     821   00:87FA  32 36 40                   ld (chary),a
     822   00:87FD  3E 02                      ld a,2
     823   00:87FF  CD 57 BC                   call dmsg
     824   00:8802  3E 02                      ld a,2
     825   00:8804  32 35 40                   ld (charx),a
     826   00:8807  3E 0D                      ld a,13
     827   00:8809  32 36 40                   ld (chary),a
     828   00:880C  3E 03                      ld a,3
     829   00:880E  CD 57 BC                   call dmsg
     830   00:8811  3E 02                      ld a,2
     831   00:8813  32 35 40                   ld (charx),a
     832   00:8816  3E 13                      ld a,19
     833   00:8818  32 36 40                   ld (chary),a
     834   00:881B  3A 27 40                   ld a,(varl)
     835   00:881E  CD 1C C0                   call disply
     836   00:8821  3E 02                      ld a,2
     837   00:8823  32 35 40                   ld (charx),a
     838   00:8826  3E 17                      ld a,23
     839   00:8828  32 36 40                   ld (chary),a
     840   00:882B  3E 04                      ld a,4
     841   00:882D  CD 57 BC                   call dmsg
     842   00:8830  3E 02                      ld a,2
     843   00:8832  32 35 40                   ld (charx),a
     844   00:8835  3E 1D                      ld a,29
     845   00:8837  32 36 40                   ld (chary),a
     846   00:883A  3A 46 40                   ld a,(numlif)
     847   00:883D  CD 1C C0                   call disply
     848   00:8840  C9                         ret
     849   00:8841                      
     850   00:8841  (00:8841)           evnt10:	equ $
     851   00:8841  3E 1F                      ld a,31
     852   00:8843  21 42 40                   ld hl,scno
     853   00:8846  BE                         cp (hl)
     854   00:8847  C2 4E 88                   jp nz,k00030
     855   00:884A  21 54 40                   ld hl,gamwon
     856   00:884D  74                         ld (hl),h
     857   00:884E  C9                  k00030 ret
     858   00:884F                      
     859   00:884F  (00:884F)           evnt11:	equ $
     860   00:884F  3E 01                      ld a,1
     861   00:8851  21 1E 40                   ld hl,varc
     862   00:8854  BE                         cp (hl)
     863   00:8855  C2 5F 88                   jp nz,l00032
     864   00:8858  AF                         xor a
     865   00:8859  32 1E 40                   ld (varc),a
     866   00:885C  C3 66 88                   jp l00045
     867   00:885F  3A 1E 40            l00032 ld a,(varc)
     868   00:8862  3C                         inc a
     869   00:8863  32 1E 40                   ld (varc),a
     870   00:8866  3E 32               l00045 ld a,50
     871   00:8868  21 28 40                   ld hl,varm
     872   00:886B  BE                         cp (hl)
     873   00:886C  C2 76 88                   jp nz,l00074
     874   00:886F  AF                         xor a
     875   00:8870  32 28 40                   ld (varm),a
     876   00:8873  C3 9B 88                   jp l00146
     877   00:8876  3A 28 40            l00074 ld a,(varm)
     878   00:8879  3C                         inc a
     879   00:887A  32 28 40                   ld (varm),a
     880   00:887D  AF                         xor a
     881   00:887E  21 22 40                   ld hl,varg
     882   00:8881  BE                         cp (hl)
     883   00:8882  D2 8C 88                   jp nc,l00116
     884   00:8885  3A 22 40                   ld a,(varg)
     885   00:8888  3D                         dec a
     886   00:8889  32 22 40                   ld (varg),a
     887   00:888C  AF                  l00116 xor a
     888   00:888D  21 23 40                   ld hl,varh
     889   00:8890  BE                         cp (hl)
     890   00:8891  D2 9B 88                   jp nc,l00146
     891   00:8894  3A 23 40                   ld a,(varh)
     892   00:8897  3D                         dec a
     893   00:8898  32 23 40                   ld (varh),a
     894   00:889B  C9                  l00146 ret
     895   00:889C                      
     896   00:889C  (00:889C)           evnt12:	equ $
     897   00:889C  3E 0C                      ld a,12
     898   00:889E  87                         add a,a
     899   00:889F  87                         add a,a
     900   00:88A0  87                         add a,a
     901   00:88A1  87                         add a,a
     902   00:88A2  5F                         ld e,a
     903   00:88A3  3A 39 40                   ld a,(clratt)
     904   00:88A6  E6 0F                      and $0F
     905   00:88A8  B3                         or e
     906   00:88A9  32 39 40                   ld (clratt),a
     907   00:88AC  AF                         xor a
     908   00:88AD  5F                         ld e,a
     909   00:88AE  3A 39 40                   ld a,(clratt)
     910   00:88B1  E6 F0                      and $F0
     911   00:88B3  B3                         or e
     912   00:88B4  32 39 40                   ld (clratt),a
     913   00:88B7  CD 11 B2                   call cls
     914   00:88BA  3E 03                      ld a,3
     915   00:88BC  32 35 40                   ld (charx),a
     916   00:88BF  3E 0B                      ld a,11
     917   00:88C1  32 36 40                   ld (chary),a
     918   00:88C4  3E 02                      ld a,2
     919   00:88C6  CD 57 BC                   call dmsg
     920   00:88C9  3E 05                      ld a,5
     921   00:88CB  32 35 40                   ld (charx),a
     922   00:88CE  3E 02                      ld a,2
     923   00:88D0  32 36 40                   ld (chary),a
     924   00:88D3  3E 0D                      ld a,13
     925   00:88D5  87                         add a,a
     926   00:88D6  87                         add a,a
     927   00:88D7  87                         add a,a
     928   00:88D8  87                         add a,a
     929   00:88D9  5F                         ld e,a
     930   00:88DA  3A 39 40                   ld a,(clratt)
     931   00:88DD  E6 0F                      and $0F
     932   00:88DF  B3                         or e
     933   00:88E0  32 39 40                   ld (clratt),a
     934   00:88E3  AF                         xor a
     935   00:88E4  5F                         ld e,a
     936   00:88E5  3A 39 40                   ld a,(clratt)
     937   00:88E8  E6 F0                      and $F0
     938   00:88EA  B3                         or e
     939   00:88EB  32 39 40                   ld (clratt),a
     940   00:88EE  3E 05                      ld a,5
     941   00:88F0  CD 57 BC                   call dmsg
     942   00:88F3  3E 08                      ld a,8
     943   00:88F5  32 35 40                   ld (charx),a
     944   00:88F8  3E 09                      ld a,9
     945   00:88FA  32 36 40                   ld (chary),a
     946   00:88FD  3E 07                      ld a,7
     947   00:88FF  87                         add a,a
     948   00:8900  87                         add a,a
     949   00:8901  87                         add a,a
     950   00:8902  87                         add a,a
     951   00:8903  5F                         ld e,a
     952   00:8904  3A 39 40                   ld a,(clratt)
     953   00:8907  E6 0F                      and $0F
     954   00:8909  B3                         or e
     955   00:890A  32 39 40                   ld (clratt),a
     956   00:890D  AF                         xor a
     957   00:890E  5F                         ld e,a
     958   00:890F  3A 39 40                   ld a,(clratt)
     959   00:8912  E6 F0                      and $F0
     960   00:8914  B3                         or e
     961   00:8915  32 39 40                   ld (clratt),a
     962   00:8918  3E 06                      ld a,6
     963   00:891A  CD 57 BC                   call dmsg
     964   00:891D  3E 0A                      ld a,10
     965   00:891F  32 35 40                   ld (charx),a
     966   00:8922  3E 0A                      ld a,10
     967   00:8924  32 36 40                   ld (chary),a
     968   00:8927  3E 0A                      ld a,10
     969   00:8929  87                         add a,a
     970   00:892A  87                         add a,a
     971   00:892B  87                         add a,a
     972   00:892C  87                         add a,a
     973   00:892D  5F                         ld e,a
     974   00:892E  3A 39 40                   ld a,(clratt)
     975   00:8931  E6 0F                      and $0F
     976   00:8933  B3                         or e
     977   00:8934  32 39 40                   ld (clratt),a
     978   00:8937  AF                         xor a
     979   00:8938  5F                         ld e,a
     980   00:8939  3A 39 40                   ld a,(clratt)
     981   00:893C  E6 F0                      and $F0
     982   00:893E  B3                         or e
     983   00:893F  32 39 40                   ld (clratt),a
     984   00:8942  3E 07                      ld a,7
     985   00:8944  CD 57 BC                   call dmsg
     986   00:8947  3E 0B                      ld a,11
     987   00:8949  32 35 40                   ld (charx),a
     988   00:894C  3E 0A                      ld a,10
     989   00:894E  32 36 40                   ld (chary),a
     990   00:8951  3E 08                      ld a,8
     991   00:8953  CD 57 BC                   call dmsg
     992   00:8956  3E 0C                      ld a,12
     993   00:8958  32 35 40                   ld (charx),a
     994   00:895B  3E 0A                      ld a,10
     995   00:895D  32 36 40                   ld (chary),a
     996   00:8960  3E 09                      ld a,9
     997   00:8962  CD 57 BC                   call dmsg
     998   00:8965  3E 12                      ld a,18
     999   00:8967  32 35 40                   ld (charx),a
    1000   00:896A  3E 05                      ld a,5
    1001   00:896C  32 36 40                   ld (chary),a
    1002   00:896F  3E 05                      ld a,5
    1003   00:8971  87                         add a,a
    1004   00:8972  87                         add a,a
    1005   00:8973  87                         add a,a
    1006   00:8974  87                         add a,a
    1007   00:8975  5F                         ld e,a
    1008   00:8976  3A 39 40                   ld a,(clratt)
    1009   00:8979  E6 0F                      and $0F
    1010   00:897B  B3                         or e
    1011   00:897C  32 39 40                   ld (clratt),a
    1012   00:897F  3E 01                      ld a,1
    1013   00:8981  5F                         ld e,a
    1014   00:8982  3A 39 40                   ld a,(clratt)
    1015   00:8985  E6 F0                      and $F0
    1016   00:8987  B3                         or e
    1017   00:8988  32 39 40                   ld (clratt),a
    1018   00:898B  3E 0A                      ld a,10
    1019   00:898D  CD 57 BC                   call dmsg
    1020   00:8990  3E 63                      ld a,99
    1021   00:8992  32 34 40                   ld (contrl),a
    1022   00:8995  3E 63               m00509 ld a,99
    1023   00:8997  21 34 40                   ld hl,contrl
    1024   00:899A  BE                         cp (hl)
    1025   00:899B  C2 DF 89                   jp nz,m00663
    1026   00:899E  21 8C 40                   ld hl,keys+14
    1027   00:89A1  7E                         ld a,(hl)
    1028   00:89A2  23                         inc hl
    1029   00:89A3  56                         ld d,(hl)
    1030   00:89A4  CD E6 BB                   call ktest
    1031   00:89A7  DA AE 89                   jp c,m00562
    1032   00:89AA  AF                         xor a
    1033   00:89AB  32 34 40                   ld (contrl),a
    1034   00:89AE  21 8E 40            m00562 ld hl,keys+16
    1035   00:89B1  7E                         ld a,(hl)
    1036   00:89B2  23                         inc hl
    1037   00:89B3  56                         ld d,(hl)
    1038   00:89B4  CD E6 BB                   call ktest
    1039   00:89B7  DA BF 89                   jp c,m00597
    1040   00:89BA  3E 01                      ld a,1
    1041   00:89BC  32 34 40                   ld (contrl),a
    1042   00:89BF  21 90 40            m00597 ld hl,keys+18
    1043   00:89C2  7E                         ld a,(hl)
    1044   00:89C3  23                         inc hl
    1045   00:89C4  56                         ld d,(hl)
    1046   00:89C5  CD E6 BB                   call ktest
    1047   00:89C8  DA D0 89                   jp c,m00632
    1048   00:89CB  3E 02                      ld a,2
    1049   00:89CD  32 34 40                   ld (contrl),a
    1050   00:89D0  21 92 40            m00632 ld hl,keys+20
    1051   00:89D3  7E                         ld a,(hl)
    1052   00:89D4  23                         inc hl
    1053   00:89D5  56                         ld d,(hl)
    1054   00:89D6  CD E6 BB                   call ktest
    1055   00:89D9  DA DC 89                   jp c,m00659
    1056   00:89DC  C3 95 89            m00659 jp m00509
    1057   00:89DF  3E 01               m00663 ld a,1
    1058   00:89E1  5F                         ld e,a
    1059   00:89E2  3A 39 40                   ld a,(clratt)
    1060   00:89E5  E6 F0                      and $F0
    1061   00:89E7  B3                         or e
    1062   00:89E8  32 39 40                   ld (clratt),a
    1063   00:89EB  CD 11 B2                   call cls
    1064   00:89EE  C9                         ret
    1065   00:89EF                      
    1066   00:89EF  (00:89EF)           evnt13:	equ $
    1067   00:89EF  3E 03                      ld a,3
    1068   00:89F1  32 46 40                   ld (numlif),a
    1069   00:89F4  3E 0F                      ld a,15
    1070   00:89F6  87                         add a,a
    1071   00:89F7  87                         add a,a
    1072   00:89F8  87                         add a,a
    1073   00:89F9  87                         add a,a
    1074   00:89FA  5F                         ld e,a
    1075   00:89FB  3A 39 40                   ld a,(clratt)
    1076   00:89FE  E6 0F                      and $0F
    1077   00:8A00  B3                         or e
    1078   00:8A01  32 39 40                   ld (clratt),a
    1079   00:8A04  3E 01                      ld a,1
    1080   00:8A06  5F                         ld e,a
    1081   00:8A07  3A 39 40                   ld a,(clratt)
    1082   00:8A0A  E6 F0                      and $F0
    1083   00:8A0C  B3                         or e
    1084   00:8A0D  32 39 40                   ld (clratt),a
    1085   00:8A10  CD 11 B2                   call cls
    1086   00:8A13  AF                         xor a
    1087   00:8A14  32 1C 40                   ld (vara),a
    1088   00:8A17  AF                         xor a
    1089   00:8A18  32 1D 40                   ld (varb),a
    1090   00:8A1B  AF                         xor a
    1091   00:8A1C  32 1E 40                   ld (varc),a
    1092   00:8A1F  AF                         xor a
    1093   00:8A20  32 1F 40                   ld (vard),a
    1094   00:8A23  AF                         xor a
    1095   00:8A24  32 20 40                   ld (vare),a
    1096   00:8A27  AF                         xor a
    1097   00:8A28  32 21 40                   ld (varf),a
    1098   00:8A2B  AF                         xor a
    1099   00:8A2C  32 22 40                   ld (varg),a
    1100   00:8A2F  AF                         xor a
    1101   00:8A30  32 23 40                   ld (varh),a
    1102   00:8A33  AF                         xor a
    1103   00:8A34  32 24 40                   ld (vari),a
    1104   00:8A37  3E 01                      ld a,1
    1105   00:8A39  32 27 40                   ld (varl),a
    1106   00:8A3C  AF                         xor a
    1107   00:8A3D  32 28 40                   ld (varm),a
    1108   00:8A40  AF                         xor a
    1109   00:8A41  32 29 40                   ld (varn),a
    1110   00:8A44  C9                         ret
    1111   00:8A45                      
    1112   00:8A45  (00:8A45)           evnt14:	equ $
    1113   00:8A45  AF                         xor a
    1114   00:8A46  32 1C 40                   ld (vara),a
    1115   00:8A49  AF                         xor a
    1116   00:8A4A  32 1D 40                   ld (varb),a
    1117   00:8A4D  AF                         xor a
    1118   00:8A4E  32 20 40                   ld (vare),a
    1119   00:8A51  AF                         xor a
    1120   00:8A52  32 21 40                   ld (varf),a
    1121   00:8A55  AF                         xor a
    1122   00:8A56  32 29 40                   ld (varn),a
    1123   00:8A59  C9                         ret
    1124   00:8A5A                      
    1125   00:8A5A  (00:8A5A)           evnt15:	equ $
    1126   00:8A5A  C9                         ret
    1127   00:8A5B                      
    1128   00:8A5B  (00:8A5B)           evnt16:	equ $
    1129   00:8A5B  3E 7F                      ld a,127
    1130   00:8A5D  32 16 40                   ld (sndtyp),a
    1131   00:8A60  3E 08                      ld a,8
    1132   00:8A62  CD 9F B4                   call explod
    1133   00:8A65  3A 46 40                   ld a,(numlif)
    1134   00:8A68  3D                         dec a
    1135   00:8A69  32 46 40                   ld (numlif),a
    1136   00:8A6C  C9                         ret
    1137   00:8A6D                      
    1138   00:8A6D  (00:8A6D)           evnt17:	equ $
    1139   00:8A6D  3E 0A                      ld a,10
    1140   00:8A6F  32 35 40                   ld (charx),a
    1141   00:8A72  3E 0C                      ld a,12
    1142   00:8A74  32 36 40                   ld (chary),a
    1143   00:8A77  3E 09                      ld a,9
    1144   00:8A79  87                         add a,a
    1145   00:8A7A  87                         add a,a
    1146   00:8A7B  87                         add a,a
    1147   00:8A7C  87                         add a,a
    1148   00:8A7D  5F                         ld e,a
    1149   00:8A7E  3A 39 40                   ld a,(clratt)
    1150   00:8A81  E6 0F                      and $0F
    1151   00:8A83  B3                         or e
    1152   00:8A84  32 39 40                   ld (clratt),a
    1153   00:8A87  3E 0E                      ld a,14
    1154   00:8A89  5F                         ld e,a
    1155   00:8A8A  3A 39 40                   ld a,(clratt)
    1156   00:8A8D  E6 F0                      and $F0
    1157   00:8A8F  B3                         or e
    1158   00:8A90  32 39 40                   ld (clratt),a
    1159   00:8A93  AF                         xor a
    1160   00:8A94  CD 57 BC                   call dmsg
    1161   00:8A97  DD E5                      push ix
    1162   00:8A99  06 32                      ld b,50
    1163   00:8A9B  CD 31 B1                   call delay
    1164   00:8A9E  DD E1                      pop ix
    1165   00:8AA0  3E 54                      ld a,84
    1166   00:8AA2  32 16 40                   ld (sndtyp),a
    1167   00:8AA5  DD E5                      push ix
    1168   00:8AA7  06 32                      ld b,50
    1169   00:8AA9  CD 31 B1                   call delay
    1170   00:8AAC  DD E1                      pop ix
    1171   00:8AAE  3E 49                      ld a,73
    1172   00:8AB0  32 16 40                   ld (sndtyp),a
    1173   00:8AB3  DD E5                      push ix
    1174   00:8AB5  06 32                      ld b,50
    1175   00:8AB7  CD 31 B1                   call delay
    1176   00:8ABA  DD E1                      pop ix
    1177   00:8ABC  3E 3E                      ld a,62
    1178   00:8ABE  32 16 40                   ld (sndtyp),a
    1179   00:8AC1  DD E5                      push ix
    1180   00:8AC3  06 C8                      ld b,200
    1181   00:8AC5  CD 31 B1                   call delay
    1182   00:8AC8  DD E1                      pop ix
    1183   00:8ACA  C9                         ret
    1184   00:8ACB                      
    1185   00:8ACB  (00:8ACB)           evnt18:	equ $
    1186   00:8ACB  3E 05                      ld a,5
    1187   00:8ACD  32 35 40                   ld (charx),a
    1188   00:8AD0  3E 09                      ld a,9
    1189   00:8AD2  32 36 40                   ld (chary),a
    1190   00:8AD5  3E 03                      ld a,3
    1191   00:8AD7  87                         add a,a
    1192   00:8AD8  87                         add a,a
    1193   00:8AD9  87                         add a,a
    1194   00:8ADA  87                         add a,a
    1195   00:8ADB  5F                         ld e,a
    1196   00:8ADC  3A 39 40                   ld a,(clratt)
    1197   00:8ADF  E6 0F                      and $0F
    1198   00:8AE1  B3                         or e
    1199   00:8AE2  32 39 40                   ld (clratt),a
    1200   00:8AE5  AF                         xor a
    1201   00:8AE6  5F                         ld e,a
    1202   00:8AE7  3A 39 40                   ld a,(clratt)
    1203   00:8AEA  E6 F0                      and $F0
    1204   00:8AEC  B3                         or e
    1205   00:8AED  32 39 40                   ld (clratt),a
    1206   00:8AF0  3E 0B                      ld a,11
    1207   00:8AF2  CD 57 BC                   call dmsg
    1208   00:8AF5  3E 05                      ld a,5
    1209   00:8AF7  87                         add a,a
    1210   00:8AF8  87                         add a,a
    1211   00:8AF9  87                         add a,a
    1212   00:8AFA  87                         add a,a
    1213   00:8AFB  5F                         ld e,a
    1214   00:8AFC  3A 39 40                   ld a,(clratt)
    1215   00:8AFF  E6 0F                      and $0F
    1216   00:8B01  B3                         or e
    1217   00:8B02  32 39 40                   ld (clratt),a
    1218   00:8B05  AF                         xor a
    1219   00:8B06  5F                         ld e,a
    1220   00:8B07  3A 39 40                   ld a,(clratt)
    1221   00:8B0A  E6 F0                      and $F0
    1222   00:8B0C  B3                         or e
    1223   00:8B0D  32 39 40                   ld (clratt),a
    1224   00:8B10  3E 07                      ld a,7
    1225   00:8B12  32 35 40                   ld (charx),a
    1226   00:8B15  3E 04                      ld a,4
    1227   00:8B17  32 36 40                   ld (chary),a
    1228   00:8B1A  3E 0C                      ld a,12
    1229   00:8B1C  CD 57 BC                   call dmsg
    1230   00:8B1F  3E 09                      ld a,9
    1231   00:8B21  32 35 40                   ld (charx),a
    1232   00:8B24  3E 04                      ld a,4
    1233   00:8B26  32 36 40                   ld (chary),a
    1234   00:8B29  3E 0D                      ld a,13
    1235   00:8B2B  CD 57 BC                   call dmsg
    1236   00:8B2E  DD E5                      push ix
    1237   00:8B30  06 FA                      ld b,250
    1238   00:8B32  CD 31 B1                   call delay
    1239   00:8B35  DD E1                      pop ix
    1240   00:8B37  DD E5                      push ix
    1241   00:8B39  06 FA                      ld b,250
    1242   00:8B3B  CD 31 B1                   call delay
    1243   00:8B3E  DD E1                      pop ix
    1244   00:8B40  C9                         ret
    1245   00:8B41                      
    1246   00:8B41  (00:8B41)           evnt19:	equ $
    1247   00:8B41  C9                         ret
    1248   00:8B42                      
    1249   00:8B42  (00:8B42)           evnt20:	equ $
    1250   00:8B42  C9                         ret
    1251   00:8B43  C9                  ptcusr ret
    1252   00:8B44  (00:8B44)           msgdat:	equ $
    1253   00:8B44                             db "GAME OVE",210
    1253   00:8B44  47 41 4D 45 20 4F 56 45 D2 
    1254   00:8B4D                             db "-NEXT LEVEL",173
    1254   00:8B4D  2D 4E 45 58 54 20 4C 45 56 45 4C AD 
    1255   00:8B59                             db "B-SQUARE",196
    1255   00:8B59  42 2D 53 51 55 41 52 45 C4 
    1256   00:8B62  4C 45 56 45 4C BA          db "LEVEL",186
    1257   00:8B68  4C 49 56 45 53 BA          db "LIVES",186
    1258   00:8B6E                             db "A GAME OF FUN AND SQUARENES",211
    1258   00:8B6E  41 20 47 41 4D 45 20 4F 46 20 46 55 4E 20 41 4E 
    1258   00:8B7E  44 20 53 51 55 41 52 45 4E 45 53 D3 
    1259   00:8B8A                             db "SELECT CONTRO",204
    1259   00:8B8A  53 45 4C 45 43 54 20 43 4F 4E 54 52 4F CC 
    1260   00:8B98                             db "1 KEYBOARD ",160
    1260   00:8B98  31 20 4B 45 59 42 4F 41 52 44 20 A0 
    1261   00:8BA4                             db "2 JOYSTICK ",177
    1261   00:8BA4  32 20 4A 4F 59 53 54 49 43 4B 20 B1 
    1262   00:8BB0                             db "3 JOYSTICK ",178
    1262   00:8BB0  33 20 4A 4F 59 53 54 49 43 4B 20 B2 
    1263   00:8BBC                             db " PAUL JENKINSON 201",183
    1263   00:8BBC  7F 20 50 41 55 4C 20 4A 45 4E 4B 49 4E 53 4F 4E 
    1263   00:8BCC  20 32 30 31 B7 
    1264   00:8BD1                             db "CONGRATULATION",211
    1264   00:8BD1  43 4F 4E 47 52 41 54 55 4C 41 54 49 4F 4E D3 
    1265   00:8BE0                             db "YES, THIS IS ALL YOU GE",212
    1265   00:8BE0  59 45 53 2C 20 54 48 49 53 20 49 53 20 41 4C 4C 
    1265   00:8BF0  20 59 4F 55 20 47 45 D4 
    1266   00:8BF8                             db "FOR COMPLETING  THE GAM",197
    1266   00:8BF8  46 4F 52 20 43 4F 4D 50 4C 45 54 49 4E 47 20 20 
    1266   00:8C08  54 48 45 20 47 41 4D C5 
    1267   00:8C10  0E                  nummsg db 14
    1268   00:8C11  (00:8C11)           scdat:	equ $
    1269   00:8C11                             defw 118,135,142,141,132,116,120,142,125,142,119,142,144,95,137,112,160,136,154,136,140,136,123,107,119,109
    1269   00:8C11  76 00 87 00 8E 00 8D 00 84 00 74 00 78 00 8E 00 
    1269   00:8C21  7D 00 8E 00 77 00 8E 00 90 00 5F 00 89 00 70 00 
    1269   00:8C31  A0 00 88 00 9A 00 88 00 8C 00 88 00 7B 00 6B 00 
    1269   00:8C41  77 00 6D 00 
    1270   00:8C45                             defw 108,114,135,152,120,60
    1270   00:8C45  6C 00 72 00 87 00 98 00 78 00 3C 00 
    1271   00:8C51                             db 62,1,225,0,10,4,44,0,5,0,5,119,10,5,124,11,5,10,4,9,4,2,2,3,0,2,142,0,9,5,5,190
    1271   00:8C51  3E 01 E1 00 0A 04 2C 00 05 00 05 77 0A 05 7C 0B 
    1271   00:8C61  05 0A 04 09 04 02 02 03 00 02 8E 00 09 05 05 BE 
    1272   00:8C71                             db 11,5,191,16,71,27,5,217,12,37,111,24,105,30,27,248,130,55,5,176,27,124,6,5,62,6,7,142,53,187,27,111
    1272   00:8C71  0B 05 BF 10 47 1B 05 D9 0C 25 6F 18 69 1E 1B F8 
    1272   00:8C81  82 37 05 B0 1B 7C 06 05 3E 06 07 8E 35 BB 1B 6F 
    1273   00:8C91                             db 118,86,253,111,27,67,139,13,198,111,12,132,139,5,139,24,4,7,139,90,27,206,154,225,223,252,254,127,177,167,253,155
    1273   00:8C91  76 56 FD 6F 1B 43 8B 0D C6 6F 0C 84 8B 05 8B 18 
    1273   00:8CA1  04 07 8B 5A 1B CE 9A E1 DF FC FE 7F B1 A7 FD 9B 
    1274   00:8CB1                             db 105,33,240,139,7,231,151,114,166,239,58,248,139,247,61,27,239,147,255,255,255,255,62,1,225,0,10,4,44,0,5,0
    1274   00:8CB1  69 21 F0 8B 07 E7 97 72 A6 EF 3A F8 8B F7 3D 1B 
    1274   00:8CC1  EF 93 FF FF FF FF 3E 01 E1 00 0A 04 2C 00 05 00 
    1275   00:8CD1                             db 5,119,10,5,124,11,5,10,4,9,4,2,2,3,0,2,142,0,9,5,5,190,11,5,191,16,71,27,5,217,12,37
    1275   00:8CD1  05 77 0A 05 7C 0B 05 0A 04 09 04 02 02 03 00 02 
    1275   00:8CE1  8E 00 09 05 05 BE 0B 05 BF 10 47 1B 05 D9 0C 25 
    1276   00:8CF1                             db 111,24,95,30,27,153,127,70,246,10,7,55,6,5,7,7,24,124,10,8,0,10,206,27,136,43,17,22,120,111,8,11
    1276   00:8CF1  6F 18 5F 1E 1B 99 7F 46 F6 0A 07 37 06 05 07 07 
    1276   00:8D01  18 7C 0A 08 00 0A CE 1B 88 2B 11 16 78 6F 08 0B 
    1277   00:8D11                             db 158,0,9,158,111,253,27,186,58,145,95,48,27,44,136,6,145,23,10,5,143,148,157,27,68,186,31,254,107,111,199,254
    1277   00:8D11  9E 00 09 9E 6F FD 1B BA 3A 91 5F 30 1B 2C 88 06 
    1277   00:8D21  91 17 0A 05 8F 94 9D 1B 44 BA 1F FE 6B 6F C7 FE 
    1278   00:8D31                             db 237,27,215,122,9,143,141,231,27,119,121,18,15,133,6,203,111,14,123,15,117,61,27,239,147,255,255,255,255,62,1,225
    1278   00:8D31  ED 1B D7 7A 09 8F 8D E7 1B 77 79 12 0F 85 06 CB 
    1278   00:8D41  6F 0E 7B 0F 75 3D 1B EF 93 FF FF FF FF 3E 01 E1 
    1279   00:8D51                             db 0,10,4,41,0,5,0,4,10,222,5,76,11,12,11,0,2,10,9,4,2,2,3,0,142,4,9,5,5,218,11,12
    1279   00:8D51  00 0A 04 29 00 05 00 04 0A DE 05 4C 0B 0C 0B 00 
    1279   00:8D61  02 0A 09 04 02 02 03 00 8E 04 09 05 05 DA 0B 0C 
    1280   00:8D71                             db 231,27,9,233,27,246,18,167,36,121,5,27,169,121,158,27,198,138,30,55,6,6,19,130,27,10,96,142,6,5,19,7
    1280   00:8D71  E7 1B 09 E9 1B F6 12 A7 24 79 05 1B A9 79 9E 1B 
    1280   00:8D81  C6 8A 1E 37 06 06 13 82 1B 0A 60 8E 06 05 13 07 
    1281   00:8D91                             db 7,4,4,9,217,74,4,173,11,126,116,182,27,209,119,173,183,7,225,139,149,127,122,27,60,160,127,6,230,11,6,206
    1281   00:8D91  07 04 04 09 D9 4A 04 AD 0B 7E 74 B6 1B D1 77 AD 
    1281   00:8DA1  B7 07 E1 8B 95 7F 7A 1B 3C A0 7F 06 E6 0B 06 CE 
    1282   00:8DB1                             db 160,248,223,109,17,187,62,151,123,111,219,27,22,137,9,252,139,112,186,6,70,7,134,206,151,30,145,59,151,214,74,12
    1282   00:8DB1  A0 F8 DF 6D 11 BB 3E 97 7B 6F DB 1B 16 89 09 FC 
    1282   00:8DC1  8B 70 BA 06 46 07 86 CE 97 1E 91 3B 97 D6 4A 0C 
    1283   00:8DD1                             db 247,86,233,27,239,127,147,255,255,255,248,62,1,225,0,10,4,45,0,5,0,120,5,10,9,9,4,2,2,3,0,2
    1283   00:8DD1  F7 56 E9 1B EF 7F 93 FF FF FF F8 3E 01 E1 00 0A 
    1283   00:8DE1  04 2D 00 05 00 78 05 0A 09 09 04 02 02 03 00 02 
    1284   00:8DF1                             db 174,63,5,9,70,27,5,237,24,150,5,27,219,118,219,21,88,17,51,55,6,12,6,4,7,4,12,220,49,226,160,27
    1284   00:8DF1  AE 3F 05 09 46 1B 05 ED 18 96 05 1B DB 76 DB 15 
    1284   00:8E01  58 11 33 37 06 0C 06 04 07 04 0C DC 31 E2 A0 1B 
    1285   00:8E11                             db 251,111,111,30,175,123,104,193,139,10,125,65,92,253,27,223,16,125,61,27,172,134,185,4,36,7,125,31,92,115,27,130
    1285   00:8E11  FB 6F 6F 1E AF 7B 68 C1 8B 0A 7D 41 5C FD 1B DF 
    1285   00:8E21  10 7D 3D 1B AC 86 B9 04 24 07 7D 1F 5C 73 1B 82 
    1286   00:8E31                             db 40,16,6,80,128,241,64,5,125,12,27,241,189,127,93,30,223,158,111,163,179,253,27,232,139,63,5,31,154,156,151,145
    1286   00:8E31  28 10 06 50 80 F1 40 05 7D 0C 1B F1 BD 7F 5D 1E 
    1286   00:8E41  DF 9E 6F A3 B3 FD 1B E8 8B 3F 05 1F 9A 9C 97 91 
    1287   00:8E51                             db 27,7,134,111,10,8,111,0,136,235,9,8,11,191,0,79,27,123,147,255,255,255,255,192,62,1,225,0,10,4,45,0
    1287   00:8E51  1B 07 86 6F 0A 08 6F 00 88 EB 09 08 0B BF 00 4F 
    1287   00:8E61  1B 7B 93 FF FF FF FF C0 3E 01 E1 00 0A 04 2D 00 
    1288   00:8E71                             db 5,0,120,5,10,9,9,4,2,2,3,0,2,174,63,5,9,70,27,5,237,24,150,5,27,205,118,5,209,27,8,205
    1288   00:8E71  05 00 78 05 0A 09 09 04 02 02 03 00 02 AE 3F 05 
    1288   00:8E81  09 46 1B 05 ED 18 96 05 1B CD 76 05 D1 1B 08 CD 
    1289   00:8E91                             db 0,10,241,27,11,155,0,166,117,190,37,27,13,0,14,0,183,5,154,27,139,133,12,115,0,76,70,195,0,6,6,4
    1289   00:8E91  00 0A F1 1B 0B 9B 00 A6 75 BE 25 1B 0D 00 0E 00 
    1289   00:8EA1  B7 05 9A 1B 8B 85 0C 73 00 4C 46 C3 00 06 06 04 
    1290   00:8EB1                             db 7,4,6,181,6,21,148,10,12,246,27,168,161,91,18,107,11,203,151,9,205,11,84,27,213,172,157,104,180,4,111,67
    1290   00:8EB1  07 04 06 B5 06 15 94 0A 0C F6 1B A8 A1 5B 12 6B 
    1290   00:8EC1  0B CB 97 09 CD 0B 54 1B D5 AC 9D 68 B4 04 6F 43 
    1291   00:8ED1                             db 10,140,5,52,127,5,87,7,5,4,22,139,4,150,27,59,248,235,251,158,27,247,147,255,255,255,255,128,62,1,225,0
    1291   00:8ED1  0A 8C 05 34 7F 05 57 07 05 04 16 8B 04 96 1B 3B 
    1291   00:8EE1  F8 EB FB 9E 1B F7 93 FF FF FF FF 80 3E 01 E1 00 
    1292   00:8EF1                             db 10,4,45,0,5,0,120,5,10,9,9,4,2,2,3,0,2,174,61,5,9,100,27,15,27,5,221,178,52,5,27,242
    1292   00:8EF1  0A 04 2D 00 05 00 78 05 0A 09 09 04 02 02 03 00 
    1292   00:8F01  02 AE 3D 05 09 64 1B 0F 1B 05 DD B2 34 05 1B F2 
    1293   00:8F11                             db 119,34,211,4,190,21,138,48,55,6,5,11,7,7,4,6,22,141,130,56,27,136,239,17,113,111,2,250,221,27,117,118
    1293   00:8F11  77 22 D3 04 BE 15 8A 30 37 06 05 0B 07 07 04 06 
    1293   00:8F21  16 8D 82 38 1B 88 EF 11 71 6F 02 FA DD 1B 75 76 
    1294   00:8F31                             db 31,12,236,139,109,27,241,139,220,17,154,254,199,223,239,27,139,31,142,213,162,111,245,148,106,40,70,160,10,8,155,0
    1294   00:8F31  1F 0C EC 8B 6D 1B F1 8B DC 11 9A FE C7 DF EF 1B 
    1294   00:8F41  8B 1F 8E D5 A2 6F F5 94 6A 28 46 A0 0A 08 9B 00 
    1295   00:8F51                             db 160,139,9,59,8,11,0,244,27,247,191,147,255,255,255,252,62,1,225,0,10,17,41,0,0,0,4,10,222,5,120,11
    1295   00:8F51  A0 8B 09 3B 08 0B 00 F4 1B F7 BF 93 FF FF FF FC 
    1295   00:8F61  3E 01 E1 00 0A 11 29 00 00 00 04 0A DE 05 78 0B 
    1296   00:8F71                             db 17,9,25,17,16,16,9,59,4,9,5,207,11,63,17,79,27,158,12,9,221,24,17,158,27,125,121,64,169,11,161,55
    1296   00:8F71  11 09 19 11 10 10 09 3B 04 09 05 CF 0B 3F 11 4F 
    1296   00:8F81  1B 9E 0C 09 DD 18 11 9E 1B 7D 79 40 A9 0B A1 37 
    1297   00:8F91                             db 19,19,143,124,10,177,27,11,18,231,27,186,15,139,3,218,55,120,243,127,110,0,11,240,158,175,27,120,163,127,146,232
    1297   00:8F91  13 13 8F 7C 0A B1 1B 0B 12 E7 1B BA 0F 8B 03 DA 
    1297   00:8FA1  37 78 F3 7F 6E 00 0B F0 9E AF 1B 78 A3 7F 92 E8 
    1298   00:8FB1                             db 11,157,175,0,10,141,223,123,5,237,111,123,30,246,27,245,174,162,139,40,121,134,214,5,158,6,18,95,166,177,139,238
    1298   00:8FB1  0B 9D AF 00 0A 8D DF 7B 05 ED 6F 7B 1E F6 1B F5 
    1298   00:8FC1  AE A2 8B 28 79 86 D6 05 9E 06 12 5F A6 B1 8B EE 
    1299   00:8FD1                             db 123,27,223,147,255,255,255,254,62,1,225,0,10,17,45,0,0,0,155,5,10,144,11,4,10,9,17,50,16,16,9,4
    1299   00:8FD1  7B 1B DF 93 FF FF FF FE 3E 01 E1 00 0A 11 2D 00 
    1299   00:8FE1  00 00 9B 05 0A 90 0B 04 0A 09 11 32 10 10 09 04 
    1300   00:8FF1                             db 235,5,12,90,11,4,126,9,155,27,150,12,13,229,11,41,237,27,177,130,109,10,7,236,27,18,240,136,11,18,17,19
    1300   00:8FF1  EB 05 0C 5A 0B 04 7E 09 9B 1B 96 0C 0D E5 0B 29 
    1300   00:9001  ED 1B B1 82 6D 0A 07 EC 1B 12 F0 88 0B 12 11 13 
    1301   00:9011                             db 17,11,219,111,219,5,85,18,27,20,0,21,0,199,5,16,165,11,27,143,116,12,183,0,188,11,167,52,127,52,10,8
    1301   00:9011  11 0B DB 6F DB 05 55 12 1B 14 00 15 00 C7 05 10 
    1301   00:9021  A5 0B 1B 8F 74 0C B7 00 BC 0B A7 34 7F 34 0A 08 
    1302   00:9031                             db 0,220,154,117,129,167,9,8,11,205,0,9,109,114,99,139,239,27,227,167,126,27,254,152,175,21,180,5,111,74,19,134
    1302   00:9031  00 DC 9A 75 81 A7 09 08 0B CD 00 09 6D 72 63 8B 
    1302   00:9041  EF 1B E3 A7 7E 1B FE 98 AF 15 B4 05 6F 4A 13 86 
    1303   00:9051                             db 18,139,122,5,6,180,5,157,118,111,223,15,248,251,27,222,147,255,255,255,255,240,62,1,225,0,10,17,45,0,0,0
    1303   00:9051  12 8B 7A 05 06 B4 05 9D 76 6F DF 0F F8 FB 1B DE 
    1303   00:9061  93 FF FF FF FF F0 3E 01 E1 00 0A 11 2D 00 00 00 
    1304   00:9071                             db 120,5,10,9,24,17,16,16,9,16,215,31,5,9,166,27,249,24,151,5,27,230,127,165,70,10,129,55,18,18,17,19
    1304   00:9071  78 05 0A 09 18 11 10 10 09 10 D7 1F 05 09 A6 1B 
    1304   00:9081  F9 18 97 05 1B E6 7F A5 46 0A 81 37 12 12 11 13 
    1305   00:9091                             db 56,119,8,148,155,11,0,103,27,36,110,55,95,12,80,91,11,36,134,139,125,58,27,247,11,225,167,237,114,122,111,110
    1305   00:9091  38 77 08 94 9B 0B 00 67 1B 24 6E 37 5F 0C 50 5B 
    1305   00:90A1  0B 24 86 8B 7D 3A 1B F7 0B E1 A7 ED 72 7A 6F 6E 
    1306   00:90B1                             db 74,113,64,139,253,74,173,70,251,30,223,252,179,236,155,119,21,177,148,195,139,8,79,0,205,30,49,76,27,11,207,0
    1306   00:90B1  4A 71 40 8B FD 4A AD 46 FB 1E DF FC B3 EC 9B 77 
    1306   00:90C1  15 B1 94 C3 8B 08 4F 00 CD 1E 31 4C 1B 0B CF 00 
    1307   00:90D1                             db 10,101,154,16,188,27,9,210,210,246,61,189,110,207,0,255,255,255,252,30,1,225,0,10,17,41,0,0,0,4,10,222
    1307   00:90D1  0A 65 9A 10 BC 1B 09 D2 D2 F6 3D BD 6E CF 00 FF 
    1307   00:90E1  FF FF FC 1E 01 E1 00 0A 11 29 00 00 00 04 0A DE 
    1308   00:90F1                             db 5,120,11,17,9,25,17,16,16,9,59,4,9,5,207,11,63,17,79,27,158,12,9,220,24,17,9,91,1,4,94,121
    1308   00:90F1  05 78 0B 11 09 19 11 10 10 09 3B 04 09 05 CF 0B 
    1308   00:9101  3F 11 4F 1B 9E 0C 09 DC 18 11 09 5B 01 04 5E 79 
    1309   00:9111                             db 14,125,130,16,125,55,124,195,43,18,0,18,161,11,5,19,17,19,107,11,106,111,218,5,188,27,21,150,0,20,0,122
    1309   00:9111  0E 7D 82 10 7D 37 7C C3 2B 12 00 12 A1 0B 05 13 
    1309   00:9121  11 13 6B 0B 6A 6F DA 05 BC 1B 15 96 00 14 00 7A 
    1310   00:9131                             db 5,108,27,122,22,251,0,187,139,17,236,139,121,176,126,5,10,18,182,0,151,179,16,5,237,223,123,254,237,111,123,254
    1310   00:9131  05 6C 1B 7A 16 FB 00 BB 8B 11 EC 8B 79 B0 7E 05 
    1310   00:9141  0A 12 B6 00 97 B3 10 05 ED DF 7B FE ED 6F 7B FE 
    1311   00:9151                             db 246,27,125,1,15,151,125,39,125,5,142,184,111,17,190,145,133,182,5,111,223,63,248,231,27,1,185,0,255,255,255,255
    1311   00:9151  F6 1B 7D 01 0F 97 7D 27 7D 05 8E B8 6F 11 BE 91 
    1311   00:9161  85 B6 05 6F DF 3F F8 E7 1B 01 B9 00 FF FF FF FF 
    1312   00:9171                             db 128,62,1,225,0,10,17,45,0,0,0,120,5,10,9,24,17,16,16,9,16,215,31,5,9,166,27,249,24,154,5,166
    1312   00:9171  80 3E 01 E1 00 0A 11 2D 00 00 00 78 05 0A 09 18 
    1312   00:9181  11 10 10 09 10 D7 1F 05 09 A6 1B F9 18 9A 05 A6 
    1313   00:9191                             db 27,225,138,168,27,20,36,20,21,0,20,0,19,13,17,19,0,18,141,142,71,111,22,154,0,241,139,37,47,18,46,19
    1313   00:9191  1B E1 8A A8 1B 14 24 14 15 00 14 00 13 0D 11 13 
    1313   00:91A1  00 12 8D 8E 47 6F 16 9A 00 F1 8B 25 2F 12 2E 13 
    1314   00:91B1                             db 5,239,198,167,161,137,218,111,163,46,10,231,154,92,27,212,17,215,53,111,63,17,239,27,190,124,136,51,27,89,151,196
    1314   00:91B1  05 EF C6 A7 A1 89 DA 6F A3 2E 0A E7 9A 5C 1B D4 
    1314   00:91C1  11 D7 35 6F 3F 11 EF 1B BE 7C 88 33 1B 59 97 C4 
    1315   00:91D1                             db 121,10,221,109,58,151,179,240,139,9,250,86,71,251,92,246,27,247,191,147,255,255,255,252,30,1,225,0,10,5,43,0
    1315   00:91D1  79 0A DD 6D 3A 97 B3 F0 8B 09 FA 56 47 FB 5C F6 
    1315   00:91E1  1B F7 BF 93 FF FF FF FC 1E 01 E1 00 0A 05 2B 00 
    1316   00:91F1                             db 0,0,6,158,5,5,128,5,10,9,5,3,3,203,9,6,173,5,10,231,5,9,233,27,179,12,9,251,24,59,5,27
    1316   00:91F1  00 00 06 9E 05 05 80 05 0A 09 05 03 03 CB 09 06 
    1316   00:9201  AD 05 0A E7 05 09 E9 1B B3 0C 09 FB 18 3B 05 1B 
    1317   00:9211                             db 239,122,182,58,12,219,27,131,136,18,0,18,5,239,86,187,142,111,116,80,237,111,124,27,18,20,20,13,0,20,0,244
    1317   00:9211  EF 7A B6 3A 0C DB 1B 83 88 12 00 12 05 EF 56 BB 
    1317   00:9221  8E 6F 74 50 ED 6F 7C 1B 12 14 14 0D 00 14 00 F4 
    1318   00:9231                             db 167,241,139,22,231,0,218,17,50,27,6,121,140,133,5,6,18,18,133,107,5,127,139,111,102,63,223,5,187,24,80,205
    1318   00:9231  A7 F1 8B 16 E7 00 DA 11 32 1B 06 79 8C 85 05 06 
    1318   00:9241  12 12 85 6B 05 7F 8B 6F 66 3F DF 05 BB 18 50 CD 
    1319   00:9251                             db 111,90,27,85,121,6,27,183,135,231,33,137,139,24,0,10,127,121,108,58,139,24,45,23,23,87,243,139,220,27,123,1
    1319   00:9251  6F 5A 1B 55 79 06 1B B7 87 E7 21 89 8B 18 00 0A 
    1319   00:9261  7F 79 6C 3A 8B 18 2D 17 17 57 F3 8B DC 1B 7B 01 
    1320   00:9271                             db 159,0,255,255,255,248,62,1,225,0,10,5,44,0,0,0,5,119,10,5,124,11,5,10,12,9,5,3,3,9,78,3
    1320   00:9271  9F 00 FF FF FF F8 3E 01 E1 00 0A 05 2C 00 00 00 
    1320   00:9281  05 77 0A 05 7C 0B 05 0A 0C 09 05 03 03 09 4E 03 
    1321   00:9291                             db 0,9,5,239,11,159,5,9,166,27,163,12,9,211,24,45,5,27,173,118,9,88,138,142,27,23,24,1,137,27,23,10
    1321   00:9291  00 09 05 EF 0B 9F 05 09 A6 1B A3 0C 09 D3 18 2D 
    1321   00:92A1  05 1B AD 76 09 58 8A 8E 1B 17 18 01 89 1B 17 0A 
    1322   00:92B1                             db 5,25,97,0,136,138,5,26,0,4,179,27,9,34,28,67,24,9,26,215,12,139,30,151,4,26,37,187,26,167,225,139
    1322   00:92B1  05 19 61 00 88 8A 05 1A 00 04 B3 1B 09 22 1C 43 
    1322   00:92C1  18 09 1A D7 0C 8B 1E 97 04 1A 25 BB 1A A7 E1 8B 
    1323   00:92D1                             db 169,27,15,132,26,140,133,5,199,154,237,27,123,5,237,111,123,30,246,27,214,123,190,15,4,246,151,122,160,243,46,82
    1323   00:92D1  A9 1B 0F 84 1A 8C 85 05 C7 9A ED 1B 7B 05 ED 6F 
    1323   00:92E1  7B 1E F6 1B D6 7B BE 0F 04 F6 97 7A A0 F3 2E 52 
    1324   00:92F1                             db 166,186,27,26,1,107,9,159,86,126,55,52,27,9,27,247,191,147,255,255,255,252,62,1,225,0,10,5,45,0,0,0
    1324   00:92F1  A6 BA 1B 1A 01 6B 09 9F 56 7E 37 34 1B 09 1B F7 
    1324   00:9301  BF 93 FF FF FF FC 3E 01 E1 00 0A 05 2D 00 00 00 
    1325   00:9311                             db 120,5,10,9,24,5,3,3,9,3,215,31,5,9,166,27,249,24,154,5,159,27,107,127,192,27,18,0,6,5,6,254
    1325   00:9311  78 05 0A 09 18 05 03 03 09 03 D7 1F 05 09 A6 1B 
    1325   00:9321  F9 18 9A 05 9F 1B 6B 7F C0 1B 12 00 06 05 06 FE 
    1326   00:9331                             db 55,252,111,219,61,212,139,7,10,24,23,168,27,9,52,23,24,60,189,27,103,150,65,139,26,45,0,25,0,83,5,246
    1326   00:9331  37 FC 6F DB 3D D4 8B 07 0A 18 17 A8 1B 09 34 17 
    1326   00:9341  18 3C BD 1B 67 96 41 8B 1A 2D 00 19 00 53 05 F6 
    1327   00:9351                             db 223,61,249,179,216,205,212,128,55,249,207,223,239,27,123,147,255,255,255,255,192,62,1,225,0,10,5,47,0,0,0,27
    1327   00:9351  DF 3D F9 B3 D8 CD D4 80 37 F9 CF DF EF 1B 7B 93 
    1327   00:9361  FF FF FF FF C0 3E 01 E1 00 0A 05 2F 00 00 00 1B 
    1328   00:9371                             db 5,10,144,11,12,9,5,3,99,3,9,3,102,5,9,229,11,12,250,110,27,77,12,5,9,197,11,0,27,207,116,5
    1328   00:9371  05 0A 90 0B 0C 09 05 03 63 03 09 03 66 05 09 E5 
    1328   00:9381  0B 0C FA 6E 1B 4D 0C 05 09 C5 0B 00 1B CF 74 05 
    1329   00:9391                             db 183,15,14,136,27,79,24,0,10,188,27,136,4,25,25,26,136,104,27,23,55,23,9,190,86,80,191,111,91,27,80,139
    1329   00:9391  B7 0F 0E 88 1B 4F 18 00 0A BC 1B 88 04 19 19 1A 
    1329   00:93A1  88 68 1B 17 37 17 09 BE 56 50 BF 6F 5B 1B 50 8B 
    1330   00:93B1                             db 211,127,80,141,116,9,111,121,0,119,26,27,203,142,26,109,5,181,27,204,80,5,211,27,157,151,251,111,222,27,222,148
    1330   00:93B1  D3 7F 50 8D 74 09 6F 79 00 77 1A 1B CB 8E 1A 6D 
    1330   00:93C1  05 B5 1B CC 50 05 D3 1B 9D 97 FB 6F DE 1B DE 94 
    1331   00:93D1                             db 182,39,211,10,99,195,147,0,10,138,225,139,242,157,9,241,151,181,0,99,145,254,27,247,191,147,255,255,255,252,62,1
    1331   00:93D1  B6 27 D3 0A 63 C3 93 00 0A 8A E1 8B F2 9D 09 F1 
    1331   00:93E1  97 B5 00 63 91 FE 1B F7 BF 93 FF FF FF FC 3E 01 
    1332   00:93F1                             db 225,0,10,5,47,0,0,0,102,5,10,193,5,9,5,3,3,143,9,3,70,5,9,223,5,167,27,247,24,54,5,9
    1332   00:93F1  E1 00 0A 05 2F 00 00 00 66 05 0A C1 05 09 05 03 
    1332   00:9401  03 8F 09 03 46 05 09 DF 05 A7 1B F7 18 36 05 09 
    1333   00:9411                             db 5,110,9,131,133,5,99,27,25,25,9,118,26,0,5,26,181,5,0,158,61,107,27,222,111,126,117,166,27,217,124,12
    1333   00:9411  05 6E 09 83 85 05 63 1B 19 19 09 76 1A 00 05 1A 
    1333   00:9421  B5 05 00 9E 3D 6B 1B DE 6F 7E 75 A6 1B D9 7C 0C 
    1334   00:9431                             db 249,5,113,0,195,199,133,227,154,132,145,163,91,27,231,80,250,30,167,181,162,124,111,145,149,25,5,6,10,153,5,11
    1334   00:9431  F9 05 71 00 C3 C7 85 E3 9A 84 91 A3 5B 1B E7 50 
    1334   00:9441  FA 1E A7 B5 A2 7C 6F 91 95 19 05 06 0A 99 05 0B 
    1335   00:9451                             db 177,145,251,30,139,231,27,189,147,255,255,255,255,224,62,1,225,0,10,5,41,0,17,0,4,10,222,5,120,11,17,9
    1335   00:9451  B1 91 FB 1E 8B E7 1B BD 93 FF FF FF FF E0 3E 01 
    1335   00:9461  E1 00 0A 05 29 00 11 00 04 0A DE 05 78 0B 11 09 
    1336   00:9471                             db 10,5,3,3,16,0,4,59,9,17,5,111,11,63,17,79,27,190,18,36,214,5,179,27,115,77,21,99,130,106,45,7
    1336   00:9471  0A 05 03 03 10 00 04 3B 09 11 05 6F 0B 3F 11 4F 
    1336   00:9481  1B BE 12 24 D6 05 B3 1B 73 4D 15 63 82 6A 2D 07 
    1337   00:9491                             db 55,238,118,27,41,17,26,0,10,19,198,136,134,27,19,17,182,111,173,5,255,18,27,13,21,0,13,0,215,38,27,115
    1337   00:9491  37 EE 76 1B 29 11 1A 00 0A 13 C6 88 86 1B 13 11 
    1337   00:94A1  B6 6F AD 05 FF 12 1B 0D 15 00 0D 00 D7 26 1B 73 
    1338   00:94B1                             db 12,220,0,133,110,31,145,19,139,0,19,192,133,9,26,48,5,26,17,6,6,199,154,88,223,213,143,229,227,139,123,42
    1338   00:94B1  0C DC 00 85 6E 1F 91 13 8B 00 13 C0 85 09 1A 30 
    1338   00:94C1  05 1A 11 06 06 C7 9A 58 DF D5 8F E5 E3 8B 7B 2A 
    1339   00:94D1                             db 246,27,204,116,9,254,148,118,139,6,24,24,10,121,58,154,27,19,19,105,70,166,99,27,23,126,254,53,73,27,132,217
    1339   00:94D1  F6 1B CC 74 09 FE 94 76 8B 06 18 18 0A 79 3A 9A 
    1339   00:94E1  1B 13 13 69 46 A6 63 1B 17 7E FE 35 49 1B 84 D9 
    1340   00:94F1                             db 138,239,27,237,135,12,231,0,127,11,255,255,255,224,62,1,225,0,10,5,47,0,17,0,67,5,10,8,64,0,10,9
    1340   00:94F1  8A EF 1B ED 87 0C E7 00 7F 0B FF FF FF E0 3E 01 
    1340   00:9501  E1 00 0A 05 2F 00 11 00 43 05 0A 08 40 00 0A 09 
    1341   00:9511                             db 5,3,38,3,16,0,3,240,5,9,8,11,231,0,9,232,27,17,252,24,205,5,77,27,76,121,64,246,138,45,55,98
    1341   00:9511  05 03 26 03 10 00 03 F0 05 09 08 0B E7 00 09 E8 
    1341   00:9521  1B 11 FC 18 CD 05 4D 1B 4C 79 40 F6 8A 2D 37 62 
    1342   00:9531                             db 130,27,214,11,141,4,19,19,211,111,207,5,214,27,195,167,115,127,120,151,211,27,102,127,10,142,139,225,151,184,223,104
    1342   00:9531  82 1B D6 0B 8D 04 13 13 D3 6F CF 05 D6 1B C3 A7 
    1342   00:9541  73 7F 78 97 D3 1B 66 7F 0A 8E 8B E1 97 B8 DF 68 
    1343   00:9551                             db 213,55,9,55,86,42,111,27,28,27,221,142,139,55,252,27,252,148,115,21,89,151,216,128,196,117,6,0,19,139,144,52
    1343   00:9551  D5 37 09 37 56 2A 6F 1B 1C 1B DD 8E 8B 37 FC 1B 
    1343   00:9561  FC 94 73 15 59 97 D8 80 C4 75 06 00 13 8B 90 34 
    1344   00:9571                             db 149,157,6,17,199,139,95,100,53,123,127,30,139,231,27,189,147,255,255,255,255,224,30,1,225,0,10,5,47,0,17,0
    1344   00:9571  95 9D 06 11 C7 8B 5F 64 35 7B 7F 1E 8B E7 1B BD 
    1344   00:9581  93 FF FF FF FF E0 1E 01 E1 00 0A 05 2F 00 11 00 
    1345   00:9591                             db 151,5,10,4,208,17,11,9,5,3,39,3,16,0,3,129,5,9,17,16,9,169,11,250,95,27,12,117,24,5,42,125
    1345   00:9591  97 05 0A 04 D0 11 0B 09 05 03 27 03 10 00 03 81 
    1345   00:95A1  05 09 11 10 09 A9 0B FA 5F 1B 0C 75 18 05 2A 7D 
    1346   00:95B1                             db 18,11,91,27,114,203,27,27,4,82,138,55,175,117,5,70,86,6,59,136,6,142,46,111,6,29,244,30,220,139,118,17
    1346   00:95B1  12 0B 5B 1B 72 CB 1B 1B 04 52 8A 37 AF 75 05 46 
    1346   00:95C1  56 06 3B 88 06 8E 2E 6F 06 1D F4 1E DC 8B 76 11 
    1347   00:95D1                             db 59,249,27,151,9,212,106,97,218,27,105,120,254,185,151,180,139,9,5,102,6,127,55,15,5,51,151,11,243,223,45,161
    1347   00:95D1  3B F9 1B 97 09 D4 6A 61 DA 1B 69 78 FE B9 97 B4 
    1347   00:95E1  8B 09 05 66 06 7F 37 0F 05 33 97 0B F3 DF 2D A1 
    1348   00:95F1                             db 59,103,223,5,230,161,182,151,173,27,217,98,126,165,27,116,215,0,33,119,125,147,141,108,16,52,139,161,235,145,5,190
    1348   00:95F1  3B 67 DF 05 E6 A1 B6 97 AD 1B D9 62 7E A5 1B 74 
    1348   00:9601  D7 00 21 77 7D 93 8D 6C 10 34 8B A1 EB 91 05 BE 
    1349   00:9611                             db 11,64,254,139,246,5,253,30,27,1,231,0,255,255,255,254,62,1,225,0,10,5,43,0,17,0,6,158,5,5,128,5
    1349   00:9611  0B 40 FE 8B F6 05 FD 1E 1B 01 E7 00 FF FF FF FE 
    1349   00:9621  3E 01 E1 00 0A 05 2B 00 11 00 06 9E 05 05 80 05 
    1350   00:9631                             db 10,9,5,3,3,87,16,0,6,91,5,10,207,5,9,209,27,17,166,12,95,6,24,150,30,27,103,115,58,155,125,121
    1350   00:9631  0A 09 05 03 03 57 10 00 06 5B 05 0A CF 05 09 D1 
    1350   00:9641  1B 11 A6 0C 5F 06 18 96 1E 1B 67 73 3A 9B 7D 79 
    1351   00:9651                             db 33,12,20,27,8,10,118,15,17,28,19,19,6,130,105,27,128,136,6,6,19,101,17,27,106,253,105,247,111,238,51,27
    1351   00:9651  21 0C 14 1B 08 0A 76 0F 11 1C 13 13 06 82 69 1B 
    1351   00:9661  80 88 06 06 13 65 11 1B 6A FD 69 F7 6F EE 33 1B 
    1352   00:9671                             db 17,12,94,150,126,27,199,136,8,139,144,171,5,6,4,99,151,237,27,123,86,245,141,139,182,119,213,115,8,103,194,195
    1352   00:9671  11 0C 5E 96 7E 1B C7 88 08 8B 90 AB 05 06 04 63 
    1352   00:9681  97 ED 1B 7B 56 F5 8D 8B B6 77 D5 73 08 67 C2 C3 
    1353   00:9691                             db 139,203,148,78,18,11,209,36,5,199,151,206,235,189,86,250,123,27,223,147,255,255,255,254,30,1,225,0,10,5,45,0
    1353   00:9691  8B CB 94 4E 12 0B D1 24 05 C7 97 CE EB BD 56 FA 
    1353   00:96A1  7B 1B DF 93 FF FF FF FE 1E 01 E1 00 0A 05 2D 00 
    1354   00:96B1                             db 17,0,120,5,10,9,9,5,3,3,16,0,3,174,63,5,9,70,27,17,237,24,150,5,27,102,115,58,217,124,39,243
    1354   00:96B1  11 00 78 05 0A 09 09 05 03 03 10 00 03 AE 3F 05 
    1354   00:96C1  09 46 1B 11 ED 18 96 05 1B 66 73 3A D9 7C 27 F3 
    1355   00:96D1                             db 135,5,138,27,24,24,142,27,209,124,26,155,27,27,136,26,10,53,27,23,234,86,19,111,255,79,27,43,139,6,24,190
    1355   00:96D1  87 05 8A 1B 18 18 8E 1B D1 7C 1A 9B 1B 1B 88 1A 
    1355   00:96E1  0A 35 1B 17 EA 56 13 6F FF 4F 1B 2B 8B 06 18 BE 
    1356   00:96F1                             db 139,144,251,27,29,127,10,27,209,139,4,10,24,223,0,101,27,21,6,173,217,102,20,0,230,111,125,6,111,186,221,27
    1356   00:96F1  8B 90 FB 1B 1D 7F 0A 1B D1 8B 04 0A 18 DF 00 65 
    1356   00:9701  1B 15 06 AD D9 66 14 00 E6 6F 7D 06 6F BA DD 1B 
    1357   00:9711                             db 123,221,27,148,223,4,157,139,117,224,139,19,5,6,27,6,19,17,143,139,3,237,5,203,27,195,249,27,1,238,127,0
    1357   00:9711  7B DD 1B 94 DF 04 9D 8B 75 E0 8B 13 05 06 1B 06 
    1357   00:9721  13 11 8F 8B 03 ED 05 CB 1B C3 F9 1B 01 EE 7F 00 
    1358   00:9731                             db 255,255,255,224,62,1,225,0,10,29,45,0,0,0,120,5,10,9,24,29,28,28,9,28,215,31,5,9,166,27,249,24
    1358   00:9731  FF FF FF E0 3E 01 E1 00 0A 1D 2D 00 00 00 78 05 
    1358   00:9741  0A 09 18 1D 1C 1C 09 1C D7 1F 05 09 A6 1B F9 18 
    1359   00:9751                             db 146,5,27,30,0,213,157,27,30,0,221,55,9,189,27,154,14,30,142,62,111,31,30,229,24,32,24,232,139,45,29,16
    1359   00:9751  92 05 1B 1E 00 D5 9D 1B 1E 00 DD 37 09 BD 1B 9A 
    1359   00:9761  0E 1E 8E 3E 6F 1F 1E E5 18 20 18 E8 8B 2D 1D 10 
    1360   00:9771                             db 141,27,31,31,112,167,79,10,4,10,227,167,187,93,12,55,36,13,179,67,139,92,27,197,149,33,241,223,253,27,47,0
    1360   00:9771  8D 1B 1F 1F 70 A7 4F 0A 04 0A E3 A7 BB 5D 0C 37 
    1360   00:9781  24 0D B3 43 8B 5C 1B C5 95 21 F1 DF FD 1B 2F 00 
    1361   00:9791                             db 27,27,187,111,24,209,163,247,153,27,9,27,240,217,30,243,0,111,27,96,139,0,32,176,0,220,243,58,159,151,217,235
    1361   00:9791  1B 1B BB 6F 18 D1 A3 F7 99 1B 09 1B F0 D9 1E F3 
    1361   00:97A1  00 6F 1B 60 8B 00 20 B0 00 DC F3 3A 9F 97 D9 EB 
    1362   00:97B1                             db 215,30,21,10,123,27,223,147,255,255,255,254,62,1,225,0,10,29,45,0,0,0,120,5,10,9,24,29,28,28,9,28
    1362   00:97B1  D7 1E 15 0A 7B 1B DF 93 FF FF FF FE 3E 01 E1 00 
    1362   00:97C1  0A 1D 2D 00 00 00 78 05 0A 09 18 1D 1C 1C 09 1C 
    1363   00:97D1                             db 215,31,5,9,166,27,249,24,156,5,27,30,219,0,123,64,78,16,27,46,10,32,0,124,251,27,163,39,0,31,31,189
    1363   00:97D1  D7 1F 05 09 A6 1B F9 18 9C 05 1B 1E DB 00 7B 40 
    1363   00:97E1  4E 10 1B 2E 0A 20 00 7C FB 1B A3 27 00 1F 1F BD 
    1364   00:97F1                             db 111,54,86,24,243,111,123,27,47,24,46,190,39,27,252,49,251,27,54,18,24,183,116,54,24,139,22,31,0,184,195,119
    1364   00:97F1  6F 36 56 18 F3 6F 7B 1B 2F 18 2E BE 27 1B FC 31 
    1364   00:9801  FB 1B 36 12 18 B7 74 36 18 8B 16 1F 00 B8 C3 77 
    1365   00:9811                             db 64,236,223,123,243,179,154,116,134,167,227,148,160,139,33,54,33,10,58,222,192,21,10,21,0,218,27,229,86,21,255,123
    1365   00:9811  40 EC DF 7B F3 B3 9A 74 86 A7 E3 94 A0 8B 21 36 
    1365   00:9821  21 0A 3A DE C0 15 0A 15 00 DA 1B E5 56 15 FF 7B 
    1366   00:9831                             db 27,223,147,255,255,255,254,62,1,225,0,10,29,45,0,0,0,120,5,10,9,24,29,28,28,9,28,215,31,5,9,166
    1366   00:9831  1B DF 93 FF FF FF FE 3E 01 E1 00 0A 1D 2D 00 00 
    1366   00:9841  00 78 05 0A 09 18 1D 1C 1C 09 1C D7 1F 05 09 A6 
    1367   00:9851                             db 27,249,24,146,5,27,30,0,212,15,222,11,191,27,111,55,126,139,49,27,20,44,0,34,0,5,125,28,11,230,27,62
    1367   00:9851  1B F9 18 92 05 1B 1E 00 D4 0F DE 0B BF 1B 6F 37 
    1367   00:9861  7E 8B 31 1B 14 2C 00 22 00 05 7D 1C 0B E6 1B 3E 
    1368   00:9871                             db 127,12,0,251,11,188,8,139,3,29,32,29,31,107,5,0,54,5,17,223,88,167,190,120,142,115,8,81,160,187,0,111
    1368   00:9871  7F 0C 00 FB 0B BC 08 8B 03 1D 20 1D 1F 6B 05 00 
    1368   00:9881  36 05 11 DF 58 A7 BE 78 8E 73 08 51 A0 BB 00 6F 
    1369   00:9891                             db 175,166,205,52,59,17,27,126,86,253,61,27,239,147,255,255,255,255,30,1,225,0,10,29,45,0,0,0,70,5,10,176
    1369   00:9891  AF A6 CD 34 3B 11 1B 7E 56 FD 3D 1B EF 93 FF FF 
    1369   00:98A1  FF FF 1E 01 E1 00 0A 1D 2D 00 00 00 46 05 0A B0 
    1370   00:98B1                             db 11,10,9,29,49,28,28,9,28,243,5,9,89,11,9,250,111,27,102,24,5,125,43,11,236,27,30,220,0,244,27,208
    1370   00:98B1  0B 0A 09 1D 31 1C 1C 09 1C F3 05 09 59 0B 09 FA 
    1370   00:98C1  6F 1B 66 18 05 7D 2B 0B EC 1B 1E DC 00 F4 1B D0 
    1371   00:98D1                             db 15,31,32,161,136,4,31,29,32,159,147,119,111,24,166,92,119,23,27,118,74,183,233,27,237,21,247,27,182,167,243,138
    1371   00:98D1  0F 1F 20 A1 88 04 1F 1D 20 9F 93 77 6F 18 A6 5C 
    1371   00:98E1  77 17 1B 76 4A B7 E9 1B ED 15 F7 1B B6 A7 F3 8A 
    1372   00:98F1                             db 9,243,167,173,86,133,191,5,183,27,187,5,27,244,111,247,182,27,217,219,128,115,235,218,167,225,222,123,254,139,221,231
    1372   00:98F1  09 F3 A7 AD 56 85 BF 05 B7 1B BB 05 1B F4 6F F7 
    1372   00:9901  B6 1B D9 DB 80 73 EB DA A7 E1 DE 7B FE 8B DD E7 
    1373   00:9911                             db 27,1,185,0,255,255,255,255,128,62,1,225,0,10,29,45,0,0,0,120,5,10,9,24,29,28,28,9,28,215,31,5
    1373   00:9911  1B 01 B9 00 FF FF FF FF 80 3E 01 E1 00 0A 1D 2D 
    1373   00:9921  00 00 00 78 05 0A 09 18 1D 1C 1C 09 1C D7 1F 05 
    1374   00:9931                             db 9,166,27,249,24,147,5,27,30,79,0,205,27,53,19,236,55,22,242,55,111,254,24,221,143,139,110,92,27,254,49,244
    1374   00:9931  09 A6 1B F9 18 93 05 1B 1E 4F 00 CD 1B 35 13 EC 
    1374   00:9941  37 16 F2 37 6F FE 18 DD 8F 8B 6E 5C 1B FE 31 F4 
    1375   00:9951                             db 167,54,142,23,32,0,182,92,152,27,21,31,181,0,195,195,222,223,61,249,179,213,30,148,153,60,151,86,33,0,168,30
    1375   00:9951  A7 36 8E 17 20 00 B6 5C 98 1B 15 1F B5 00 C3 C3 
    1375   00:9961  DE DF 3D F9 B3 D5 1E 94 99 3C 97 56 21 00 A8 1E 
    1376   00:9971                             db 18,243,111,54,27,30,254,33,251,27,103,0,10,231,27,189,147,255,255,255,255,224,62,1,225,0,10,36,45,0,4,0
    1376   00:9971  12 F3 6F 36 1B 1E FE 21 FB 1B 67 00 0A E7 1B BD 
    1376   00:9981  93 FF FF FF FF E0 3E 01 E1 00 0A 24 2D 00 04 00 
    1377   00:9991                             db 120,5,10,9,9,36,35,35,2,0,35,174,63,5,9,70,27,4,237,24,146,5,27,30,0,213,157,27,30,0,150,55
    1377   00:9991  78 05 0A 09 09 24 23 23 02 00 23 AE 3F 05 09 46 
    1377   00:99A1  1B 04 ED 18 92 05 1B 1E 00 D5 9D 1B 1E 00 96 37 
    1378   00:99B1                             db 0,126,7,104,27,142,105,111,253,30,248,139,103,40,111,92,199,167,247,61,225,167,179,30,4,88,139,213,143,133,143,139
    1378   00:99B1  00 7E 07 68 1B 8E 69 6F FD 1E F8 8B 67 28 6F 5C 
    1378   00:99C1  C7 A7 F7 3D E1 A7 B3 1E 04 58 8B D5 8F 85 8F 8B 
    1379   00:99D1                             db 208,223,247,231,179,120,155,122,30,104,0,151,234,27,46,10,8,222,0,193,139,9,11,189,0,250,123,27,223,147,255,255
    1379   00:99D1  D0 DF F7 E7 B3 78 9B 7A 1E 68 00 97 EA 1B 2E 0A 
    1379   00:99E1  08 DE 00 C1 8B 09 0B BD 00 FA 7B 1B DF 93 FF FF 
    1380   00:99F1                             db 255,254,30,1,225,0,10,36,45,0,4,0,120,5,10,9,9,36,35,35,2,0,35,174,63,5,9,70,27,4,237,24
    1380   00:99F1  FF FE 1E 01 E1 00 0A 24 2D 00 04 00 78 05 0A 09 
    1380   00:9A01  09 24 23 23 02 00 23 AE 3F 05 09 46 1B 04 ED 18 
    1381   00:9A11                             db 147,5,27,30,77,0,77,33,188,13,27,243,124,237,27,188,136,27,247,183,111,217,27,37,247,27,111,139,109,30,152,150
    1381   00:9A11  93 05 1B 1E 4D 00 4D 21 BC 0D 1B F3 7C ED 1B BC 
    1381   00:9A21  88 1B F7 B7 6F D9 1B 25 F7 1B 6F 8B 6D 1E 98 96 
    1382   00:9A31                             db 11,6,223,139,125,27,139,215,11,5,237,223,251,151,139,86,109,130,148,182,6,107,27,24,139,10,33,0,10,185,36,139
    1382   00:9A31  0B 06 DF 8B 7D 1B 8B D7 0B 05 ED DF FB 97 8B 56 
    1382   00:9A41  6D 82 94 B6 06 6B 1B 18 8B 0A 21 00 0A B9 24 8B 
    1383   00:9A51                             db 10,248,139,9,239,27,155,11,4,126,92,143,27,1,115,0,255,255,255,255,62,1,225,0,10,36,41,0,4,0,4,10
    1383   00:9A51  0A F8 8B 09 EF 1B 9B 0B 04 7E 5C 8F 1B 01 73 00 
    1383   00:9A61  FF FF FF FF 3E 01 E1 00 0A 24 29 00 04 00 04 0A 
    1384   00:9A71                             db 222,5,120,11,17,9,10,36,35,35,2,0,4,59,9,4,5,111,11,63,17,79,27,190,18,36,214,5,155,27,30,159
    1384   00:9A71  DE 05 78 0B 11 09 0A 24 23 23 02 00 04 3B 09 04 
    1384   00:9A81  05 6F 0B 3F 11 4F 1B BE 12 24 D6 05 9B 1B 1E 9F 
    1385   00:9A91                             db 0,219,27,197,130,29,237,27,189,74,219,29,222,111,213,102,64,29,191,85,27,5,92,29,246,27,27,130,159,30,23,150
    1385   00:9A91  00 DB 1B C5 82 1D ED 1B BD 4A DB 1D DE 6F D5 66 
    1385   00:9AA1  40 1D BF 55 1B 05 5C 1D F6 1B 1B 82 9F 1E 17 96 
    1386   00:9AB1                             db 19,198,139,182,27,177,151,223,27,198,242,252,167,123,126,5,222,27,105,122,15,155,8,105,98,19,50,27,33,0,168,182
    1386   00:9AB1  13 C6 8B B6 1B B1 97 DF 1B C6 F2 FC A7 7B 7E 05 
    1386   00:9AC1  DE 1B 69 7A 0F 9B 08 69 62 13 32 1B 21 00 A8 B6 
    1387   00:9AD1                             db 18,212,151,43,159,49,21,27,39,154,5,167,80,118,22,55,237,27,158,21,247,147,255,255,255,255,128,30,1,225,0,10
    1387   00:9AD1  12 D4 97 2B 9F 31 15 1B 27 9A 05 A7 50 76 16 37 
    1387   00:9AE1  ED 1B 9E 15 F7 93 FF FF FF FF 80 1E 01 E1 00 0A 
    1388   00:9AF1                             db 36,45,0,4,0,120,5,10,9,9,36,35,35,2,0,35,174,63,5,9,71,27,4,201,12,30,0,4,207,4,36,172
    1388   00:9AF1  24 2D 00 04 00 78 05 0A 09 09 24 23 23 02 00 23 
    1388   00:9B01  AE 3F 05 09 47 1B 04 C9 0C 1E 00 04 CF 04 24 AC 
    1389   00:9B11                             db 30,27,13,218,27,96,235,27,108,108,27,22,202,55,0,29,217,68,10,94,27,154,102,67,142,154,111,117,29,68,11,166
    1389   00:9B11  1E 1B 0D DA 1B 60 EB 1B 6C 6C 1B 16 CA 37 00 1D 
    1389   00:9B21  D9 44 0A 5E 1B 9A 66 43 8E 9A 6F 75 1D 44 0B A6 
    1390   00:9B31                             db 98,90,92,0,151,139,177,109,108,27,94,51,86,215,167,15,217,27,217,246,167,106,48,102,180,30,167,167,155,139,223,27
    1390   00:9B31  62 5A 5C 00 97 8B B1 6D 6C 1B 5E 33 56 D7 A7 0F 
    1390   00:9B41  D9 1B D9 F6 A7 6A 30 66 B4 1E A7 A7 9B 8B DF 1B 
    1391   00:9B51                             db 102,167,132,110,27,103,236,43,125,98,223,232,12,38,122,38,126,42,155,27,61,248,30,59,0,114,109,139,168,121,186,0
    1391   00:9B51  66 A7 84 6E 1B 67 EC 2B 7D 62 DF E8 0C 26 7A 26 
    1391   00:9B61  7E 2A 9B 1B 3D F8 1E 3B 00 72 6D 8B A8 79 BA 00 
    1392   00:9B71                             db 7,7,238,5,157,254,139,254,5,253,30,27,1,231,0,255,255,255,254,62,1,225,0,10,36,45,0,4,0,120,5,10
    1392   00:9B71  07 07 EE 05 9D FE 8B FE 05 FD 1E 1B 01 E7 00 FF 
    1392   00:9B81  FF FF FE 3E 01 E1 00 0A 24 2D 00 04 00 78 05 0A 
    1393   00:9B91                             db 9,9,36,35,35,2,0,35,174,63,5,9,70,27,4,237,24,155,5,143,27,30,154,0,4,182,27,177,136,247,27,233
    1393   00:9B91  09 09 24 23 23 02 00 23 AE 3F 05 09 46 1B 04 ED 
    1393   00:9BA1  18 9B 05 8F 1B 1E 9A 00 04 B6 1B B1 88 F7 1B E9 
    1394   00:9BB1                             db 111,254,198,167,23,130,36,109,5,11,232,139,68,132,160,243,5,4,23,11,10,5,161,27,15,15,173,92,127,18,26,167
    1394   00:9BB1  6F FE C6 A7 17 82 24 6D 05 0B E8 8B 44 84 A0 F3 
    1394   00:9BC1  05 04 17 0B 0A 05 A1 1B 0F 0F AD 5C 7F 12 1A A7 
    1395   00:9BD1                             db 197,204,18,247,111,189,27,188,142,253,5,180,0,27,38,198,0,10,141,145,41,182,5,59,12,10,21,107,27,69,120,220
    1395   00:9BD1  C5 CC 12 F7 6F BD 1B BC 8E FD 05 B4 00 1B 26 C6 
    1395   00:9BE1  00 0A 8D 91 29 B6 05 3B 0C 0A 15 6B 1B 45 78 DC 
    1396   00:9BF1                             db 227,134,85,61,27,239,147,255,255,255,255,62,1,225,0,10,0,234,30,0,10,9,179,27,9,87,246,27,102,28,0,190
    1396   00:9BF1  E3 86 55 3D 1B EF 93 FF FF FF FF 3E 01 E1 00 0A 
    1396   00:9C01  00 EA 1E 00 0A 09 B3 1B 09 57 F6 1B 66 1C 00 BE 
    1397   00:9C11                             db 140,27,2,0,45,0,16,0,150,17,3,0,51,5,35,0,81,27,17,122,0,219,27,98,19,10,5,7,229,99,36,27
    1397   00:9C11  8C 1B 02 00 2D 00 10 00 96 11 03 00 33 05 23 00 
    1397   00:9C21  51 1B 11 7A 00 DB 1B 62 13 0A 05 07 E5 63 24 1B 
    1398   00:9C31                             db 239,127,147,255,255,255,248
    1398   00:9C31  EF 7F 93 FF FF FF F8 
    1399   00:9C38  20                  numsc  db 32
    1400   00:9C39  (00:9C39)           chgfx:	equ $
    1401   00:9C39                             db 0,0,0,0,0,0,0,0,241,241,241,241,241,241,241,241
    1401   00:9C39  00 00 00 00 00 00 00 00 F1 F1 F1 F1 F1 F1 F1 F1 
    1402   00:9C49                             db 255,0,88,52,106,197,255,0,33,33,33,33,33,33,33,33
    1402   00:9C49  FF 00 58 34 6A C5 FF 00 21 21 21 21 21 21 21 21 
    1403   00:9C59                             db 0,0,0,0,0,0,0,0,245,245,245,245,245,245,245,245
    1403   00:9C59  00 00 00 00 00 00 00 00 F5 F5 F5 F5 F5 F5 F5 F5 
    1404   00:9C69                             db 0,0,0,0,0,0,0,0,248,248,248,248,248,248,248,248
    1404   00:9C69  00 00 00 00 00 00 00 00 F8 F8 F8 F8 F8 F8 F8 F8 
    1405   00:9C79                             db 0,0,0,0,0,0,0,0,228,228,228,228,228,228,228,228
    1405   00:9C79  00 00 00 00 00 00 00 00 E4 E4 E4 E4 E4 E4 E4 E4 
    1406   00:9C89                             db 0,0,0,0,0,0,0,0,230,230,230,230,230,230,230,230
    1406   00:9C89  00 00 00 00 00 00 00 00 E6 E6 E6 E6 E6 E6 E6 E6 
    1407   00:9C99                             db 116,116,100,32,36,0,32,0,166,166,166,166,166,166,166,166
    1407   00:9C99  74 74 64 20 24 00 20 00 A6 A6 A6 A6 A6 A6 A6 A6 
    1408   00:9CA9                             db 77,77,6,68,4,0,4,0,228,228,228,228,228,228,228,228
    1408   00:9CA9  4D 4D 06 44 04 00 04 00 E4 E4 E4 E4 E4 E4 E4 E4 
    1409   00:9CB9                             db 129,194,228,112,56,28,78,135,209,209,209,209,209,209,209,209
    1409   00:9CB9  81 C2 E4 70 38 1C 4E 87 D1 D1 D1 D1 D1 D1 D1 D1 
    1410   00:9CC9                             db 58,76,114,124,122,124,122,124,241,241,241,241,241,241,241,241
    1410   00:9CC9  3A 4C 72 7C 7A 7C 7A 7C F1 F1 F1 F1 F1 F1 F1 F1 
    1411   00:9CD9                             db 0,64,112,124,122,124,122,124,225,225,225,225,225,225,225,225
    1411   00:9CD9  00 40 70 7C 7A 7C 7A 7C E1 E1 E1 E1 E1 E1 E1 E1 
    1412   00:9CE9                             db 129,194,228,112,56,28,78,135,209,209,209,209,209,209,209,209
    1412   00:9CE9  81 C2 E4 70 38 1C 4E 87 D1 D1 D1 D1 D1 D1 D1 D1 
    1413   00:9CF9                             db 255,0,8,124,8,0,255,0,177,177,177,177,177,177,177,177
    1413   00:9CF9  FF 00 08 7C 08 00 FF 00 B1 B1 B1 B1 B1 B1 B1 B1 
    1414   00:9D09                             db 0,0,0,0,0,0,0,0,248,248,248,248,248,248,248,248
    1414   00:9D09  00 00 00 00 00 00 00 00 F8 F8 F8 F8 F8 F8 F8 F8 
    1415   00:9D19                             db 0,0,0,0,0,0,0,0,245,245,245,245,245,245,245,245
    1415   00:9D19  00 00 00 00 00 00 00 00 F5 F5 F5 F5 F5 F5 F5 F5 
    1416   00:9D29                             db 0,0,0,0,0,0,0,0,181,181,181,181,181,181,181,181
    1416   00:9D29  00 00 00 00 00 00 00 00 B5 B5 B5 B5 B5 B5 B5 B5 
    1417   00:9D39                             db 0,0,0,0,0,0,0,0,253,253,253,253,253,253,253,253
    1417   00:9D39  00 00 00 00 00 00 00 00 FD FD FD FD FD FD FD FD 
    1418   00:9D49                             db 0,0,0,0,0,0,0,0,237,237,237,237,237,237,237,237
    1418   00:9D49  00 00 00 00 00 00 00 00 ED ED ED ED ED ED ED ED 
    1419   00:9D59                             db 42,40,18,16,0,16,0,0,177,177,177,177,177,177,177,177
    1419   00:9D59  2A 28 12 10 00 10 00 00 B1 B1 B1 B1 B1 B1 B1 B1 
    1420   00:9D69                             db 58,20,4,20,0,4,0,0,173,173,173,173,173,173,173,173
    1420   00:9D69  3A 14 04 14 00 04 00 00 AD AD AD AD AD AD AD AD 
    1421   00:9D79                             db 0,0,0,0,0,0,0,0,241,241,241,241,241,241,241,241
    1421   00:9D79  00 00 00 00 00 00 00 00 F1 F1 F1 F1 F1 F1 F1 F1 
    1422   00:9D89                             db 0,0,0,0,0,0,0,0,253,253,253,253,253,253,253,253
    1422   00:9D89  00 00 00 00 00 00 00 00 FD FD FD FD FD FD FD FD 
    1423   00:9D99                             db 255,0,32,124,32,0,255,0,177,177,177,177,177,177,177,177
    1423   00:9D99  FF 00 20 7C 20 00 FF 00 B1 B1 B1 B1 B1 B1 B1 B1 
    1424   00:9DA9                             db 7,114,248,208,116,128,166,13,177,177,177,177,177,177,177,177
    1424   00:9DA9  07 72 F8 D0 74 80 A6 0D B1 B1 B1 B1 B1 B1 B1 B1 
    1425   00:9DB9                             db 7,114,248,208,116,128,166,13,161,161,161,161,161,161,161,161
    1425   00:9DB9  07 72 F8 D0 74 80 A6 0D A1 A1 A1 A1 A1 A1 A1 A1 
    1426   00:9DC9                             db 103,82,32,0,0,0,0,0,161,161,161,161,161,161,161,161
    1426   00:9DC9  67 52 20 00 00 00 00 00 A1 A1 A1 A1 A1 A1 A1 A1 
    1427   00:9DD9                             db 103,82,32,0,0,0,0,0,166,166,166,166,166,166,166,166
    1427   00:9DD9  67 52 20 00 00 00 00 00 A6 A6 A6 A6 A6 A6 A6 A6 
    1428   00:9DE9                             db 58,76,114,124,122,124,122,60,241,241,241,241,241,241,241,241
    1428   00:9DE9  3A 4C 72 7C 7A 7C 7A 3C F1 F1 F1 F1 F1 F1 F1 F1 
    1429   00:9DF9                             db 0,0,0,0,0,0,0,0,242,242,242,242,242,242,242,242
    1429   00:9DF9  00 00 00 00 00 00 00 00 F2 F2 F2 F2 F2 F2 F2 F2 
    1430   00:9E09                             db 0,0,0,0,0,0,0,0,236,236,236,236,236,236,236,236
    1430   00:9E09  00 00 00 00 00 00 00 00 EC EC EC EC EC EC EC EC 
    1431   00:9E19                             db 255,0,122,122,122,122,0,255,241,241,241,241,241,241,241,241
    1431   00:9E19  FF 00 7A 7A 7A 7A 00 FF F1 F1 F1 F1 F1 F1 F1 F1 
    1432   00:9E29                             db 60,24,16,0,16,0,0,0,129,129,129,129,129,129,129,129
    1432   00:9E29  3C 18 10 00 10 00 00 00 81 81 81 81 81 81 81 81 
    1433   00:9E39                             db 92,72,8,64,8,0,0,0,108,108,108,108,108,108,108,108
    1433   00:9E39  5C 48 08 40 08 00 00 00 6C 6C 6C 6C 6C 6C 6C 6C 
    1434   00:9E49                             db 221,187,119,170,221,187,119,238,113,113,113,113,113,113,113,113
    1434   00:9E49  DD BB 77 AA DD BB 77 EE 71 71 71 71 71 71 71 71 
    1435   00:9E59                             db 0,0,0,0,0,0,0,0,242,242,242,242,242,242,242,242
    1435   00:9E59  00 00 00 00 00 00 00 00 F2 F2 F2 F2 F2 F2 F2 F2 
    1436   00:9E69                             db 0,0,0,0,0,0,0,0,247,247,247,247,247,247,247,247
    1436   00:9E69  00 00 00 00 00 00 00 00 F7 F7 F7 F7 F7 F7 F7 F7 
    1437   00:9E79                             db 0,0,0,0,0,0,0,0,231,231,231,231,231,231,231,231
    1437   00:9E79  00 00 00 00 00 00 00 00 E7 E7 E7 E7 E7 E7 E7 E7 
    1438   00:9E89                             db 0,8,10,74,68,84,36,40,135,135,135,135,135,135,135,135
    1438   00:9E89  00 08 0A 4A 44 54 24 28 87 87 87 87 87 87 87 87 
    1439   00:9E99                             db 65,162,84,40,20,42,69,130,241,241,241,241,241,241,241,241
    1439   00:9E99  41 A2 54 28 14 2A 45 82 F1 F1 F1 F1 F1 F1 F1 F1 
    1440   00:9EA9                             db 221,187,126,145,155,178,127,238,113,113,113,113,113,113,113,113
    1440   00:9EA9  DD BB 7E 91 9B B2 7F EE 71 71 71 71 71 71 71 71 
    1441   00:9EB9  (00:9EB9)           bprop  equ $
    1442   00:9EB9  00                         db 0
    1443   00:9EBA  02                         db 2
    1444   00:9EBB  00                         db 0
    1445   00:9EBC  00                         db 0
    1446   00:9EBD  00                         db 0
    1447   00:9EBE  00                         db 0
    1448   00:9EBF  05                         db 5
    1449   00:9EC0  05                         db 5
    1450   00:9EC1  00                         db 0
    1451   00:9EC2  02                         db 2
    1452   00:9EC3  02                         db 2
    1453   00:9EC4  00                         db 0
    1454   00:9EC5  02                         db 2
    1455   00:9EC6  06                         db 6
    1456   00:9EC7  06                         db 6
    1457   00:9EC8  02                         db 2
    1458   00:9EC9  00                         db 0
    1459   00:9ECA  00                         db 0
    1460   00:9ECB  05                         db 5
    1461   00:9ECC  05                         db 5
    1462   00:9ECD  06                         db 6
    1463   00:9ECE  06                         db 6
    1464   00:9ECF  02                         db 2
    1465   00:9ED0  02                         db 2
    1466   00:9ED1  02                         db 2
    1467   00:9ED2  05                         db 5
    1468   00:9ED3  05                         db 5
    1469   00:9ED4  02                         db 2
    1470   00:9ED5  00                         db 0
    1471   00:9ED6  00                         db 0
    1472   00:9ED7  02                         db 2
    1473   00:9ED8  05                         db 5
    1474   00:9ED9  05                         db 5
    1475   00:9EDA  02                         db 2
    1476   00:9EDB  06                         db 6
    1477   00:9EDC  00                         db 0
    1478   00:9EDD  00                         db 0
    1479   00:9EDE  05                         db 5
    1480   00:9EDF  00                         db 0
    1481   00:9EE0  00                         db 0
    1482   00:9EE1  (00:9EE1)           sprgfx:	equ $
    1483   00:9EE1                             db 0,0,63,127,126,127,127,127,127,127,127,111,111,115,127,63,0,0,252,254,14,230,246,246,246,246,246,254,254,254,254,252
    1483   00:9EE1  00 00 3F 7F 7E 7F 7F 7F 7F 7F 7F 6F 6F 73 7F 3F 
    1483   00:9EF1  00 00 FC FE 0E E6 F6 F6 F6 F6 F6 FE FE FE FE FC 
    1484   00:9F01                             db 0,12,31,63,62,63,127,127,127,127,255,223,239,115,15,1,0,0,128,240,60,222,238,246,244,244,252,248,248,248,240,192
    1484   00:9F01  00 0C 1F 3F 3E 3F 7F 7F 7F 7F FF DF EF 73 0F 01 
    1484   00:9F11  00 00 80 F0 3C DE EE F6 F4 F4 FC F8 F8 F8 F0 C0 
    1485   00:9F21                             db 0,1,3,7,12,31,63,127,255,127,55,27,13,6,3,1,0,128,192,224,48,216,236,246,255,254,252,248,240,224,192,128
    1485   00:9F21  00 01 03 07 0C 1F 3F 7F FF 7F 37 1B 0D 06 03 01 
    1485   00:9F31  00 80 C0 E0 30 D8 EC F6 FF FE FC F8 F0 E0 C0 80 
    1486   00:9F41                             db 0,0,1,15,63,127,127,127,63,63,63,23,23,25,15,3,0,48,248,156,236,244,246,246,246,254,255,255,255,254,240,128
    1486   00:9F41  00 00 01 0F 3F 7F 7F 7F 3F 3F 3F 17 17 19 0F 03 
    1486   00:9F51  00 30 F8 9C EC F4 F6 F6 F6 FE FF FF FF FE F0 80 
    1487   00:9F61                             db 0,0,0,6,25,57,123,121,127,62,15,39,72,68,132,128,0,0,0,96,152,156,222,158,254,124,240,228,18,34,33,1
    1487   00:9F61  00 00 00 06 19 39 7B 79 7F 3E 0F 27 48 44 84 80 
    1487   00:9F71  00 00 00 60 98 9C DE 9E FE 7C F0 E4 12 22 21 01 
    1488   00:9F81                             db 0,0,0,6,25,57,123,121,127,62,15,39,72,68,68,64,0,0,0,96,152,156,222,158,254,124,240,228,18,34,34,2
    1488   00:9F81  00 00 00 06 19 39 7B 79 7F 3E 0F 27 48 44 44 40 
    1488   00:9F91  00 00 00 60 98 9C DE 9E FE 7C F0 E4 12 22 22 02 
    1489   00:9FA1                             db 0,0,6,25,59,121,121,127,62,15,23,44,43,36,20,8,0,0,96,152,220,158,158,254,124,240,232,52,212,36,40,16
    1489   00:9FA1  00 00 06 19 3B 79 79 7F 3E 0F 17 2C 2B 24 14 08 
    1489   00:9FB1  00 00 60 98 DC 9E 9E FE 7C F0 E8 34 D4 24 28 10 
    1490   00:9FC1                             db 0,0,6,25,59,121,121,127,62,15,23,44,75,68,68,64,0,0,96,152,220,158,158,254,124,240,232,52,210,34,34,2
    1490   00:9FC1  00 00 06 19 3B 79 79 7F 3E 0F 17 2C 4B 44 44 40 
    1490   00:9FD1  00 00 60 98 DC 9E 9E FE 7C F0 E8 34 D2 22 22 02 
    1491   00:9FE1                             db 0,0,128,67,101,53,5,21,27,12,7,8,16,16,0,0,0,0,1,194,166,172,160,168,216,48,224,16,8,8,0,0
    1491   00:9FE1  00 00 80 43 65 35 05 15 1B 0C 07 08 10 10 00 00 
    1491   00:9FF1  00 00 01 C2 A6 AC A0 A8 D8 30 E0 10 08 08 00 00 
    1492   00:A001                             db 0,0,0,3,101,245,5,21,27,12,7,8,8,8,0,0,0,0,0,192,166,175,160,168,216,48,224,16,16,16,0,0
    1492   00:A001  00 00 00 03 65 F5 05 15 1B 0C 07 08 08 08 00 00 
    1492   00:A011  00 00 00 C0 A6 AF A0 A8 D8 30 E0 10 10 10 00 00 
    1493   00:A021                             db 0,0,0,3,5,21,101,213,155,12,7,8,4,4,0,0,0,0,0,192,160,168,166,171,217,48,224,16,32,32,0,0
    1493   00:A021  00 00 00 03 05 15 65 D5 9B 0C 07 08 04 04 00 00 
    1493   00:A031  00 00 00 C0 A0 A8 A6 AB D9 30 E0 10 20 20 00 00 
    1494   00:A041                             db 0,0,0,3,101,245,5,21,27,12,7,8,8,8,0,0,0,0,0,192,166,175,160,168,216,48,224,16,16,16,0,0
    1494   00:A041  00 00 00 03 65 F5 05 15 1B 0C 07 08 08 08 00 00 
    1494   00:A051  00 00 00 C0 A6 AF A0 A8 D8 30 E0 10 10 10 00 00 
    1495   00:A061                             db 0,0,0,0,0,2,6,28,52,24,0,0,0,0,0,0,7,55,64,128,183,247,247,247,247,119,55,7,0,0,0,0
    1495   00:A061  00 00 00 00 00 02 06 1C 34 18 00 00 00 00 00 00 
    1495   00:A071  07 37 40 80 B7 F7 F7 F7 F7 77 37 07 00 00 00 00 
    1496   00:A081                             db 0,0,24,52,28,6,2,0,0,0,0,0,0,0,0,0,7,55,64,128,183,247,247,247,247,119,55,7,0,0,0,0
    1496   00:A081  00 00 18 34 1C 06 02 00 00 00 00 00 00 00 00 00 
    1496   00:A091  07 37 40 80 B7 F7 F7 F7 F7 77 37 07 00 00 00 00 
    1497   00:A0A1                             db 0,0,1,2,6,7,3,5,2,3,1,0,1,0,7,15,0,0,128,64,32,32,64,160,64,192,128,0,128,0,160,208
    1497   00:A0A1  00 00 01 02 06 07 03 05 02 03 01 00 01 00 07 0F 
    1497   00:A0B1  00 00 80 40 20 20 40 A0 40 C0 80 00 80 00 A0 D0 
    1498   00:A0C1                             db 0,0,0,0,8,20,8,8,3,15,31,14,23,35,68,132,0,0,0,0,16,40,16,16,192,240,248,112,232,196,34,33
    1498   00:A0C1  00 00 00 00 08 14 08 08 03 0F 1F 0E 17 23 44 84 
    1498   00:A0D1  00 00 00 00 10 28 10 10 C0 F0 F8 70 E8 C4 22 21 
    1499   00:A0E1                             db 0,0,0,0,0,16,40,16,8,3,15,31,14,23,35,196,0,0,0,0,0,8,20,8,16,192,240,248,112,232,196,35
    1499   00:A0E1  00 00 00 00 00 10 28 10 08 03 0F 1F 0E 17 23 C4 
    1499   00:A0F1  00 00 00 00 00 08 14 08 10 C0 F0 F8 70 E8 C4 23 
    1500   00:A101                             db 0,0,0,0,16,40,16,8,3,15,31,14,23,35,32,34,0,0,0,0,8,20,8,16,192,240,248,112,232,196,4,68
    1500   00:A101  00 00 00 00 10 28 10 08 03 0F 1F 0E 17 23 20 22 
    1500   00:A111  00 00 00 00 08 14 08 10 C0 F0 F8 70 E8 C4 04 44 
    1501   00:A121                             db 0,0,0,8,20,8,8,3,15,31,14,7,19,16,18,18,0,0,0,16,40,16,16,192,240,248,112,224,200,8,72,72
    1501   00:A121  00 00 00 08 14 08 08 03 0F 1F 0E 07 13 10 12 12 
    1501   00:A131  00 00 00 10 28 10 10 C0 F0 F8 70 E0 C8 08 48 48 
    1502   00:A141                             db 0,15,17,46,95,87,95,46,17,14,32,36,36,18,18,0,0,240,136,116,250,186,250,116,136,112,4,36,36,72,72,0
    1502   00:A141  00 0F 11 2E 5F 57 5F 2E 11 0E 20 24 24 12 12 00 
    1502   00:A151  00 F0 88 74 FA BA FA 74 88 70 04 24 24 48 48 00 
    1503   00:A161                             db 0,15,17,46,95,91,95,46,17,14,32,36,36,36,36,0,0,240,136,116,250,218,250,116,136,112,4,36,36,36,36,0
    1503   00:A161  00 0F 11 2E 5F 5B 5F 2E 11 0E 20 24 24 24 24 00 
    1503   00:A171  00 F0 88 74 FA DA FA 74 88 70 04 24 24 24 24 00 
    1504   00:A181                             db 0,15,17,46,95,93,95,46,17,14,32,36,36,72,72,0,0,240,136,116,250,234,250,116,136,112,4,36,36,18,18,0
    1504   00:A181  00 0F 11 2E 5F 5D 5F 2E 11 0E 20 24 24 48 48 00 
    1504   00:A191  00 F0 88 74 FA EA FA 74 88 70 04 24 24 12 12 00 
    1505   00:A1A1                             db 0,15,17,46,95,91,95,46,17,14,32,36,36,36,36,0,0,240,136,116,250,218,250,116,136,112,4,36,36,36,36,0
    1505   00:A1A1  00 0F 11 2E 5F 5B 5F 2E 11 0E 20 24 24 24 24 00 
    1505   00:A1B1  00 F0 88 74 FA DA FA 74 88 70 04 24 24 24 24 00 
    1506   00:A1C1  (00:A1C1)           frmlst equ $
    1507   00:A1C1  00 04                      db 0,4
    1508   00:A1C3  04 04                      db 4,4
    1509   00:A1C5  08 04                      db 8,4
    1510   00:A1C7  0C 02                      db 12,2
    1511   00:A1C9  0E 01                      db 14,1
    1512   00:A1CB  0F 04                      db 15,4
    1513   00:A1CD  13 04 17 00                db 19,4,23,0
    1514   00:A1D1                      nmedat db 0,0,15,48,80,2,2,15,80,176,2,2,15,80,56,2,2,15,120,88,255
    1514   00:A1D1  00 00 0F 30 50 02 02 0F 50 B0 02 02 0F 50 38 02 
    1514   00:A1E1  02 0F 78 58 FF 
    1515   00:A1E6                             db 0,0,15,48,112,2,2,15,128,200,2,1,15,160,72,255
    1515   00:A1E6  00 00 0F 30 70 02 02 0F 80 C8 02 01 0F A0 48 FF 
    1516   00:A1F6                             db 0,0,15,160,200,2,1,15,128,128,2,2,15,80,48,255
    1516   00:A1F6  00 00 0F A0 C8 02 01 0F 80 80 02 02 0F 50 30 FF 
    1517   00:A206                             db 0,0,15,48,32,3,2,15,56,136,2,2,15,112,144,2,1,15,160,88,3,2,15,136,144,255
    1517   00:A206  00 00 0F 30 20 03 02 0F 38 88 02 02 0F 70 90 02 
    1517   00:A216  01 0F A0 58 03 02 0F 88 90 FF 
    1518   00:A220                             db 0,0,15,48,32,3,2,15,48,120,3,2,15,64,144,2,1,15,160,136,2,1,15,128,120,255
    1518   00:A220  00 00 0F 30 20 03 02 0F 30 78 03 02 0F 40 90 02 
    1518   00:A230  01 0F A0 88 02 01 0F 80 78 FF 
    1519   00:A23A                             db 0,0,15,160,32,8,3,15,48,216,2,2,15,120,128,2,2,15,80,88,3,2,15,120,80,255
    1519   00:A23A  00 00 0F A0 20 08 03 0F 30 D8 02 02 0F 78 80 02 
    1519   00:A24A  02 0F 50 58 03 02 0F 78 50 FF 
    1520   00:A254                             db 0,0,15,160,32,1,1,15,128,40,1,1,15,128,160,1,1,15,128,104,8,3,15,88,216,255
    1520   00:A254  00 00 0F A0 20 01 01 0F 80 28 01 01 0F 80 A0 01 
    1520   00:A264  01 0F 80 68 08 03 0F 58 D8 FF 
    1521   00:A26E                             db 0,0,15,88,24,3,2,15,48,80,3,2,15,64,168,2,1,15,160,40,8,3,15,120,72,255
    1521   00:A26E  00 00 0F 58 18 03 02 0F 30 50 03 02 0F 40 A8 02 
    1521   00:A27E  01 0F A0 28 08 03 0F 78 48 FF 
    1522   00:A288                             db 0,0,15,128,32,3,2,15,96,80,3,2,15,112,128,2,1,15,160,168,3,2,15,40,144,255
    1522   00:A288  00 00 0F 80 20 03 02 0F 60 50 03 02 0F 70 80 02 
    1522   00:A298  01 0F A0 A8 03 02 0F 28 90 FF 
    1523   00:A2A2                             db 0,0,15,48,24,8,3,15,40,72,2,5,15,160,80,2,2,15,120,128,3,2,15,48,96,255
    1523   00:A2A2  00 00 0F 30 18 08 03 0F 28 48 02 05 0F A0 50 02 
    1523   00:A2B2  02 0F 78 80 03 02 0F 30 60 FF 
    1524   00:A2BC                             db 0,0,15,160,104,8,3,15,152,56,2,5,15,160,184,2,2,15,120,64,255
    1524   00:A2BC  00 00 0F A0 68 08 03 0F 98 38 02 05 0F A0 B8 02 
    1524   00:A2CC  02 0F 78 40 FF 
    1525   00:A2D1                             db 0,0,15,48,176,2,6,15,80,168,2,1,15,160,128,3,6,15,144,104,3,2,15,120,144,7,4,15,160,56,8,3,15,120,216,3,2,15,56,128,255
    1525   00:A2D1  00 00 0F 30 B0 02 06 0F 50 A8 02 01 0F A0 80 03 
    1525   00:A2E1  06 0F 90 68 03 02 0F 78 90 07 04 0F A0 38 08 03 
    1525   00:A2F1  0F 78 D8 03 02 0F 38 80 FF 
    1526   00:A2FA                             db 0,0,15,48,24,2,2,15,104,72,2,5,15,160,144,2,5,15,88,160,255
    1526   00:A2FA  00 00 0F 30 18 02 02 0F 68 48 02 05 0F A0 90 02 
    1526   00:A30A  05 0F 58 A0 FF 
    1527   00:A30F                             db 0,0,15,160,32,8,3,15,160,216,7,4,15,88,152,2,5,15,88,72,2,5,15,88,40,2,5,15,88,144,2,5,15,160,112,3,2,15,40,168,255
    1527   00:A30F  00 00 0F A0 20 08 03 0F A0 D8 07 04 0F 58 98 02 
    1527   00:A31F  05 0F 58 48 02 05 0F 58 28 02 05 0F 58 90 02 05 
    1527   00:A32F  0F A0 70 03 02 0F 28 A8 FF 
    1528   00:A338                             db 0,0,15,48,24,2,1,15,48,152,2,1,15,48,192,7,4,15,48,136,8,3,15,160,192,2,6,15,120,80,2,5,15,160,88,255
    1528   00:A338  00 00 0F 30 18 02 01 0F 30 98 02 01 0F 30 C0 07 
    1528   00:A348  04 0F 30 88 08 03 0F A0 C0 02 06 0F 78 50 02 05 
    1528   00:A358  0F A0 58 FF 
    1529   00:A35C                             db 0,0,15,160,32,5,4,15,128,216,2,6,15,88,80,255
    1529   00:A35C  00 00 0F A0 20 05 04 0F 80 D8 02 06 0F 58 50 FF 
    1530   00:A36C                             db 0,0,15,48,24,2,2,15,80,104,3,2,15,40,176,3,2,15,128,168,5,4,15,48,216,255
    1530   00:A36C  00 00 0F 30 18 02 02 0F 50 68 03 02 0F 28 B0 03 
    1530   00:A37C  02 0F 80 A8 05 04 0F 30 D8 FF 
    1531   00:A386                             db 0,0,15,48,32,7,4,15,128,216,8,3,15,160,120,2,5,15,128,176,2,2,15,80,160,2,2,15,80,104,255
    1531   00:A386  00 00 0F 30 20 07 04 0F 80 D8 08 03 0F A0 78 02 
    1531   00:A396  05 0F 80 B0 02 02 0F 50 A0 02 02 0F 50 68 FF 
    1532   00:A3A5                             db 0,0,15,48,24,7,4,15,48,192,8,3,15,88,56,3,2,15,40,120,3,2,15,88,144,5,4,15,160,216,2,5,15,48,184,2,5,15,48,216,255
    1532   00:A3A5  00 00 0F 30 18 07 04 0F 30 C0 08 03 0F 58 38 03 
    1532   00:A3B5  02 0F 28 78 03 02 0F 58 90 05 04 0F A0 D8 02 05 
    1532   00:A3C5  0F 30 B8 02 05 0F 30 D8 FF 
    1533   00:A3CE                             db 0,0,15,48,24,5,4,15,160,216,5,4,15,88,216,3,2,15,40,136,255
    1533   00:A3CE  00 00 0F 30 18 05 04 0F A0 D8 05 04 0F 58 D8 03 
    1533   00:A3DE  02 0F 28 88 FF 
    1534   00:A3E3                             db 0,0,15,48,24,5,4,15,88,184,5,4,15,160,216,255
    1534   00:A3E3  00 00 0F 30 18 05 04 0F 58 B8 05 04 0F A0 D8 FF 
    1535   00:A3F3                             db 0,0,15,160,216,5,4,15,88,216,2,6,15,128,128,3,6,15,104,64,5,4,15,48,216,255
    1535   00:A3F3  00 00 0F A0 D8 05 04 0F 58 D8 02 06 0F 80 80 03 
    1535   00:A403  06 0F 68 40 05 04 0F 30 D8 FF 
    1536   00:A40D                             db 0,0,15,128,24,5,4,15,48,216,2,1,15,160,80,3,6,15,88,168,3,6,15,40,96,255
    1536   00:A40D  00 00 0F 80 18 05 04 0F 30 D8 02 01 0F A0 50 03 
    1536   00:A41D  06 0F 58 A8 03 06 0F 28 60 FF 
    1537   00:A427                             db 0,0,15,48,24,3,6,15,40,80,3,6,15,72,168,5,4,15,160,200,2,5,15,88,32,255
    1537   00:A427  00 00 0F 30 18 03 06 0F 28 50 03 06 0F 48 A8 05 
    1537   00:A437  04 0F A0 C8 02 05 0F 58 20 FF 
    1538   00:A441                             db 0,0,15,48,128,5,4,15,88,192,5,4,15,160,192,3,2,15,40,56,3,6,15,96,56,255
    1538   00:A441  00 00 0F 30 80 05 04 0F 58 C0 05 04 0F A0 C0 03 
    1538   00:A451  02 0F 28 38 03 06 0F 60 38 FF 
    1539   00:A45B                             db 0,0,15,128,32,5,4,15,160,216,3,6,15,48,112,3,6,15,112,184,3,6,15,72,80,255
    1539   00:A45B  00 00 0F 80 20 05 04 0F A0 D8 03 06 0F 30 70 03 
    1539   00:A46B  06 0F 70 B8 03 06 0F 48 50 FF 
    1540   00:A475                             db 0,0,15,48,24,2,1,15,160,72,3,2,15,40,112,7,4,15,160,104,8,3,15,48,216,5,4,15,128,216,3,6,15,112,88,3,6,15,136,48,255
    1540   00:A475  00 00 0F 30 18 02 01 0F A0 48 03 02 0F 28 70 07 
    1540   00:A485  04 0F A0 68 08 03 0F 30 D8 05 04 0F 80 D8 03 06 
    1540   00:A495  0F 70 58 03 06 0F 88 30 FF 
    1541   00:A49E                             db 0,0,15,160,24,5,4,15,88,216,5,4,15,128,216,255
    1541   00:A49E  00 00 0F A0 18 05 04 0F 58 D8 05 04 0F 80 D8 FF 
    1542   00:A4AE                             db 0,0,15,48,96,5,4,15,88,136,2,5,15,160,104,3,6,15,48,152,3,6,15,64,184,255
    1542   00:A4AE  00 00 0F 30 60 05 04 0F 58 88 02 05 0F A0 68 03 
    1542   00:A4BE  06 0F 30 98 03 06 0F 40 B8 FF 
    1543   00:A4C8                             db 0,0,15,48,32,2,5,15,160,104,3,6,15,96,80,2,2,15,88,184,3,6,15,40,160,255
    1543   00:A4C8  00 00 0F 30 20 02 05 0F A0 68 03 06 0F 60 50 02 
    1543   00:A4D8  02 0F 58 B8 03 06 0F 28 A0 FF 
    1544   00:A4E2                             db 0,0,15,128,128,8,3,15,128,216,7,4,15,128,72,2,2,15,80,160,2,2,15,80,72,2,5,15,160,96,2,5,15,128,48,255,255
    1544   00:A4E2  00 00 0F 80 80 08 03 0F 80 D8 07 04 0F 80 48 02 
    1544   00:A4F2  02 0F 50 A0 02 02 0F 50 48 02 05 0F A0 60 02 05 
    1544   00:A502  0F 80 30 FF FF 
    1545   00:A507  (00:001F)           NUMOBJ equ 31
    1546   00:A507  (00:A507)           objdta:	equ $
    1547   00:A507                             db 0,160,136,0,0,127,128,181,165,178,165,0,0,254,1,93,73,73,73,181,128,127,0,0,0,0,0,73,1,254,0,0,0,0,0,240,240,240,240,240,240,240,240,240,240,240,240,240,240,240,240,240,240,240,240,240,240,240,240,240,240,240,240,240,240,240,240
    1547   00:A507  00 A0 88 00 00 7F 80 B5 A5 B2 A5 00 00 FE 01 5D 
    1547   00:A517  49 49 49 B5 80 7F 00 00 00 00 00 49 01 FE 00 00 
    1547   00:A527  00 00 00 F0 F0 F0 F0 F0 F0 F0 F0 F0 F0 F0 F0 F0 
    1547   00:A537  F0 F0 F0 F0 F0 F0 F0 F0 F0 F0 F0 F0 F0 F0 F0 F0 
    1547   00:A547  F0 F0 F0 
    1548   00:A54A                             db 1,48,32,0,0,127,128,181,165,178,165,0,0,254,1,93,73,73,73,181,128,127,0,0,0,0,0,73,1,254,0,0,0,0,0,241,241,241,241,241,241,241,241,241,241,241,241,241,241,241,241,241,241,241,241,241,241,241,241,241,241,241,241,241,241,241,241
    1548   00:A54A  01 30 20 00 00 7F 80 B5 A5 B2 A5 00 00 FE 01 5D 
    1548   00:A55A  49 49 49 B5 80 7F 00 00 00 00 00 49 01 FE 00 00 
    1548   00:A56A  00 00 00 F1 F1 F1 F1 F1 F1 F1 F1 F1 F1 F1 F1 F1 
    1548   00:A57A  F1 F1 F1 F1 F1 F1 F1 F1 F1 F1 F1 F1 F1 F1 F1 F1 
    1548   00:A58A  F1 F1 F1 
    1549   00:A58D                             db 2,48,32,0,0,127,128,181,165,178,165,0,0,254,1,93,73,73,73,181,128,127,0,0,0,0,0,73,1,254,0,0,0,0,0,241,241,241,241,241,241,241,241,241,241,241,241,241,241,241,241,241,241,241,241,241,241,241,241,241,241,241,241,241,241,241,241
    1549   00:A58D  02 30 20 00 00 7F 80 B5 A5 B2 A5 00 00 FE 01 5D 
    1549   00:A59D  49 49 49 B5 80 7F 00 00 00 00 00 49 01 FE 00 00 
    1549   00:A5AD  00 00 00 F1 F1 F1 F1 F1 F1 F1 F1 F1 F1 F1 F1 F1 
    1549   00:A5BD  F1 F1 F1 F1 F1 F1 F1 F1 F1 F1 F1 F1 F1 F1 F1 F1 
    1549   00:A5CD  F1 F1 F1 
    1550   00:A5D0                             db 3,88,72,0,0,127,128,181,165,178,165,0,0,254,1,93,73,73,73,181,128,127,0,0,0,0,0,73,1,254,0,0,0,0,0,241,241,241,241,241,241,241,241,241,241,241,241,241,241,241,241,241,241,241,241,241,241,241,241,241,241,241,241,241,241,241,241
    1550   00:A5D0  03 58 48 00 00 7F 80 B5 A5 B2 A5 00 00 FE 01 5D 
    1550   00:A5E0  49 49 49 B5 80 7F 00 00 00 00 00 49 01 FE 00 00 
    1550   00:A5F0  00 00 00 F1 F1 F1 F1 F1 F1 F1 F1 F1 F1 F1 F1 F1 
    1550   00:A600  F1 F1 F1 F1 F1 F1 F1 F1 F1 F1 F1 F1 F1 F1 F1 F1 
    1550   00:A610  F1 F1 F1 
    1551   00:A613                             db 4,160,24,0,0,127,128,181,165,178,165,0,0,254,1,93,73,73,73,181,128,127,0,0,0,0,0,73,1,254,0,0,0,0,0,241,241,241,241,241,241,241,241,241,241,241,241,241,241,241,241,241,241,241,241,241,241,241,241,241,241,241,241,241,241,241,241
    1551   00:A613  04 A0 18 00 00 7F 80 B5 A5 B2 A5 00 00 FE 01 5D 
    1551   00:A623  49 49 49 B5 80 7F 00 00 00 00 00 49 01 FE 00 00 
    1551   00:A633  00 00 00 F1 F1 F1 F1 F1 F1 F1 F1 F1 F1 F1 F1 F1 
    1551   00:A643  F1 F1 F1 F1 F1 F1 F1 F1 F1 F1 F1 F1 F1 F1 F1 F1 
    1551   00:A653  F1 F1 F1 
    1552   00:A656                             db 5,48,32,0,0,127,128,181,165,178,165,0,0,254,1,93,73,73,73,181,128,127,0,0,0,0,0,73,1,254,0,0,0,0,0,241,241,241,241,241,241,241,241,241,241,241,241,241,241,241,241,241,241,241,241,241,241,241,241,241,241,241,241,241,241,241,241
    1552   00:A656  05 30 20 00 00 7F 80 B5 A5 B2 A5 00 00 FE 01 5D 
    1552   00:A666  49 49 49 B5 80 7F 00 00 00 00 00 49 01 FE 00 00 
    1552   00:A676  00 00 00 F1 F1 F1 F1 F1 F1 F1 F1 F1 F1 F1 F1 F1 
    1552   00:A686  F1 F1 F1 F1 F1 F1 F1 F1 F1 F1 F1 F1 F1 F1 F1 F1 
    1552   00:A696  F1 F1 F1 
    1553   00:A699                             db 6,88,24,0,0,127,128,181,165,178,165,0,0,254,1,93,73,73,73,181,128,127,0,0,0,0,0,73,1,254,0,0,0,0,0,241,241,241,241,241,241,241,241,241,241,241,241,241,241,241,241,241,241,241,241,241,241,241,241,241,241,241,241,241,241,241,241
    1553   00:A699  06 58 18 00 00 7F 80 B5 A5 B2 A5 00 00 FE 01 5D 
    1553   00:A6A9  49 49 49 B5 80 7F 00 00 00 00 00 49 01 FE 00 00 
    1553   00:A6B9  00 00 00 F1 F1 F1 F1 F1 F1 F1 F1 F1 F1 F1 F1 F1 
    1553   00:A6C9  F1 F1 F1 F1 F1 F1 F1 F1 F1 F1 F1 F1 F1 F1 F1 F1 
    1553   00:A6D9  F1 F1 F1 
    1554   00:A6DC                             db 7,48,208,0,0,127,128,181,165,178,165,0,0,254,1,93,73,73,73,181,128,127,0,0,0,0,0,73,1,254,0,0,0,0,0,241,241,241,241,241,241,241,241,241,241,241,241,241,241,241,241,241,241,241,241,241,241,241,241,241,241,241,241,241,241,241,241
    1554   00:A6DC  07 30 D0 00 00 7F 80 B5 A5 B2 A5 00 00 FE 01 5D 
    1554   00:A6EC  49 49 49 B5 80 7F 00 00 00 00 00 49 01 FE 00 00 
    1554   00:A6FC  00 00 00 F1 F1 F1 F1 F1 F1 F1 F1 F1 F1 F1 F1 F1 
    1554   00:A70C  F1 F1 F1 F1 F1 F1 F1 F1 F1 F1 F1 F1 F1 F1 F1 F1 
    1554   00:A71C  F1 F1 F1 
    1555   00:A71F                             db 9,48,208,0,0,127,128,181,165,178,165,0,0,254,1,93,73,73,73,181,128,127,0,0,0,0,0,73,1,254,0,0,0,0,0,241,241,241,241,241,241,241,241,241,241,241,241,241,241,241,241,241,241,241,241,241,241,241,241,241,241,241,241,241,241,241,241
    1555   00:A71F  09 30 D0 00 00 7F 80 B5 A5 B2 A5 00 00 FE 01 5D 
    1555   00:A72F  49 49 49 B5 80 7F 00 00 00 00 00 49 01 FE 00 00 
    1555   00:A73F  00 00 00 F1 F1 F1 F1 F1 F1 F1 F1 F1 F1 F1 F1 F1 
    1555   00:A74F  F1 F1 F1 F1 F1 F1 F1 F1 F1 F1 F1 F1 F1 F1 F1 F1 
    1555   00:A75F  F1 F1 F1 
    1556   00:A762                             db 10,160,208,0,0,127,128,181,165,178,165,0,0,254,1,93,73,73,73,181,128,127,0,0,0,0,0,73,1,254,0,0,0,0,0,241,241,241,241,241,241,241,241,241,241,241,241,241,241,241,241,241,241,241,241,241,241,241,241,241,241,241,241,241,241,241,241
    1556   00:A762  0A A0 D0 00 00 7F 80 B5 A5 B2 A5 00 00 FE 01 5D 
    1556   00:A772  49 49 49 B5 80 7F 00 00 00 00 00 49 01 FE 00 00 
    1556   00:A782  00 00 00 F1 F1 F1 F1 F1 F1 F1 F1 F1 F1 F1 F1 F1 
    1556   00:A792  F1 F1 F1 F1 F1 F1 F1 F1 F1 F1 F1 F1 F1 F1 F1 F1 
    1556   00:A7A2  F1 F1 F1 
    1557   00:A7A5                             db 11,160,208,0,0,127,128,181,165,178,165,0,0,254,1,93,73,73,73,181,128,127,0,0,0,0,0,73,1,254,0,0,0,0,0,241,241,241,241,241,241,241,241,241,241,241,241,241,241,241,241,241,241,241,241,241,241,241,241,241,241,241,241,241,241,241,241
    1557   00:A7A5  0B A0 D0 00 00 7F 80 B5 A5 B2 A5 00 00 FE 01 5D 
    1557   00:A7B5  49 49 49 B5 80 7F 00 00 00 00 00 49 01 FE 00 00 
    1557   00:A7C5  00 00 00 F1 F1 F1 F1 F1 F1 F1 F1 F1 F1 F1 F1 F1 
    1557   00:A7D5  F1 F1 F1 F1 F1 F1 F1 F1 F1 F1 F1 F1 F1 F1 F1 F1 
    1557   00:A7E5  F1 F1 F1 
    1558   00:A7E8                             db 12,48,216,0,0,127,128,181,165,178,165,0,0,254,1,93,73,73,73,181,128,127,0,0,0,0,0,73,1,254,0,0,0,0,0,241,241,241,241,241,241,241,241,241,241,241,241,241,241,241,241,241,241,241,241,241,241,241,241,241,241,241,241,241,241,241,241
    1558   00:A7E8  0C 30 D8 00 00 7F 80 B5 A5 B2 A5 00 00 FE 01 5D 
    1558   00:A7F8  49 49 49 B5 80 7F 00 00 00 00 00 49 01 FE 00 00 
    1558   00:A808  00 00 00 F1 F1 F1 F1 F1 F1 F1 F1 F1 F1 F1 F1 F1 
    1558   00:A818  F1 F1 F1 F1 F1 F1 F1 F1 F1 F1 F1 F1 F1 F1 F1 F1 
    1558   00:A828  F1 F1 F1 
    1559   00:A82B                             db 13,80,216,0,0,127,128,181,165,178,165,0,0,254,1,93,73,73,73,181,128,127,0,0,0,0,0,73,1,254,0,0,0,0,0,241,241,241,241,241,241,241,241,241,241,241,241,241,241,241,241,241,241,241,241,241,241,241,241,241,241,241,241,241,241,241,241
    1559   00:A82B  0D 50 D8 00 00 7F 80 B5 A5 B2 A5 00 00 FE 01 5D 
    1559   00:A83B  49 49 49 B5 80 7F 00 00 00 00 00 49 01 FE 00 00 
    1559   00:A84B  00 00 00 F1 F1 F1 F1 F1 F1 F1 F1 F1 F1 F1 F1 F1 
    1559   00:A85B  F1 F1 F1 F1 F1 F1 F1 F1 F1 F1 F1 F1 F1 F1 F1 F1 
    1559   00:A86B  F1 F1 F1 
    1560   00:A86E                             db 8,48,32,0,0,127,128,181,165,178,165,0,0,254,1,93,73,73,73,181,128,127,0,0,0,0,0,73,1,254,0,0,0,0,0,241,241,241,241,241,241,241,241,241,241,241,241,241,241,241,241,241,241,241,241,241,241,241,241,241,241,241,241,241,241,241,241
    1560   00:A86E  08 30 20 00 00 7F 80 B5 A5 B2 A5 00 00 FE 01 5D 
    1560   00:A87E  49 49 49 B5 80 7F 00 00 00 00 00 49 01 FE 00 00 
    1560   00:A88E  00 00 00 F1 F1 F1 F1 F1 F1 F1 F1 F1 F1 F1 F1 F1 
    1560   00:A89E  F1 F1 F1 F1 F1 F1 F1 F1 F1 F1 F1 F1 F1 F1 F1 F1 
    1560   00:A8AE  F1 F1 F1 
    1561   00:A8B1                             db 14,160,216,0,0,127,128,181,165,178,165,0,0,254,1,93,73,73,73,181,128,127,0,0,0,0,0,73,1,254,0,0,0,0,0,241,241,241,241,241,241,241,241,241,241,241,241,241,241,241,241,241,241,241,241,241,241,241,241,241,241,241,241,241,241,241,241
    1561   00:A8B1  0E A0 D8 00 00 7F 80 B5 A5 B2 A5 00 00 FE 01 5D 
    1561   00:A8C1  49 49 49 B5 80 7F 00 00 00 00 00 49 01 FE 00 00 
    1561   00:A8D1  00 00 00 F1 F1 F1 F1 F1 F1 F1 F1 F1 F1 F1 F1 F1 
    1561   00:A8E1  F1 F1 F1 F1 F1 F1 F1 F1 F1 F1 F1 F1 F1 F1 F1 F1 
    1561   00:A8F1  F1 F1 F1 
    1562   00:A8F4                             db 15,48,160,0,0,127,128,181,165,178,165,0,0,254,1,93,73,73,73,181,128,127,0,0,0,0,0,73,1,254,0,0,0,0,0,241,241,241,241,241,241,241,241,241,241,241,241,241,241,241,241,241,241,241,241,241,241,241,241,241,241,241,241,241,241,241,241
    1562   00:A8F4  0F 30 A0 00 00 7F 80 B5 A5 B2 A5 00 00 FE 01 5D 
    1562   00:A904  49 49 49 B5 80 7F 00 00 00 00 00 49 01 FE 00 00 
    1562   00:A914  00 00 00 F1 F1 F1 F1 F1 F1 F1 F1 F1 F1 F1 F1 F1 
    1562   00:A924  F1 F1 F1 F1 F1 F1 F1 F1 F1 F1 F1 F1 F1 F1 F1 F1 
    1562   00:A934  F1 F1 F1 
    1563   00:A937                             db 16,48,96,0,0,127,128,181,165,178,165,0,0,254,1,93,73,73,73,181,128,127,0,0,0,0,0,73,1,254,0,0,0,0,0,241,241,241,241,241,241,241,241,241,241,241,241,241,241,241,241,241,241,241,241,241,241,241,241,241,241,241,241,241,241,241,241
    1563   00:A937  10 30 60 00 00 7F 80 B5 A5 B2 A5 00 00 FE 01 5D 
    1563   00:A947  49 49 49 B5 80 7F 00 00 00 00 00 49 01 FE 00 00 
    1563   00:A957  00 00 00 F1 F1 F1 F1 F1 F1 F1 F1 F1 F1 F1 F1 F1 
    1563   00:A967  F1 F1 F1 F1 F1 F1 F1 F1 F1 F1 F1 F1 F1 F1 F1 F1 
    1563   00:A977  F1 F1 F1 
    1564   00:A97A                             db 17,160,208,0,0,127,128,181,165,178,165,0,0,254,1,93,73,73,73,181,128,127,0,0,0,0,0,73,1,254,0,0,0,0,0,241,241,241,241,241,241,241,241,241,241,241,241,241,241,241,241,241,241,241,241,241,241,241,241,241,241,241,241,241,241,241,241
    1564   00:A97A  11 A0 D0 00 00 7F 80 B5 A5 B2 A5 00 00 FE 01 5D 
    1564   00:A98A  49 49 49 B5 80 7F 00 00 00 00 00 49 01 FE 00 00 
    1564   00:A99A  00 00 00 F1 F1 F1 F1 F1 F1 F1 F1 F1 F1 F1 F1 F1 
    1564   00:A9AA  F1 F1 F1 F1 F1 F1 F1 F1 F1 F1 F1 F1 F1 F1 F1 F1 
    1564   00:A9BA  F1 F1 F1 
    1565   00:A9BD                             db 18,48,168,0,0,127,128,181,165,178,165,0,0,254,1,93,73,73,73,181,128,127,0,0,0,0,0,73,1,254,0,0,0,0,0,241,241,241,241,241,241,241,241,241,241,241,241,241,241,241,241,241,241,241,241,241,241,241,241,241,241,241,241,241,241,241,241
    1565   00:A9BD  12 30 A8 00 00 7F 80 B5 A5 B2 A5 00 00 FE 01 5D 
    1565   00:A9CD  49 49 49 B5 80 7F 00 00 00 00 00 49 01 FE 00 00 
    1565   00:A9DD  00 00 00 F1 F1 F1 F1 F1 F1 F1 F1 F1 F1 F1 F1 F1 
    1565   00:A9ED  F1 F1 F1 F1 F1 F1 F1 F1 F1 F1 F1 F1 F1 F1 F1 F1 
    1565   00:A9FD  F1 F1 F1 
    1566   00:AA00                             db 19,48,80,0,0,127,128,181,165,178,165,0,0,254,1,93,73,73,73,181,128,127,0,0,0,0,0,73,1,254,0,0,0,0,0,241,241,241,241,241,241,241,241,241,241,241,241,241,241,241,241,241,241,241,241,241,241,241,241,241,241,241,241,241,241,241,241
    1566   00:AA00  13 30 50 00 00 7F 80 B5 A5 B2 A5 00 00 FE 01 5D 
    1566   00:AA10  49 49 49 B5 80 7F 00 00 00 00 00 49 01 FE 00 00 
    1566   00:AA20  00 00 00 F1 F1 F1 F1 F1 F1 F1 F1 F1 F1 F1 F1 F1 
    1566   00:AA30  F1 F1 F1 F1 F1 F1 F1 F1 F1 F1 F1 F1 F1 F1 F1 F1 
    1566   00:AA40  F1 F1 F1 
    1567   00:AA43                             db 20,88,216,0,0,127,128,181,165,178,165,0,0,254,1,93,73,73,73,181,128,127,0,0,0,0,0,73,1,254,0,0,0,0,0,241,241,241,241,241,241,241,241,241,241,241,241,241,241,241,241,241,241,241,241,241,241,241,241,241,241,241,241,241,241,241,241
    1567   00:AA43  14 58 D8 00 00 7F 80 B5 A5 B2 A5 00 00 FE 01 5D 
    1567   00:AA53  49 49 49 B5 80 7F 00 00 00 00 00 49 01 FE 00 00 
    1567   00:AA63  00 00 00 F1 F1 F1 F1 F1 F1 F1 F1 F1 F1 F1 F1 F1 
    1567   00:AA73  F1 F1 F1 F1 F1 F1 F1 F1 F1 F1 F1 F1 F1 F1 F1 F1 
    1567   00:AA83  F1 F1 F1 
    1568   00:AA86                             db 21,128,96,0,0,127,128,181,165,178,165,0,0,254,1,93,73,73,73,181,128,127,0,0,0,0,0,73,1,254,0,0,0,0,0,241,241,241,241,241,241,241,241,241,241,241,241,241,241,241,241,241,241,241,241,241,241,241,241,241,241,241,241,241,241,241,241
    1568   00:AA86  15 80 60 00 00 7F 80 B5 A5 B2 A5 00 00 FE 01 5D 
    1568   00:AA96  49 49 49 B5 80 7F 00 00 00 00 00 49 01 FE 00 00 
    1568   00:AAA6  00 00 00 F1 F1 F1 F1 F1 F1 F1 F1 F1 F1 F1 F1 F1 
    1568   00:AAB6  F1 F1 F1 F1 F1 F1 F1 F1 F1 F1 F1 F1 F1 F1 F1 F1 
    1568   00:AAC6  F1 F1 F1 
    1569   00:AAC9                             db 22,88,24,0,0,127,128,181,165,178,165,0,0,254,1,93,73,73,73,181,128,127,0,0,0,0,0,73,1,254,0,0,0,0,0,241,241,241,241,241,241,241,241,241,241,241,241,241,241,241,241,241,241,241,241,241,241,241,241,241,241,241,241,241,241,241,241
    1569   00:AAC9  16 58 18 00 00 7F 80 B5 A5 B2 A5 00 00 FE 01 5D 
    1569   00:AAD9  49 49 49 B5 80 7F 00 00 00 00 00 49 01 FE 00 00 
    1569   00:AAE9  00 00 00 F1 F1 F1 F1 F1 F1 F1 F1 F1 F1 F1 F1 F1 
    1569   00:AAF9  F1 F1 F1 F1 F1 F1 F1 F1 F1 F1 F1 F1 F1 F1 F1 F1 
    1569   00:AB09  F1 F1 F1 
    1570   00:AB0C                             db 23,160,24,0,0,127,128,181,165,178,165,0,0,254,1,93,73,73,73,181,128,127,0,0,0,0,0,73,1,254,0,0,0,0,0,241,241,241,241,241,241,241,241,241,241,241,241,241,241,241,241,241,241,241,241,241,241,241,241,241,241,241,241,241,241,241,241
    1570   00:AB0C  17 A0 18 00 00 7F 80 B5 A5 B2 A5 00 00 FE 01 5D 
    1570   00:AB1C  49 49 49 B5 80 7F 00 00 00 00 00 49 01 FE 00 00 
    1570   00:AB2C  00 00 00 F1 F1 F1 F1 F1 F1 F1 F1 F1 F1 F1 F1 F1 
    1570   00:AB3C  F1 F1 F1 F1 F1 F1 F1 F1 F1 F1 F1 F1 F1 F1 F1 F1 
    1570   00:AB4C  F1 F1 F1 
    1571   00:AB4F                             db 24,160,216,0,0,127,128,181,165,178,165,0,0,254,1,93,73,73,73,181,128,127,0,0,0,0,0,73,1,254,0,0,0,0,0,241,241,241,241,241,241,241,241,241,241,241,241,241,241,241,241,241,241,241,241,241,241,241,241,241,241,241,241,241,241,241,241
    1571   00:AB4F  18 A0 D8 00 00 7F 80 B5 A5 B2 A5 00 00 FE 01 5D 
    1571   00:AB5F  49 49 49 B5 80 7F 00 00 00 00 00 49 01 FE 00 00 
    1571   00:AB6F  00 00 00 F1 F1 F1 F1 F1 F1 F1 F1 F1 F1 F1 F1 F1 
    1571   00:AB7F  F1 F1 F1 F1 F1 F1 F1 F1 F1 F1 F1 F1 F1 F1 F1 F1 
    1571   00:AB8F  F1 F1 F1 
    1572   00:AB92                             db 25,48,24,0,0,127,128,181,165,178,165,0,0,254,1,93,73,73,73,181,128,127,0,0,0,0,0,73,1,254,0,0,0,0,0,241,241,241,241,241,241,241,241,241,241,241,241,241,241,241,241,241,241,241,241,241,241,241,241,241,241,241,241,241,241,241,241
    1572   00:AB92  19 30 18 00 00 7F 80 B5 A5 B2 A5 00 00 FE 01 5D 
    1572   00:ABA2  49 49 49 B5 80 7F 00 00 00 00 00 49 01 FE 00 00 
    1572   00:ABB2  00 00 00 F1 F1 F1 F1 F1 F1 F1 F1 F1 F1 F1 F1 F1 
    1572   00:ABC2  F1 F1 F1 F1 F1 F1 F1 F1 F1 F1 F1 F1 F1 F1 F1 F1 
    1572   00:ABD2  F1 F1 F1 
    1573   00:ABD5                             db 26,104,24,0,0,127,128,181,165,178,165,0,0,254,1,93,73,73,73,181,128,127,0,0,0,0,0,73,1,254,0,0,0,0,0,241,241,241,241,241,241,241,241,241,241,241,241,241,241,241,241,241,241,241,241,241,241,241,241,241,241,241,241,241,241,241,241
    1573   00:ABD5  1A 68 18 00 00 7F 80 B5 A5 B2 A5 00 00 FE 01 5D 
    1573   00:ABE5  49 49 49 B5 80 7F 00 00 00 00 00 49 01 FE 00 00 
    1573   00:ABF5  00 00 00 F1 F1 F1 F1 F1 F1 F1 F1 F1 F1 F1 F1 F1 
    1573   00:AC05  F1 F1 F1 F1 F1 F1 F1 F1 F1 F1 F1 F1 F1 F1 F1 F1 
    1573   00:AC15  F1 F1 F1 
    1574   00:AC18                             db 27,160,216,0,0,127,128,181,165,178,165,0,0,254,1,93,73,73,73,181,128,127,0,0,0,0,0,73,1,254,0,0,0,0,0,241,241,241,241,241,241,241,241,241,241,241,241,241,241,241,241,241,241,241,241,241,241,241,241,241,241,241,241,241,241,241,241
    1574   00:AC18  1B A0 D8 00 00 7F 80 B5 A5 B2 A5 00 00 FE 01 5D 
    1574   00:AC28  49 49 49 B5 80 7F 00 00 00 00 00 49 01 FE 00 00 
    1574   00:AC38  00 00 00 F1 F1 F1 F1 F1 F1 F1 F1 F1 F1 F1 F1 F1 
    1574   00:AC48  F1 F1 F1 F1 F1 F1 F1 F1 F1 F1 F1 F1 F1 F1 F1 F1 
    1574   00:AC58  F1 F1 F1 
    1575   00:AC5B                             db 28,48,72,0,0,127,128,181,165,178,165,0,0,254,1,93,73,73,73,181,128,127,0,0,0,0,0,73,1,254,0,0,0,0,0,241,241,241,241,241,241,241,241,241,241,241,241,241,241,241,241,241,241,241,241,241,241,241,241,241,241,241,241,241,241,241,241
    1575   00:AC5B  1C 30 48 00 00 7F 80 B5 A5 B2 A5 00 00 FE 01 5D 
    1575   00:AC6B  49 49 49 B5 80 7F 00 00 00 00 00 49 01 FE 00 00 
    1575   00:AC7B  00 00 00 F1 F1 F1 F1 F1 F1 F1 F1 F1 F1 F1 F1 F1 
    1575   00:AC8B  F1 F1 F1 F1 F1 F1 F1 F1 F1 F1 F1 F1 F1 F1 F1 F1 
    1575   00:AC9B  F1 F1 F1 
    1576   00:AC9E                             db 29,104,120,0,0,127,128,181,165,178,165,0,0,254,1,93,73,73,73,181,128,127,0,0,0,0,0,73,1,254,0,0,0,0,0,241,241,241,241,241,241,241,241,241,241,241,241,241,241,241,241,241,241,241,241,241,241,241,241,241,241,241,241,241,241,241,241
    1576   00:AC9E  1D 68 78 00 00 7F 80 B5 A5 B2 A5 00 00 FE 01 5D 
    1576   00:ACAE  49 49 49 B5 80 7F 00 00 00 00 00 49 01 FE 00 00 
    1576   00:ACBE  00 00 00 F1 F1 F1 F1 F1 F1 F1 F1 F1 F1 F1 F1 F1 
    1576   00:ACCE  F1 F1 F1 F1 F1 F1 F1 F1 F1 F1 F1 F1 F1 F1 F1 F1 
    1576   00:ACDE  F1 F1 F1 
    1577   00:ACE1                             db 30,128,24,0,0,127,128,181,165,178,165,0,0,254,1,93,73,73,73,181,128,127,0,0,0,0,0,73,1,254,0,0,0,0,0,241,241,241,241,241,241,241,241,241,241,241,241,241,241,241,241,241,241,241,241,241,241,241,241,241,241,241,241,241,241,241,241
    1577   00:ACE1  1E 80 18 00 00 7F 80 B5 A5 B2 A5 00 00 FE 01 5D 
    1577   00:ACF1  49 49 49 B5 80 7F 00 00 00 00 00 49 01 FE 00 00 
    1577   00:AD01  00 00 00 F1 F1 F1 F1 F1 F1 F1 F1 F1 F1 F1 F1 F1 
    1577   00:AD11  F1 F1 F1 F1 F1 F1 F1 F1 F1 F1 F1 F1 F1 F1 F1 F1 
    1577   00:AD21  F1 F1 F1 
    1578   00:AD24  (00:AD24)           palett:	equ $
    1579   00:AD24                             defw $0,$0,$611,$733,$117,$327,$151,$627,$171,$373,$661,$664,$411,$265,$555,$777
    1579   00:AD24  00 00 00 00 11 06 33 07 17 01 27 03 51 01 27 06 
    1579   00:AD34  71 01 73 03 61 06 64 06 11 04 65 02 55 05 77 07 
    1580   00:AD44  (00:AD44)           font:	equ $
    1581   00:AD44                             db 0,0,0,0,0,0,0,0
    1581   00:AD44  00 00 00 00 00 00 00 00 
    1582   00:AD4C                             db 0,48,48,48,48,0,48,0
    1582   00:AD4C  00 30 30 30 30 00 30 00 
    1583   00:AD54                             db 0,108,108,0,0,0,0,0
    1583   00:AD54  00 6C 6C 00 00 00 00 00 
    1584   00:AD5C                             db 0,108,254,108,108,254,108,0
    1584   00:AD5C  00 6C FE 6C 6C FE 6C 00 
    1585   00:AD64                             db 0,24,126,120,126,30,126,24
    1585   00:AD64  00 18 7E 78 7E 1E 7E 18 
    1586   00:AD6C                             db 0,230,236,24,48,110,206,0
    1586   00:AD6C  00 E6 EC 18 30 6E CE 00 
    1587   00:AD74                             db 0,48,120,48,126,204,126,0
    1587   00:AD74  00 30 78 30 7E CC 7E 00 
    1588   00:AD7C                             db 0,24,48,0,0,0,0,0
    1588   00:AD7C  00 18 30 00 00 00 00 00 
    1589   00:AD84                             db 112,64,64,64,64,64,112,0
    1589   00:AD84  70 40 40 40 40 40 70 00 
    1590   00:AD8C                             db 56,8,8,8,8,8,56,0
    1590   00:AD8C  38 08 08 08 08 08 38 00 
    1591   00:AD94                             db 0,0,60,24,126,24,60,0
    1591   00:AD94  00 00 3C 18 7E 18 3C 00 
    1592   00:AD9C                             db 0,0,24,24,126,24,24,0
    1592   00:AD9C  00 00 18 18 7E 18 18 00 
    1593   00:ADA4                             db 0,0,0,0,0,0,16,48
    1593   00:ADA4  00 00 00 00 00 00 10 30 
    1594   00:ADAC                             db 0,0,60,36,36,60,0,0
    1594   00:ADAC  00 00 3C 24 24 3C 00 00 
    1595   00:ADB4                             db 0,0,0,0,0,56,56,0
    1595   00:ADB4  00 00 00 00 00 38 38 00 
    1596   00:ADBC                             db 0,0,6,12,24,48,96,0
    1596   00:ADBC  00 00 06 0C 18 30 60 00 
    1597   00:ADC4                             db 254,130,178,170,154,130,254,0
    1597   00:ADC4  FE 82 B2 AA 9A 82 FE 00 
    1598   00:ADCC                             db 254,206,238,238,238,130,254,0
    1598   00:ADCC  FE CE EE EE EE 82 FE 00 
    1599   00:ADD4                             db 254,130,250,130,190,130,254,0
    1599   00:ADD4  FE 82 FA 82 BE 82 FE 00 
    1600   00:ADDC                             db 254,130,250,226,250,130,254,0
    1600   00:ADDC  FE 82 FA E2 FA 82 FE 00 
    1601   00:ADE4                             db 254,190,174,174,130,238,254,0
    1601   00:ADE4  FE BE AE AE 82 EE FE 00 
    1602   00:ADEC                             db 254,130,190,130,250,130,254,0
    1602   00:ADEC  FE 82 BE 82 FA 82 FE 00 
    1603   00:ADF4                             db 254,190,190,130,186,130,254,0
    1603   00:ADF4  FE BE BE 82 BA 82 FE 00 
    1604   00:ADFC                             db 254,130,250,250,250,250,254,0
    1604   00:ADFC  FE 82 FA FA FA FA FE 00 
    1605   00:AE04                             db 254,130,186,130,186,130,254,0
    1605   00:AE04  FE 82 BA 82 BA 82 FE 00 
    1606   00:AE0C                             db 254,130,186,130,250,250,254,0
    1606   00:AE0C  FE 82 BA 82 FA FA FE 00 
    1607   00:AE14                             db 0,48,48,0,48,48,0,0
    1607   00:AE14  00 30 30 00 30 30 00 00 
    1608   00:AE1C                             db 0,0,48,0,0,48,48,96
    1608   00:AE1C  00 00 30 00 00 30 30 60 
    1609   00:AE24                             db 254,158,190,190,190,158,254,0
    1609   00:AE24  FE 9E BE BE BE 9E FE 00 
    1610   00:AE2C                             db 0,0,0,126,0,126,0,0
    1610   00:AE2C  00 00 00 7E 00 7E 00 00 
    1611   00:AE34                             db 0,0,48,24,12,24,48,0
    1611   00:AE34  00 00 30 18 0C 18 30 00 
    1612   00:AE3C                             db 0,124,198,12,24,0,24,0
    1612   00:AE3C  00 7C C6 0C 18 00 18 00 
    1613   00:AE44                             db 0,124,222,254,254,192,124,0
    1613   00:AE44  00 7C DE FE FE C0 7C 00 
    1614   00:AE4C                             db 254,130,186,130,186,186,254,0
    1614   00:AE4C  FE 82 BA 82 BA BA FE 00 
    1615   00:AE54                             db 254,134,182,130,186,130,254,0
    1615   00:AE54  FE 86 B6 82 BA 82 FE 00 
    1616   00:AE5C                             db 254,130,190,190,190,130,254,0
    1616   00:AE5C  FE 82 BE BE BE 82 FE 00 
    1617   00:AE64                             db 254,134,186,186,186,134,254,0
    1617   00:AE64  FE 86 BA BA BA 86 FE 00 
    1618   00:AE6C                             db 254,130,190,142,190,130,254,0
    1618   00:AE6C  FE 82 BE 8E BE 82 FE 00 
    1619   00:AE74                             db 254,130,190,142,190,190,254,0
    1619   00:AE74  FE 82 BE 8E BE BE FE 00 
    1620   00:AE7C                             db 254,130,190,178,186,130,254,0
    1620   00:AE7C  FE 82 BE B2 BA 82 FE 00 
    1621   00:AE84                             db 254,186,186,130,186,186,254,0
    1621   00:AE84  FE BA BA 82 BA BA FE 00 
    1622   00:AE8C                             db 254,130,238,238,238,130,254,0
    1622   00:AE8C  FE 82 EE EE EE 82 FE 00 
    1623   00:AE94                             db 254,130,250,250,186,130,254,0
    1623   00:AE94  FE 82 FA FA BA 82 FE 00 
    1624   00:AE9C                             db 254,186,182,142,182,186,254,0
    1624   00:AE9C  FE BA B6 8E B6 BA FE 00 
    1625   00:AEA4                             db 254,190,190,190,190,130,254,0
    1625   00:AEA4  FE BE BE BE BE 82 FE 00 
    1626   00:AEAC                             db 254,130,170,170,170,186,254,0
    1626   00:AEAC  FE 82 AA AA AA BA FE 00 
    1627   00:AEB4                             db 254,186,154,170,178,186,254,0
    1627   00:AEB4  FE BA 9A AA B2 BA FE 00 
    1628   00:AEBC                             db 254,130,186,186,186,130,254,0
    1628   00:AEBC  FE 82 BA BA BA 82 FE 00 
    1629   00:AEC4                             db 254,134,186,134,190,190,254,0
    1629   00:AEC4  FE 86 BA 86 BE BE FE 00 
    1630   00:AECC                             db 254,130,186,170,178,130,254,0
    1630   00:AECC  FE 82 BA AA B2 82 FE 00 
    1631   00:AED4                             db 254,134,182,130,186,186,254,0
    1631   00:AED4  FE 86 B6 82 BA BA FE 00 
    1632   00:AEDC                             db 254,130,190,130,250,130,254,0
    1632   00:AEDC  FE 82 BE 82 FA 82 FE 00 
    1633   00:AEE4                             db 254,130,238,238,238,238,254,0
    1633   00:AEE4  FE 82 EE EE EE EE FE 00 
    1634   00:AEEC                             db 254,186,186,186,186,198,254,0
    1634   00:AEEC  FE BA BA BA BA C6 FE 00 
    1635   00:AEF4                             db 254,186,186,186,214,238,254,0
    1635   00:AEF4  FE BA BA BA D6 EE FE 00 
    1636   00:AEFC                             db 254,186,186,170,170,130,254,0
    1636   00:AEFC  FE BA BA AA AA 82 FE 00 
    1637   00:AF04                             db 254,186,214,238,214,186,254,0
    1637   00:AF04  FE BA D6 EE D6 BA FE 00 
    1638   00:AF0C                             db 254,186,186,130,250,130,254,0
    1638   00:AF0C  FE BA BA 82 FA 82 FE 00 
    1639   00:AF14                             db 254,130,246,238,222,130,254,0
    1639   00:AF14  FE 82 F6 EE DE 82 FE 00 
    1640   00:AF1C                             db 0,30,24,24,24,24,30,0
    1640   00:AF1C  00 1E 18 18 18 18 1E 00 
    1641   00:AF24                             db 0,0,192,96,48,24,12,0
    1641   00:AF24  00 00 C0 60 30 18 0C 00 
    1642   00:AF2C                             db 0,240,48,48,48,48,240,0
    1642   00:AF2C  00 F0 30 30 30 30 F0 00 
    1643   00:AF34                             db 0,48,120,252,48,48,48,0
    1643   00:AF34  00 30 78 FC 30 30 30 00 
    1644   00:AF3C                             db 0,0,0,0,0,0,0,255
    1644   00:AF3C  00 00 00 00 00 00 00 FF 
    1645   00:AF44                             db 0,60,102,248,96,96,254,0
    1645   00:AF44  00 3C 66 F8 60 60 FE 00 
    1646   00:AF4C                             db 0,0,120,12,124,204,124,0
    1646   00:AF4C  00 00 78 0C 7C CC 7C 00 
    1647   00:AF54                             db 0,96,96,124,102,102,124,0
    1647   00:AF54  00 60 60 7C 66 66 7C 00 
    1648   00:AF5C                             db 0,0,60,96,96,96,60,0
    1648   00:AF5C  00 00 3C 60 60 60 3C 00 
    1649   00:AF64                             db 0,12,12,124,204,204,124,0
    1649   00:AF64  00 0C 0C 7C CC CC 7C 00 
    1650   00:AF6C                             db 0,0,120,204,248,192,124,0
    1650   00:AF6C  00 00 78 CC F8 C0 7C 00 
    1651   00:AF74                             db 0,28,48,56,48,48,48,0
    1651   00:AF74  00 1C 30 38 30 30 30 00 
    1652   00:AF7C                             db 0,0,124,204,204,124,12,120
    1652   00:AF7C  00 00 7C CC CC 7C 0C 78 
    1653   00:AF84                             db 0,192,192,248,204,204,204,0
    1653   00:AF84  00 C0 C0 F8 CC CC CC 00 
    1654   00:AF8C                             db 0,48,0,112,48,48,120,0
    1654   00:AF8C  00 30 00 70 30 30 78 00 
    1655   00:AF94                             db 0,12,0,12,12,12,108,56
    1655   00:AF94  00 0C 00 0C 0C 0C 6C 38 
    1656   00:AF9C                             db 0,96,120,112,112,120,108,0
    1656   00:AF9C  00 60 78 70 70 78 6C 00 
    1657   00:AFA4                             db 0,48,48,48,48,48,28,0
    1657   00:AFA4  00 30 30 30 30 30 1C 00 
    1658   00:AFAC                             db 0,0,248,252,252,252,252,0
    1658   00:AFAC  00 00 F8 FC FC FC FC 00 
    1659   00:AFB4                             db 0,0,248,204,204,204,204,0
    1659   00:AFB4  00 00 F8 CC CC CC CC 00 
    1660   00:AFBC                             db 0,0,120,204,204,204,120,0
    1660   00:AFBC  00 00 78 CC CC CC 78 00 
    1661   00:AFC4                             db 0,0,248,204,204,248,192,192
    1661   00:AFC4  00 00 F8 CC CC F8 C0 C0 
    1662   00:AFCC                             db 0,0,124,204,204,124,12,14
    1662   00:AFCC  00 00 7C CC CC 7C 0C 0E 
    1663   00:AFD4                             db 0,0,60,96,96,96,96,0
    1663   00:AFD4  00 00 3C 60 60 60 60 00 
    1664   00:AFDC                             db 0,0,120,192,120,12,248,0
    1664   00:AFDC  00 00 78 C0 78 0C F8 00 
    1665   00:AFE4                             db 0,48,120,48,48,48,28,0
    1665   00:AFE4  00 30 78 30 30 30 1C 00 
    1666   00:AFEC                             db 0,0,204,204,204,204,120,0
    1666   00:AFEC  00 00 CC CC CC CC 78 00 
    1667   00:AFF4                             db 0,0,204,204,120,120,48,0
    1667   00:AFF4  00 00 CC CC 78 78 30 00 
    1668   00:AFFC                             db 0,0,204,252,252,252,120,0
    1668   00:AFFC  00 00 CC FC FC FC 78 00 
    1669   00:B004                             db 0,0,204,120,48,120,204,0
    1669   00:B004  00 00 CC 78 30 78 CC 00 
    1670   00:B00C                             db 0,0,204,204,204,124,12,120
    1670   00:B00C  00 00 CC CC CC 7C 0C 78 
    1671   00:B014                             db 0,0,252,24,48,96,252,0
    1671   00:B014  00 00 FC 18 30 60 FC 00 
    1672   00:B01C                             db 0,30,24,112,24,24,30,0
    1672   00:B01C  00 1E 18 70 18 18 1E 00 
    1673   00:B024                             db 0,24,24,24,24,24,24,0
    1673   00:B024  00 18 18 18 18 18 18 00 
    1674   00:B02C                             db 0,240,48,28,48,48,240,0
    1674   00:B02C  00 F0 30 1C 30 30 F0 00 
    1675   00:B034                             db 0,60,120,0,0,0,0,0
    1675   00:B034  00 3C 78 00 00 00 00 00 
    1676   00:B03C                             db 254,206,182,190,182,206,254,0
    1676   00:B03C  FE CE B6 BE B6 CE FE 00 
    1677   00:B044                      jtab:	
    1678   00:B044                             db 248,250,252,254,254,255,255,255,0,0,0,1,1,1,2,2,4,6,8,8,8,99
    1678   00:B044  F8 FA FC FE FE FF FF FF 00 00 00 01 01 01 02 02 
    1678   00:B054  04 06 08 08 08 63 
    1679   00:B05A                      keytab:	defw $28,$540,$28,$28,$28,$28,$28,$601,$602,$603,$604; Game engine code --------------------------------------------------------------
    1679   00:B05A  28 00 40 05 28 00 28 00 28 00 28 00 28 00 01 06 
    1679   00:B06A  02 06 03 06 04 06 
    1680   00:B070                      
    1681   00:B070                      ; DEFINE DEBUG
    1682   00:B070                      ; DEFINE FASTVRAMDUMP
    1683   00:B070                      
    1684   00:B070                      ; Arcade Game Designer.
    1685   00:B070                      ; (C) 2008 - 2018 Jonathan Cauldwell.
    1686   00:B070                      ; MSX version (C) jltursan
    1687   00:B070                      ; Based on ZX Spectrum Engine v0.7.4
    1688   00:B070                      ;
    1689   00:B070                      ; Notes about Music & SFX engine
    1690   00:B070                      ; From the EngineMSX itself, 5 routines are being called right now:
    1691   00:B070                      ;
    1692   00:B070                      ; * music_init => initializes the music engine. If your engine doesn't needs this, use ret to do nothing
    1693   00:B070                      ; * music_play => plays a music frame from the ISR. The idea is to set a buffer with all the PSG register ready to dump
    1694   00:B070                      ; but also must implement:
    1695   00:B070                      ; * music_loopoff
    1696   00:B070                      ; * music_loopon
    1697   00:B070                      ; * music_set
    1698   00:B070                      ; * music_mute
    1699   00:B070                      ; * sfx_init => initializes the sfx engine. Idem
    1700   00:B070                      ; * sfx_play => plays a sfx frame from the ISR. Idem
    1701   00:B070                      ; * psgrout => generic routine to dump all PSG registers
    1702   00:B070                      ;
    1703   00:B070                      ; Fixed: Now evnt18 (game completed) doesn't disables sprites at all; so you can use the sprites in an ending scene (if you need to hide them, use now SPRITESOFF)
    1704   00:B070                      ; Added: Due the change in evnt18, a new command SPRITESOFF has been added to the compiler, it hides all sprites by setting 208 Y-coord to sprite 0
    1705   00:B070                      ; Fixed: CLS & CLW routines now erase scrmap buffer and also disable sprites (Thanks to FX).
    1706   00:B070                      ; Fixed: ROM stack initialization bug in MSX machines with drives (specially TR)
    1707   00:B070                      ;
    1708   00:B070                      ; Fixed: Sprite flicker bug (MSX freezes) due a byte boundary overrun. Table colltab must not cross a byte boundary to avoid this.
    1709   00:B070                      ; Added: Some cycles saved in plot pixel routine
    1710   00:B070                      ; Added: New command CRUMBLE
    1711   00:B070                      ; Fixed: Keyboard scanning back to 50fps to fix some positioning problems when controlling characters
    1712   00:B070                      ; Fixed: PSG initialization bug filling registers with illegal values
    1713   00:B070                      ; Fixed: Some optimization to the ayFX replayer routine
    1714   00:B070                      ; Fixed: PSG wrong reset sound when multichannel mode active (FX_MODE=1)  
    1715   00:B070                      ; Fixed: Serious bug in the PSG dumping routine (PT3 specially affected)
    1716   00:B070                      ; Added: Support for Metablocks (2x2 characters map blocks)
    1717   00:B070                      ; Fixed: UNDOSPRITEMOVE support
    1718   00:B070                      ; Fixed: Sometimes player sprite was not initialized correctly when changing screen 
    1719   00:B070                      ; Added: New command SPRITESOFF
    1720   00:B070                      ; Fixed: RAM/ROM slot routines changed to a more compatible ones (Thanks JAM!)
    1721   00:B070                      ; Added: Support of forced PAL/NTSC TV modes
    1722   00:B070                      ; Added: PAL/NTSC modes swappable with hotkey (SELECT)
    1723   00:B070                      ; Added: New command THRUST
    1724   00:B070                      ; Added: LZ compression (Pletter) instead RLE for map screens
    1725   00:B070                      ; Added: New command SCREENON
    1726   00:B070                      ; Added: New command SCREENOFF
    1727   00:B070                      
    1728   00:B070                      ;
    1729   00:B070                      ; Core rotuines
    1730   00:B070                      ; ----------------------------------
    1731   00:B070                      ; ptxt => core routine that prints a font character (no color)
    1732   00:B070                      ; pchr => core routine that prints a BLOCK (pattern+color)
    1733   00:B070                      
    1734   00:B070                      /*
    1735   00:B070                    ~ MEANING OF FLAGS
    1736   00:B070                    ~ =========================================
    1737   00:B070                    ~ 
    1738   00:B070                    ~ AFLAG	: Adventure mode
    1739   00:B070                    ~ CFLAG	: Collectables
    1740   00:B070                    ~ CRFLAG	: Crumbling blocks
    1741   00:B070                    ~ DFLAG	: Digging
    1742   00:B070                    ~ EFLAG	: Beeper
    1743   00:B070                    ~ HCFLAG	: Hardware collisions disabled
    1744   00:B070                    ~ LFLAG	: Ladders
    1745   00:B070                    ~ MFLAG	: Menu/Inventory
    1746   00:B070                    ~ MBFLAG	: MetaBlocks
    1747   00:B070                    ~ RTFLAG	: Thrust for rotational control
    1748   00:B070                    ~ OFLAG	: Objects
    1749   00:B070                    ~ PFLAG	: Particles
    1750   00:B070                    ~ QFLAG	: Marquee
    1751   00:B070                    ~ SFLAG	: Scrolling
    1752   00:B070                    ~ TVFREQ	: Force 50Hz(50)/60Hz(60). Only for MSX2 or higher models
    1753   00:B070                    ~ UFLAG	: User routines 
    1754   00:B070                    ~ XFLAG	: PSG SFX
    1755   00:B070                    ~ YFLAG	: PSG Music
    1756   00:B070                    ~ FX_RELATIVE : Relative SFX volume
    1757   00:B070                    ~ FX_MODE 	: SFX replayer mode
    1758   00:B070                    ~ FX_CHANNEL	: Fixed SFX channel (if FX_MODE=0, 1 = C, 2 = B, 3 = A)
    1759   00:B070                    ~ */
    1760   00:B070                      
    1761   00:B070                      ; Distribution types
    1762   00:B070                      
    1763   00:B070  (00:0000)           ROM=0
    1764   00:B070  (00:0001)           DISK=1
    1765   00:B070  (00:0002)           TAPE=2
    1766   00:B070                      
    1767   00:B070                      ; TV modes
    1768   00:B070                      
    1769   00:B070  (00:0001)           PAL=1
    1770   00:B070  (00:0002)           NTSC=2
    1771   00:B070                      
    1772   00:B070                      ; MSX machines characteristics
    1773   00:B070  (00:0018)           MSX_MAXROWS	equ 24
    1774   00:B070  (00:0020)           MSX_MAXCOLS	equ 32
    1775   00:B070  (00:00FF)           MSX_MAXCX	equ 255
    1776   00:B070  (00:00BF)           MSX_MAXCY	equ 191
    1777   00:B070  (00:0010)           MSX_SPRHS	equ 16
    1778   00:B070  (00:0010)           MSX_SPRVS	equ 16
    1779   00:B070                      
    1780   00:B070                      
    1781   00:B070                      ; =============================================================================================
    1782   00:B070                       
    1783   00:B070                      ; Block characteristics.
    1784   00:B070                      
    1785   00:B070  (00:0001)           PLATFM	equ 1               ; platform.
    1786   00:B070  (00:0002)           WALL	equ PLATFM + 1      ; solid wall.
    1787   00:B070  (00:0003)           LADDER	equ WALL + 1        ; ladder.
    1788   00:B070  (00:0004)           FODDER	equ LADDER + 1      ; fodder block.
    1789   00:B070  (00:0005)           DEADLY	equ FODDER + 1      ; deadly block.
    1790   00:B070  (00:0006)           CUSTOM	equ DEADLY + 1      ; custom block.
    1791   00:B070  (00:0007)           WATER	equ CUSTOM + 1      ; water block.
    1792   00:B070  (00:0008)           COLECT	equ WATER + 1       ; collectable block.
    1793   00:B070  (00:0009)           NUMTYP	equ COLECT + 1      ; number of types.
    1794   00:B070                      
    1795   00:B070  (00:0007)           CRUMBLING_SPEED	equ	7		; crumble every 8 frames. Valid values are 7 (every 8),3 (every 4) or 1 (every 2)
    1796   00:B070                      
    1797   00:B070                      ; Objects
    1798   00:B070                      
    1799   00:B070                      	if DISTYPE=ROM
    1800   00:B070                      
    1801   00:B070  (00:0043)           OBJSIZ 	equ 64+3			; size of each object entry, variable bytes are moved to 
    1802   00:B070  (00:0003)           ODTSIZ 	equ 3			   	; object data size
    1803   00:B070                      		
    1804   00:B070                      	else
    1805   00:B070                    ~ 	
    1806   00:B070                    ~ OBJSIZ 	equ 64+6			; size of each object entry
    1807   00:B070                    ~ ODTSIZ 	equ 6			   	; object data size
    1808   00:B070                    ~ 
    1809   00:B070                    ~ 	endif
    1810   00:B070                      
    1811   00:B070                      ; Sprites.
    1812   00:B070                      
    1813   00:B070  (00:0020)           NUMSPR 	equ 32              ; number of sprites.
    1814   00:B070  (00:0011)           TABSIZ 	equ 17              ; size of each entry.
    1815   00:B070  (00:0220)           SPRBUF 	equ NUMSPR * TABSIZ ; size of entire table.
    1816   00:B070  (00:0005)           NMESIZ 	equ 5               ; bytes stored in nmetab for each sprite (SPRITEPOSITIONs).
    1817   00:B070  (00:0003)           X      	equ 3               ; new x coordinate of sprite.
    1818   00:B070  (00:0004)           Y      	equ X + 1           ; new y coordinate of sprite.
    1819   00:B070  (00:0005)           PAM1ST	equ 5               ; first sprite parameter, old x (ix+5).
    1820   00:B070  (00:0230)           MAPSIZE	equ	WINDOWHGT * WINDOWWID	
    1821   00:B070                      	
    1822   00:B070                      ; Particle engine.
    1823   00:B070                      
    1824   00:B070                      	if PFLAG
    1825   00:B070                      
    1826   00:B070  (00:0036)           NUMSHR	equ 54              ; pieces of shrapnel.
    1827   00:B070  (00:0009)           SHRSIZ	equ 9               ; bytes per particle.
    1828   00:B070  (00:000A)           VAPTIM	equ 10				; vapour particle life time
    1829   00:B070                      		
    1830   00:B070                      	endif
    1831   00:B070                      
    1832   00:B070                      ;	include "MSX_Defs.asm"
    1833   00:B070                      ;	include "MSX_Macros.asm"
    1834   00:B070                      
    1835   00:B070                      ; Game starts here.  No reason why screen data couldn't go between start and contrl to put them in
    1836   00:B070                      ; contended RAM, leaving the code and rest of the game in uncontended memory at 32768 and beyond.
    1837   00:B070                      
    1838   00:B070                      start:
    1839   00:B070                      	if DISTYPE=ROM
    1840   00:B070  F3                  		di
    1841   00:B071  31 00 30            		ld sp,MSX_STACK
    1842   00:B074                      	endif
    1843   00:B074                      
    1844   00:B074                      ;~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~Colecovision patch start~~
    1845   00:B074                      ;
    1846   00:B074                      ;	else
    1847   00:B074                      ; 		ld hl,(MSX_HIMEM)
    1848   00:B074                      ;		ld sp,hl
    1849   00:B074                      ;	endif
    1850   00:B074                      ;		ld a,$C9
    1851   00:B074                      ;		ld (MSX_HKEYI),a
    1852   00:B074                      ;		ld (MSX_HTIMI),a
    1853   00:B074                      ;		xor	a
    1854   00:B074                      ;		ld (MSX_SCNCNT),a
    1855   00:B074                      ;		ld (MSX_INTCNT),a		
    1856   00:B074                      ;
    1857   00:B074                      ;~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~Colecovision patch end~~
    1858   00:B074                      
    1859   00:B074                      		; initialize vars
    1860   00:B074  21 00 40            		ld hl,varbegin
    1861   00:B077  11 01 40            		ld de,varbegin+1
    1862   00:B07A  01 5D 00            		ld bc,(varend-varbegin)-1
    1863   00:B07D  36 00               		ld (hl),0
    1864   00:B07F  ED B0               		ldir
    1865   00:B081                      
    1866   00:B081                      ;~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~Colecovision patch start~~
    1867   00:B081                      ;
    1868   00:B081                      ;		;init mapper
    1869   00:B081                      ;		ld	a,1
    1870   00:B081                      ;		out	(MSX_MMAP2),a
    1871   00:B081                      ;		inc	a
    1872   00:B081                      ;		out	(MSX_MMAP1),a
    1873   00:B081                      ;		inc	a
    1874   00:B081                      ;		out	(MSX_MMAP0),a
    1875   00:B081                      ;		
    1876   00:B081                      ;	ifdef NOBIOS
    1877   00:B081                      ;		ld a,(biosvars+MSX_MSXVER)      	; version del MSX
    1878   00:B081                      ;	else
    1879   00:B081                      ;		ld a,(MSX_MSXVER)      	; version del MSX
    1880   00:B081                      ;	endif
    1881   00:B081                      ;		inc a
    1882   00:B081                      ;		dec a
    1883   00:B081                      ;		jr z,.common
    1884   00:B081                      ;		dec a
    1885   00:B081                      ;		jr z,.MSX2
    1886   00:B081                      ;		dec a
    1887   00:B081                      ;		jr z,.MSX2P
    1888   00:B081                      ;		; it's a TR		
    1889   00:B081                      ;	if EFLAG
    1890   00:B081                      ;		ld a,255
    1891   00:B081                      ;		ld (snddelay),a
    1892   00:B081                      ;	endif
    1893   00:B081                      ;		jr .MSX2
    1894   00:B081                      ;.MSX2P:
    1895   00:B081                      ;		in a,(MSX_DEVID)
    1896   00:B081                      ;		cpl
    1897   00:B081                      ;		push af
    1898   00:B081                      ;		ld a,8
    1899   00:B081                      ;		out (MSX_DEVID),a  		;out the manufacturer code 8 (Panasonic) to I/O port 40h
    1900   00:B081                      ;		in a,(MSX_DEVID)   		;read the value you have just written
    1901   00:B081                      ;		cpl          			;complement all bits of the value
    1902   00:B081                      ;		cp 8         			;if it does not match the value you originally wrote,
    1903   00:B081                      ;		jr nz,.notWX  			;it is not a WX/WSX/FX.
    1904   00:B081                      ;		xor a        			;write 0 to I/O port 41h
    1905   00:B081                      ;		out (MSX_SWTIO),a  		;and the mode changes to high-speed clock
    1906   00:B081                      ;	if EFLAG
    1907   00:B081                      ;		ld a,32
    1908   00:B081                      ;		ld (snddelay),a
    1909   00:B081                      ;	endif
    1910   00:B081                      ;.notWX:
    1911   00:B081                      ;		pop af
    1912   00:B081                      ;		out (MSX_DEVID),a		
    1913   00:B081                      ;.MSX2:		
    1914   00:B081                      ;		ld hl,palett
    1915   00:B081                      ;		call setpal
    1916   00:B081                      ;				
    1917   00:B081                      ;		if (TVFREQ>0)
    1918   00:B081                      ;			ld hl,MSX_RG9SAV
    1919   00:B081                      ;			if (TVFREQ=PAL)
    1920   00:B081                      ;				res 1,(hl)
    1921   00:B081                      ;			else
    1922   00:B081                      ;				set 1,(hl)
    1923   00:B081                      ;			endif
    1924   00:B081                      ;			call swaphz
    1925   00:B081                      ;		else
    1926   00:B081                      ;			ld a,(MSX_RG9SAV)
    1927   00:B081                      ;		endif
    1928   00:B081                      ;		call setticks
    1929   00:B081                      ;
    1930   00:B081                      ;.common:		
    1931   00:B081                      ;	if (DISTYPE=ROM and DISSIZE!=48)
    1932   00:B081                      ;		ld a,(MSX_CHGCPU)
    1933   00:B081                      ;		cp $C3
    1934   00:B081                      ;		ld a,$81
    1935   00:B081                      ;		call z,MSX_CHGCPU		; if turbo available, set it
    1936   00:B081                      ;	endif
    1937   00:B081                      ;
    1938   00:B081                      ;		; Set up the display if needed
    1939   00:B081                      ;	if QFLAG=0
    1940   00:B081                      ;
    1941   00:B081                      ;~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~Colecovision patch end~~
    1942   00:B081                      
    1943   00:B081  21 01 01            		ld hl,$0101
    1944   00:B084  22 EA 53            		ld (MSX_FORCLR+1),hl    ; sets background & border colour to black
    1945   00:B087                       
    1946   00:B087  CD 2D C7            		call MSX_INIGRP		; set display to screen 2
    1947   00:B08A                      
    1948   00:B08A                      ;~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~Colecovision patch start~~
    1949   00:B08A                      
    1950   00:B08A                      ;Enable both joysticks, buttons, keypads
    1951   00:B08A                      
    1952   00:B08A  21 9B 9B            		ld hl,$9b9b
    1953   00:B08D  22 98 40            		ld (CONTROLLER_BUFFER),hl
    1954   00:B090  AF                  		xor a
    1955   00:B091  CD 05 11            		call CONTROLLER_INIT    
    1956   00:B094                      
    1957   00:B094                      ; Default control joystick1
    1958   00:B094                      
    1959   00:B094  3E 01               		ld a,1		
    1960   00:B096  32 34 40            		ld (contrl),a
    1961   00:B099                      
    1962   00:B099                      ;~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~Colecovision patch end~~
    1963   00:B099                      
    1964   00:B099                      ;~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~Colecovision patch start~~
    1965   00:B099                      ;
    1966   00:B099                      ;		ld a,(MSX_RG1SAV)
    1967   00:B099                      ;		or 2
    1968   00:B099                      ;		ld b,a
    1969   00:B099                      ;		ld c,1
    1970   00:B099                      ;		call MSX_WRTVDP		; enable 16x16 sprites
    1971   00:B099                      ;		xor a
    1972   00:B099                      ;		ld (MSX_CLIKSW),a       ; disables keyboard click
    1973   00:B099                      ;
    1974   00:B099                      ;	endif
    1975   00:B099                      ;
    1976   00:B099                      ;~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~Colecovision patch end~~
    1977   00:B099                      		
    1978   00:B099  3E F1               		ld a,$F1
    1979   00:B09B  32 39 40            		ld (clratt),a
    1980   00:B09E                      	
    1981   00:B09E                      	if YFLAG
    1982   00:B09E                    ~ 		call music_init
    1983   00:B09E                    ~ 	endif
    1984   00:B09E                      	if XFLAG
    1985   00:B09E  CD 02 C5            		call sfx_init
    1986   00:B0A1                      	endif
    1987   00:B0A1                      	
    1988   00:B0A1                      ;~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~Colecovision patch start~~
    1989   00:B0A1                      ;
    1990   00:B0A1                      ;		; installs ISR
    1991   00:B0A1                      ;		di
    1992   00:B0A1                      ;		ld hl,isr
    1993   00:B0A1                      ;		ld (MSX_HTIMI+1),hl
    1994   00:B0A1                      ;		ld a,$C3
    1995   00:B0A1                      ;		ld (MSX_HTIMI),a
    1996   00:B0A1                      ;		ei
    1997   00:B0A1                      ;
    1998   00:B0A1                      ;~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~Colecovision patch end~~
    1999   00:B0A1                      
    2000   00:B0A1                      	; When ROM, setup of variables with starting value
    2001   00:B0A1                      	if DISTYPE=ROM
    2002   00:B0A1                      		
    2003   00:B0A1  AF                  		xor a
    2004   00:B0A2                      	if EFLAG
    2005   00:B0A2  21 16 40            		ld hl,sndtyp
    2006   00:B0A5  77                  		ld (hl),a
    2007   00:B0A6                      	endif
    2008   00:B0A6                      		; ROM mode needs to initialize some vars
    2009   00:B0A6  21 00 40            		ld hl,score		; scores.		
    2010   00:B0A9  11 01 40            		ld de,score+1		; next byte.
    2011   00:B0AC  01 11 00            		ld bc,17		; size of score vars.
    2012   00:B0AF  36 30               		ld (hl),'0'        	; write '0'
    2013   00:B0B1  ED B0               		ldir
    2014   00:B0B3  21 15 40            		ld hl,displ0+3
    2015   00:B0B6  36 8D               		ld (hl),13+128
    2016   00:B0B8                      	if SFLAG
    2017   00:B0B8                    ~ 		inc a			; A=1
    2018   00:B0B8                    ~ 		ld (scrlyoff),a		; by default, no scrolltext
    2019   00:B0B8                    ~ 	endif
    2020   00:B0B8                      	if PFLAG
    2021   00:B0B8  21 B8 B2            		ld hl,prosh1
    2022   00:B0BB  22 17 40            		ld (shrplot),hl
    2023   00:B0BE                      	endif
    2024   00:B0BE                      	if MFLAG
    2025   00:B0BE                    ~ 		ld a,$C3
    2026   00:B0BE                    ~ 		ld (mod0),a
    2027   00:B0BE                    ~ 		ld (mod1),a
    2028   00:B0BE                    ~ 		ld (mod2),a
    2029   00:B0BE                    ~ 	endif
    2030   00:B0BE  21 5A B0            		ld hl,keytab
    2031   00:B0C1  11 7E 40            		ld de,keys
    2032   00:B0C4  01 16 00            		ld bc,22
    2033   00:B0C7  ED B0               		ldir
    2034   00:B0C9                      		
    2035   00:B0C9  EB                  		ex de,hl
    2036   00:B0CA                      		
    2037   00:B0CA  36 03               		ld (hl),WINDOWTOP
    2038   00:B0CC  23                  		inc hl
    2039   00:B0CD  36 02               		ld (hl),WINDOWLFT
    2040   00:B0CF  23                  		inc hl
    2041   00:B0D0  36 14               		ld (hl),WINDOWHGT
    2042   00:B0D2  23                  		inc hl
    2043   00:B0D3  36 1C               		ld (hl),WINDOWWID
    2044   00:B0D5                      		
    2045   00:B0D5                      	; DATA command initialization
    2046   00:B0D5                      	ifdef DATA00
    2047   00:B0D5                    ~ 		ld hl,rdat00
    2048   00:B0D5                    ~ 		ld (rptr00),hl
    2049   00:B0D5                    ~ 	endif
    2050   00:B0D5                      	ifdef DATA01
    2051   00:B0D5                    ~ 		ld hl,rdat01
    2052   00:B0D5                    ~ 		ld (rptr01),hl
    2053   00:B0D5                    ~ 	endif
    2054   00:B0D5                      	ifdef DATA02
    2055   00:B0D5                    ~ 		ld hl,rdat02
    2056   00:B0D5                    ~ 		ld (rptr02),hl
    2057   00:B0D5                    ~ 	endif
    2058   00:B0D5                      	ifdef DATA03
    2059   00:B0D5                    ~ 		ld hl,rdat03
    2060   00:B0D5                    ~ 		ld (rptr03),hl
    2061   00:B0D5                    ~ 	endif
    2062   00:B0D5                      	ifdef DATA04
    2063   00:B0D5                    ~ 		ld hl,rdat04
    2064   00:B0D5                    ~ 		ld (rptr04),hl
    2065   00:B0D5                    ~ 	endif
    2066   00:B0D5                      	ifdef DATA05
    2067   00:B0D5                    ~ 		ld hl,rdat05
    2068   00:B0D5                    ~ 		ld (rptr05),hl
    2069   00:B0D5                    ~ 	endif
    2070   00:B0D5                      	ifdef DATA06
    2071   00:B0D5                    ~ 		ld hl,rdat06
    2072   00:B0D5                    ~ 		ld (rptr06),hl
    2073   00:B0D5                    ~ 	endif
    2074   00:B0D5                      	ifdef DATA07
    2075   00:B0D5                    ~ 		ld hl,rdat07
    2076   00:B0D5                    ~ 		ld (rptr07),hl
    2077   00:B0D5                    ~ 	endif
    2078   00:B0D5                      	ifdef DATA08
    2079   00:B0D5                    ~ 		ld hl,rdat08
    2080   00:B0D5                    ~ 		ld (rptr08),hl
    2081   00:B0D5                    ~ 	endif
    2082   00:B0D5                      	ifdef DATA09
    2083   00:B0D5                    ~ 		ld hl,rdat09
    2084   00:B0D5                    ~ 		ld (rptr09),hl
    2085   00:B0D5                    ~ 	endif
    2086   00:B0D5                      	ifdef DATA10
    2087   00:B0D5                    ~ 		ld hl,rdat10
    2088   00:B0D5                    ~ 		ld (rptr10),hl
    2089   00:B0D5                    ~ 	endif
    2090   00:B0D5                      	ifdef DATA11
    2091   00:B0D5                    ~ 		ld hl,rdat11
    2092   00:B0D5                    ~ 		ld (rptr11),hl
    2093   00:B0D5                    ~ 	endif
    2094   00:B0D5                      	ifdef DATA12
    2095   00:B0D5                    ~ 		ld hl,rdat12
    2096   00:B0D5                    ~ 		ld (rptr12),hl
    2097   00:B0D5                    ~ 	endif
    2098   00:B0D5                      	ifdef DATA13
    2099   00:B0D5                    ~ 		ld hl,rdat13
    2100   00:B0D5                    ~ 		ld (rptr13),hl
    2101   00:B0D5                    ~ 	endif
    2102   00:B0D5                      	ifdef DATA14
    2103   00:B0D5                    ~ 		ld hl,rdat14
    2104   00:B0D5                    ~ 		ld (rptr14),hl
    2105   00:B0D5                    ~ 	endif
    2106   00:B0D5                      	ifdef DATA15
    2107   00:B0D5                    ~ 		ld hl,rdat15
    2108   00:B0D5                    ~ 		ld (rptr15),hl
    2109   00:B0D5                    ~ 	endif
    2110   00:B0D5                      	ifdef DATA16
    2111   00:B0D5                    ~ 		ld hl,rdat16
    2112   00:B0D5                    ~ 		ld (rptr16),hl
    2113   00:B0D5                    ~ 	endif
    2114   00:B0D5                      	ifdef DATA17
    2115   00:B0D5                    ~ 		ld hl,rdat17
    2116   00:B0D5                    ~ 		ld (rptr17),hl
    2117   00:B0D5                    ~ 	endif
    2118   00:B0D5                      	ifdef DATA18
    2119   00:B0D5                    ~ 		ld hl,rdat18
    2120   00:B0D5                    ~ 		ld (rptr18),hl
    2121   00:B0D5                    ~ 	endif
    2122   00:B0D5                      	ifdef DATA19
    2123   00:B0D5                    ~ 		ld hl,rdat19
    2124   00:B0D5                    ~ 		ld (rptr19),hl
    2125   00:B0D5                    ~ 	endif
    2126   00:B0D5                      	ifdef DATA20
    2127   00:B0D5                    ~ 		ld hl,rdat20
    2128   00:B0D5                    ~ 		ld (rptr20),hl
    2129   00:B0D5                    ~ 	endif
    2130   00:B0D5                      		
    2131   00:B0D5                      	endif
    2132   00:B0D5  C3 5F B5            		jp game             ; start the game.
    2133   00:B0D8                      
    2134   00:B0D8  1F                  numob  db NUMOBJ         ; number of objects in game.
    2135   00:B0D9                      
    2136   00:B0D9                      ; Variables start here.
    2137   00:B0D9                      ; Pixel versions of wintop, winlft, winhgt, winwid.
    2138   00:B0D9                      
    2139   00:B0D9  19                  wntopx db (8 * WINDOWTOP) + 1
    2140   00:B0DA  10                  wnlftx db (8 * WINDOWLFT)
    2141   00:B0DB  A8                  wnbotx db ((WINDOWTOP * 8) + (WINDOWHGT * 8) - 16)
    2142   00:B0DC  E0                  wnrgtx db ((WINDOWLFT * 8) + (WINDOWWID * 8) - 16)
    2143   00:B0DD                      
    2144   00:B0DD                      ; Make sure pointers are arranged in the same order as the data itself.
    2145   00:B0DD                      
    2146   00:B0DD  C1 A1               frmptr dw frmlst         ; sprite frames.
    2147   00:B0DF  39 9C               blkptr dw chgfx          ; block graphics.
    2148   00:B0E1  B9 9E               proptr dw bprop          ; address of char properties.
    2149   00:B0E3  11 8C               scrptr dw scdat          ; address of screens.
    2150   00:B0E5  D1 A1               nmeptr dw nmedat         ; enemy start positions.
    2151   00:B0E7                      
    2152   00:B0E7                      	if MFLAG
    2153   00:B0E7                    ~ 	
    2154   00:B0E7                    ~ ; Modify for inventory.
    2155   00:B0E7                    ~ 
    2156   00:B0E7                    ~ minve:
    2157   00:B0E7                    ~ 	if MBFLAG
    2158   00:B0E7                    ~ 		ld l,a
    2159   00:B0E7                    ~ 		ld a,WINDOWHGT	
    2160   00:B0E7                    ~ 		add a,a			
    2161   00:B0E7                    ~ 		ld (winhgt),a	
    2162   00:B0E7                    ~ 		ld a,WINDOWWID	
    2163   00:B0E7                    ~ 		add a,a			
    2164   00:B0E7                    ~ 		ld (winwid),a	
    2165   00:B0E7                    ~ 		ld a,l
    2166   00:B0E7                    ~ 	endif
    2167   00:B0E7                    ~ 		
    2168   00:B0E7                    ~ 		ld hl,invdis        ; routine address.
    2169   00:B0E7                    ~ 		ld (mod0+1),hl      ; set up menu routine.
    2170   00:B0E7                    ~ 		ld (mod2+1),hl      ; set up count routine.
    2171   00:B0E7                    ~ 		ld hl,fopt          ; find option from available objects.
    2172   00:B0E7                    ~ 		ld (mod1+1),hl      ; set up routine.
    2173   00:B0E7                    ~ 		jr dbox             ; do menu routine.
    2174   00:B0E7                    ~ 
    2175   00:B0E7                    ~ ; Modify for menu.
    2176   00:B0E7                    ~ 
    2177   00:B0E7                    ~ mmenu:
    2178   00:B0E7                    ~ 		ld hl,always        ; routine address.
    2179   00:B0E7                    ~ 		ld (mod0+1),hl      ; set up routine.
    2180   00:B0E7                    ~ 		ld (mod2+1),hl      ; set up count routine.
    2181   00:B0E7                    ~ 		ld hl,fstd          ; standard option selection.
    2182   00:B0E7                    ~ 		ld (mod1+1),hl      ; set up routine.
    2183   00:B0E7                    ~ 
    2184   00:B0E7                    ~ ; Drop through into box routine.
    2185   00:B0E7                    ~ 
    2186   00:B0E7                    ~ ; Work out size of box for message or menu.
    2187   00:B0E7                    ~ 
    2188   00:B0E7                    ~ dbox:   		
    2189   00:B0E7                    ~ 		ld hl,msgdat        ; pointer to messages.
    2190   00:B0E7                    ~ 		call getwrd         ; get message number.
    2191   00:B0E7                    ~ 		push hl             ; store pointer to message.
    2192   00:B0E7                    ~ 		ld d,1              ; height.
    2193   00:B0E7                    ~ 		xor a               ; start at object zero.
    2194   00:B0E7                    ~ 		ld (combyt),a       ; store number of object in combyt.
    2195   00:B0E7                    ~ 		ld e,a              ; maximum width.
    2196   00:B0E7                    ~ dbox5:
    2197   00:B0E7                    ~ 		ld b,0              ; this line's width.
    2198   00:B0E7                    ~ ;mod2:						 ; auto-modifying code
    2199   00:B0E7                    ~ ;		call always
    2200   00:B0E7                    ~ 		
    2201   00:B0E7                    ~ 		call mod2		
    2202   00:B0E7                    ~ 		jr nz,dbox6         ; not in inventory, skip this line. (dbox3?)
    2203   00:B0E7                    ~ 		inc d               ; add to tally.
    2204   00:B0E7                    ~ dbox6:
    2205   00:B0E7                    ~ 		ld a,(hl)           ; get character.
    2206   00:B0E7                    ~ 		inc hl              ; next character.
    2207   00:B0E7                    ~ 		cp ','              ; reached end of line?
    2208   00:B0E7                    ~ 		jr z,dbox3          ; yes.
    2209   00:B0E7                    ~ 		cp 13               ; reached end of line?
    2210   00:B0E7                    ~ 		jr z,dbox3          ; yes.
    2211   00:B0E7                    ~ 		inc b               ; add to this line's width.
    2212   00:B0E7                    ~ 		and a               ; end of message?
    2213   00:B0E7                    ~ 		jp m,dbox4          ; yes, end count.
    2214   00:B0E7                    ~ 		jr dbox6            ; repeat until we find the end.
    2215   00:B0E7                    ~ dbox3:
    2216   00:B0E7                    ~ 		ld a,e              ; maximum line width.
    2217   00:B0E7                    ~ 		cp b                ; have we exceeded longest so far?
    2218   00:B0E7                    ~ 		jr nc,dbox5         ; no, carry on looking.
    2219   00:B0E7                    ~ 		ld e,b              ; make this the widest so far.
    2220   00:B0E7                    ~ 		jr dbox5            ; keep looking.
    2221   00:B0E7                    ~ dbox4:
    2222   00:B0E7                    ~ 		ld a,e              ; maximum line width.
    2223   00:B0E7                    ~ 		cp b                ; have we exceeded longest so far?
    2224   00:B0E7                    ~ 		jr nc,dbox8         ; no, carry on looking.
    2225   00:B0E7                    ~ 		ld e,b              ; final line is the longest so far.
    2226   00:B0E7                    ~ dbox8:
    2227   00:B0E7                    ~ 		dec d               ; decrement items found.
    2228   00:B0E7                    ~ 		jp z,dbox15         ; total was zero.
    2229   00:B0E7                    ~ 		ld a,e              ; longest line.
    2230   00:B0E7                    ~ 		and a               ; was it zero?
    2231   00:B0E7                    ~ 		jp z,dbox15         ; total was zero.
    2232   00:B0E7                    ~ 		ld (bwid),de        ; set up size.
    2233   00:B0E7                    ~ 
    2234   00:B0E7                    ~ ; That's set up our box size.
    2235   00:B0E7                    ~ 
    2236   00:B0E7                    ~ 		call dissprs
    2237   00:B0E7                    ~ 
    2238   00:B0E7                    ~ 		ld a,(winhgt)       ; window height in characters.
    2239   00:B0E7                    ~ 		sub d               ; subtract height of box.
    2240   00:B0E7                    ~ 		rra                 ; divide by 2.
    2241   00:B0E7                    ~ 		ld hl,wintop        ; top edge of window.
    2242   00:B0E7                    ~ 		add a,(hl)          ; add displacement.
    2243   00:B0E7                    ~ 		ld (btop),a         ; set up box top.
    2244   00:B0E7                    ~ 		ld a,(winwid)       ; window width in characters.
    2245   00:B0E7                    ~ 		sub e               ; subtract box width.
    2246   00:B0E7                    ~ 		rra                 ; divide by 2.
    2247   00:B0E7                    ~ 		inc hl              ; left edge of window.
    2248   00:B0E7                    ~ 		add a,(hl)          ; add displacement.
    2249   00:B0E7                    ~ 		ld (blft),a         ; box left.
    2250   00:B0E7                    ~ 
    2251   00:B0E7                    ~ 		ld hl,font-256       ; font.
    2252   00:B0E7                    ~ 		ld (grbase),hl      ; set up for text display.
    2253   00:B0E7                    ~ 		pop hl              ; restore message pointer.
    2254   00:B0E7                    ~ 		ld a,(btop)         ; box top.
    2255   00:B0E7                    ~ 		ld (dispx),a        ; set display coordinate.
    2256   00:B0E7                    ~ 		xor a               ; start at object zero.
    2257   00:B0E7                    ~ 		ld (combyt),a       ; store number of object in combyt.
    2258   00:B0E7                    ~ dbox2:
    2259   00:B0E7                    ~ 		ld a,(combyt)       ; get object number.
    2260   00:B0E7                    ~ ;mod0:						 ; auto-modifying code
    2261   00:B0E7                    ~ ;		call always         ; check inventory for display.
    2262   00:B0E7                    ~ 
    2263   00:B0E7                    ~ 
    2264   00:B0E7                    ~ 		call mod0		
    2265   00:B0E7                    ~ 		jp nz,dbox13        ; not in inventory, skip this line.
    2266   00:B0E7                    ~ 		ld a,(blft)         ; box left.
    2267   00:B0E7                    ~ 		ld (dispy),a        ; set left display position.
    2268   00:B0E7                    ~ 		ld a,(bwid)         ; box width.
    2269   00:B0E7                    ~ 		ld b,a              ; store width.
    2270   00:B0E7                    ~ 	   
    2271   00:B0E7                    ~ dbox0:  
    2272   00:B0E7                    ~ 		ld a,(hl)           ; get character.
    2273   00:B0E7                    ~ 		cp ','              ; end of line?
    2274   00:B0E7                    ~ 		jr z,dbox1          ; yes, next one.
    2275   00:B0E7                    ~ 		cp 13               ; end of option?
    2276   00:B0E7                    ~ 		jr z,dbox1          ; yes, on to next.
    2277   00:B0E7                    ~ 		dec b               ; one less to display.
    2278   00:B0E7                    ~ 		and 127             ; remove terminator.
    2279   00:B0E7                    ~ 
    2280   00:B0E7                    ~ 		push bc             ; store characters remaining.
    2281   00:B0E7                    ~ 		push hl             ; store address on stack.
    2282   00:B0E7                    ~ 
    2283   00:B0E7                    ~ 
    2284   00:B0E7                    ~ 		call ptxt           ; display character.		
    2285   00:B0E7                    ~ 		
    2286   00:B0E7                    ~ 		ld hl,dispy         ; y coordinate.
    2287   00:B0E7                    ~ 		inc (hl)            ; move along one.
    2288   00:B0E7                    ~ 		
    2289   00:B0E7                    ~ 		pop hl              ; retrieve address of next character.
    2290   00:B0E7                    ~ 		pop bc              ; chars left for this line.
    2291   00:B0E7                    ~ 
    2292   00:B0E7                    ~ 		ld a,(hl)           ; get character.
    2293   00:B0E7                    ~ 		inc hl              ; next character.
    2294   00:B0E7                    ~ 		cp 128              ; end of message?
    2295   00:B0E7                    ~ 		jp nc,dbox7         ; yes, job done.
    2296   00:B0E7                    ~ 		ld a,b              ; chars remaining.
    2297   00:B0E7                    ~ 		and a               ; are any left?
    2298   00:B0E7                    ~ 		jr nz,dbox0         ; yes, continue.
    2299   00:B0E7                    ~ 
    2300   00:B0E7                    ~ ; Reached limit of characters per line.
    2301   00:B0E7                    ~ 
    2302   00:B0E7                    ~ dbox9:
    2303   00:B0E7                    ~ 		ld a,(hl)           ; get character.
    2304   00:B0E7                    ~ 		inc hl              ; next one.
    2305   00:B0E7                    ~ 		cp ','              ; another line?
    2306   00:B0E7                    ~ 		jr z,dbox10         ; yes, do next line.
    2307   00:B0E7                    ~ 		cp 13               ; another line?
    2308   00:B0E7                    ~ 		jr z,dbox10         ; yes, on to next.
    2309   00:B0E7                    ~ 		cp 128              ; end of message?
    2310   00:B0E7                    ~ 		jr nc,dbox11        ; yes, finish message.
    2311   00:B0E7                    ~ 		jr dbox9
    2312   00:B0E7                    ~ 
    2313   00:B0E7                    ~ ; Fill box to end of line.
    2314   00:B0E7                    ~ 
    2315   00:B0E7                    ~ dboxf:
    2316   00:B0E7                    ~ 		push hl             ; store address on stack.
    2317   00:B0E7                    ~ 		push bc             ; store characters remaining.	   
    2318   00:B0E7                    ~ 		ld a,' '
    2319   00:B0E7                    ~ 		call ptxt           ; display character.		
    2320   00:B0E7                    ~ 		
    2321   00:B0E7                    ~ 		ld hl,dispy         ; y coordinate.
    2322   00:B0E7                    ~ 		inc (hl)            ; move along one.		
    2323   00:B0E7                    ~ 		pop bc              ; retrieve character count.
    2324   00:B0E7                    ~ 		pop hl              ; retrieve address of next character.
    2325   00:B0E7                    ~ 		djnz dboxf          ; repeat for remaining chars on line.
    2326   00:B0E7                    ~ 		ret
    2327   00:B0E7                    ~ 
    2328   00:B0E7                    ~ dbox1:
    2329   00:B0E7                    ~ 		inc hl              ; skip character.
    2330   00:B0E7                    ~ 		call dboxf          ; fill box out to right side.
    2331   00:B0E7                    ~ dbox10:
    2332   00:B0E7                    ~ 		ld a,(dispx)        ; x coordinate.
    2333   00:B0E7                    ~ 		inc a               ; down a line.
    2334   00:B0E7                    ~ 		ld (dispx),a        ; next position.
    2335   00:B0E7                    ~ 		jp dbox2            ; next line.
    2336   00:B0E7                    ~ dbox7:
    2337   00:B0E7                    ~ 		ld a,b              ; chars remaining.
    2338   00:B0E7                    ~ 		and a               ; are any left?
    2339   00:B0E7                    ~ 		jr z,dbox11         ; no, nothing to draw.
    2340   00:B0E7                    ~ 		call dboxf          ; fill message to line.
    2341   00:B0E7                    ~ 
    2342   00:B0E7                    ~ ; Drawn the box menu, now select option.
    2343   00:B0E7                    ~ 
    2344   00:B0E7                    ~ dbox11:
    2345   00:B0E7                    ~ 		ld a,(btop)         ; box top.
    2346   00:B0E7                    ~ 		ld (dispx),a        ; set bar position.
    2347   00:B0E7                    ~ dbox14:
    2348   00:B0E7                    ~ 		call joykey         ; get controls.
    2349   00:B0E7                    ~ 		and 31              ; anything pressed?
    2350   00:B0E7                    ~ 		jr nz,dbox14        ; yes, debounce it.
    2351   00:B0E7                    ~ 		call dbar           ; draw bar.
    2352   00:B0E7                    ~ dbox12:
    2353   00:B0E7                    ~ 		call joykey         ; get controls.
    2354   00:B0E7                    ~ 		and 28              ; anything pressed?
    2355   00:B0E7                    ~ 		jr z,dbox12         ; no, nothing.
    2356   00:B0E7                    ~ 		and 16              ; fire button pressed?
    2357   00:B0E7                    ~ 		jp nz,mod1
    2358   00:B0E7                    ~ 		call dbar           ; delete bar.
    2359   00:B0E7                    ~ 		ld a,(joyval)       ; joystick reading.
    2360   00:B0E7                    ~ 		and 8               ; going up?
    2361   00:B0E7                    ~ 		jr nz,dboxu         ; yes, go up.
    2362   00:B0E7                    ~ 		ld a,(dispx)        ; vertical position of bar.
    2363   00:B0E7                    ~ 		inc a               ; look down.
    2364   00:B0E7                    ~ 		ld hl,btop          ; top of box.
    2365   00:B0E7                    ~ 		sub (hl)            ; find distance from top.
    2366   00:B0E7                    ~ 		dec hl              ; point to height.
    2367   00:B0E7                    ~ 		cp (hl)             ; are we at end?
    2368   00:B0E7                    ~ 		jp z,dbox14         ; yes, go no further.
    2369   00:B0E7                    ~ 		ld hl,dispx         ; coordinate.
    2370   00:B0E7                    ~ 		inc (hl)            ; move bar.
    2371   00:B0E7                    ~ 		jr dbox14           ; continue.
    2372   00:B0E7                    ~ dboxu:
    2373   00:B0E7                    ~ 		ld a,(dispx)        ; vertical position of bar.
    2374   00:B0E7                    ~ 		ld hl,btop          ; top of box.
    2375   00:B0E7                    ~ 		cp (hl)             ; are we at the top?
    2376   00:B0E7                    ~ 		jp z,dbox14         ; yes, go no further.
    2377   00:B0E7                    ~ 		ld hl,dispx         ; coordinate.
    2378   00:B0E7                    ~ 		dec (hl)            ; move bar.
    2379   00:B0E7                    ~ 		jr dbox14           ; continue.
    2380   00:B0E7                    ~ fstd:
    2381   00:B0E7                    ~ 		ld a,(dispx)        ; bar position.
    2382   00:B0E7                    ~ 		ld hl,btop          ; top of menu.
    2383   00:B0E7                    ~ 		sub (hl)            ; find selected option.
    2384   00:B0E7                    ~ 		ld (varopt),a       ; store the option.
    2385   00:B0E7                    ~ 		jp redraw           ; redraw the screen.
    2386   00:B0E7                    ~ 
    2387   00:B0E7                    ~ ; Option not available.  Skip this line.
    2388   00:B0E7                    ~ 
    2389   00:B0E7                    ~ dbox13:
    2390   00:B0E7                    ~ 		ld a,(hl)           ; get character.
    2391   00:B0E7                    ~ 		inc hl              ; next one.
    2392   00:B0E7                    ~ 		cp ','              ; another line?
    2393   00:B0E7                    ~ 		jp z,dbox2          ; yes, do next line.
    2394   00:B0E7                    ~ 		cp 13               ; another line?
    2395   00:B0E7                    ~ 		jp z,dbox2          ; yes, on to next line.
    2396   00:B0E7                    ~ 		and a               ; end of message?
    2397   00:B0E7                    ~ 		jp m,dbox11         ; yes, finish message.
    2398   00:B0E7                    ~ 		jr dbox13
    2399   00:B0E7                    ~ dbox15:
    2400   00:B0E7                    ~ 
    2401   00:B0E7                    ~ 	if MBFLAG
    2402   00:B0E7                    ~ 		ld a,WINDOWWID
    2403   00:B0E7                    ~ 		ld (winwid),a
    2404   00:B0E7                    ~ 		ld a,WINDOWHGT
    2405   00:B0E7                    ~ 		ld (winhgt),a
    2406   00:B0E7                    ~ 	endif
    2407   00:B0E7                    ~ 	
    2408   00:B0E7                    ~ 		pop hl              ; pop message pointer from the stack.
    2409   00:B0E7                    ~ 		ret
    2410   00:B0E7                    ~ 
    2411   00:B0E7                    ~ dbar:
    2412   00:B0E7                    ~ 		ld a,(blft)         ; box left.
    2413   00:B0E7                    ~ 		ld (dispy),a        ; set display coordinate.
    2414   00:B0E7                    ~ 		call gprad          ; get printing address.
    2415   00:B0E7                    ~ 		ex de,hl            ; flip into hl register pair.
    2416   00:B0E7                    ~ 	   
    2417   00:B0E7                    ~ 		set 5,h
    2418   00:B0E7                    ~ 		ld a,(bwid)         ; box width.
    2419   00:B0E7                    ~ 		add a,a
    2420   00:B0E7                    ~ 		add a,a
    2421   00:B0E7                    ~ 		add a,a
    2422   00:B0E7                    ~ 		ld c,a
    2423   00:B0E7                    ~ 		ld b,0
    2424   00:B0E7                    ~ 		call MSX_RDVRM
    2425   00:B0E7                    ~ 
    2426   00:B0E7                    ~ 		rlca
    2427   00:B0E7                    ~ 		rlca
    2428   00:B0E7                    ~ 		rlca
    2429   00:B0E7                    ~ 		rlca
    2430   00:B0E7                    ~ 		jp MSX_FILVRM
    2431   00:B0E7                    ~ 
    2432   00:B0E7                    ~ invdis:
    2433   00:B0E7                    ~ 		push hl             ; store message text pointer.
    2434   00:B0E7                    ~ 		push de             ; store de pair for line count.
    2435   00:B0E7                    ~ 		ld hl,combyt        ; object number.
    2436   00:B0E7                    ~ 		ld a,(hl)           ; get object number.
    2437   00:B0E7                    ~ 		inc (hl)            ; ready for next one.
    2438   00:B0E7                    ~ 		call gotob          ; check if we have object.
    2439   00:B0E7                    ~ 		pop de              ; retrieve de pair from stack.
    2440   00:B0E7                    ~ 		pop hl              ; retrieve text pointer.
    2441   00:B0E7                    ~ 		ret
    2442   00:B0E7                    ~ 		
    2443   00:B0E7                    ~ ; Find option selected.
    2444   00:B0E7                    ~ 
    2445   00:B0E7                    ~ fopt:
    2446   00:B0E7                    ~ 		ld a,(dispx)
    2447   00:B0E7                    ~ 		ld hl,btop          ; top of menu.
    2448   00:B0E7                    ~ 		sub (hl)            ; find selected option.
    2449   00:B0E7                    ~ 		inc a               ; object 0 needs one iteration, 1 needs 2 and so on.
    2450   00:B0E7                    ~ 		ld b,a              ; option selected in b register.
    2451   00:B0E7                    ~ 		ld hl,combyt        ; object number.
    2452   00:B0E7                    ~ 		ld (hl),0           ; set to first item.
    2453   00:B0E7                    ~ fopt0:
    2454   00:B0E7                    ~ 		push bc             ; store option counter in b register.
    2455   00:B0E7                    ~ 		call fobj           ; find next object in inventory.
    2456   00:B0E7                    ~ 		pop bc              ; restore option counter.
    2457   00:B0E7                    ~ 		djnz fopt0          ; repeat for relevant steps down the list.
    2458   00:B0E7                    ~ 		ld a,(combyt)       ; get option.
    2459   00:B0E7                    ~ 		dec a               ; one less, due to where we increment combyt.
    2460   00:B0E7                    ~ 		ld (varopt),a       ; store the option.
    2461   00:B0E7                    ~ 		xor a
    2462   00:B0E7                    ~ 		ld (joyval),a
    2463   00:B0E7                    ~ 		jp redraw           ; redraw the screen.
    2464   00:B0E7                    ~ 
    2465   00:B0E7                    ~ fobj:
    2466   00:B0E7                    ~ 		ld hl,combyt        ; object number.
    2467   00:B0E7                    ~ 		ld a,(hl)           ; get object number.
    2468   00:B0E7                    ~ 		inc (hl)            ; ready for next item.
    2469   00:B0E7                    ~ 		ret z               ; in case we loop back to zero.
    2470   00:B0E7                    ~ 		call gotob          ; do we have this item?
    2471   00:B0E7                    ~ 		ret z               ; yes, it's on the list.
    2472   00:B0E7                    ~ 		jr fobj             ; repeat until we find next item in pockets.
    2473   00:B0E7                    ~ 
    2474   00:B0E7                    ~ 	endif
    2475   00:B0E7                      
    2476   00:B0E7                      ;~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~Colecovision patch start~~
    2477   00:B0E7                      ;
    2478   00:B0E7                      ; ISR
    2479   00:B0E7                      ;
    2480   00:B0E7                      ;
    2481   00:B0E7                      ;isr:
    2482   00:B0E7                      ;	ifdef NOBIOS
    2483   00:B0E7                      ;		push hl
    2484   00:B0E7                      ;		push de
    2485   00:B0E7                      ;		push bc
    2486   00:B0E7                      ;		push af
    2487   00:B0E7                      ;		exx
    2488   00:B0E7                      ;		ex af,af
    2489   00:B0E7                      ;		push hl
    2490   00:B0E7                      ;		push de
    2491   00:B0E7                      ;		push bc
    2492   00:B0E7                      ;		push af
    2493   00:B0E7                      ;		push iy
    2494   00:B0E7                      ;		push ix
    2495   00:B0E7                      ;       in a,($99)      ;Clear possible interrupt request
    2496   00:B0E7                      ;       or a               ;Interrupt requested by VDP?		
    2497   00:B0E7                      ;		jp p,.intret       ;No, skip the rest
    2498   00:B0E7                      ;		ei
    2499   00:B0E7                      ;	endif			
    2500   00:B0E7                      ;       ld (MSX_STATFL),a	;Store this new status
    2501   00:B0E7                      ;        ld hl,(MSX_JIFFY)
    2502   00:B0E7                      ;        inc hl
    2503   00:B0E7                      ;        ld (MSX_JIFFY),hl		
    2504   00:B0E7                      ;	if (YFLAG or XFLAG)	
    2505   00:B0E7                      ;		call psgrout
    2506   00:B0E7                      ;		if YFLAG
    2507   00:B0E7                      ;			call music_play
    2508   00:B0E7                      ;		endif
    2509   00:B0E7                      ;		if XFLAG
    2510   00:B0E7                      ;			call sfx_play
    2511   00:B0E7                      ;		endif
    2512   00:B0E7                      ;	endif
    2513   00:B0E7                      ;	ifdef NOBIOS
    2514   00:B0E7                      ;.intret:
    2515   00:B0E7                      ;	else
    2516   00:B0E7                      ;		pop af
    2517   00:B0E7                      ;	endif
    2518   00:B0E7                      ;        pop ix              ;Restore all registers
    2519   00:B0E7                      ;        pop iy
    2520   00:B0E7                      ;        pop af
    2521   00:B0E7                      ;        pop bc
    2522   00:B0E7                      ;        pop de
    2523   00:B0E7                      ;        pop hl
    2524   00:B0E7                      ;        ex  af,af
    2525   00:B0E7                      ;        exx
    2526   00:B0E7                      ;        pop af
    2527   00:B0E7                      ;        pop bc
    2528   00:B0E7                      ;        pop de
    2529   00:B0E7                      ;        pop hl
    2530   00:B0E7                      ;        ei
    2531   00:B0E7                      ;        ret					; returns from interrupt		
    2532   00:B0E7                      ;
    2533   00:B0E7                      ;~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~Colecovision patch end~~
    2534   00:B0E7                      
    2535   00:B0E7                      ; Wait for keypress.
    2536   00:B0E7                      
    2537   00:B0E7                      chkkey:
    2538   00:B0E7  CD 73 B1            		call vsync
    2539   00:B0EA  06 0B               		ld b,11
    2540   00:B0EC                      .nokey:
    2541   00:B0EC  78                  		ld a,b
    2542   00:B0ED  3D                  		dec a
    2543   00:B0EE                      ;~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~Colecovision patch start~~
    2544   00:B0EE                      ;		call MSX_SNSMAT
    2545   00:B0EE                      ;~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~Colecovision patch end~~
    2546   00:B0EE                      
    2547   00:B0EE  FE FF               		cp 255
    2548   00:B0F0  C0                  		ret nz
    2549   00:B0F1  10 F9               		djnz .nokey
    2550   00:B0F3  18 F2               		jr chkkey
    2551   00:B0F5                      
    2552   00:B0F5                      prskey:
    2553   00:B0F5  CD 73 B1            	call vsync
    2554   00:B0F8                      
    2555   00:B0F8  3A 9A 40            	ld a,(CONTROLLER_BUFFER+2)	; Test button left
    2556   00:B0FB  A7                  	and a
    2557   00:B0FC  20 16               	jr nz,debkey
    2558   00:B0FE                      
    2559   00:B0FE  3A 9B 40            	ld a,(CONTROLLER_BUFFER+3)	; Test joystick
    2560   00:B101  A7                  	and a
    2561   00:B102  20 10               	jr nz,debkey
    2562   00:B104                      
    2563   00:B104  3A 9E 40            	ld a,(CONTROLLER_BUFFER+6)	; Test keypad
    2564   00:B107  FE 0F               	cp $0f
    2565   00:B109  20 09               	jr nz,debkey
    2566   00:B10B                      
    2567   00:B10B  3A 9D 40            	ld a,(CONTROLLER_BUFFER+5)	; Test button right
    2568   00:B10E  A7                  	and a
    2569   00:B10F  20 03               	jr nz,debkey
    2570   00:B111                      
    2571   00:B111  C3 F5 B0            	jp prskey
    2572   00:B114                      
    2573   00:B114                      ; Debounce keypress.
    2574   00:B114                      		
    2575   00:B114                      debkey:
    2576   00:B114  CD 73 B1            	call vsync
    2577   00:B117                      
    2578   00:B117  3A 9A 40            	ld a,(CONTROLLER_BUFFER+2)	; Test button left
    2579   00:B11A  A7                  	and a
    2580   00:B11B  20 F7               	jr nz,debkey
    2581   00:B11D                      
    2582   00:B11D  3A 9B 40            	ld a,(CONTROLLER_BUFFER+3)	; Test joystick
    2583   00:B120  A7                  	and a
    2584   00:B121  20 F1               	jr nz,debkey
    2585   00:B123                      
    2586   00:B123  3A 9E 40            	ld a,(CONTROLLER_BUFFER+6)	; Test keypad
    2587   00:B126  FE 0F               	cp $0f
    2588   00:B128  20 EA               	jr nz,debkey
    2589   00:B12A                      
    2590   00:B12A  3A 9D 40            	ld a,(CONTROLLER_BUFFER+5)	; Test button right
    2591   00:B12D  A7                  	and a
    2592   00:B12E  20 E4               	jr nz,debkey
    2593   00:B130                      
    2594   00:B130  C9                  	ret
    2595   00:B131                      
    2596   00:B131                      ; Delay routine.
    2597   00:B131                      
    2598   00:B131                      delay:
    2599   00:B131  C5                  		push bc             ; store loop counter.
    2600   00:B132  CD 73 B1            		call vsync          ; wait for interrupt.
    2601   00:B135  C1                  		pop bc              ; restore counter.
    2602   00:B136  10 F9               		djnz delay          ; repeat.
    2603   00:B138  C9                  		ret
    2604   00:B139                      
    2605   00:B139                      ; Clear sprite table.
    2606   00:B139                      
    2607   00:B139                      xspr:
    2608   00:B139  21 B5 40            		ld hl,sprtab       ; sprite table.
    2609   00:B13C  11 B6 40            		ld de,sprtab+1
    2610   00:B13F  36 FF               		ld (hl),255
    2611   00:B141  01 1F 02            		ld bc,SPRBUF-1     ; length of table.
    2612   00:B144  ED B0               		ldir
    2613   00:B146  AF                  		xor a
    2614   00:B147  32 4C 40            		ld (highslot),a		; resets also highest sprite slot number
    2615   00:B14A                      ;
    2616   00:B14A                      xspr0:
    2617   00:B14A  21 00 4D            		ld hl,mapspr       ; sprite images map.
    2618   00:B14D  11 01 4D            		ld de,mapspr+1
    2619   00:B150  36 FF               		ld (hl),255
    2620   00:B152  01 7F 00            		ld bc,127          ; length of table.
    2621   00:B155  ED B0               		ldir
    2622   00:B157  C9                  		ret
    2623   00:B158                      		
    2624   00:B158                      	if OFLAG
    2625   00:B158                      	
    2626   00:B158                      ; Initialise all objects.
    2627   00:B158                      
    2628   00:B158                      	if DISTYPE=ROM
    2629   00:B158                      
    2630   00:B158                      iniob:
    2631   00:B158                      		; ROM model
    2632   00:B158  3A D8 B0            		ld a,(numob)        ; number of objects in the game.
    2633   00:B15B  47                  		ld b,a
    2634   00:B15C  21 07 A5            		ld hl,objdta        ; objects table.
    2635   00:B15F  11 A8 4F            		ld de,objatr
    2636   00:B162                      .loop:
    2637   00:B162  3E 40               		ld a,OBJSIZ-ODTSIZ  ; distance between objects.
    2638   00:B164  4F                  		ld c,a
    2639   00:B165  ED A0               		ldi
    2640   00:B167  ED A0               		ldi
    2641   00:B169  ED A0               		ldi
    2642   00:B16B                      		ADD_HL_A
    2642   00:B16B  85                >   add a,l
    2642   00:B16C  6F                >   ld l,a
    2642   00:B16D  8C                >   adc a,h
    2642   00:B16E  95                >   sub l
    2642   00:B16F  67                >   ld h,a
    2643   00:B170  10 F0               		djnz .loop         ; repeat.
    2644   00:B172  C9                  		ret
    2645   00:B173                      
    2646   00:B173                      	else
    2647   00:B173                    ~ 		; RAM model
    2648   00:B173                    ~ iniob:
    2649   00:B173                    ~ 		/*
    2650   00:B173                    ~ 		ld ix,objdta        ; objects table.
    2651   00:B173                    ~ 		ld a,(numob)        ; number of objects in the game.
    2652   00:B173                    ~ 		ld b,a              ; loop counter.
    2653   00:B173                    ~ 		ld de,OBJSIZ        ; distance between objects.
    2654   00:B173                    ~ .loop:
    2655   00:B173                    ~ 		ld a,(ix+67)        ; start screen.
    2656   00:B173                    ~ 		ld (ix+64),a        ; set start screen.
    2657   00:B173                    ~ 		ld a,(ix+68)        ; find start x.
    2658   00:B173                    ~ 		ld (ix+65),a        ; set start x.
    2659   00:B173                    ~ 		ld a,(ix+69)        ; get initial y.
    2660   00:B173                    ~ 		ld (ix+66),a        ; set y coord.
    2661   00:B173                    ~ 		add ix,de           ; point to next object.
    2662   00:B173                    ~ 		djnz .loop         ; repeat.
    2663   00:B173                    ~ 		ret
    2664   00:B173                    ~ 		*/
    2665   00:B173                    ~ 		ld a,(numob)        ; number of objects in the game.
    2666   00:B173                    ~ 		ld b,a				; objects counter
    2667   00:B173                    ~ 		ld hl,objdta+OBJSIZ-1	
    2668   00:B173                    ~ .loop:
    2669   00:B173                    ~ 		ld c,h				; h must be > 3
    2670   00:B173                    ~ 		ld d,h
    2671   00:B173                    ~ 		ld e,l
    2672   00:B173                    ~ 		dec de
    2673   00:B173                    ~ 		dec de
    2674   00:B173                    ~ 		dec de
    2675   00:B173                    ~ 		ldd
    2676   00:B173                    ~ 		ldd
    2677   00:B173                    ~ 		ldd
    2678   00:B173                    ~ 		ld de,OBJSIZ+3
    2679   00:B173                    ~ 		add hl,de
    2680   00:B173                    ~ 		djnz .loop         ; repeat.
    2681   00:B173                    ~ 		ret
    2682   00:B173                    ~ 		
    2683   00:B173                    ~ 	endif
    2684   00:B173                      	
    2685   00:B173                      	endif
    2686   00:B173                      	
    2687   00:B173                      	
    2688   00:B173                      ; Screen synchronisation.
    2689   00:B173                      
    2690   00:B173                      vsync:
    2691   00:B173  F5                  	push af
    2692   00:B174  E5                  	push hl
    2693   00:B175  CD 8F BE            	call buildspr
    2694   00:B178                      	if PFLAG
    2695   00:B178  CD 70 B2            		call proshr
    2696   00:B17B                      	endif
    2697   00:B17B                      	if EFLAG
    2698   00:B17B  CD 94 B1            		call beeper
    2699   00:B17E                      	endif
    2700   00:B17E  CD 10 BC            	call joykey
    2701   00:B181                      
    2702   00:B181                      ; Sync framerate to 25 Hz
    2703   00:B181                      
    2704   00:B181                      check_if_enough_frames_passed:
    2705   00:B181  21 7D 40            	ld hl,time
    2706   00:B184  7E                  	ld a,(hl)
    2707   00:B185  FE 01               	cp 1
    2708   00:B187  00                  	nop
    2709   00:B188  00                  	nop
    2710   00:B189  00                  	nop
    2711   00:B18A  00                  	nop
    2712   00:B18B  00                  	nop
    2713   00:B18C  00                  	nop
    2714   00:B18D  38 F2               	jr c,check_if_enough_frames_passed
    2715   00:B18F                      
    2716   00:B18F  AF                  	xor a			; sync framerate 25 Hz
    2717   00:B190  77                  	ld (hl),a
    2718   00:B191                      
    2719   00:B191  E1                  	pop hl
    2720   00:B192  F1                  	pop af
    2721   00:B193                      
    2722   00:B193  C9                  	ret
    2723   00:B194                      
    2724   00:B194                      ;~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~
    2725   00:B194                      ; SN76489AN sound chip
    2726   00:B194                      ;
    2727   00:B194                      ; Registers:
    2728   00:B194                      ; 0 - Tone 1 frequency
    2729   00:B194                      ; 1 - Tone 1 attenuation
    2730   00:B194                      ; 2 - Tone 2 frequency
    2731   00:B194                      ; 3 - Tone 21 attenuation
    2732   00:B194                      ; 4 - Tone 3 frequency
    2733   00:B194                      ; 5 - Tone 3 attenuation
    2734   00:B194                      ; 6 - Noise control
    2735   00:B194                      ; 7 - Noise attenuation
    2736   00:B194                      ;
    2737   00:B194                      ; Update noise source:
    2738   00:B194                      ;  +-+---------+------------+ +-+ +---+----------------------+
    2739   00:B194                      ;  |   | Reg Addr |    Data     | |   |       Data           |
    2740   00:B194                      ;  +---+----------+-------------+ +---+----------------------+ 
    2741   00:B194                      ;  | 1 | R0 R1 R2 | F6 F7 F8 F9 | | 0 | F0 F1 F2 F3 F4 F5 F6 |
    2742   00:B194                      ;  +---+----------+-------------+ +---+----------------------+
    2743   00:B194                      ;
    2744   00:B194                      ; Update noise source:
    2745   00:B194                      ;  +---+----------+---+----+---------+	
    2746   00:B194                      ;  |   | Reg Addr |   |    | Shift   |
    2747   00:B194                      ;  +---+----------+---+----+---------+
    2748   00:B194                      ;  | 1 | R0 R1 R2 | x | FB | NF0 NF1 | 
    2749   00:B194                      ;  +---+----------+---+----+---------+ 
    2750   00:B194                      ;
    2751   00:B194                      ;  NF0 NF1 Shift rate			FB	Configuration
    2752   00:B194                      ;   0   0  N/512			0	Periodic noise
    2753   00:B194                      ;   0   1  N/1024			1	White noise
    2754   00:B194                      ;   1   0  N/2048
    2755   00:B194                      ;   1   1  Tone generator #3 Output
    2756   00:B194                      ;
    2757   00:B194                      ; Update attenuator:
    2758   00:B194                      ;  +---+----------+-------------+
    2759   00:B194                      ;  |   | Reg Addr |    Data     |
    2760   00:B194                      ;  +---+----------+-------------+ 
    2761   00:B194                      ;  | 1 | R0 R1 R2 | A0 A1 A2 A3 |
    2762   00:B194                      ;  +---+----------+-------------+
    2763   00:B194                      
    2764   00:B194                      beeper:
    2765   00:B194  21 16 40            	ld hl,sndtyp
    2766   00:B197  7E                  	ld a,(hl)
    2767   00:B198  A7                  	and a
    2768   00:B199  28 40               	jr z,sndskip
    2769   00:B19B                      
    2770   00:B19B  3E 90               	ld a,%10010000		; PSG channel 0 full volume
    2771   00:B19D  CD DC B1            	call psgWrite
    2772   00:B1A0                      beepLoop:
    2773   00:B1A0  21 16 40            	ld hl,sndtyp
    2774   00:B1A3  7E                  	ld a,(hl)
    2775   00:B1A4  CB 17               	rl a
    2776   00:B1A6  E6 03               	and 3
    2777   00:B1A8  CB 17               	rl a
    2778   00:B1AA  CB 17               	rl a
    2779   00:B1AC  F6 80               	or %10000000
    2780   00:B1AE  CD DC B1            	call psgWrite
    2781   00:B1B1  21 16 40            	ld hl,sndtyp
    2782   00:B1B4  7E                  	ld a,(hl)
    2783   00:B1B5  CB 1F               	rr a
    2784   00:B1B7  CB 1F               	rr a
    2785   00:B1B9  CD DC B1            	call psgWrite
    2786   00:B1BC                      
    2787   00:B1BC  21 16 40            	ld hl,sndtyp
    2788   00:B1BF  7E                  	ld a,(hl)
    2789   00:B1C0                      
    2790   00:B1C0  47                  	ld b,a
    2791   00:B1C1                      beepWait:
    2792   00:B1C1  00                  	nop
    2793   00:B1C2  00                  	nop
    2794   00:B1C3  00                  	nop
    2795   00:B1C4  00                  	nop
    2796   00:B1C5  00                  	nop
    2797   00:B1C6  00                  	nop
    2798   00:B1C7  00                  	nop
    2799   00:B1C8  00                  	nop
    2800   00:B1C9  00                  	nop
    2801   00:B1CA  00                  	nop
    2802   00:B1CB  10 F4               	djnz beepWait
    2803   00:B1CD                      
    2804   00:B1CD  21 16 40            	ld hl,sndtyp
    2805   00:B1D0  7E                  	ld a,(hl)
    2806   00:B1D1  3D                  	dec a
    2807   00:B1D2  77                  	ld (hl),a
    2808   00:B1D3  A7                  	and a
    2809   00:B1D4  20 CA               	jr nz,beepLoop
    2810   00:B1D6                      
    2811   00:B1D6  3E 9F               	ld a,%10011111		; PSG channel 0 volume off
    2812   00:B1D8  CD DC B1            	call psgWrite
    2813   00:B1DB                      
    2814   00:B1DB                      sndskip:
    2815   00:B1DB  C9                  	ret
    2816   00:B1DC                      
    2817   00:B1DC                      psgWrite:
    2818   00:B1DC  D3 FF               	out ($ff),a
    2819   00:B1DE  C9                  	ret
    2820   00:B1DF                      
    2821   00:B1DF                      ;~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~
    2822   00:B1DF                      
    2823   00:B1DF                      ;		ld hl,MSX_JIFFY
    2824   00:B1DF                      ;		ld a,(hl)
    2825   00:B1DF                      ;
    2826   00:B1DF                      ;	if SFLAG
    2827   00:B1DF                      ;		push af
    2828   00:B1DF                      ;		push hl
    2829   00:B1DF                      ;		call scrltxt
    2830   00:B1DF                      ;		pop hl
    2831   00:B1DF                      ;		pop af
    2832   00:B1DF                      ;		cp (hl)
    2833   00:B1DF                      ;		jr z,.novbl0
    2834   00:B1DF                      ;		call scrly
    2835   00:B1DF                      ;	if PFLAG
    2836   00:B1DF                      ;;		call proshr
    2837   00:B1DF                      ;	endif
    2838   00:B1DF                      ;		call buildspr
    2839   00:B1DF                      ;	ret
    2840   00:B1DF                      ;	if EFLAG
    2841   00:B1DF                      ;		call beeper
    2842   00:B1DF                      ;	endif
    2843   00:B1DF                      ;		call joykey
    2844   00:B1DF                      ;		jr .nowait
    2845   00:B1DF                      ;		
    2846   00:B1DF                      ;.novbl0:		
    2847   00:B1DF                      ;	endif
    2848   00:B1DF                      ;
    2849   00:B1DF                      ;	if PFLAG
    2850   00:B1DF                      ;		
    2851   00:B1DF                      ;		push af
    2852   00:B1DF                      ;		push hl
    2853   00:B1DF                      ;		call proshr
    2854   00:B1DF                      ;		pop hl
    2855   00:B1DF                      ;		pop af
    2856   00:B1DF                      ;		cp (hl)
    2857   00:B1DF                      ;		jr z,.novbl1
    2858   00:B1DF                      ;	if SFLAG
    2859   00:B1DF                      ;		call scrly
    2860   00:B1DF                      ;	endif
    2861   00:B1DF                      ;		call buildspr
    2862   00:B1DF                      ;	if EFLAG
    2863   00:B1DF                      ;		call beeper
    2864   00:B1DF                      ;	endif
    2865   00:B1DF                      ;		call joykey
    2866   00:B1DF                      ;		jr .nowait
    2867   00:B1DF                      ;		
    2868   00:B1DF                      ;.novbl1:		
    2869   00:B1DF                      ;	endif
    2870   00:B1DF                      ;		
    2871   00:B1DF                      ;		push af
    2872   00:B1DF                      ;		push hl
    2873   00:B1DF                      ;		call buildspr
    2874   00:B1DF                      ;		pop hl
    2875   00:B1DF                      ;		pop af
    2876   00:B1DF                      ;		cp (hl)
    2877   00:B1DF                      ;		jr z,.novbl2
    2878   00:B1DF                      ;	if SFLAG
    2879   00:B1DF                      ;		call scrly
    2880   00:B1DF                      ;	endif
    2881   00:B1DF                      ;	if EFLAG
    2882   00:B1DF                      ;		call beeper
    2883   00:B1DF                      ;	endif
    2884   00:B1DF                      ;		call joykey
    2885   00:B1DF                      ;		jr .nowait
    2886   00:B1DF                      ;
    2887   00:B1DF                      ;.novbl2:
    2888   00:B1DF                      ;	if EFLAG
    2889   00:B1DF                      ;		call beeper
    2890   00:B1DF                      ;	endif
    2891   00:B1DF                      ;		cp (hl)
    2892   00:B1DF                      ;		jr z,.novbl3
    2893   00:B1DF                      ;	if SFLAG
    2894   00:B1DF                      ;		call scrly
    2895   00:B1DF                      ;	endif
    2896   00:B1DF                      ;		call joykey
    2897   00:B1DF                      ;		jr .nowait
    2898   00:B1DF                      ;		
    2899   00:B1DF                      ;.novbl3:
    2900   00:B1DF                      ;		push af
    2901   00:B1DF                      ;		push hl
    2902   00:B1DF                      ;		call joykey
    2903   00:B1DF                      ;		pop hl
    2904   00:B1DF                      ;		pop af
    2905   00:B1DF                      ;		cp (hl)
    2906   00:B1DF                      ;		; jr z,.novbl5
    2907   00:B1DF                      ;		jr z,.wait
    2908   00:B1DF                      ;	if SFLAG
    2909   00:B1DF                      ;		call scrly
    2910   00:B1DF                      ;	endif
    2911   00:B1DF                      ;		jr .nowait
    2912   00:B1DF                      ;		
    2913   00:B1DF                      ;.wait:		
    2914   00:B1DF                      ;	ifdef DEBUG
    2915   00:B1DF                      ;		BORDER 13
    2916   00:B1DF                      ;	endif
    2917   00:B1DF                      ;		cp (hl)
    2918   00:B1DF                      ;		jr z,.wait
    2919   00:B1DF                      ;	if SFLAG
    2920   00:B1DF                      ;		call scrly
    2921   00:B1DF                      ;	endif
    2922   00:B1DF                      ;	
    2923   00:B1DF                      ;.nowait:
    2924   00:B1DF                      ;	ifdef DEBUG
    2925   00:B1DF                      ;		BORDER 14
    2926   00:B1DF                      ;	endif
    2927   00:B1DF                      ;		ret
    2928   00:B1DF                      ;
    2929   00:B1DF                      ;	if EFLAG
    2930   00:B1DF                      ;	
    2931   00:B1DF                      ;	ifdef DEBUG
    2932   00:B1DF                      ;		BORDER 15
    2933   00:B1DF                      ;	endif
    2934   00:B1DF                      ;		ld e,a				; keeps JIFFY
    2935   00:B1DF                      ;		ld a,(sndtyp)       ; sound to play.
    2936   00:B1DF                      ;		and a               ; any sound?
    2937   00:B1DF                      ;		jr z,beep1			; no.
    2938   00:B1DF                      ;		ld b,a              ; outer loop.
    2939   00:B1DF                      ;		and a               ; test it.
    2940   00:B1DF                      ;		ld c,14				; first value to write (0)
    2941   00:B1DF                      ;		jp m,noise          ; play white noise.
    2942   00:B1DF                      ;.beep2:
    2943   00:B1DF                      ;		ld a,c              ; (5) get speaker value.
    2944   00:B1DF                      ;		out (MSX_PPICM),a   ; (12) write to speaker.
    2945   00:B1DF                      ;		xor 1               ; (7) toggle bit 0.
    2946   00:B1DF                      ;		ld c,a              ; (5) store value for next time.
    2947   00:B1DF                      ;		ld d,b              ; (5) store loop counter.
    2948   00:B1DF                      ;		
    2949   00:B1DF                      ;		ld a,(snddelay)
    2950   00:B1DF                      ;		or a
    2951   00:B1DF                      ;		jr z,.nodelay
    2952   00:B1DF                      ;		ld b,a
    2953   00:B1DF                      ;		djnz $
    2954   00:B1DF                      ;		ld b,d
    2955   00:B1DF                      ;.nodelay:		
    2956   00:B1DF                      ;		ld a,e				; (5) restore old JiFFY
    2957   00:B1DF                      ;.beep3:
    2958   00:B1DF                      ;		cp (hl)				; (8) next frame?
    2959   00:B1DF                      ;		jr nz,.beep4		; (8/13) yes, no more processing please.
    2960   00:B1DF                      ;		djnz .beep3         ; (14/9) loop while frame doesn't changes.
    2961   00:B1DF                      ;		
    2962   00:B1DF                      ;		ld b,d              ; (5) restore loop counter.
    2963   00:B1DF                      ;		djnz .beep2         ; (14/9) continue noise.
    2964   00:B1DF                      ;							; (87)
    2965   00:B1DF                      ;.beep4:
    2966   00:B1DF                      ;		ld a,d              ; where we got to.
    2967   00:B1DF                      ;vsynca:
    2968   00:B1DF                      ;		ld (sndtyp),a       ; remember for next time.
    2969   00:B1DF                      ;beep1:		
    2970   00:B1DF                      ;		ld a,e
    2971   00:B1DF                      ;
    2972   00:B1DF                      ;	ifdef DEBUG
    2973   00:B1DF                      ;		BORDER 14
    2974   00:B1DF                      ;	endif
    2975   00:B1DF                      ;
    2976   00:B1DF                      ;		ret
    2977   00:B1DF                      
    2978   00:B1DF                      ; Play white noise
    2979   00:B1DF                      
    2980   00:B1DF                      ;noise: 
    2981   00:B1DF                      ;		sub 127
    2982   00:B1DF                      ;		ld b,a				; outer loop
    2983   00:B1DF                      ;vsync7:
    2984   00:B1DF                      ;		ld a,r              ; get random speaker value.
    2985   00:B1DF                      ;		and 2               ; only retain the speaker/earphone bits.
    2986   00:B1DF                      ;		rrca
    2987   00:B1DF                      ;		or c                ; merge with command PPI bit 7.
    2988   00:B1DF                      ;		out (MSX_PPICM),a   ; write to speaker.
    2989   00:B1DF                      ;		ld a,e				; restore old JiFFY
    2990   00:B1DF                      ;		cp (hl)             ; subtract last reading.
    2991   00:B1DF                      ;		jp nz,vsync8        ; yes, no more processing please.
    2992   00:B1DF                      ;		ld a,b
    2993   00:B1DF                      ;		;and 127
    2994   00:B1DF                      ;		inc a
    2995   00:B1DF                      ;vsync9:
    2996   00:B1DF                      ;		dec a
    2997   00:B1DF                      ;		jr nz,vsync9        ; loop.
    2998   00:B1DF                      ;		djnz vsync7         ; continue noise.
    2999   00:B1DF                      ;vsync8:
    3000   00:B1DF                      ;		xor a
    3001   00:B1DF                      ;		jr vsynca
    3002   00:B1DF                      ;
    3003   00:B1DF                      ;	endif
    3004   00:B1DF                      	
    3005   00:B1DF                      ; Redraw the screen.
    3006   00:B1DF                      
    3007   00:B1DF                      redraw:
    3008   00:B1DF                      	if MBFLAG
    3009   00:B1DF                    ~ 		ld a,WINDOWWID
    3010   00:B1DF                    ~ 		ld (winwid),a
    3011   00:B1DF                    ~ 		ld a,WINDOWHGT
    3012   00:B1DF                    ~ 		ld (winhgt),a
    3013   00:B1DF                    ~ 	endif
    3014   00:B1DF                      
    3015   00:B1DF  CD A7 C2            		call clrscrmap
    3016   00:B1E2  DD E5               		push ix             ; place sprite pointer on stack.
    3017   00:B1E4                      		; ld (nohide),a		; disable screen hiding
    3018   00:B1E4                      		
    3019   00:B1E4  CD 84 BA            		call droom          ; show screen layout.
    3020   00:B1E7                      	if OFLAG
    3021   00:B1E7  CD CD B6            		call shwob          ; draw objects.
    3022   00:B1EA                      	endif
    3023   00:B1EA                      
    3024   00:B1EA                      		WAITFRAME
    3024   00:B1EA                    >   ifdef DEBUG
    3024   00:B1EA                    ~   BORDER 13
    3024   00:B1EA                    ~   endif
    3024   00:B1EA  FB                >   ei
    3024   00:B1EB  21 9E 5C          >   ld hl,MSX_JIFFY
    3024   00:B1EE  7E                >   ld a,(hl)
    3024   00:B1EF                    > .wait:
    3024   00:B1EF  BE                >   cp (hl)
    3024   00:B1F0  28 FD             >   jr z,.wait
    3024   00:B1F2                    >   ifdef DEBUG
    3024   00:B1F2                    ~   BORDER 14
    3024   00:B1F2                    ~   endif
    3025   00:B1F2                      		
    3026   00:B1F2  21 80 45            		ld hl,spratr
    3027   00:B1F5  11 00 1B            		ld de,MSX_SPRATR
    3028   00:B1F8  06 80               		ld b,128
    3029   00:B1FA  CD 5F BE            		call ram2vram			   
    3030   00:B1FD                      	   
    3031   00:B1FD                      rpblc1:
    3032   00:B1FD                      	if PFLAG
    3033   00:B1FD  CD F1 B4            		call dshrp          ; redraw shrapnel.
    3034   00:B200                      	endif
    3035   00:B200                      	if AFLAG
    3036   00:B200                    ~ 		call rbloc          ; draw blocks for this screen
    3037   00:B200                    ~ 	endif
    3038   00:B200  DD E1               		pop ix              ; retrieve sprite pointer.
    3039   00:B202  C9                  		ret
    3040   00:B203                      
    3041   00:B203                      ; swap PAL/NTSC
    3042   00:B203                      
    3043   00:B203                      swaphz:		
    3044   00:B203  3A E8 5F            		ld a,(MSX_RG9SAV)
    3045   00:B206  EE 02               		xor 2
    3046   00:B208  47                  		ld b,a
    3047   00:B209  0E 09               		ld c,9
    3048   00:B20B  F5                  		push af
    3049   00:B20C  CD D9 1F            		call MSX_WRTVDP			
    3050   00:B20F  F1                  		pop af
    3051   00:B210  C9                  		ret
    3052   00:B211                      
    3053   00:B211                      ; Clear screen routine.
    3054   00:B211                      
    3055   00:B211                      cls:
    3056   00:B211  3A 39 40            		ld a,(clratt)
    3057   00:B214  5F                  		ld e,a
    3058   00:B215  E6 F0               		and $F0
    3059   00:B217  0F                  		rrca
    3060   00:B218  0F                  		rrca
    3061   00:B219  0F                  		rrca
    3062   00:B21A  0F                  		rrca
    3063   00:B21B  32 E9 53            		ld (MSX_FORCLR),a
    3064   00:B21E  7B                  		ld a,e
    3065   00:B21F  E6 0F               		and $0F
    3066   00:B221  32 EA 53            		ld (MSX_BAKCLR),a
    3067   00:B224  AF                  		xor a
    3068   00:B225  CD 71 C7            		call MSX_CLS
    3069   00:B228  21 00 00            		ld hl,0             ; set hl to origin (0, 0).
    3070   00:B22B  22 35 40            		ld (charx),hl       ; reset coordinates.
    3071   00:B22E  CD A7 C2            		call clrscrmap
    3072   00:B231  C3 57 BE            		jp dissprs
    3073   00:B234                      
    3074   00:B234                      ; Set palette routine and data.
    3075   00:B234                      ; Palette.
    3076   00:B234                      
    3077   00:B234                      setpal:
    3078   00:B234  3A 07 00            		ld a,(MSX_VDPPRT)	; get first VDP write port
    3079   00:B237  4F                  		ld c,a
    3080   00:B238  0C                  		inc c      		; prepare to write register data
    3081   00:B239  AF                  		xor a      		; from color 0
    3082   00:B23A  ED 79               		out (c),a
    3083   00:B23C  3E 90               		ld a,16+128		; write R#16
    3084   00:B23E  ED 79               		out (c),a
    3085   00:B240  0C                  		inc c      		; prepare to write palette data
    3086   00:B241  06 20               		ld b,32      	; 16 color * 2 bytes for palette data
    3087   00:B243  ED B3               		otir
    3088   00:B245  C9                  		ret
    3089   00:B246                      		
    3090   00:B246                      	if (PFLAG or DFLAG)
    3091   00:B246                      	
    3092   00:B246                      fdchk:
    3093   00:B246  7E                  		ld a,(hl)           ; fetch cell.
    3094   00:B247  FE 04               		cp FODDER           ; is it fodder?
    3095   00:B249  C0                  		ret nz              ; no.
    3096   00:B24A  36 00               		ld (hl),0           ; rewrite block type.
    3097   00:B24C  E5                  		push hl             ; store pointer to block.
    3098   00:B24D  11 00 46            		ld de,MAP           ; address of map.
    3099   00:B250  A7                  		and a               ; clear carry flag for subtraction.
    3100   00:B251  ED 52               		sbc hl,de           ; find simple displacement for block.
    3101   00:B253  7D                  		ld a,l              ; low byte is y coordinate.
    3102   00:B254  E6 1F               		and 31              ; column position 0 - 31.
    3103   00:B256  32 56 40            		ld (dispy),a        ; set up y position.
    3104   00:B259  29                  		add hl,hl           ; multiply displacement by 8.
    3105   00:B25A  29                  		add hl,hl
    3106   00:B25B  29                  		add hl,hl
    3107   00:B25C  7C                  		ld a,h              ; x coordinate now in h.
    3108   00:B25D  32 55 40            		ld (dispx),a        ; set the display coordinate.
    3109   00:B260  2A DF B0            		ld hl,(blkptr)      ; blocks.
    3110   00:B263  22 3F 40            		ld (grbase),hl      ; set graphics base.		
    3111   00:B266  AF                  		xor a               ; block to write.
    3112   00:B267  CD FE B9            		call pattr          ; write block.
    3113   00:B26A  E1                  		pop hl              ; restore block pointer.
    3114   00:B26B  C9                  		ret
    3115   00:B26C                      		
    3116   00:B26C                      	endif
    3117   00:B26C                      	
    3118   00:B26C                      ; Colour a sprite.
    3119   00:B26C                      
    3120   00:B26C                      cspr:
    3121   00:B26C  DD 71 05            		ld (ix+5),c
    3122   00:B26F  C9                  		ret
    3123   00:B270                      				
    3124   00:B270                      	if PFLAG
    3125   00:B270                      
    3126   00:B270                      ; Specialist routines.
    3127   00:B270                      ; Process shrapnel.
    3128   00:B270                      		
    3129   00:B270                      proshr:
    3130   00:B270  CD A4 B2            		call setshr
    3131   00:B273                      		
    3132   00:B273                      proshrnoset:
    3133   00:B273                      		
    3134   00:B273                      	ifdef DEBUG
    3135   00:B273                    ~ 		BORDER 5
    3136   00:B273                    ~ 	endif
    3137   00:B273                      
    3138   00:B273  CD 8B B2            		call proshr0
    3139   00:B276  CD 8B B2            		call proshr0
    3140   00:B279  CD 8B B2            		call proshr0
    3141   00:B27C  CD 8B B2            		call proshr0
    3142   00:B27F  CD 8B B2            		call proshr0
    3143   00:B282  CD 8B B2            		call proshr0
    3144   00:B285  CD 8B B2            		call proshr0
    3145   00:B288  CD 8B B2            		call proshr0
    3146   00:B28B                      		
    3147   00:B28B                      	ifdef DEBUG
    3148   00:B28B                    ~ 
    3149   00:B28B                    ~ 		call proshr0 	
    3150   00:B28B                    ~ 		BORDER 14
    3151   00:B28B                    ~ 		ret
    3152   00:B28B                    ~ 
    3153   00:B28B                    ~ 	else
    3154   00:B28B                      
    3155   00:B28B                      proshr0:
    3156   00:B28B  DD 2A C0 4D         		ld ix,(shraddr)
    3157   00:B28F  06 03               		ld b,NUMSHR/(9*2)
    3158   00:B291                      proshloop:
    3159   00:B291  DD 7E 00            		ld a,(ix+0)         ; on/off marker.
    3160   00:B294  17                  		rla                 ; check its status.
    3161   00:B295  D4 B4 B2            		call nc,proshx      ; on, so process it.
    3162   00:B298  11 12 00            		ld de,SHRSIZ*2      ; distance to next.
    3163   00:B29B  DD 19               		add ix,de           ; point there.
    3164   00:B29D  10 F2               		djnz proshloop      ; round again.
    3165   00:B29F  DD 22 C0 4D         		ld (shraddr),ix
    3166   00:B2A3  C9                  		ret
    3167   00:B2A4                      	
    3168   00:B2A4                      	endif
    3169   00:B2A4                      	
    3170   00:B2A4                      setshr:
    3171   00:B2A4  3A 9E 5C            		ld a,(MSX_JIFFY)
    3172   00:B2A7                      setshr0:
    3173   00:B2A7  21 CB 4D            		ld hl,SHRAPN+SHRSIZ        ; table.
    3174   00:B2AA  0F                  		rrca
    3175   00:B2AB  38 03               		jr c,.shrodd
    3176   00:B2AD  21 C2 4D            		ld hl,SHRAPN			 ; table.
    3177   00:B2B0                      .shrodd:
    3178   00:B2B0  22 C0 4D            		ld (shraddr),hl
    3179   00:B2B3  C9                  		ret
    3180   00:B2B4                      
    3181   00:B2B4                      	ifdef DEBUG
    3182   00:B2B4                    ~ 		
    3183   00:B2B4                    ~ proshr0:
    3184   00:B2B4                    ~ 		ld ix,(shraddr)
    3185   00:B2B4                    ~ 		ld b,NUMSHR/(9*2)
    3186   00:B2B4                    ~ proshloop:
    3187   00:B2B4                    ~ 		ld a,(ix+0)         ; on/off marker.
    3188   00:B2B4                    ~ 		rla                 ; check its status.
    3189   00:B2B4                    ~ 		call nc,proshx      ; on, so process it.
    3190   00:B2B4                    ~ 		ld de,SHRSIZ*2      ; distance to next.
    3191   00:B2B4                    ~ 		add ix,de           ; point there.
    3192   00:B2B4                    ~ 		djnz proshloop      ; round again.
    3193   00:B2B4                    ~ 		ld (shraddr),ix
    3194   00:B2B4                    ~ 		ret
    3195   00:B2B4                    ~ 
    3196   00:B2B4                    ~ 	endif
    3197   00:B2B4                      
    3198   00:B2B4                      proshx:
    3199   00:B2B4  2A 17 40            		ld hl,(shrplot)
    3200   00:B2B7  E9                  		jp (hl)
    3201   00:B2B8                      
    3202   00:B2B8                      prosh1:
    3203   00:B2B8  C5                  		push bc             ; store counter.
    3204   00:B2B9  CD 27 B3            		call plot           ; delete the pixel.
    3205   00:B2BC  DD 7E 00            		ld a,(ix+0)         ; restore shrapnel type.
    3206   00:B2BF  CD C7 B2            		call prosh2         ; run the routine.
    3207   00:B2C2  CD 00 B3            		call chkxy          ; check x and y are good before we redisplay.
    3208   00:B2C5  C1                  		pop bc              ; restore counter.
    3209   00:B2C6  C9                  		ret
    3210   00:B2C7                      prosh2:
    3211   00:B2C7  87                  		add a,a		
    3212   00:B2C8  C6 08               		add a,shrptr&$FF
    3213   00:B2CA  6F                  		ld l,a
    3214   00:B2CB  26 C4               		ld h,shrptr>>8
    3215   00:B2CD                      		;ld (addr+1),a			; auto-modifying code
    3216   00:B2CD                      ;addr:
    3217   00:B2CD                      		;ld hl,(shrptr)
    3218   00:B2CD                      
    3219   00:B2CD  C3 12 BE            		jp jumphl
    3220   00:B2D0                       
    3221   00:B2D0                      
    3222   00:B2D0                      ; Explosion shrapnel.
    3223   00:B2D0                      ; 220
    3224   00:B2D0                      /*
    3225   00:B2D0                    ~ shrap: 
    3226   00:B2D0                    ~ 		ld h,(shrsin >> 8) & $FF    ; Get MSB of table
    3227   00:B2D0                    ~ 		ld l,(ix+1)
    3228   00:B2D0                    ~ 		
    3229   00:B2D0                    ~ 		ld e,(hl)           ; fetch value from table.
    3230   00:B2D0                    ~ 		inc hl              ; next byte of table.
    3231   00:B2D0                    ~ 		ld d,(hl)           ; fetch value from table.
    3232   00:B2D0                    ~ 		
    3233   00:B2D0                    ~ 		inc hl              ; next byte of table.
    3234   00:B2D0                    ~ 		ld c,(hl)           ; fetch value from table.
    3235   00:B2D0                    ~ 		inc hl              ; next byte of table.
    3236   00:B2D0                    ~ 		ld b,(hl)           ; fetch value from table.
    3237   00:B2D0                    ~ 		
    3238   00:B2D0                    ~ 		ld l,(ix+2)         ; x coordinate in hl.
    3239   00:B2D0                    ~ 		ld h,(ix+3)
    3240   00:B2D0                    ~ 		add hl,de           ; add sine.
    3241   00:B2D0                    ~ 		ld (ix+2),l         ; store new coordinate.
    3242   00:B2D0                    ~ 		ld (ix+3),h
    3243   00:B2D0                    ~ 		
    3244   00:B2D0                    ~ 		ld l,(ix+4)         ; y coordinate in hl.
    3245   00:B2D0                    ~ 		ld h,(ix+5)
    3246   00:B2D0                    ~ 		add hl,bc           ; add cosine.
    3247   00:B2D0                    ~ 		ld (ix+4),l         ; store new coordinate.
    3248   00:B2D0                    ~ 		ld (ix+5),h
    3249   00:B2D0                    ~ 		ret
    3250   00:B2D0                    ~  */
    3251   00:B2D0                       ; 182 -> 156
    3252   00:B2D0                      shrap: 
    3253   00:B2D0  26 C4               		ld h,shrsin>>8    ; Get MSB of table
    3254   00:B2D2  DD 7E 01            		ld a,(ix+1)
    3255   00:B2D5  C6 18               		add a,shrsin&$FF	; table offset (saving some bytes)
    3256   00:B2D7  6F                  		ld l,a
    3257   00:B2D8  ED 73 7B 40         		ld (stack),sp
    3258   00:B2DC  F3                  		di
    3259   00:B2DD  F9                  		ld sp,hl
    3260   00:B2DE  D1                  		pop de						; fetch sine
    3261   00:B2DF  C1                  		pop bc						; fetch cosine
    3262   00:B2E0  DD F9               		ld sp,ix
    3263   00:B2E2  E1                  		pop hl
    3264   00:B2E3  E1                  		pop hl
    3265   00:B2E4  19                  		add hl,de
    3266   00:B2E5  E5                  		push hl		
    3267   00:B2E6  E1                  		pop hl
    3268   00:B2E7  E1                  		pop hl
    3269   00:B2E8  09                  		add hl,bc
    3270   00:B2E9  E5                  		push hl				
    3271   00:B2EA  FB                  		ei
    3272   00:B2EB  ED 7B 7B 40         		ld sp,(stack)            ;parameter will overwritten
    3273   00:B2EF  C9                  		ret
    3274   00:B2F0                      
    3275   00:B2F0  DD 35 05            dotl:   dec (ix+5)          ; move left.
    3276   00:B2F3  C9                          ret
    3277   00:B2F4  DD 34 05            dotr:   inc (ix+5)          ; move left.
    3278   00:B2F7  C9                          ret
    3279   00:B2F8  DD 35 03            dotu:   dec (ix+3)          ; move up.
    3280   00:B2FB  C9                          ret
    3281   00:B2FC  DD 34 03            dotd:   inc (ix+3)          ; move down.
    3282   00:B2FF  C9                          ret
    3283   00:B300                      
    3284   00:B300                      ; Check coordinates are good before redrawing at new position.
    3285   00:B300                      
    3286   00:B300                      chkxy:
    3287   00:B300                      ;		ld (ix+7),255
    3288   00:B300                      
    3289   00:B300  21 D9 B0            		ld hl,wntopx        ; window top.
    3290   00:B303  DD 7E 03            		ld a,(ix+3)         ; fetch shrapnel Y coordinate.
    3291   00:B306  BE                  		cp (hl)             ; compare with top window limit.
    3292   00:B307  38 19               		jr c,kilshr         ; out of window, kill shrapnel.
    3293   00:B309  23                  		inc hl              ; left edge.
    3294   00:B30A  DD 7E 05            		ld a,(ix+5)         ; fetch shrapnel X coordinate.
    3295   00:B30D  BE                  		cp (hl)             ; compare with left window limit.
    3296   00:B30E  38 12               		jr c,kilshr         ; out of window, kill shrapnel.
    3297   00:B310                      
    3298   00:B310  23                  		inc hl              ; point to bottom.
    3299   00:B311  7E                  		ld a,(hl)           ; fetch window limit.
    3300   00:B312  C6 0F               		add a,MSX_SPRVS-1   ; add height of sprite.
    3301   00:B314  DD BE 03            		cp (ix+3)           ; compare with shrapnel Y coordinate.
    3302   00:B317  38 09               		jr c,kilshr         ; off screen, kill shrapnel.
    3303   00:B319  23                  		inc hl              ; point to right edge.
    3304   00:B31A  7E                  		ld a,(hl)           ; fetch shrapnel X coordinate.
    3305   00:B31B  C6 0F               		add a,MSX_SPRVS-1   ; add width of sprite.
    3306   00:B31D  DD BE 05            		cp (ix+5)           ; compare with window limit.
    3307   00:B320  30 05               		jr nc,plot          ; off screen, kill shrapnel.
    3308   00:B322                      
    3309   00:B322                      kilshr:
    3310   00:B322  DD 36 00 80         		ld (ix+0),128       ; switch off shrapnel.
    3311   00:B326                      		; ld (ix+7),255       ; switch off shrapnel.
    3312   00:B326                      		
    3313   00:B326  C9                  		ret
    3314   00:B327                      
    3315   00:B327                      
    3316   00:B327                      ; Drop through.
    3317   00:B327                      ; Display shrapnel.
    3318   00:B327                      
    3319   00:B327                      plot:   ; ret
    3320   00:B327                      
    3321   00:B327  DD 6E 03            		ld l,(ix+3)         ; y integer.
    3322   00:B32A  DD 66 05            		ld h,(ix+5)         ; x integer.
    3323   00:B32D  22 55 40            		ld (dispx),hl       ; workspace coordinates.
    3324   00:B330  DD 7E 00            		ld a,(ix+0)         ; type.
    3325   00:B333  A7                  		and a               ; is it a laser?
    3326   00:B334  28 1F               		jr z,plot1          ; yes, draw laser instead.
    3327   00:B336                      
    3328   00:B336                      ; INPUT:
    3329   00:B336                      ; 	H = X
    3330   00:B336                      ;	L = Y
    3331   00:B336                      plot0:
    3332   00:B336                      /*
    3333   00:B336                    ~ 		ld a,h              ; 5 which pixel within byte do we
    3334   00:B336                    ~ 		and 7               ; 7 want to set first?		
    3335   00:B336                    ~ 		ld e,a				; 5
    3336   00:B336                    ~ 		call scadd          	; screen address.		
    3337   00:B336                    ~ 		ld a,l				; 5 (22)
    3338   00:B336                    ~ 		di					; 5
    3339   00:B336                    ~ 		out (MSX_VDPCW),a	; 12
    3340   00:B336                    ~ 		ld a,h				; 5
    3341   00:B336                    ~ 		out (MSX_VDPCW),a	; 12
    3342   00:B336                    ~ 		ld d,dots>>8		; 7 Get MSB of table
    3343   00:B336                    ~ 		ld a,(de)			; 8 get value
    3344   00:B336                    ~ 		ld e,a				; 5
    3345   00:B336                    ~ 		in a,(MSX_VDPDRW)   ; 12 (66)
    3346   00:B336                    ~ 		xor e				; 5
    3347   00:B336                    ~ 		ld e,a				; 5
    3348   00:B336                    ~ 		ld a,l				; 5
    3349   00:B336                    ~ 		out (MSX_VDPCW),a	; 12
    3350   00:B336                    ~ 		ld a,h				; 5
    3351   00:B336                    ~ 		or 64				; 7
    3352   00:B336                    ~ 		out (MSX_VDPCW),a	; 12
    3353   00:B336                    ~ 		ei					; 5
    3354   00:B336                    ~ 		ld a,e				; 5
    3355   00:B336                    ~ 		out (MSX_VDPDRW),a	; 12 (73) 161		 = 139
    3356   00:B336                    ~ 		ret	   
    3357   00:B336                    ~ */
    3358   00:B336                      
    3359   00:B336                      
    3360   00:B336  7C                  		ld a,h              ; 5 which pixel within byte do we
    3361   00:B337  E6 07               		and 7               ; 7 want to set first?		
    3362   00:B339  5F                  		ld e,a				; 5	(24)
    3363   00:B33A  CD 77 BF            		call scadd          	; screen address.					
    3364   00:B33D  0E BF               		ld c,MSX_VDPCW		; 7
    3365   00:B33F  F3                  		di					; 5
    3366   00:B340  ED 69               		out (c),l			; 14	
    3367   00:B342  ED 61               		out (c),h			; 14
    3368   00:B344  16 C4               		ld d,dots>>8		; 7 Get MSB of table
    3369   00:B346  1A                  		ld a,(de)			; 8 get value
    3370   00:B347  5F                  		ld e,a				; 5
    3371   00:B348                      pltwrt:
    3372   00:B348  DB BE               		in a,(MSX_VDPDRW)   ; 12
    3373   00:B34A  AB                  		xor e				; 5 (70)
    3374   00:B34B  ED 69               		out (c),l			; 14
    3375   00:B34D  CB F4               		set 6,h				; 10
    3376   00:B34F  ED 61               		out (c),h			; 14
    3377   00:B351  FB                  		ei					; 5
    3378   00:B352  D3 BE               		out (MSX_VDPDRW),a	; 12 (65)		 = 159
    3379   00:B354  C9                  		ret	   
    3380   00:B355                      		
    3381   00:B355                      plot1:
    3382   00:B355  CD 77 BF            		call scadd          ; screen address.
    3383   00:B358  0E BF               		ld c,MSX_VDPCW		; 7
    3384   00:B35A  F3                  		di					; 5
    3385   00:B35B  ED 69               		out (c),l			; 14	
    3386   00:B35D  ED 61               		out (c),h			; 14
    3387   00:B35F  1E FF               		ld e,255
    3388   00:B361  C3 48 B3            		jp pltwrt
    3389   00:B364                      		
    3390   00:B364                      		/*
    3391   00:B364                    ~ 		and $FF					; dummy, wait 7 cycles
    3392   00:B364                    ~ 		and $FF					; dummy, wait 7 cycles
    3393   00:B364                    ~ 		in a,(MSX_VDPDRW)   ; 12
    3394   00:B364                    ~ 		cpl					; 5 (70)
    3395   00:B364                    ~ 		out (c),l			; 14
    3396   00:B364                    ~ 		set 6,h				; 10
    3397   00:B364                    ~ 		out (c),h			; 14
    3398   00:B364                    ~ 		ei					; 5
    3399   00:B364                    ~ 		out (MSX_VDPDRW),a	; 12 (65)		 = 159
    3400   00:B364                    ~ 		ret	   
    3401   00:B364                    ~ 		*/
    3402   00:B364                      /*
    3403   00:B364                    ~ 		call scadd          ; screen address.
    3404   00:B364                    ~ 		ld a,l
    3405   00:B364                    ~ 		di
    3406   00:B364                    ~ 		out (MSX_VDPCW),a
    3407   00:B364                    ~ 		ld a,h
    3408   00:B364                    ~ 		out (MSX_VDPCW),a
    3409   00:B364                    ~ 		and $FF					; dummy, wait 7 cycles
    3410   00:B364                    ~ 		and $FF					; dummy, wait 7 cycles
    3411   00:B364                    ~ 		in a,(MSX_VDPDRW)
    3412   00:B364                    ~ 		cpl
    3413   00:B364                    ~ 		ld e,a
    3414   00:B364                    ~ 		ld a,l
    3415   00:B364                    ~ 		out (MSX_VDPCW),a
    3416   00:B364                    ~ 		ld a,h
    3417   00:B364                    ~ 		or 64
    3418   00:B364                    ~ 		out (MSX_VDPCW),a
    3419   00:B364                    ~ 		ei	
    3420   00:B364                    ~ 		ld a,e
    3421   00:B364                    ~ 		out (MSX_VDPDRW),a		
    3422   00:B364                    ~ 		ret
    3423   00:B364                    ~ */
    3424   00:B364                      
    3425   00:B364                      
    3426   00:B364                      
    3427   00:B364                      trail:
    3428   00:B364  DD 35 01            		dec (ix+1)          ; time remaining.
    3429   00:B367  CA 86 B3            		jp z,trailk        ; time to switch it off.
    3430   00:B36A  CD E4 B4            		call qrand          ; get a random number.
    3431   00:B36D  1F                  		rra                 ; x or y axis?
    3432   00:B36E  38 0B               		jr c,.trailv        ; use x.
    3433   00:B370  1F                  		rra                 ; which direction?
    3434   00:B371  38 04               		jr c,.traill        ; go left.
    3435   00:B373  DD 34 05            		inc (ix+5)          ; go right.
    3436   00:B376  C9                  		ret
    3437   00:B377                      .traill:
    3438   00:B377  DD 35 05            		dec (ix+5)          ; go left.
    3439   00:B37A  C9                  		ret
    3440   00:B37B                      .trailv:
    3441   00:B37B  1F                  		rra                 ; which direction?
    3442   00:B37C  38 04               		jr c,.trailu        ; go up.
    3443   00:B37E  DD 34 03            		inc (ix+3)          ; go down.
    3444   00:B381  C9                  		ret
    3445   00:B382                      .trailu:
    3446   00:B382  DD 35 03            		dec (ix+3)          ; go up.
    3447   00:B385  C9                  		ret
    3448   00:B386                      trailk:
    3449   00:B386  DD 36 03 C8         		ld (ix+3),200       ; set off-screen to kill vapour trail.
    3450   00:B38A  C9                  		ret
    3451   00:B38B                      
    3452   00:B38B                      laser:
    3453   00:B38B  DD 7E 01            		ld a,(ix+1)         ; direction.
    3454   00:B38E  1F                  		rra                 ; left or right?
    3455   00:B38F  30 04               		jr nc,laserl        ; move left.
    3456   00:B391  06 08               		ld b,8              ; distance to travel.
    3457   00:B393  18 02               		jr laserm           ; move laser.
    3458   00:B395                      laserl:
    3459   00:B395  06 F8               		ld b,248            ; distance to travel.
    3460   00:B397                      laserm:
    3461   00:B397  DD 7E 05            		ld a,(ix+5)         ; y position.
    3462   00:B39A  80                  		add a,b             ; add distance.
    3463   00:B39B  DD 77 05            		ld (ix+5),a         ; set new y coordinate.
    3464   00:B39E                      
    3465   00:B39E                      ; Test new block.
    3466   00:B39E                      
    3467   00:B39E  32 56 40            		ld (dispy),a        ; set y for block collision detection purposes.
    3468   00:B3A1  DD 7E 03            		ld a,(ix+3)         ; get x.
    3469   00:B3A4  32 55 40            		ld (dispx),a        ; set coordinate for collision test.
    3470   00:B3A7  CD 9C BB            		call tstbl          ; get block type there.
    3471   00:B3AA  FE 02               		cp WALL             ; is it solid?
    3472   00:B3AC  28 D8               		jr z,trailk         ; yes, it cannot pass.
    3473   00:B3AE                      
    3474   00:B3AE                      	if (PFLAG or DFLAG)
    3475   00:B3AE  FE 04               		cp FODDER           ; is it fodder?
    3476   00:B3B0  20 05               		jr nz,.exit         ; no, ignore it.
    3477   00:B3B2  CD 46 B2            		call fdchk          ; remove fodder block.
    3478   00:B3B5  18 CF               		jr trailk           ; destroy laser.
    3479   00:B3B7                      .exit
    3480   00:B3B7                      	endif
    3481   00:B3B7  C9                  		ret
    3482   00:B3B8                      
    3483   00:B3B8                      ; Plot, preserving de.
    3484   00:B3B8                      
    3485   00:B3B8                      plotde:
    3486   00:B3B8  D5                  		push de             ; put de on stack.
    3487   00:B3B9  CD 27 B3            		call plot           ; plot pixel.
    3488   00:B3BC  D1                  		pop de              ; restore de from stack.
    3489   00:B3BD  C9                  		ret
    3490   00:B3BE                      
    3491   00:B3BE                      ; Shoot a laser.
    3492   00:B3BE                      
    3493   00:B3BE                      shoot:
    3494   00:B3BE  4F                  		ld c,a              ; store direction in c register.
    3495   00:B3BF  DD 7E 03            		ld a,(ix+3)         ; sprite x coordinate.
    3496   00:B3C2                      shoot1:
    3497   00:B3C2  C6 07               		add a,7             ; down 7 pixels.
    3498   00:B3C4  6F                  		ld l,a              ; puty x coordinate in l.
    3499   00:B3C5  DD 66 04            		ld h,(ix+4)         ; sprite y coordinate in h.
    3500   00:B3C8  DD E5               		push ix             ; store pointer to sprite.
    3501   00:B3CA  CD 8C B4            		call fpslot         ; find particle slot.
    3502   00:B3CD  30 2C               		jr nc,vapou2        ; failed, restore ix.
    3503   00:B3CF  DD 36 00 00         		ld (ix+0),0         ; set up a laser.
    3504   00:B3D3  DD 71 01            		ld (ix+1),c         ; set the direction.
    3505   00:B3D6  DD 75 03            		ld (ix+3),l         ; set x coordinate.
    3506   00:B3D9  CB 19               		rr c                ; check direction we want.
    3507   00:B3DB  38 08               		jr c,shootr         ; shoot right.
    3508   00:B3DD  7C                  		ld a,h              ; y position.
    3509   00:B3DE                      
    3510   00:B3DE                      shoot0:
    3511   00:B3DE  E6 F8               		and 248             ; align on character boundary.
    3512   00:B3E0  DD 77 05            		ld (ix+5),a         ; set y coordinate.
    3513   00:B3E3  18 2D               		jr vapou0           ; draw first image.
    3514   00:B3E5                      shootr:
    3515   00:B3E5  7C                  		ld a,h              ; y position.
    3516   00:B3E6  C6 0F               		add a,15            ; look right.
    3517   00:B3E8  18 F4               		jr shoot0           ; align and continue.
    3518   00:B3EA                      
    3519   00:B3EA                      ; Create a bit of vapour trail.
    3520   00:B3EA                      
    3521   00:B3EA                      vapour:
    3522   00:B3EA  DD E5               		push ix             ; store pointer to sprite.
    3523   00:B3EC  DD 6E 03            		ld l,(ix+3)         ; x coordinate.
    3524   00:B3EF  DD 66 04            		ld h,(ix+4)         ; y coordinate.
    3525   00:B3F2                      vapou3:
    3526   00:B3F2  11 07 07            		ld de,7*256+7       ; mid-point of sprite.
    3527   00:B3F5  19                  		add hl,de           ; point to centre of sprite.
    3528   00:B3F6  CD 8C B4            		call fpslot         ; find particle slot.
    3529   00:B3F9  38 03               		jr c,vapou1         ; no, we can use it.
    3530   00:B3FB                      vapou2:
    3531   00:B3FB  DD E1               		pop ix              ; restore sprite pointer.
    3532   00:B3FD  C9                  		ret                 ; out of slots, can't generate anything.
    3533   00:B3FE                      vapou1:
    3534   00:B3FE  DD 75 03            		ld (ix+3),l         ; set up x.
    3535   00:B401  DD 74 05            		ld (ix+5),h         ; set up y coordinate.
    3536   00:B404  CD E4 B4            		call qrand          ; get quick random number.
    3537   00:B407  E6 0F               		and 15              ; random time.
    3538   00:B409  C6 0A               		add a,VAPTIM      ; minimum time on screen.
    3539   00:B40B  DD 77 01            		ld (ix+1),a         ; set time on screen.
    3540   00:B40E  DD 36 00 01         		ld (ix+0),1         ; define particle as vapour trail.
    3541   00:B412                      vapou0:
    3542   00:B412  CD 00 B3            		call chkxy          ; plot first position.
    3543   00:B415  18 E4               		jr vapou2
    3544   00:B417                      
    3545   00:B417                      ; Create a user particle.
    3546   00:B417                      
    3547   00:B417                      ptusr:
    3548   00:B417  08                  		ex af,af            ; store timer.
    3549   00:B418  DD 6E 03            		ld l,(ix+3)         ; x coordinate.
    3550   00:B41B  DD 66 04            		ld h,(ix+4)         ; y coordinate.
    3551   00:B41E  11 07 07            		ld de,7*256+7       ; mid-point of sprite.
    3552   00:B421  19                  		add hl,de           ; point to centre of sprite.
    3553   00:B422  CD 8C B4            		call fpslot         ; find particle slot.
    3554   00:B425  38 01               		jr c,.ptusr1        ; no, we can use it.
    3555   00:B427  C9                  		ret                 ; out of slots, can't generate anything.
    3556   00:B428                      .ptusr1:
    3557   00:B428  DD 75 03            		ld (ix+3),l         ; set up x.
    3558   00:B42B  DD 74 05            		ld (ix+5),h         ; set up y coordinate.
    3559   00:B42E  08                  		ex af,af            ; restore timer.
    3560   00:B42F  DD 77 01            		ld (ix+1),a         ; set time on screen.
    3561   00:B432  DD 36 00 07         		ld (ix+0),7         ; define particle as user particle.
    3562   00:B436  C3 00 B3            		jp chkxy            ; plot first position.
    3563   00:B439                      
    3564   00:B439                      
    3565   00:B439                      ; Create a vertical or horizontal star.
    3566   00:B439                      
    3567   00:B439  DD E5               star   push ix             ; store pointer to sprite.
    3568   00:B43B  CD 8C B4                   call fpslot         ; find particle slot.
    3569   00:B43E  DA 44 B4                   jp c,star7          ; found one we can use.
    3570   00:B441  DD E1               star0  pop ix              ; restore sprite pointer.
    3571   00:B443  C9                         ret                 ; out of slots, can't generate anything.
    3572   00:B444                      
    3573   00:B444  79                  star7  ld a,c              ; direction.
    3574   00:B445  E6 03                      and 3               ; is it left?
    3575   00:B447  28 21                      jr z,star1          ; yes, it's horizontal.
    3576   00:B449  3D                         dec a               ; is it right?
    3577   00:B44A  28 2C                      jr z,star2          ; yes, it's horizontal.
    3578   00:B44C  3D                         dec a               ; is it up?
    3579   00:B44D  28 35                      jr z,star3          ; yes, it's vertical.
    3580   00:B44F                      
    3581   00:B44F  3A D9 B0                   ld a,(wntopx)       ; get edge of screen.
    3582   00:B452  3C                         inc a               ; down one pixel.
    3583   00:B453  DD 77 03            star8  ld (ix+3),a         ; set x coord.
    3584   00:B456  CD E4 B4                   call qrand          ; get quick random number.
    3585   00:B459  DD 77 05            star9  ld (ix+5),a         ; set y position.
    3586   00:B45C  79                         ld a,c              ; direction.
    3587   00:B45D  E6 03                      and 3               ; zero to three.
    3588   00:B45F  C6 03                      add a,3             ; 3 to 6 for starfield.
    3589   00:B461  DD 77 00                   ld (ix+0),a         ; define particle as star.
    3590   00:B464  CD 00 B3                   call chkxy          ; plot first position.
    3591   00:B467  C3 41 B4                   jp star0
    3592   00:B46A  CD E4 B4            star1  call qrand          ; get quick random number.
    3593   00:B46D  DD 77 03                   ld (ix+3),a         ; set x coord.
    3594   00:B470  3A DC B0                   ld a,(wnrgtx)       ; get edge of screen.
    3595   00:B473  C6 0F                      add a,15            ; add width of sprite minus 1.
    3596   00:B475  C3 59 B4                   jp star9
    3597   00:B478  CD E4 B4            star2  call qrand          ; get quick random number.
    3598   00:B47B  DD 77 03                   ld (ix+3),a         ; set x coord.
    3599   00:B47E  3A DA B0                   ld a,(wnlftx)       ; get edge of screen.
    3600   00:B481  C3 59 B4                   jp star9
    3601   00:B484  3A DB B0            star3  ld a,(wnbotx)       ; get edge of screen.
    3602   00:B487  C6 0F                      add a,15            ; height of sprite minus one pixel.
    3603   00:B489  C3 53 B4                   jp star8
    3604   00:B48C                      
    3605   00:B48C                      
    3606   00:B48C                      ; Find particle slot for lasers or vapour trail.
    3607   00:B48C                      ; Can't use alternate accumulator.
    3608   00:B48C                      
    3609   00:B48C                      fpslot:
    3610   00:B48C  DD 21 C2 4D         		ld ix,SHRAPN        ; shrapnel table.
    3611   00:B490  11 09 00            		ld de,SHRSIZ        ; size of each particle.
    3612   00:B493  06 36               		ld b,NUMSHR         ; number of pieces in table.
    3613   00:B495                      fpslt0:
    3614   00:B495  DD 7E 00            		ld a,(ix+0)         ; get type.
    3615   00:B498  17                  		rla                 ; is this slot in use?
    3616   00:B499  D8                  		ret c               ; no, we can use it.
    3617   00:B49A  DD 19               		add ix,de           ; point to more shrapnel.
    3618   00:B49C  10 F7               		djnz fpslt0         ; repeat for all shrapnel.
    3619   00:B49E  C9                  		ret                 ; out of slots, can't generate anything.
    3620   00:B49F                      
    3621   00:B49F                      ; Create an explosion at sprite position.
    3622   00:B49F                      
    3623   00:B49F                      explod:
    3624   00:B49F  4F                  		ld c,a              ; particles to create.
    3625   00:B4A0  DD E5               		push ix             ; store pointer to sprite.
    3626   00:B4A2  DD 6E 03            		ld l,(ix+3)         ; y coordinate.
    3627   00:B4A5  DD 66 04            		ld h,(ix+4)         ; x coordinate.
    3628   00:B4A8  DD 21 C2 4D         		ld ix,SHRAPN        ; shrapnel table.
    3629   00:B4AC  11 09 00            		ld de,SHRSIZ        ; size of each particle.
    3630   00:B4AF  06 36               		ld b,NUMSHR         ; number of pieces in table.
    3631   00:B4B1                      expld0:
    3632   00:B4B1  DD 7E 00            		ld a,(ix+0)         ; get type.
    3633   00:B4B4  17                  		rla                 ; is this slot in use?
    3634   00:B4B5  38 07               		jr c,expld1         ; no, we can use it.
    3635   00:B4B7                      expld2:
    3636   00:B4B7  DD 19               		add ix,de           ; point to more shrapnel.
    3637   00:B4B9  10 F6               		djnz expld0         ; repeat for all shrapnel.
    3638   00:B4BB                      expld3:
    3639   00:B4BB  DD E1               		pop ix              ; restore sprite pointer.
    3640   00:B4BD  C9                  		ret                 ; out of slots, can't generate any more.
    3641   00:B4BE                      
    3642   00:B4BE                      expld1:
    3643   00:B4BE  79                  		ld a,c              ; shrapnel counter.
    3644   00:B4BF  E6 0F               		and 15              ; 0 to 15.
    3645   00:B4C1  85                  		add a,l             ; add to x.
    3646   00:B4C2  DD 77 03            		ld (ix+3),a         ; x coord.
    3647   00:B4C5  3A 50 40            		ld a,(seed3)        ; crap random number.
    3648   00:B4C8  E6 0F               		and 15              ; 0 to 15.
    3649   00:B4CA  84                  		add a,h             ; add to y.
    3650   00:B4CB  DD 77 05            		ld (ix+5),a         ; y coord.
    3651   00:B4CE  DD 36 00 02         		ld (ix+0),2         ; switch it on.
    3652   00:B4D2  D9                  		exx                 ; store coordinates.
    3653   00:B4D3  CD 00 B3            		call chkxy          ; plot first position.
    3654   00:B4D6  CD E4 B4            		call qrand          ; quick random angle.
    3655   00:B4D9  E6 3C               		and 60              ; keep within range.
    3656   00:B4DB  DD 77 01            		ld (ix+1),a         ; angle.
    3657   00:B4DE  D9                  		exx                 ; restore coordinates.
    3658   00:B4DF  0D                  		dec c               ; one less piece of shrapnel to generate.
    3659   00:B4E0  20 D5               		jr nz,expld2        ; back to main explosion loop.
    3660   00:B4E2  18 D7               		jr expld3           ; restore sprite pointer and exit.
    3661   00:B4E4                      qrand:
    3662   00:B4E4  3A 50 40            		ld a,(seed3)        ; random seed.
    3663   00:B4E7  6F                  		ld l,a              ; low byte.
    3664   00:B4E8  26 00               		ld h,0              ; no high byte.
    3665   00:B4EA  ED 5F               		ld a,r              ; r register.
    3666   00:B4EC  AE                  		xor (hl)            ; combine with seed.
    3667   00:B4ED  32 50 40            		ld (seed3),a        ; new seed.
    3668   00:B4F0  C9                  		ret
    3669   00:B4F1                      
    3670   00:B4F1                      ; Display all shrapnel.
    3671   00:B4F1                      
    3672   00:B4F1                      dshrp:
    3673   00:B4F1  21 B8 B3            		ld hl,plotde        ; display routine.
    3674   00:B4F4  22 17 40            		ld (shrplot),hl
    3675   00:B4F7                      		; ld (proshx+1),hl    ; modify routine.		
    3676   00:B4F7                      		
    3677   00:B4F7  AF                  		xor a
    3678   00:B4F8  CD A7 B2            		call setshr0
    3679   00:B4FB  CD 73 B2            		call proshrnoset    ; process even shrapnel.
    3680   00:B4FE  3E 01               		ld a,1
    3681   00:B500  CD A7 B2            		call setshr0
    3682   00:B503  CD 73 B2            		call proshrnoset    ; process odd shrapnel.
    3683   00:B506                      		
    3684   00:B506  21 B8 B2            		ld hl,prosh1        ; processing routine.
    3685   00:B509  22 17 40            		ld (shrplot),hl
    3686   00:B50C                      		; ld (proshx+1),hl    ; modify the call.
    3687   00:B50C                      		
    3688   00:B50C  C9                  		ret
    3689   00:B50D                      
    3690   00:B50D                      ; Deletes all shrapnel
    3691   00:B50D                      
    3692   00:B50D                      delshr: 
    3693   00:B50D  DD 21 C2 4D         		ld ix,SHRAPN        ; table.
    3694   00:B511  06 36               		ld b,NUMSHR         ; shrapnel pieces to process.
    3695   00:B513                      		; ld d,0				; plot needs this initially		
    3696   00:B513                      .loop:
    3697   00:B513  DD 7E 00            		ld a,(ix+0)         ; on/off marker.
    3698   00:B516  17                  		rla
    3699   00:B517  38 05               		jr c,.noshr
    3700   00:B519  C5                  		push bc             ; store counter.
    3701   00:B51A  CD 27 B3            		call plot           ; delete the pixel.
    3702   00:B51D  C1                  		pop bc              ; restore counter.
    3703   00:B51E                      .noshr:		
    3704   00:B51E  11 09 00            		ld de,SHRSIZ        ; distance to next.
    3705   00:B521  DD 19               		add ix,de           ; point there.
    3706   00:B523  10 EE               		djnz .loop         ; round again.
    3707   00:B525  C9                  		ret
    3708   00:B526                      
    3709   00:B526                      inishr:	
    3710   00:B526  21 C2 4D            		ld hl,SHRAPN        ; table.
    3711   00:B529  11 C3 4D            		ld de,SHRAPN+1        ; distance to next.
    3712   00:B52C  36 FF               		ld (hl),255
    3713   00:B52E  01 E5 01            		ld bc,(NUMSHR*SHRSIZ)-1         ; shrapnel pieces to process.
    3714   00:B531  ED B0               		ldir 
    3715   00:B533  C9                  		ret
    3716   00:B534                      	   
    3717   00:B534                      ; Check for collision between laser and sprite.
    3718   00:B534                      
    3719   00:B534                      lcol:
    3720   00:B534  21 C2 4D            		ld hl,SHRAPN        ; shrapnel table.
    3721   00:B537  11 09 00            		ld de,SHRSIZ        ; size of each particle.
    3722   00:B53A  06 36               		ld b,NUMSHR         ; number of pieces in table.
    3723   00:B53C                      .loop:
    3724   00:B53C  7E                  		ld a,(hl)           ; get type.
    3725   00:B53D  A7                  		and a               ; is this slot a laser?
    3726   00:B53E  28 04               		jr z,.chkcol          ; yes, check collision.
    3727   00:B540                      .nxtshr:
    3728   00:B540  19                  		add hl,de           ; point to more shrapnel.
    3729   00:B541  10 F9               		djnz .loop          ; repeat for all shrapnel.
    3730   00:B543  C9                  		ret                 ; no collision, carry not set.
    3731   00:B544                      .chkcol:
    3732   00:B544  E5                  		push hl             ; store pointer to laser.
    3733   00:B545  23                  		inc hl              ; direction.
    3734   00:B546  23                  		inc hl              ; not used.
    3735   00:B547  23                  		inc hl              ; x position.
    3736   00:B548  7E                  		ld a,(hl)           ; get x.
    3737   00:B549  DD 96 03            		sub (ix+X)          ; subtract sprite x.
    3738   00:B54C                      ;lcolh:
    3739   00:B54C  FE 10               		cp 16               ; within range?
    3740   00:B54E  30 0A               		jr nc,.missed         ; no, missed.
    3741   00:B550  23                  		inc hl              ; not used.
    3742   00:B551  23                  		inc hl              ; y position.
    3743   00:B552  7E                  		ld a,(hl)           ; get y.
    3744   00:B553  DD 96 04            		sub (ix+Y)          ; subtract sprite y.
    3745   00:B556  FE 10               		cp 16               ; within range?
    3746   00:B558  38 03               		jr c,.exit          ; yes, collision occurred.
    3747   00:B55A                      .missed:
    3748   00:B55A  E1                  		pop hl              ; restore laser pointer from stack.
    3749   00:B55B  18 E3               		jr .nxtshr
    3750   00:B55D                      .exit:
    3751   00:B55D  E1                  		pop hl              ; restore laser pointer.
    3752   00:B55E  C9                  		ret                 ; return with carry set for collision.
    3753   00:B55F                      
    3754   00:B55F                      	endif
    3755   00:B55F                      	
    3756   00:B55F                      ; Main game engine code starts here.
    3757   00:B55F                      
    3758   00:B55F                      game:
    3759   00:B55F                      
    3760   00:B55F                      	if PFLAG
    3761   00:B55F  CD 26 B5            		call inishr         ; initialise particle engine.
    3762   00:B562                      	endif
    3763   00:B562                      evintr:
    3764   00:B562  F3                  	di
    3765   00:B563  CD 9C 88            		call evnt12         ; call intro/menu event.
    3766   00:B566                      
    3767   00:B566  21 00 46            		ld hl,MAP           ; block properties.
    3768   00:B569  0E 03               		ld c,3     			; 3 * 256 bytes
    3769   00:B56B  3E 02               		ld a,WALL			; fill value
    3770   00:B56D  CD AE C2            		call fastfill
    3771   00:B570                      
    3772   00:B570                      	if OFLAG
    3773   00:B570  CD 9D C2            		call clrobjlst
    3774   00:B573                      	endif
    3775   00:B573  CD A7 C2            		call clrscrmap
    3776   00:B576                      
    3777   00:B576                      	if OFLAG
    3778   00:B576  CD 58 B1            		call iniob          ; initialise objects.
    3779   00:B579                      	endif
    3780   00:B579  AF                  		xor a               ; put zero in accumulator.
    3781   00:B57A  32 54 40            		ld (gamwon),a       ; reset game won flag.
    3782   00:B57D                      
    3783   00:B57D  21 00 40            		ld hl,score         ; score.
    3784   00:B580  CD A2 B6            		call inisc          ; init the score.
    3785   00:B583                      mapst:
    3786   00:B583  3A B2 80            		ld a,(stmap)        ; start position on map.
    3787   00:B586  32 4D 40            		ld (roomtb),a       ; set up position in table, if there is one.
    3788   00:B589                      inipbl:
    3789   00:B589                      	if AFLAG
    3790   00:B589                    ~ 		ld hl,eop          ; reset blockpointer
    3791   00:B589                    ~ 		; ld (pbptr+1),hl
    3792   00:B589                    ~ 		ld (pblkptr),hl
    3793   00:B589                    ~ 	endif
    3794   00:B589                       
    3795   00:B589  CD 2D C0            		call initsc         ; set up first screen.
    3796   00:B58C  DD 21 A4 40         		ld ix,ssprit        ; default to spare sprite in table.
    3797   00:B590                      evini:  
    3798   00:B590                      
    3799   00:B590  CD EF 89            		call evnt13         ; initialisation. (GAMEINIT)
    3800   00:B593                      
    3801   00:B593                      ; Two restarts.
    3802   00:B593                      ; First restart - clear all sprites and initialise everything.
    3803   00:B593                      
    3804   00:B593                      rstrt:
    3805   00:B593  CD 5D B6            		call rsevt          ; restart events (evnt14 - RESTARTSCREEN).
    3806   00:B596  CD 39 B1            		call xspr           ; clear sprite table.
    3807   00:B599  CD 85 C1            		call sprlst         ; fetch pointer to screen sprites.
    3808   00:B59C  CD B4 C1            		call ispr           ; initialise sprite table.
    3809   00:B59F  18 0F               		jr rstrt0
    3810   00:B5A1                      
    3811   00:B5A1                      ; Second restart - clear all but player, and don't initialise him.
    3812   00:B5A1                      
    3813   00:B5A1                      rstrtn:
    3814   00:B5A1  CD 5D B6            		call rsevt          ; restart events (evnt14 - RESTARTSCREEN).
    3815   00:B5A4  CD 9C C1            		call nspr           ; clear all non-player sprites.
    3816   00:B5A7  CD 4A B1            		call xspr0
    3817   00:B5AA  CD 85 C1            		call sprlst         ; fetch pointer to screen sprites.
    3818   00:B5AD  CD D9 C1            		call kspr           ; initialise sprite table, no more players.
    3819   00:B5B0                      
    3820   00:B5B0                      ; Set up the player and/or enemy sprites.
    3821   00:B5B0                      
    3822   00:B5B0                      rstrt0: 
    3823   00:B5B0  AF                  		xor a               ; zero in accumulator.
    3824   00:B5B1  32 51 40            		ld (nexlev),a       ; reset next level flag.
    3825   00:B5B4  32 52 40            		ld (restfl),a       ; reset restart flag.
    3826   00:B5B7  32 53 40            		ld (deadf),a        ; reset dead flag.
    3827   00:B5BA                      		; ld (nohide),a		; enable screen hiding		
    3828   00:B5BA                      		
    3829   00:B5BA                      	if PFLAG
    3830   00:B5BA  CD 0D B5            		call delshr			; erases all particles from screen
    3831   00:B5BD                      	endif
    3832   00:B5BD                      	if OFLAG
    3833   00:B5BD  CD C7 B7            		call robjs			; removes all present objects from screen
    3834   00:B5C0                      	endif
    3835   00:B5C0  CD 84 BA            		call droom          ; show screen layout.
    3836   00:B5C3                      rpblc0: 
    3837   00:B5C3                      	if AFLAG
    3838   00:B5C3                    ~ 		call rbloc          ; draw blocks for this screen
    3839   00:B5C3                    ~ 	endif
    3840   00:B5C3                      	if PFLAG
    3841   00:B5C3  CD 26 B5            		call inishr         ; initialise particle engine.
    3842   00:B5C6                      	endif
    3843   00:B5C6                      	if OFLAG
    3844   00:B5C6  CD CD B6            		call shwob          ; draw objects.
    3845   00:B5C9                      	endif
    3846   00:B5C9                      mloop:
    3847   00:B5C9  CD 73 B1            		call vsync          ; synchronise with display.
    3848   00:B5CC  CD 61 BF            		call dumpspr
    3849   00:B5CF                      		
    3850   00:B5CF                      	ifdef DEBUG
    3851   00:B5CF                    ~ 		BORDER 9
    3852   00:B5CF                    ~ 	endif
    3853   00:B5CF                      	   
    3854   00:B5CF  DD 21 A4 40         		ld ix,ssprit        ; point to spare sprite for spawning purposes.
    3855   00:B5D3                      evlp1:  
    3856   00:B5D3  CD 41 88            		call evnt10         ; MAINLOOP1: called once per main loop.
    3857   00:B5D6  CD D3 BD            		call pspr           ; process sprites.
    3858   00:B5D9                      		
    3859   00:B5D9                      ; Main loop events.
    3860   00:B5D9  DD 21 A4 40         		ld ix,ssprit        ; point to spare sprite for spawning purposes.
    3861   00:B5DD                      evlp2:  
    3862   00:B5DD                      	ifdef DEBUG
    3863   00:B5DD                    ~ 		BORDER 8
    3864   00:B5DD                    ~ 	endif
    3865   00:B5DD  CD 4F 88            		call evnt11         ; MAINLOOP2: called once per main loop.
    3866   00:B5E0                      	ifdef DEBUG
    3867   00:B5E0                    ~ 		BORDER 14
    3868   00:B5E0                    ~ 	endif
    3869   00:B5E0                      		
    3870   00:B5E0  DD 21 B5 40         		ld ix,sprtab
    3871   00:B5E4  CD 29 BE            		call chkimg
    3872   00:B5E7                      		
    3873   00:B5E7  3A 51 40            		ld a,(nexlev)       ; finished level flag.
    3874   00:B5EA  A7                  		and a               ; has it been set?
    3875   00:B5EB  20 1E               		jr nz,newlev        ; yes, go to next level.
    3876   00:B5ED  3A 54 40            		ld a,(gamwon)       ; finished game flag.
    3877   00:B5F0  A7                  		and a               ; has it been set?
    3878   00:B5F1  20 28               		jr nz,evwon         ; yes, finish the game.
    3879   00:B5F3  3A 52 40            		ld a,(restfl)       ; finished level flag.
    3880   00:B5F6  3D                  		dec a               ; has it been set?
    3881   00:B5F7  CA 93 B5            		jp z,rstrt          ; yes, go to next level.
    3882   00:B5FA  3D                  		dec a               ; has it been set?
    3883   00:B5FB  CA A1 B5            		jp z,rstrtn         ; yes, go to next level.
    3884   00:B5FE  3A 53 40            		ld a,(deadf)        ; dead flag.
    3885   00:B601  A7                  		and a               ; is it non-zero?
    3886   00:B602  20 1D               		jr nz,pdead         ; yes, player dead.
    3887   00:B604                      		
    3888   00:B604  21 4E 40            		ld hl,frmno         ; game frame.
    3889   00:B607  34                  		inc (hl)            ; advance the frame.
    3890   00:B608                      ; Back to start of main loop.
    3891   00:B608                      qoff:	
    3892   00:B608  C3 C9 B5            		jp mloop            ; switched to a jp nz,mloop during test mode.
    3893   00:B60B                      		
    3894   00:B60B                      ;----------------------------------------------------------
    3895   00:B60B                      ; Read blocks from list and update screen accordingly.
    3896   00:B60B                      ;----------------------------------------------------------
    3897   00:B60B                      
    3898   00:B60B                      	if AFLAG
    3899   00:B60B                    ~ 	
    3900   00:B60B                    ~ rbloc:
    3901   00:B60B                    ~ ;pbbuf:
    3902   00:B60B                    ~ 		ld de,eop             ; check for last block
    3903   00:B60B                    ~ rbloc2:
    3904   00:B60B                    ~ 		; ld hl,(pbptr+1)
    3905   00:B60B                    ~ 		ld hl,(pblkptr)
    3906   00:B60B                    ~ 		or a
    3907   00:B60B                    ~ 		sbc hl,de
    3908   00:B60B                    ~ 		ret z
    3909   00:B60B                    ~ rbloc1:
    3910   00:B60B                    ~ 		ex de,hl
    3911   00:B60B                    ~ 		ld a,(scno)
    3912   00:B60B                    ~ 		cp (hl)                ;pbbuf
    3913   00:B60B                    ~ 		jr nz,rbloc0
    3914   00:B60B                    ~ 		push hl
    3915   00:B60B                    ~ 		inc hl
    3916   00:B60B                    ~ 		ld de,dispx
    3917   00:B60B                    ~ 		ldi                    ;dispx
    3918   00:B60B                    ~ 		ldi                    ;dispy
    3919   00:B60B                    ~ 		ld a,(hl)
    3920   00:B60B                    ~ 		call pattr2            ; draw block
    3921   00:B60B                    ~ 		pop hl
    3922   00:B60B                    ~ rbloc0:
    3923   00:B60B                    ~ 		ld de,4
    3924   00:B60B                    ~ 		add hl,de              ; point to next block
    3925   00:B60B                    ~ 		ex de,hl
    3926   00:B60B                    ~ 		jr rbloc2
    3927   00:B60B                    ~     
    3928   00:B60B                    ~ 	endif
    3929   00:B60B                      
    3930   00:B60B                      	
    3931   00:B60B                      newlev:
    3932   00:B60B  3A 42 40            		ld a,(scno)         ; current screen.
    3933   00:B60E  21 38 9C            		ld hl,numsc         ; total number of screens.
    3934   00:B611  3C                  		inc a               ; next screen.
    3935   00:B612  BE                  		cp (hl)             ; reached the limit?
    3936   00:B613  30 06               		jr nc,evwon         ; yes, game finished.
    3937   00:B615  32 42 40            		ld (scno),a         ; set new level number.
    3938   00:B618  C3 93 B5            		jp rstrt            ; restart, clearing all aliens.
    3939   00:B61B                      evwon:
    3940   00:B61B  CD CB 8A            		call evnt18         ; game completed.
    3941   00:B61E  C3 35 B6            		jp tidyup           ; tidy up and return to BASIC/calling routine.
    3942   00:B621                      
    3943   00:B621                      ; Player dead.
    3944   00:B621                      
    3945   00:B621                      pdead:
    3946   00:B621  AF                  		xor a               ; zeroise accumulator.
    3947   00:B622  32 53 40            		ld (deadf),a        ; reset dead flag.
    3948   00:B625                      evdie:
    3949   00:B625  CD 5B 8A            		call evnt16         ; death subroutine.
    3950   00:B628  3A 46 40            		ld a,(numlif)       ; number of lives.
    3951   00:B62B  A7                  		and a               ; reached zero yet?
    3952   00:B62C  C2 93 B5            		jp nz,rstrt         ; restart game.
    3953   00:B62F  CD 57 BE            		call dissprs
    3954   00:B632  CD 6D 8A            		call evnt17         ; failure event.
    3955   00:B635                      tidyup: 
    3956   00:B635  21 06 40            		ld hl,hiscor        ; high score.
    3957   00:B638  11 00 40            		ld de,score         ; player's score.
    3958   00:B63B  06 06               		ld b,6              ; digits to check.
    3959   00:B63D                      .tidyu2 
    3960   00:B63D  1A                  		ld a,(de)           ; get score digit.
    3961   00:B63E  BE                  		cp (hl)             ; are we larger than high score digit?
    3962   00:B63F  38 06               		jr c,tidyu0         ; high score is bigger.
    3963   00:B641  20 07               		jr nz,tidyu1        ; score is greater, record new high score.
    3964   00:B643  23                  		inc hl              ; next digit of high score.
    3965   00:B644  13                  		inc de              ; next digit of score.
    3966   00:B645  10 F6               		djnz .tidyu2         ; repeat for all digits.
    3967   00:B647                      tidyu0:
    3968   00:B647  C3 5F B5            		jp game
    3969   00:B64A                      tidyu1:
    3970   00:B64A  21 00 40            		ld hl,score         ; score.
    3971   00:B64D  11 06 40            		ld de,hiscor        ; high score.
    3972   00:B650  01 06 00            		ld bc,6             ; digits to copy.
    3973   00:B653  ED B0               		ldir                ; copy score to high score.
    3974   00:B655  CD 57 BE            		call dissprs
    3975   00:B658  CD 41 8B            		call evnt19         ; new high score event.
    3976   00:B65B  18 EA               		jr tidyu0           ; tidy up.
    3977   00:B65D                      
    3978   00:B65D                      ; Restart event.
    3979   00:B65D                      
    3980   00:B65D                      rsevt:
    3981   00:B65D  DD 21 A4 40         		ld ix,ssprit        ; default to spare element in table.
    3982   00:B661                      evrs:
    3983   00:B661  C3 45 8A            		jp evnt14           ; call restart event.
    3984   00:B664                      
    3985   00:B664                      ; Copy number passed in a to string position bc, right-justified.
    3986   00:B664                      
    3987   00:B664  6F                  num2ch ld l,a              ; put accumulator in l.
    3988   00:B665  26 00                      ld h,0              ; blank high byte of hl.
    3989   00:B667  3E 20                      ld a,32             ; leading spaces.
    3990   00:B669  11 64 00            numdg3 ld de,100           ; hundreds column.
    3991   00:B66C  CD 7A B6                   call numdg          ; show digit.
    3992   00:B66F  11 0A 00            numdg2 ld de,10            ; tens column.
    3993   00:B672  CD 7A B6                   call numdg          ; show digit.
    3994   00:B675  F6 10                      or 16               ; last digit is always shown.
    3995   00:B677  11 01 00                   ld de,1             ; units column.
    3996   00:B67A  E6 30               numdg  and 48              ; clear carry, clear digit.
    3997   00:B67C  ED 52               numdg1 sbc hl,de           ; subtract from column.
    3998   00:B67E  38 05                      jr c,numdg0         ; nothing to show.
    3999   00:B680  F6 10                      or 16               ; something to show, make it a digit.
    4000   00:B682  3C                         inc a               ; increment digit.
    4001   00:B683  18 F7                      jr numdg1           ; repeat until column is zero.
    4002   00:B685  19                  numdg0 add hl,de           ; restore total.
    4003   00:B686  FE 20                      cp 32               ; leading space?
    4004   00:B688  C8                         ret z               ; yes, don't write that.
    4005   00:B689  02                         ld (bc),a           ; write digit to buffer.
    4006   00:B68A  03                         inc bc              ; next buffer position.
    4007   00:B68B  C9                         ret
    4008   00:B68C  6F                  num2dd ld l,a              ; put accumulator in l.
    4009   00:B68D  26 00                      ld h,0              ; blank high byte of hl.
    4010   00:B68F  3E 20                      ld a,32             ; leading spaces.
    4011   00:B691  11 64 00                   ld de,100           ; hundreds column.
    4012   00:B694  CD 7A B6                   call numdg          ; show digit.
    4013   00:B697  F6 10                      or 16               ; second digit is always shown.
    4014   00:B699  18 D4                      jr numdg2
    4015   00:B69B  6F                  num2td ld l,a              ; put accumulator in l.
    4016   00:B69C  26 00                      ld h,0              ; blank high byte of hl.
    4017   00:B69E  3E 30                      ld a,48             ; leading spaces.
    4018   00:B6A0  18 C7                      jr numdg3
    4019   00:B6A2                      
    4020   00:B6A2  06 06               inisc  ld b,6              ; digits to initialise.
    4021   00:B6A4  36 30               inisc0 ld (hl),'0'         ; write zero digit.
    4022   00:B6A6  23                         inc hl              ; next column.
    4023   00:B6A7  10 FB                      djnz inisc0         ; repeat for all digits.
    4024   00:B6A9  C9                         ret
    4025   00:B6AA                      
    4026   00:B6AA                      
    4027   00:B6AA                      ; Multiply h by d and return in hl.
    4028   00:B6AA                      
    4029   00:B6AA                      imul:   
    4030   00:B6AA  5A                  		ld e,d              ; HL = H * D
    4031   00:B6AB  4C                  		ld c,h              ; make c first multiplier.
    4032   00:B6AC                      imul0:
    4033   00:B6AC  21 00 00            		ld hl,0             ; zeroise total.
    4034   00:B6AF  54                  		ld d,h              ; zeroise high byte.
    4035   00:B6B0  06 08               		ld b,8              ; repeat 8 times.
    4036   00:B6B2                      .loop:
    4037   00:B6B2  CB 19               		rr c                ; rotate rightmost bit into carry.
    4038   00:B6B4  30 02               		jr nc,.imul2         ; wasn't set.
    4039   00:B6B6  19                  		add hl,de           ; bit was set, so add de.
    4040   00:B6B7  A7                  		and a               ; reset carry.
    4041   00:B6B8                      .imul2:
    4042   00:B6B8  CB 13               		rl e                ; shift de 1 bit left.
    4043   00:B6BA  CB 12               		rl d
    4044   00:B6BC  10 F4               		djnz .loop          ; repeat 8 times.
    4045   00:B6BE  C9                  		ret
    4046   00:B6BF                      
    4047   00:B6BF                      ; Divide d by e and return in d, remainder in a.
    4048   00:B6BF                      
    4049   00:B6BF                      idiv:
    4050   00:B6BF  AF                  		xor a
    4051   00:B6C0  06 08               		ld b,8              ; bits to shift.
    4052   00:B6C2                      .loop:
    4053   00:B6C2  CB 22               		sla d               ; multiply d by 2.
    4054   00:B6C4  17                  		rla                 ; shift carry into remainder.
    4055   00:B6C5  BB                  		cp e                ; test if e is smaller.
    4056   00:B6C6  38 02               		jr c,.nodiv          ; e is greater, no division this time.
    4057   00:B6C8  93                  		sub e               ; subtract it.
    4058   00:B6C9  14                  		inc d               ; rotate into d.
    4059   00:B6CA                      .nodiv:
    4060   00:B6CA  10 F6               		djnz .loop
    4061   00:B6CC  C9                  		ret
    4062   00:B6CD                      
    4063   00:B6CD                      	
    4064   00:B6CD                      	if OFLAG
    4065   00:B6CD                      
    4066   00:B6CD                      ; Objects handling.
    4067   00:B6CD                      ; 64 bytes for image
    4068   00:B6CD                      ; 3 for room, x and y
    4069   00:B6CD                      ; 3 for starting room, x and y.
    4070   00:B6CD                      ; 254 = disabled.
    4071   00:B6CD                      ; 255 = object in player's pockets.
    4072   00:B6CD                      
    4073   00:B6CD                      ; Show items present.
    4074   00:B6CD                      
    4075   00:B6CD                      	if DISTYPE=ROM
    4076   00:B6CD                      	
    4077   00:B6CD                      shwob:
    4078   00:B6CD  21 A8 4F            		ld hl,objatr        ; objects attribute table.		
    4079   00:B6D0  3A D8 B0            		ld a,(numob)        ; number of objects in the game.
    4080   00:B6D3  47                  		ld b,a              ; loop counter.
    4081   00:B6D4                      .loop0:
    4082   00:B6D4  C5                  		push bc             ; store count.
    4083   00:B6D5  E5                  		push hl             ; store item pointer.
    4084   00:B6D6  3A D8 B0            		ld a,(numob)
    4085   00:B6D9  90                  		sub b				; need to invert object counter
    4086   00:B6DA  32 47 40            		ld (curobj),a
    4087   00:B6DD  3A 42 40            		ld a,(scno)         ; current location.
    4088   00:B6E0  BE                  		cp (hl)             ; same as an item?
    4089   00:B6E1  CC ED B6            		call z,dobj         ; yes, display object in colour.
    4090   00:B6E4  E1                  		pop hl              ; restore pointer.
    4091   00:B6E5  C1                  		pop bc              ; restore counter.
    4092   00:B6E6  11 03 00            		ld de,ODTSIZ		; distance to next item.
    4093   00:B6E9  19                  		add hl,de           ; point to it.
    4094   00:B6EA  10 E8               		djnz .loop0         ; repeat for others.
    4095   00:B6EC  C9                  		ret
    4096   00:B6ED                      
    4097   00:B6ED                      	else
    4098   00:B6ED                    ~ 	
    4099   00:B6ED                    ~ shwob:
    4100   00:B6ED                    ~ 		ld hl,objdta        ; objects table.
    4101   00:B6ED                    ~ 		ld de,OBJSIZ-ODTSIZ ; distance to room number.
    4102   00:B6ED                    ~ 		add hl,de           ; point to room data.
    4103   00:B6ED                    ~ 		ld a,(numob)        ; number of objects in the game.
    4104   00:B6ED                    ~ 		ld b,a              ; loop counter.
    4105   00:B6ED                    ~ .loop0:
    4106   00:B6ED                    ~ 		push bc             ; store count.
    4107   00:B6ED                    ~ 		push hl             ; store item pointer.
    4108   00:B6ED                    ~ 		ld a,(numob)
    4109   00:B6ED                    ~ 		sub b				; need to invert object counter
    4110   00:B6ED                    ~ 		ld (curobj),a
    4111   00:B6ED                    ~ 		ld a,(scno)         ; current location.
    4112   00:B6ED                    ~ 		cp (hl)             ; same as an item?
    4113   00:B6ED                    ~ 		call z,dobj         ; yes, display object in colour.
    4114   00:B6ED                    ~ 		pop hl              ; restore pointer.
    4115   00:B6ED                    ~ 		pop bc              ; restore counter.
    4116   00:B6ED                    ~ 		ld de,OBJSIZ        ; distance to next item.
    4117   00:B6ED                    ~ 		add hl,de           ; point to it.
    4118   00:B6ED                    ~ 		djnz .loop0         ; repeat for others.
    4119   00:B6ED                    ~ 		ret
    4120   00:B6ED                    ~ 
    4121   00:B6ED                    ~ 	endif
    4122   00:B6ED                      
    4123   00:B6ED                      ; Display object.
    4124   00:B6ED                      ; hl must point to object's room number.
    4125   00:B6ED                      
    4126   00:B6ED                      	if DISTYPE=ROM
    4127   00:B6ED                      	
    4128   00:B6ED                      dobj:   
    4129   00:B6ED  23                  		inc hl						; point to y.
    4130   00:B6EE  11 55 40            		ld de,dispx         		; coordinates.
    4131   00:B6F1  7E                  		ld a,(hl)
    4132   00:B6F2  FE C0               		cp MSX_MAXCY+1
    4133   00:B6F4  D0                  		ret nc						; don't draw if it's out of boundaries
    4134   00:B6F5  ED A0               		ldi                 		; transfer y coord.
    4135   00:B6F7  ED A0               		ldi                 		; transfer x too.
    4136   00:B6F9  CD 2F B7            		call objimg			; gets object image address in HL
    4137   00:B6FC                      putobj:
    4138   00:B6FC  E5                  		push hl             ; store object graphic address.
    4139   00:B6FD  CD 85 B7            		call wobj			; preserves visible object coords in list
    4140   00:B700  CD 77 BF            		call scadd          ; get screen address in hl.
    4141   00:B703  CB F4               		set 6,h				; set write permanently
    4142   00:B705  7D                  		ld a,l
    4143   00:B706  F3                  		di					;
    4144   00:B707  D3 BF               		out (MSX_VDPCW),a
    4145   00:B709  7C                  		ld a,h
    4146   00:B70A  FB                  		ei	
    4147   00:B70B  D3 BF               		out (MSX_VDPCW),a   ;
    4148   00:B70D  0E BE               		ld c,MSX_VDPDRW		
    4149   00:B70F  EB                  		ex de,hl            ; switch regs. DE=VRAM
    4150   00:B710  E1                  		pop hl              ; restore graphic address. HL=graphics, DE=VRAM
    4151   00:B711  CD 27 B7            		call putrow0		; 1st pattern row
    4152   00:B714  14                  		inc d				; row increased
    4153   00:B715  CD 1F B7            		call putrow			; 2nd pattern row
    4154   00:B718  15                  		dec d				; back again to 1st row
    4155   00:B719  CB EA               		set 5,d				; point to color area
    4156   00:B71B  CD 1F B7            		call putrow			; 1st color row
    4157   00:B71E  14                  		inc d				; row increased and process color row
    4158   00:B71F                      putrow:
    4159   00:B71F  7B                  		ld a,e
    4160   00:B720  F3                  		di					;
    4161   00:B721  D3 BF               		out (MSX_VDPCW),a
    4162   00:B723  7A                  		ld a,d
    4163   00:B724  FB                  		ei	
    4164   00:B725  D3 BF               		out (MSX_VDPCW),a   ;
    4165   00:B727                      putrow0:
    4166   00:B727  06 10               		ld b,16
    4167   00:B729                      .loop:
    4168   00:B729  ED A3               		outi
    4169   00:B72B  C2 29 B7            		jp nz,.loop
    4170   00:B72E  C9                  		ret
    4171   00:B72F                      ;
    4172   00:B72F                      ; calculates object image address from object number
    4173   00:B72F                      ;
    4174   00:B72F                      ; Input:
    4175   00:B72F                      ;	A = object number
    4176   00:B72F                      ; Output:
    4177   00:B72F                      ;	HL = object image address
    4178   00:B72F                      ;
    4179   00:B72F                      objimg:
    4180   00:B72F  16 00               		ld d,0
    4181   00:B731  3A 47 40            		ld a,(curobj)
    4182   00:B734  5F                  		ld e,a
    4183   00:B735  0F                  		rrca
    4184   00:B736  0F                  		rrca
    4185   00:B737  6F                  		ld l,a			
    4186   00:B738  E6 3F               		and $3F			
    4187   00:B73A  67                  		ld h,a			
    4188   00:B73B  7D                  		ld a,l			
    4189   00:B73C  E6 C0               		and $C0			
    4190   00:B73E  6F                  		ld l,a			; n * 64
    4191   00:B73F  19                  		add hl,de
    4192   00:B740  EB                  		ex de,hl		; DE=n*65
    4193   00:B741  29                  		add hl,hl		; HL=n*2
    4194   00:B742  19                  		add hl,de		; HL=n*65 + n*2
    4195   00:B743  11 0A A5            		ld de,objdta+3
    4196   00:B746  19                  		add hl,de		; point to image.		
    4197   00:B747  C9                  		ret
    4198   00:B748                      
    4199   00:B748                      	else
    4200   00:B748                    ~ 	
    4201   00:B748                    ~ dobj:   
    4202   00:B748                    ~ 		inc hl						; point to x.
    4203   00:B748                    ~ 		ld de,dispx         		; coordinates.
    4204   00:B748                    ~ 		ld a,(hl)
    4205   00:B748                    ~ 		cp MSX_MAXCY+1
    4206   00:B748                    ~ 		ret nc						; don't draw if it's out of boundaries
    4207   00:B748                    ~ 		ldi                 		; transfer y coord.
    4208   00:B748                    ~ 		ldi                 		; transfer x too.
    4209   00:B748                    ~ 		ld de,-(OBJSIZ-(ODTSIZ/2))	; distance needed to restore image pointer.
    4210   00:B748                    ~ 		add hl,de           		; point to image.
    4211   00:B748                    ~ putobj:
    4212   00:B748                    ~ 		push hl             ; store sprite graphic address.
    4213   00:B748                    ~ 		call wobj			; preserves visible object coords in list
    4214   00:B748                    ~ 		call scadd          ; get screen address in hl.
    4215   00:B748                    ~ 		set 6,h
    4216   00:B748                    ~ 		ld a,l
    4217   00:B748                    ~ 		di					;
    4218   00:B748                    ~ 		out (MSX_VDPCW),a
    4219   00:B748                    ~ 		ld a,h
    4220   00:B748                    ~ 		ei	
    4221   00:B748                    ~ 		out (MSX_VDPCW),a   ;
    4222   00:B748                    ~ 		ld c,MSX_VDPDRW		
    4223   00:B748                    ~ 		ex de,hl            ; switch regs. DE=VRAM
    4224   00:B748                    ~ 		pop hl              ; restore graphic address. HL=graphics, DE=VRAM
    4225   00:B748                    ~ 		call putrow0		; 1st pattern row
    4226   00:B748                    ~ 		inc d				; row increased
    4227   00:B748                    ~ 		call putrow			; 2nd pattern row
    4228   00:B748                    ~ 		dec d				; back again to 1st row
    4229   00:B748                    ~ 		set 5,d				; point to color area
    4230   00:B748                    ~ 		call putrow			; 1st color row
    4231   00:B748                    ~ 		inc d				; row increased and process las color row
    4232   00:B748                    ~ putrow:
    4233   00:B748                    ~ 		ld a,e
    4234   00:B748                    ~ 		di					;
    4235   00:B748                    ~ 		out (MSX_VDPCW),a
    4236   00:B748                    ~ 		ld a,d
    4237   00:B748                    ~ 		ei	
    4238   00:B748                    ~ 		out (MSX_VDPCW),a   ;
    4239   00:B748                    ~ putrow0:
    4240   00:B748                    ~ 		ld b,16
    4241   00:B748                    ~ .loop:
    4242   00:B748                    ~ 		outi
    4243   00:B748                    ~ 		jp nz,.loop
    4244   00:B748                    ~ 		ret
    4245   00:B748                    ~ 
    4246   00:B748                    ~ 	endif
    4247   00:B748                      	
    4248   00:B748                      	
    4249   00:B748                      ; Remove an object (REMOVEOBJECT).
    4250   00:B748                      
    4251   00:B748                      remob:
    4252   00:B748  21 D8 B0            		ld hl,numob         ; number of objects in game.
    4253   00:B74B  BE                  		cp (hl)             ; are we checking past the end?
    4254   00:B74C  D0                  		ret nc              ; yes, can't get non-existent item.
    4255   00:B74D  F5                  		push af             ; remember object.
    4256   00:B74E  CD 58 B7            		call getob          ; pick it up if we haven't already got it.
    4257   00:B751  F1                  		pop af              ; retrieve object number.
    4258   00:B752  CD 3F B8            		call gotob          ; get its address.
    4259   00:B755  36 FE               		ld (hl),254         ; remove it.
    4260   00:B757  C9                  		ret
    4261   00:B758                      
    4262   00:B758                      ; Pick up object number held in the accumulator (GET).
    4263   00:B758                      
    4264   00:B758                      getob:  
    4265   00:B758  32 47 40            		ld (curobj),a		; preserves object number
    4266   00:B75B  21 D8 B0            		ld hl,numob         ; number of objects in game.
    4267   00:B75E  BE                  		cp (hl)             ; are we checking past the end?
    4268   00:B75F  D0                  		ret nc              ; yes, can't get non-existent item.
    4269   00:B760  CD 3F B8            		call gotob          ; check if we already have it.
    4270   00:B763  C8                  		ret z               ; we already do.
    4271   00:B764  EB                  		ex de,hl            ; object address in de.
    4272   00:B765  21 42 40            		ld hl,scno          ; current screen.
    4273   00:B768  BE                  		cp (hl)             ; is it on this screen?
    4274   00:B769  EB                  		ex de,hl            ; object address back in hl.
    4275   00:B76A  20 0B               		jr nz,.notinscr        ; not on screen, so nothing to delete.
    4276   00:B76C  36 FF               		ld (hl),255         ; pick it up.
    4277   00:B76E  2A DF B0            		ld hl,(blkptr)      ; blocks.
    4278   00:B771  22 3F 40            		ld (grbase),hl      ; set graphics base.		
    4279   00:B774  C3 8D B7            		jp robj
    4280   00:B777                      .notinscr:
    4281   00:B777  36 FF               		ld (hl),255         ; pick it up.
    4282   00:B779  C9                  		ret
    4283   00:B77A                      
    4284   00:B77A                      ;
    4285   00:B77A                      ; Returns pointers over dispx & object coords list
    4286   00:B77A                      ; Input:
    4287   00:B77A                      ;	curobj = object number
    4288   00:B77A                      ; Output:
    4289   00:B77A                      ;	HL = dispx
    4290   00:B77A                      ;	DE = Object's pointer
    4291   00:B77A                      ;
    4292   00:B77A                      objptr:
    4293   00:B77A  3A 47 40            		ld a,(curobj)
    4294   00:B77D  87                  		add a,a
    4295   00:B77E  5F                  		ld e,a
    4296   00:B77F  16 49               		ld d,(objlist >> 8) & $FF
    4297   00:B781  21 55 40            		ld hl,dispx
    4298   00:B784  C9                  		ret
    4299   00:B785                      
    4300   00:B785                      ;
    4301   00:B785                      ; Stores current coords in object coords list
    4302   00:B785                      ; Input:
    4303   00:B785                      ;	curobj = object number
    4304   00:B785                      ; Output:
    4305   00:B785                      ;	None. Object's coords filled with dispx/y
    4306   00:B785                      ;
    4307   00:B785                      wobj:
    4308   00:B785  CD 7A B7            		call objptr
    4309   00:B788  ED A0               		ldi
    4310   00:B78A  ED A0               		ldi					; stores dispxy to objects coords list
    4311   00:B78C  C9                  		ret
    4312   00:B78D                      
    4313   00:B78D                      ;
    4314   00:B78D                      ; Removes object from objects list restoring background		
    4315   00:B78D                      ;		
    4316   00:B78D                      ; Input:
    4317   00:B78D                      ; 	curobj = object number to delete
    4318   00:B78D                      ; Output:
    4319   00:B78D                      ;	None. Object's coords erased with $FF
    4320   00:B78D                      ; Modifies: All
    4321   00:B78D                      ;		
    4322   00:B78D                      robj:
    4323   00:B78D  CD 7A B7            		call objptr
    4324   00:B790  1A                  		ld a,(de)			
    4325   00:B791  FE FF               		cp 255
    4326   00:B793  C8                  		ret z				; if dispx=255, there's no object displayed
    4327   00:B794  EB                  		ex de,hl	
    4328   00:B795  ED A0               		ldi				
    4329   00:B797  ED A0               		ldi					; restores to dispxy stored objects coords
    4330   00:B799  2B                  		dec hl
    4331   00:B79A  2B                  		dec hl
    4332   00:B79B  36 FF               		ld (hl),255			; clear stored dispx, object deleted
    4333   00:B79D  CD 70 B9            		call gp2tp
    4334   00:B7A0  11 00 4A            		ld de,scrmap
    4335   00:B7A3  CD 92 B9            		call pradd
    4336   00:B7A6  19                  		add hl,de
    4337   00:B7A7  7E                  		ld a,(hl)			; gets old block from screen map buffer
    4338   00:B7A8  E5                  		push hl
    4339   00:B7A9  CD 26 BA            		call pchr
    4340   00:B7AC  E1                  		pop hl
    4341   00:B7AD  23                  		inc hl
    4342   00:B7AE  7E                  		ld a,(hl)
    4343   00:B7AF  E5                  		push hl
    4344   00:B7B0  CD 26 BA            		call pchr
    4345   00:B7B3  35                  		dec (hl)
    4346   00:B7B4  35                  		dec (hl)
    4347   00:B7B5  2B                  		dec hl
    4348   00:B7B6  34                  		inc (hl)
    4349   00:B7B7  E1                  		pop hl
    4350   00:B7B8  11 1F 00            		ld de,31
    4351   00:B7BB  19                  		add hl,de
    4352   00:B7BC  7E                  		ld a,(hl)
    4353   00:B7BD  E5                  		push hl
    4354   00:B7BE  CD 26 BA            		call pchr
    4355   00:B7C1  E1                  		pop hl
    4356   00:B7C2  23                  		inc hl
    4357   00:B7C3  7E                  		ld a,(hl)
    4358   00:B7C4  C3 26 BA            		jp pchr
    4359   00:B7C7                      
    4360   00:B7C7                      ;
    4361   00:B7C7                      ; Removes all objects from objects list restoring background		
    4362   00:B7C7                      ;		
    4363   00:B7C7                      ; Input:
    4364   00:B7C7                      ; 	None
    4365   00:B7C7                      ; Output:
    4366   00:B7C7                      ;	None. All object's dispx in objects list erased with $FF		
    4367   00:B7C7                      		
    4368   00:B7C7                      robjs:
    4369   00:B7C7  2A DF B0            		ld hl,(blkptr)      ; blocks.
    4370   00:B7CA  22 3F 40            		ld (grbase),hl      ; set graphics base.
    4371   00:B7CD  3A D8 B0            		ld a,(numob)
    4372   00:B7D0  47                  		ld b,a
    4373   00:B7D1                      .loop:
    4374   00:B7D1  C5                  		push bc
    4375   00:B7D2  78                  		ld a,b
    4376   00:B7D3  3D                  		dec a
    4377   00:B7D4  32 47 40            		ld (curobj),a
    4378   00:B7D7  CD 8D B7            		call robj			; erase object restoring bg
    4379   00:B7DA  C1                  		pop bc
    4380   00:B7DB  10 F4               		djnz .loop
    4381   00:B7DD  C9                  		ret
    4382   00:B7DE                      
    4383   00:B7DE                      ; Drop object number at (dispx, dispy).
    4384   00:B7DE                      
    4385   00:B7DE                      	if DISTYPE=ROM
    4386   00:B7DE                      
    4387   00:B7DE                      drpob:
    4388   00:B7DE  32 47 40            		ld (curobj),a		; preserves object number
    4389   00:B7E1  21 D8 B0            		ld hl,numob         ; number of objects in game.
    4390   00:B7E4  BE                  		cp (hl)             ; are we checking past the end?
    4391   00:B7E5  D0                  		ret nc              ; yes, can't drop non-existent item.
    4392   00:B7E6  CD 3F B8            		call gotob          ; make sure object is in inventory.
    4393   00:B7E9  3A 42 40            		ld a,(scno)         ; screen number.
    4394   00:B7EC  BE                  		cp (hl)             ; already on this screen?
    4395   00:B7ED  C8                  		ret z               ; yes, nothing to do.
    4396   00:B7EE  77                  		ld (hl),a           ; bring onto screen.
    4397   00:B7EF  23                  		inc hl              ; point to x coord.
    4398   00:B7F0                      		
    4399   00:B7F0  3A 55 40            		ld a,(dispx)        ; object y coordinate.
    4400   00:B7F3  77                  		ld (hl),a           ; set y coord.
    4401   00:B7F4  4F                  		ld c,a
    4402   00:B7F5  23                  		inc hl              ; point to object x.
    4403   00:B7F6  3A 56 40            		ld a,(dispy)        ; object x coordinate.
    4404   00:B7F9  77                  		ld (hl),a           ; set the x position.
    4405   00:B7FA  79                  		ld a,c
    4406   00:B7FB  FE C0               		cp MSX_MAXCY+1
    4407   00:B7FD  D0                  		ret nc				; don't draw object if it's out of boundaries
    4408   00:B7FE                      
    4409   00:B7FE  3A 47 40            		ld a,(curobj)
    4410   00:B801  CD 2F B7            		call objimg
    4411   00:B804  C3 FC B6            		jp putobj           ; draw object.
    4412   00:B807                      
    4413   00:B807                      	else
    4414   00:B807                    ~ 	
    4415   00:B807                    ~ drpob:
    4416   00:B807                    ~ 		ld (curobj),a		; preserves object number
    4417   00:B807                    ~ 		ld hl,numob         ; number of objects in game.
    4418   00:B807                    ~ 		cp (hl)             ; are we checking past the end?
    4419   00:B807                    ~ 		ret nc              ; yes, can't drop non-existent item.
    4420   00:B807                    ~ 		call gotob          ; make sure object is in inventory.
    4421   00:B807                    ~ 		ld a,(scno)         ; screen number.
    4422   00:B807                    ~ 		cp (hl)             ; already on this screen?
    4423   00:B807                    ~ 		ret z               ; yes, nothing to do.
    4424   00:B807                    ~ 		ld (hl),a           ; bring onto screen.
    4425   00:B807                    ~ 		inc hl              ; point to x coord.
    4426   00:B807                    ~ 		
    4427   00:B807                    ~ 		ld a,(dispx)        ; object y coordinate.
    4428   00:B807                    ~ 		ld (hl),a           ; set y coord.
    4429   00:B807                    ~ 		ld c,a
    4430   00:B807                    ~ 		inc hl              ; point to object x.
    4431   00:B807                    ~ 		ld a,(dispy)        ; object x coordinate.
    4432   00:B807                    ~ 		ld (hl),a           ; set the x position.
    4433   00:B807                    ~ 		ld a,c
    4434   00:B807                    ~ 		cp MSX_MAXCY+1
    4435   00:B807                    ~ 		ret nc				; don't draw object if it's out of boundaries
    4436   00:B807                    ~ 		
    4437   00:B807                    ~ 		ld de,-66           ; minus graphic size.
    4438   00:B807                    ~ 		add hl,de           ; point to graphics.
    4439   00:B807                    ~ 		jp putobj           ; draw object.
    4440   00:B807                    ~ 
    4441   00:B807                    ~ 	endif
    4442   00:B807                      	
    4443   00:B807                      
    4444   00:B807                      ; Seek objects at sprite position.
    4445   00:B807                      
    4446   00:B807                      	if DISTYPE=ROM
    4447   00:B807                      	
    4448   00:B807                      skobj:
    4449   00:B807  11 03 00            		ld de,ODTSIZ        ; size of each object.
    4450   00:B80A  21 A8 4F            		ld hl,objatr
    4451   00:B80D  3A D8 B0            		ld a,(numob)        ; number of objects in game.
    4452   00:B810  47                  		ld b,a              ; set up the loop counter.
    4453   00:B811                      .sk0: 
    4454   00:B811  3A 42 40            		ld a,(scno)         ; current room number.
    4455   00:B814  BE                  		cp (hl)             ; is object in here?
    4456   00:B815  CC 1E B8            		call z,.sk1       	; yes, check coordinates.
    4457   00:B818  19                  		add hl,de           ; point to next object in table.
    4458   00:B819  10 F6               		djnz .sk0         	; repeat for all objects.
    4459   00:B81B  3E FF               		ld a,255            ; end of list and nothing found, return 255.
    4460   00:B81D  C9                  		ret
    4461   00:B81E                      .sk1: 
    4462   00:B81E  23                  		inc hl              ; point to y coordinate.
    4463   00:B81F  7E                  		ld a,(hl)           ; get coordinate.
    4464   00:B820  DD 96 03            		sub (ix+3)          ; subtract sprite y.
    4465   00:B823  C6 0F               		add a,MSX_SPRVS-1	; add sprite height minus one.
    4466   00:B825  FE 1F               		cp MSX_SPRVS+16-1   ; within range?
    4467   00:B827  D2 3D B8            		jp nc,.sk2        	; no, ignore object.
    4468   00:B82A  23                  		inc hl              ; point to x coordinate now.
    4469   00:B82B  7E                  		ld a,(hl)           ; get coordinate.
    4470   00:B82C  DD 96 04            		sub (ix+4)          ; subtract the sprite x.
    4471   00:B82F  C6 0F               		add a,MSX_SPRHS-1   ; add sprite width minus one.
    4472   00:B831  FE 1F               		cp MSX_SPRHS+16-1   ; within range?
    4473   00:B833  D2 3C B8            		jp nc,.sk3        	; no, ignore object.
    4474   00:B836  D1                  		pop de              ; remove return address from stack.
    4475   00:B837  3A D8 B0            		ld a,(numob)        ; objects in game.
    4476   00:B83A  90                  		sub b               ; subtract loop counter.
    4477   00:B83B  C9                  		ret                 ; accumulator now points to object.
    4478   00:B83C                      .sk3:
    4479   00:B83C  2B                  		dec hl              ; back to y position.
    4480   00:B83D                      .sk2:
    4481   00:B83D  2B                  		dec hl              ; back to room.
    4482   00:B83E  C9                  		ret
    4483   00:B83F                      
    4484   00:B83F                      	else
    4485   00:B83F                    ~ 	
    4486   00:B83F                    ~ skobj:
    4487   00:B83F                    ~ 		ld hl,objdta        ; pointer to objects.
    4488   00:B83F                    ~ 		ld de,OBJSIZ-ODTSIZ ; distance to room number.
    4489   00:B83F                    ~ 		add hl,de           ; point to room data.
    4490   00:B83F                    ~ 		ld de,OBJSIZ        ; size of each object.
    4491   00:B83F                    ~ 		ld a,(numob)        ; number of objects in game.
    4492   00:B83F                    ~ 		ld b,a              ; set up the loop counter.
    4493   00:B83F                    ~ .sk0: 
    4494   00:B83F                    ~ 		ld a,(scno)         ; current room number.
    4495   00:B83F                    ~ 		cp (hl)             ; is object in here?
    4496   00:B83F                    ~ 		call z,.sk1       	; yes, check coordinates.
    4497   00:B83F                    ~ 		add hl,de           ; point to next object in table.
    4498   00:B83F                    ~ 		djnz .sk0         	; repeat for all objects.
    4499   00:B83F                    ~ 		ld a,255            ; end of list and nothing found, return 255.
    4500   00:B83F                    ~ 		ret
    4501   00:B83F                    ~ .sk1: 
    4502   00:B83F                    ~ 		inc hl              ; point to x coordinate.
    4503   00:B83F                    ~ 		ld a,(hl)           ; get coordinate.
    4504   00:B83F                    ~ 		sub (ix+3)          ; subtract sprite x.
    4505   00:B83F                    ~ 		add a,15            ; add sprite height minus one.
    4506   00:B83F                    ~ 		cp 31               ; within range?
    4507   00:B83F                    ~ 		jp nc,.sk2        	; no, ignore object.
    4508   00:B83F                    ~ 		inc hl              ; point to y coordinate now.
    4509   00:B83F                    ~ 		ld a,(hl)           ; get coordinate.
    4510   00:B83F                    ~ 		sub (ix+4)          ; subtract the sprite y.
    4511   00:B83F                    ~ 		add a,15            ; add sprite width minus one.
    4512   00:B83F                    ~ 		cp 31               ; within range?
    4513   00:B83F                    ~ 		jp nc,.sk3        	; no, ignore object.
    4514   00:B83F                    ~ 		pop de              ; remove return address from stack.
    4515   00:B83F                    ~ 		ld a,(numob)        ; objects in game.
    4516   00:B83F                    ~ 		sub b               ; subtract loop counter.
    4517   00:B83F                    ~ 		ret                 ; accumulator now points to object.
    4518   00:B83F                    ~ .sk3:
    4519   00:B83F                    ~ 		dec hl              ; back to y position.
    4520   00:B83F                    ~ .sk2:
    4521   00:B83F                    ~ 		dec hl              ; back to room.
    4522   00:B83F                    ~ 		ret
    4523   00:B83F                    ~ 
    4524   00:B83F                    ~ 	endif
    4525   00:B83F                      	
    4526   00:B83F                      	endif
    4527   00:B83F                      	
    4528   00:B83F                      	if (OFLAG or MFLAG)
    4529   00:B83F                      		
    4530   00:B83F                      ;-----------------------------------------------------------------
    4531   00:B83F                      ; Got object check.
    4532   00:B83F                      ; Call with object in accumulator, returns zero set if in pockets.
    4533   00:B83F                      ;
    4534   00:B83F                      ; Input:
    4535   00:B83F                      ;  A = object number
    4536   00:B83F                      ;-----------------------------------------------------------------
    4537   00:B83F                      
    4538   00:B83F                      gotob:
    4539   00:B83F  21 D8 B0            		ld hl,numob         ; number of objects in game.
    4540   00:B842  BE                  		cp (hl)             ; are we checking past the end?
    4541   00:B843  30 06               		jr nc,.gotob0       ; yes, we can't have a non-existent object.
    4542   00:B845  CD 4F B8            		call findob         ; find the object.
    4543   00:B848                      .gotob1:
    4544   00:B848  FE FF               		cp 255              ; in pockets?
    4545   00:B84A  C9                  		ret
    4546   00:B84B                      .gotob0:
    4547   00:B84B  3E FE               		ld a,254            ; missing.
    4548   00:B84D  18 F9               		jr .gotob1
    4549   00:B84F                      
    4550   00:B84F                      ; Find object address
    4551   00:B84F                      
    4552   00:B84F                      	if DISTYPE=ROM
    4553   00:B84F                      	
    4554   00:B84F                      findob:
    4555   00:B84F  26 00               		ld h,0
    4556   00:B851  6F                  		ld l,a
    4557   00:B852  29                  		add hl,hl
    4558   00:B853                      		ADD_HL_A
    4558   00:B853  85                >   add a,l
    4558   00:B854  6F                >   ld l,a
    4558   00:B855  8C                >   adc a,h
    4558   00:B856  95                >   sub l
    4558   00:B857  67                >   ld h,a
    4559   00:B858  11 A8 4F            		ld de,objatr
    4560   00:B85B  19                  		add hl,de
    4561   00:B85C  7E                  		ld a,(hl)
    4562   00:B85D  C9                  		ret
    4563   00:B85E                      
    4564   00:B85E                      	else
    4565   00:B85E                    ~ 	
    4566   00:B85E                    ~ findob:
    4567   00:B85E                    ~ 		ld hl,objdta        ; objects.
    4568   00:B85E                    ~ 		ld de,OBJSIZ        ; size of each object (64+6)
    4569   00:B85E                    ~ 		and a               ; is it zero?
    4570   00:B85E                    ~ 		jr z,.fndob1        ; yes, skip loop.
    4571   00:B85E                    ~ 		ld b,a              ; loop counter in b.
    4572   00:B85E                    ~ .fndob2:
    4573   00:B85E                    ~ 		add hl,de           ; point to next one.
    4574   00:B85E                    ~ 		djnz .fndob2        ; repeat until we find address.
    4575   00:B85E                    ~ .fndob1:
    4576   00:B85E                    ~ 		ld e,OBJSIZ-ODTSIZ  ; distance to room it's in (0-63 obj.data, 64 room)
    4577   00:B85E                    ~ 		add hl,de           ; point to room.
    4578   00:B85E                    ~ 		ld a,(hl)           ; fetch status.
    4579   00:B85E                    ~ 		ret
    4580   00:B85E                    ~ 
    4581   00:B85E                    ~ 	endif
    4582   00:B85E                      	
    4583   00:B85E                      	endif
    4584   00:B85E                      
    4585   00:B85E                      
    4586   00:B85E                      ;
    4587   00:B85E                      ; Fills a box of values 255 in screenmap
    4588   00:B85E                      ;
    4589   00:B85E                      ; Input:
    4590   00:B85E                      ;	dispx: y coord (0-191)
    4591   00:B85E                      ;	dispy: x coord (0-255)
    4592   00:B85E                      ;	dirthig: height of the box
    4593   00:B85E                      ;	dirthig+1: width of the box		
    4594   00:B85E                      ; Output:
    4595   00:B85E                      ; 	None. box is filled in scrmap
    4596   00:B85E                      ; Modifies:
    4597   00:B85E                      ;	None
    4598   00:B85E                      ;
    4599   00:B85E                      
    4600   00:B85E                      /* dirtybox:
    4601   00:B85E                    ~ 		push hl
    4602   00:B85E                    ~ 		push de
    4603   00:B85E                    ~ 		push bc
    4604   00:B85E                    ~ 		ld de,scrmap
    4605   00:B85E                    ~ 		call chradd
    4606   00:B85E                    ~ 		add hl,de
    4607   00:B85E                    ~ 		ld de,32
    4608   00:B85E                    ~ 		ld bc,(dirthig)
    4609   00:B85E                    ~ 		ld a,b
    4610   00:B85E                    ~ .looprows:	
    4611   00:B85E                    ~ 		push hl
    4612   00:B85E                    ~ .loopcols:		
    4613   00:B85E                    ~ 		ld (hl),255
    4614   00:B85E                    ~ 		inc hl
    4615   00:B85E                    ~ 		djnz .loopcols
    4616   00:B85E                    ~ 		pop hl		
    4617   00:B85E                    ~ 		add hl,de
    4618   00:B85E                    ~ 		ld b,a		
    4619   00:B85E                    ~ 		dec c
    4620   00:B85E                    ~ 		jr nz,.looprows		
    4621   00:B85E                    ~ 		pop bc
    4622   00:B85E                    ~ 		pop de
    4623   00:B85E                    ~ 		pop hl
    4624   00:B85E                    ~ 		ret
    4625   00:B85E                    ~  */	   
    4626   00:B85E                      
    4627   00:B85E                      ; Spawn a new sprite.
    4628   00:B85E                      
    4629   00:B85E                      spawn:
    4630   00:B85E  21 B5 40            		ld hl,sprtab        ; sprite table.
    4631   00:B861                      numsp1:
    4632   00:B861  3E 20               		ld a,NUMSPR         ; number of sprites.
    4633   00:B863  11 11 00            		ld de,TABSIZ        ; size of each entry.
    4634   00:B866                      .nxtslot:
    4635   00:B866  08                  		ex af,af            ; store loop counter.
    4636   00:B867  7E                  		ld a,(hl)           ; get sprite type.
    4637   00:B868  3C                  		inc a               ; is it an unused slot?
    4638   00:B869  28 05               		jr z,.spaw1         ; yes, we can use this one.
    4639   00:B86B  19                  		add hl,de           ; point to next sprite in table.
    4640   00:B86C  08                  		ex af,af            ; restore loop counter.
    4641   00:B86D  3D                  		dec a               ; one less iteration.
    4642   00:B86E  20 F6               		jr nz,.nxtslot      ; keep going until we find a slot.
    4643   00:B870                      ; Didn't find one but drop through and set up a dummy sprite instead.
    4644   00:B870                      .spaw1:
    4645   00:B870  DD E5               		push ix             ; existing sprite address on stack.
    4646   00:B872  22 3C 40            		ld (spptr),hl       ; store spawned sprite address.
    4647   00:B875  71                  		ld (hl),c           ; set the type.
    4648   00:B876  23                  		inc hl              ; point to image.
    4649   00:B877  70                  		ld (hl),b           ; set the image.
    4650   00:B878  23                  		inc hl              ; next byte.
    4651   00:B879                      
    4652   00:B879  78                  		ld a,b
    4653   00:B87A  CD 51 C2            		call mapsprite
    4654   00:B87D                      
    4655   00:B87D  36 00               		ld (hl),0           ; frame zero.
    4656   00:B87F  23                  		inc hl              ; next byte.
    4657   00:B880  DD 7E 03            		ld a,(ix+X)         ; x coordinate.
    4658   00:B883  77                  		ld (hl),a           ; set sprite coordinate.
    4659   00:B884  23                  		inc hl              ; next byte.
    4660   00:B885  DD 7E 04            		ld a,(ix+Y)         ; y coordinate.
    4661   00:B888  77                  		ld (hl),a           ; set sprite coordinate.
    4662   00:B889  23                  		inc hl              ; next byte.
    4663   00:B88A                      
    4664   00:B88A  DD 7E 05            		ld a,(ix+5)         ; color
    4665   00:B88D  77                  		ld (hl),a           ; set sprite color.
    4666   00:B88E  23                  		inc hl              ; next byte.
    4667   00:B88F  23                  		inc hl
    4668   00:B890  23                  		inc hl
    4669   00:B891  DD 7E 03            		ld a,(ix+X)         ; x coordinate.
    4670   00:B894  77                  		ld (hl),a           ; set sprite coordinate.
    4671   00:B895  23                  		inc hl              ; next byte.
    4672   00:B896  DD 7E 04            		ld a,(ix+Y)         ; y coordinate.
    4673   00:B899  77                  		ld (hl),a           ; set sprite coordinate.
    4674   00:B89A  23                  		inc hl              ; next byte.
    4675   00:B89B                      
    4676   00:B89B  DD 7E 0A            		ld a,(ix+10)        ; direction of original.
    4677   00:B89E  77                  		ld (hl),a           ; set the direction.
    4678   00:B89F  23                  		inc hl              ; next byte.
    4679   00:B8A0  06 00               		ld b,0
    4680   00:B8A2  70                  		ld (hl),b           ; reset parameter.
    4681   00:B8A3  23                  		inc hl              ; next byte.
    4682   00:B8A4  70                  		ld (hl),b           ; reset parameter.
    4683   00:B8A5  23                  		inc hl              ; next byte.
    4684   00:B8A6  70                  		ld (hl),b           ; reset parameter.
    4685   00:B8A7  23                  		inc hl              ; next byte.
    4686   00:B8A8  70                  		ld (hl),b           ; reset parameter.
    4687   00:B8A9                      rtssp:
    4688   00:B8A9  DD 2A 3C 40         		ld ix,(spptr)       ; address of new sprite.
    4689   00:B8AD                      evis1:
    4690   00:B8AD  CD D7 87            		call evnt09         ; call sprite initialisation event.
    4691   00:B8B0  DD E1               		pop ix              ; address of original sprite.
    4692   00:B8B2                      
    4693   00:B8B2                      ;
    4694   00:B8B2                      ; Finds the highest used sprite slot
    4695   00:B8B2                      ;
    4696   00:B8B2                      
    4697   00:B8B2                      hslot:		
    4698   00:B8B2  3E FF               		ld a,255
    4699   00:B8B4  06 20               		ld b,NUMSPR
    4700   00:B8B6  11 EF FF            		ld de,-TABSIZ
    4701   00:B8B9  21 C4 42            		ld hl,sprtab+((NUMSPR-1)*TABSIZ)
    4702   00:B8BC                      .nxtslot:
    4703   00:B8BC  BE                  		cp (hl)
    4704   00:B8BD  20 03               		jr nz,.found
    4705   00:B8BF  19                  		add hl,de
    4706   00:B8C0  10 FA               		djnz .nxtslot
    4707   00:B8C2                      .found		
    4708   00:B8C2  78                  		ld a,b
    4709   00:B8C3  32 4C 40            		ld (highslot),a
    4710   00:B8C6  C9                  		ret
    4711   00:B8C7                      
    4712   00:B8C7                      checkx:
    4713   00:B8C7  7B                  		ld a,e              ; x position.
    4714   00:B8C8  FE 18               		cp MSX_MAXROWS      ; off screen?
    4715   00:B8CA  D8                  		ret c               ; no, it's okay.
    4716   00:B8CB  E1                  		pop hl              ; remove return address from stack.
    4717   00:B8CC  C9                  		ret
    4718   00:B8CD                      
    4719   00:B8CD                      ; Displays the current score. (MSX:OK)
    4720   00:B8CD                      
    4721   00:B8CD                      dscor:
    4722   00:B8CD  CD B7 BD            		call preprt         ; set up font and print position.
    4723   00:B8D0  CD C7 B8            		call checkx         ; make sure we're in a printable range.
    4724   00:B8D3  3A 38 40            		ld a,(prtmod)       ; get print mode.
    4725   00:B8D6  A7                  		and a               ; standard size text?
    4726   00:B8D7  C2 F6 B8            		jp nz,bscor0        ; no, show double-height.
    4727   00:B8DA                      dscor0:
    4728   00:B8DA  C5                  		push bc             ; place counter onto the stack.
    4729   00:B8DB  E5                  		push hl
    4730   00:B8DC  7E                  		ld a,(hl)           ; fetch character.
    4731   00:B8DD  CD C6 B9            		call ptxt           ; display character.
    4732   00:B8E0                      		
    4733   00:B8E0  21 56 40            		ld hl,dispy         ; y coordinate.
    4734   00:B8E3  34                  		inc (hl)            ; move along one.
    4735   00:B8E4  E1                  		pop hl
    4736   00:B8E5  23                  		inc hl              ; next score column.
    4737   00:B8E6  C1                  		pop bc              ; retrieve character counter.
    4738   00:B8E7  10 F1               		djnz dscor0         ; repeat for all digits.
    4739   00:B8E9  2A DF B0            		ld hl,(blkptr)      ; blocks.
    4740   00:B8EC  22 3F 40            		ld (grbase),hl      ; set graphics base.
    4741   00:B8EF                      dscor2:
    4742   00:B8EF  2A 55 40            		ld hl,(dispx)       ; general coordinates.
    4743   00:B8F2  22 35 40            		ld (charx),hl       ; set up display coordinates.
    4744   00:B8F5  C9                  		ret
    4745   00:B8F6                      
    4746   00:B8F6                      ; Displays the current score in double-height characters.
    4747   00:B8F6                      
    4748   00:B8F6  C5                  bscor0 push bc             ; place counter onto the stack.
    4749   00:B8F7  E5                         push hl
    4750   00:B8F8  7E                         ld a,(hl)           ; fetch character.
    4751   00:B8F9  CD 36 BD                   call bchar          ; display big char.
    4752   00:B8FC  E1                         pop hl
    4753   00:B8FD  23                         inc hl              ; next score column.
    4754   00:B8FE  C1                         pop bc              ; retrieve character counter.
    4755   00:B8FF  10 F5                      djnz bscor0         ; repeat for all digits.
    4756   00:B901  C3 EF B8                   jp dscor2           ; tidy up line and column variables.
    4757   00:B904                      
    4758   00:B904                      ; Adds number in the hl pair to the score.
    4759   00:B904                      
    4760   00:B904  11 01 40            addsc  ld de,score+1       ; ten thousands column.
    4761   00:B907  01 10 27                   ld bc,10000         ; amount to add each time.
    4762   00:B90A  CD 26 B9                   call incsc          ; add to score.
    4763   00:B90D  13                         inc de              ; thousands column.
    4764   00:B90E  01 E8 03                   ld bc,1000          ; amount to add each time.
    4765   00:B911  CD 26 B9                   call incsc          ; add to score.
    4766   00:B914  13                         inc de              ; hundreds column.
    4767   00:B915  01 64 00                   ld bc,100           ; amount to add each time.
    4768   00:B918  CD 26 B9                   call incsc          ; add to score.
    4769   00:B91B  13                         inc de              ; tens column.
    4770   00:B91C  01 0A 00                   ld bc,10            ; amount to add each time.
    4771   00:B91F  CD 26 B9                   call incsc          ; add to score.
    4772   00:B922  13                         inc de              ; units column.
    4773   00:B923  01 01 00                   ld bc,1             ; units.
    4774   00:B926  E5                  incsc  push hl             ; store amount to add.
    4775   00:B927  A7                         and a               ; clear the carry flag.
    4776   00:B928  ED 42                      sbc hl,bc           ; subtract from amount to add.
    4777   00:B92A  38 09                      jr c,incsc0         ; too much, restore value.
    4778   00:B92C  F1                         pop af              ; delete the previous amount from the stack.
    4779   00:B92D  D5                         push de             ; store column position.
    4780   00:B92E  CD 37 B9                   call incsc2         ; do the increment.
    4781   00:B931  D1                         pop de              ; restore column.
    4782   00:B932  C3 26 B9                   jp incsc            ; repeat until all added.
    4783   00:B935  E1                  incsc0 pop hl              ; restore previous value.
    4784   00:B936  C9                         ret
    4785   00:B937  1A                  incsc2 ld a,(de)           ; get amount.
    4786   00:B938  3C                         inc a               ; add one to column.
    4787   00:B939  12                         ld (de),a           ; write new column total.
    4788   00:B93A  FE 3A                      cp '9'+1            ; gone beyond range of digits?
    4789   00:B93C  D8                         ret c               ; no, carry on.
    4790   00:B93D  3E 30                      ld a,'0'            ; mae it zero.
    4791   00:B93F  12                         ld (de),a           ; write new column total.
    4792   00:B940  1B                         dec de              ; back one column.
    4793   00:B941  18 F4                      jr incsc2
    4794   00:B943                      
    4795   00:B943                      ; Add bonus to score.
    4796   00:B943                      
    4797   00:B943  11 05 40            addbo  ld de,score+5       ; last score digit.
    4798   00:B946  21 11 40                   ld hl,bonus+5       ; last bonus digit.
    4799   00:B949  A7                         and a               ; clear carry.
    4800   00:B94A  01 30 06                   ld bc,6*256+48      ; 6 digits to add, ASCII '0' in c.
    4801   00:B94D  1A                  addbo0 ld a,(de)           ; get score.
    4802   00:B94E  8E                         adc a,(hl)          ; add bonus.
    4803   00:B94F  91                         sub c               ; 0 to 18.
    4804   00:B950  71                         ld (hl),c           ; zeroise bonus.
    4805   00:B951  2B                         dec hl              ; next bonus.
    4806   00:B952  FE 3A                      cp 58               ; carried?
    4807   00:B954  38 02                      jr c,addbo1         ; no, do next one.
    4808   00:B956  D6 0A                      sub 10              ; subtract 10.
    4809   00:B958  12                  addbo1 ld (de),a           ; write new score.
    4810   00:B959  1B                         dec de              ; next score digit.
    4811   00:B95A  3F                         ccf                 ; set carry for next digit.
    4812   00:B95B  10 F0                      djnz addbo0         ; repeat for all 6 digits.
    4813   00:B95D  C9                         ret
    4814   00:B95E                      
    4815   00:B95E                      ; Swap score and bonus.
    4816   00:B95E                      
    4817   00:B95E  11 00 40            swpsb  ld de,score         ; first score digit.
    4818   00:B961  21 0C 40                   ld hl,bonus         ; first bonus digit.
    4819   00:B964  06 06                      ld b,6              ; digits to add.
    4820   00:B966  1A                  swpsb0 ld a,(de)           ; get score and bonus digits.
    4821   00:B967  4E                         ld c,(hl)
    4822   00:B968  EB                         ex de,hl            ; swap pointers.
    4823   00:B969  71                         ld (hl),c           ; write bonus and score digits.
    4824   00:B96A  12                         ld (de),a
    4825   00:B96B  23                         inc hl              ; next score and bonus.
    4826   00:B96C  13                         inc de
    4827   00:B96D  10 F7                      djnz swpsb0         ; repeat for all 6 digits.
    4828   00:B96F  C9                         ret
    4829   00:B970                      
    4830   00:B970                      ; Turns graphic coordinates to text ones
    4831   00:B970                      ; Input:
    4832   00:B970                      ;	None
    4833   00:B970                      ; Output:
    4834   00:B970                      ; 	dispx & dispy updated
    4835   00:B970                      gp2tp:
    4836   00:B970  3A 55 40            		ld a,(dispx)
    4837   00:B973  0F                  		rrca
    4838   00:B974  0F                  		rrca
    4839   00:B975  0F                  		rrca
    4840   00:B976  E6 1F               		and $1F			
    4841   00:B978  32 55 40            		ld (dispx),a	; stores y/8
    4842   00:B97B  3A 56 40            		ld a,(dispy)
    4843   00:B97E  0F                  		rrca
    4844   00:B97F  0F                  		rrca
    4845   00:B980  0F                  		rrca
    4846   00:B981  E6 1F               		and $1F			
    4847   00:B983  32 56 40            		ld (dispy),a	; stores x/8
    4848   00:B986  C9                  		ret
    4849   00:B987                      		
    4850   00:B987                      ; Get print address.Returns VRAM address in DE (0000-17FF).
    4851   00:B987                      ; Requires: y(0-23), x(0-31)
    4852   00:B987                      ; Must NOT modify HL
    4853   00:B987                      
    4854   00:B987                      gprad:
    4855   00:B987  ED 5B 55 40         		ld de,(dispx)		; get y coord
    4856   00:B98B  7A                  		ld a,d				; y*256
    4857   00:B98C  87                  		add a,a				; get x coord
    4858   00:B98D  87                  		add a,a				; 
    4859   00:B98E  87                  		add a,a				; 
    4860   00:B98F  53                  		ld d,e				; x*8
    4861   00:B990  5F                  		ld e,a				; (y*256)+(x*8)
    4862   00:B991  C9                  		ret		
    4863   00:B992                       
    4864   00:B992                      ; Get property buffer address of char at (dispx, dispy) in HL (0-767).
    4865   00:B992                      ; Requires: y(0-23), x(0-31)
    4866   00:B992                      
    4867   00:B992                      pradd:
    4868   00:B992  3A 55 40            		ld a,(dispx)        ; y coordinate.
    4869   00:B995  0F                  		rrca
    4870   00:B996  0F                  		rrca
    4871   00:B997  0F                  		rrca
    4872   00:B998  6F                  		ld l,a			
    4873   00:B999  E6 1F               		and $1F			
    4874   00:B99B  67                  		ld h,a			
    4875   00:B99C  7D                  		ld a,l			
    4876   00:B99D  E6 E0               		and $E0			
    4877   00:B99F  6F                  		ld l,a				; y * 32
    4878   00:B9A0  3A 56 40            		ld a,(dispy)    	; fetch x coordinate.
    4879   00:B9A3  E6 1F               		and $1F         	; should be in range 0 - 31.
    4880   00:B9A5                      		ADD_HL_A
    4880   00:B9A5  85                >   add a,l
    4880   00:B9A6  6F                >   ld l,a
    4880   00:B9A7  8C                >   adc a,h
    4880   00:B9A8  95                >   sub l
    4880   00:B9A9  67                >   ld h,a
    4881   00:B9AA  C9                  		ret		
    4882   00:B9AB                      
    4883   00:B9AB                      ; Get screen buffer address of char at (dispx, dispy) in hl (0-767).
    4884   00:B9AB                      ; Requires: y(0-191), x(0-255)
    4885   00:B9AB                      
    4886   00:B9AB                      chradd:
    4887   00:B9AB  3A 55 40            		ld a,(dispx)
    4888   00:B9AE  07                  		rlca                ; multiply char by 4.
    4889   00:B9AF  07                  		rlca
    4890   00:B9B0  6F                  		ld l,a              ; store shift in e.
    4891   00:B9B1  E6 03               		and 3               ; only want high byte bits.
    4892   00:B9B3  67                  		ld h,a              ; store in d.
    4893   00:B9B4  7D                  		ld a,l              ; restore shifted value.
    4894   00:B9B5  E6 FC               		and $FC             ; only want low byte bits.
    4895   00:B9B7  6F                  		ld l,a
    4896   00:B9B8  3A 56 40            		ld a,(dispy)
    4897   00:B9BB  E6 F8               		and $F8
    4898   00:B9BD  0F                  		rrca
    4899   00:B9BE  0F                  		rrca
    4900   00:B9BF  0F                  		rrca
    4901   00:B9C0                      		ADD_HL_A
    4901   00:B9C0  85                >   add a,l
    4901   00:B9C1  6F                >   ld l,a
    4901   00:B9C2  8C                >   adc a,h
    4901   00:B9C3  95                >   sub l
    4901   00:B9C4  67                >   ld h,a
    4902   00:B9C5  C9                  		ret
    4903   00:B9C6                      
    4904   00:B9C6                      ; print char pattern (without color) (MSX:OK)
    4905   00:B9C6                      ; A= char
    4906   00:B9C6                      ; dispy,dispx = x,y
    4907   00:B9C6                      ; fgclr,bgclr		
    4908   00:B9C6                      ptxt:
    4909   00:B9C6  07                  		rlca                ; find address for the font char
    4910   00:B9C7  07                  		rlca
    4911   00:B9C8  07                  		rlca				; multiply char code by 8.
    4912   00:B9C9  5F                  		ld e,a              ; store shift in e.
    4913   00:B9CA  E6 07               		and 7               ; only want high byte bits.
    4914   00:B9CC  57                  		ld d,a              ; store in d.
    4915   00:B9CD  7B                  		ld a,e              ; restore shifted value.
    4916   00:B9CE  E6 F8               		and 248             ; only want low byte bits.
    4917   00:B9D0  5F                  		ld e,a              ; that's the low byte. DE=CHAR*8
    4918   00:B9D1  2A 3F 40            		ld hl,(grbase)      ; address of graphics.
    4919   00:B9D4  19                  		add hl,de           ; add displacement.
    4920   00:B9D5  CD 87 B9            		call gprad          ; get screen address (in DE)
    4921   00:B9D8                      		SETWRT de		
    4921   00:B9D8                    >  ifdifi reg,de
    4921   00:B9D8                    ~   ld a,l
    4921   00:B9D8                    ~   di
    4921   00:B9D8                    ~   out (MSX_VDPCW),a
    4921   00:B9D8                    ~   ld a,h
    4921   00:B9D8                    ~  else
    4921   00:B9D8  7B                >   ld a,e
    4921   00:B9D9  F3                >   di
    4921   00:B9DA  D3 BF             >   out (MSX_VDPCW),a
    4921   00:B9DC  7A                >   ld a,d
    4921   00:B9DD                    >  endif
    4921   00:B9DD  F6 40             >   or $40
    4921   00:B9DF  D3 BF             >   out (MSX_VDPCW),a
    4921   00:B9E1  FB                >   ei
    4922   00:B9E2  01 BE 08            		ld bc,8*256+MSX_VDPDRW
    4923   00:B9E5                      ldirvm0:
    4924   00:B9E5  ED A3               		outi				; writes pattern bytes
    4925   00:B9E7  C2 E5 B9            		jp nz,ldirvm0				
    4926   00:B9EA  7B                  		ld a,e
    4927   00:B9EB  F3                  		di					; 5
    4928   00:B9EC  D3 BF               		out (MSX_VDPCW),a
    4929   00:B9EE  7A                  		ld a,d
    4930   00:B9EF  F6 60               		or $60				; color patterns + write
    4931   00:B9F1  FB                  		ei	
    4932   00:B9F2  D3 BF               		out (MSX_VDPCW),a   ; (51)
    4933   00:B9F4  06 08               		ld b,8
    4934   00:B9F6  3A 39 40            		ld a,(clratt)
    4935   00:B9F9                      .nxtrow:
    4936   00:B9F9  D3 BE               		out (MSX_VDPDRW),a	; writes color bytes
    4937   00:B9FB  10 FC               		djnz .nxtrow
    4938   00:B9FD  C9                  		ret
    4939   00:B9FE                      		
    4940   00:B9FE                      ; Print block with attributes, properties and pixels (saves block if adventure mode).
    4941   00:B9FE                      
    4942   00:B9FE                      pattr:
    4943   00:B9FE                      		if AFLAG
    4944   00:B9FE                    ~ 		call wbloc          ; save blockinfo	   
    4945   00:B9FE                    ~ 		endif
    4946   00:B9FE                      
    4947   00:B9FE                      ; Print block with attributes, properties and pixels (no saving).
    4948   00:B9FE                      		
    4949   00:B9FE                      pattr2:
    4950   00:B9FE  47                  		ld b,a              ; store cell in b register for now.
    4951   00:B9FF  2A E1 B0            		ld hl,(proptr)      ; pointer to properties.
    4952   00:BA02                      		ADD_HL_A
    4952   00:BA02  85                >   add a,l
    4952   00:BA03  6F                >   ld l,a
    4952   00:BA04  8C                >   adc a,h
    4952   00:BA05  95                >   sub l
    4952   00:BA06  67                >   ld h,a
    4953   00:BA07  4E                  		ld c,(hl)           ; fetch byte.
    4954   00:BA08  79                  		ld a,c              ; put into accumulator.
    4955   00:BA09  FE 08               		cp COLECT           ; is it a collectable?
    4956   00:BA0B  C2 12 BA            		jp nz,pattr1        ; no, carry on as normal.
    4957   00:BA0E  78                  		ld a,b              ; restore cell.
    4958   00:BA0F  32 37 40            		ld (colpat),a       ; store collectable block.
    4959   00:BA12                      pattr1:
    4960   00:BA12  11 00 46            		ld de,MAP
    4961   00:BA15  CD 92 B9            		call pradd          ; get property buffer address.
    4962   00:BA18  E5                  		push hl
    4963   00:BA19  19                  		add hl,de
    4964   00:BA1A  71                  		ld (hl),c           ; write property.		
    4965   00:BA1B  11 00 4A            		ld de,scrmap		; screen buffer
    4966   00:BA1E  E1                  		pop hl
    4967   00:BA1F  19                  		add hl,de
    4968   00:BA20  7E                  		ld a,(hl)
    4969   00:BA21  B8                  		cp b
    4970   00:BA22  28 38               		jr z, pattrnxt		; skip printing char
    4971   00:BA24  70                   		ld (hl),b		
    4972   00:BA25  78                  		ld a,b              ; restore block number.
    4973   00:BA26                      
    4974   00:BA26                      ; Print block.
    4975   00:BA26                      pchr:
    4976   00:BA26  07                  		rlca                ; find address for the block 
    4977   00:BA27  07                  		rlca
    4978   00:BA28  07                  		rlca
    4979   00:BA29  07                  		rlca				; multiply block code by 16
    4980   00:BA2A  5F                  		ld e,a              ; store shift in e.
    4981   00:BA2B  E6 0F               		and $0F             ; only want high byte bits.
    4982   00:BA2D  57                  		ld d,a              ; store in d.
    4983   00:BA2E  7B                  		ld a,e              ; restore shifted value.
    4984   00:BA2F  E6 F0               		and $F0             ; only want low byte bits.
    4985   00:BA31  5F                  		ld e,a              ; that's the low byte. DE=CHAR*8
    4986   00:BA32  2A 3F 40            		ld hl,(grbase)      ; address of graphics.
    4987   00:BA35  19                  		add hl,de           ; add displacement.
    4988   00:BA36  CD 87 B9            		call gprad          ; get screen address (in DE)
    4989   00:BA39                      		SETWRT de
    4989   00:BA39                    >  ifdifi reg,de
    4989   00:BA39                    ~   ld a,l
    4989   00:BA39                    ~   di
    4989   00:BA39                    ~   out (MSX_VDPCW),a
    4989   00:BA39                    ~   ld a,h
    4989   00:BA39                    ~  else
    4989   00:BA39  7B                >   ld a,e
    4989   00:BA3A  F3                >   di
    4989   00:BA3B  D3 BF             >   out (MSX_VDPCW),a
    4989   00:BA3D  7A                >   ld a,d
    4989   00:BA3E                    >  endif
    4989   00:BA3E  F6 40             >   or $40
    4989   00:BA40  D3 BF             >   out (MSX_VDPCW),a
    4989   00:BA42  FB                >   ei
    4990   00:BA43  01 BE 08            		ld bc,8*256+MSX_VDPDRW
    4991   00:BA46                      .ldirvm0:
    4992   00:BA46  ED A3               		outi
    4993   00:BA48  C2 46 BA            		jp nz,.ldirvm0		
    4994   00:BA4B  7B                  		ld a,e
    4995   00:BA4C  F3                  		di					; 5
    4996   00:BA4D  D3 BF               		out (MSX_VDPCW),a
    4997   00:BA4F  7A                  		ld a,d
    4998   00:BA50  F6 60               		or $60				; color patterns + write
    4999   00:BA52  FB                  		ei	
    5000   00:BA53  D3 BF               		out (MSX_VDPCW),a   ; (51)
    5001   00:BA55  06 08               		ld b,8
    5002   00:BA57                      .loop:
    5003   00:BA57  ED A3               		outi
    5004   00:BA59  C2 57 BA            		jp nz,.loop
    5005   00:BA5C                      pattrnxt:		
    5006   00:BA5C  21 56 40            		ld hl,dispy         ; x coordinate.
    5007   00:BA5F  34                  		inc (hl)            ; move along one.
    5008   00:BA60  C9                  		ret
    5009   00:BA61                      
    5010   00:BA61                      ;----------------------------------------------
    5011   00:BA61                      ; Write block
    5012   00:BA61                      ;----------------------------------------------
    5013   00:BA61                      
    5014   00:BA61                      		if AFLAG
    5015   00:BA61                    ~ wbloc:
    5016   00:BA61                    ~ 		ld de,(pblkptr)
    5017   00:BA61                    ~         ld hl,scno
    5018   00:BA61                    ~         ldi                ; write screen.
    5019   00:BA61                    ~         ld hl,dispx
    5020   00:BA61                    ~         ldi                ; write x position of block.
    5021   00:BA61                    ~         ldi                ; write y position of block.
    5022   00:BA61                    ~         ld (de),a          ; store block number
    5023   00:BA61                    ~         inc de
    5024   00:BA61                    ~ 		
    5025   00:BA61                    ~ 		ld (pblkptr),de
    5026   00:BA61                    ~         ret
    5027   00:BA61                    ~ 		endif
    5028   00:BA61                      	   
    5029   00:BA61                      ; Get room address.
    5030   00:BA61                      
    5031   00:BA61                      groom:
    5032   00:BA61  3A 42 40            		ld a,(scno)         ; screen number.
    5033   00:BA64                      groomx:
    5034   00:BA64  11 00 00            		ld de,0             ; start at zero.
    5035   00:BA67  2A E3 B0            		ld hl,(scrptr)      ; pointer to screens.
    5036   00:BA6A                      groom1:
    5037   00:BA6A  4E                  		ld c,(hl)           ; low byte of screen size.
    5038   00:BA6B  23                  		inc hl              ; point to high byte.
    5039   00:BA6C  46                  		ld b,(hl)           ; high byte of screen size.
    5040   00:BA6D  23                  		inc hl              ; next address.
    5041   00:BA6E  A7                  		and a               ; is it the first one?
    5042   00:BA6F  28 06               		jr z,groom0         ; no more screens to skip.
    5043   00:BA71  EB                  		ex de,hl            ; put total in hl, pointer in de.
    5044   00:BA72  09                  		add hl,bc           ; skip a screen.
    5045   00:BA73  EB                  		ex de,hl            ; put total in de, pointer in hl.
    5046   00:BA74  3D                  		dec a               ; one less iteration.
    5047   00:BA75  18 F3               		jr groom1           ; loop until we reach the end.
    5048   00:BA77                      groom0:
    5049   00:BA77  2A E3 B0            		ld hl,(scrptr)      ; pointer to screens.
    5050   00:BA7A  19                  		add hl,de           ; add displacement.
    5051   00:BA7B  3A 38 9C            		ld a,(numsc)        ; number of screens.
    5052   00:BA7E  16 00               		ld d,0              ; zeroise high byte.
    5053   00:BA80  5F                  		ld e,a              ; displacement in de.
    5054   00:BA81  19                  		add hl,de           ; add double displacement to address.
    5055   00:BA82  19                  		add hl,de
    5056   00:BA83  C9                  		ret
    5057   00:BA84                      
    5058   00:BA84                      ; Draw present room.
    5059   00:BA84                      
    5060   00:BA84                      droom:
    5061   00:BA84  3A 94 40            		ld a,(wintop)       ; window top.
    5062   00:BA87  32 55 40            		ld (dispx),a        ; set x coordinate.
    5063   00:BA8A                      droom2:
    5064   00:BA8A  2A DF B0            		ld hl,(blkptr)      ; blocks.
    5065   00:BA8D  22 3F 40            		ld (grbase),hl      ; set graphics base.
    5066   00:BA90  CD 61 BA            		call groom          ; get address of current room.
    5067   00:BA93                      
    5068   00:BA93  11 D5 42            		ld de,mapbuf
    5069   00:BA96  CD 58 C4            		call unpack
    5070   00:BA99                      		; call scunpack	
    5071   00:BA99                      		
    5072   00:BA99                      		
    5073   00:BA99  21 D5 42            		ld hl,mapbuf
    5074   00:BA9C  3A 96 40            		ld a,(winhgt)       ; height of window.
    5075   00:BA9F  4F                  		ld c,a
    5076   00:BAA0                      droom0:
    5077   00:BAA0  3A 95 40            		ld a,(winlft)       ; window left edge.
    5078   00:BAA3  32 56 40            		ld (dispy),a        ; set cursor position.
    5079   00:BAA6  3A 97 40            		ld a,(winwid)       ; width of window.
    5080   00:BAA9  47                  		ld b,a
    5081   00:BAAA                      droom1:
    5082   00:BAAA  C5                  		push bc             ; store column counter.
    5083   00:BAAB  7E                  		ld a,(hl)
    5084   00:BAAC  23                  		inc hl
    5085   00:BAAD  E5                  		push hl             ; store address of cell.
    5086   00:BAAE                      	if MBFLAG
    5087   00:BAAE                    ~ 		call drwmeta		; draw metablock
    5088   00:BAAE                    ~ 	else
    5089   00:BAAE  CD FE B9            		call pattr2
    5090   00:BAB1                      	endif
    5091   00:BAB1  E1                  		pop hl              ; restore cell address.
    5092   00:BAB2  C1                  		pop bc              ; restore loop counter.
    5093   00:BAB3  10 F5               		djnz droom1
    5094   00:BAB5  3A 55 40            		ld a,(dispx)        ; y coord.
    5095   00:BAB8  3C                  		inc a               ; move down one line.
    5096   00:BAB9                      	if MBFLAG
    5097   00:BAB9                    ~ 		inc a				; move down one line.
    5098   00:BAB9                    ~ 	endif		
    5099   00:BAB9  32 55 40            		ld (dispx),a        ; set new position.
    5100   00:BABC  0D                  		dec c
    5101   00:BABD  20 E1               		jr nz,droom0
    5102   00:BABF                      ;		jp enascreen
    5103   00:BABF  C9                  		ret
    5104   00:BAC0                      
    5105   00:BAC0                      /*
    5106   00:BAC0                    ~ ; HL = pointer to packed screen data
    5107   00:BAC0                    ~ ; BC = lenght of packed screen data
    5108   00:BAC0                    ~ scunpack:
    5109   00:BAC0                    ~ 		xor a               ; zero in accumulator.
    5110   00:BAC0                    ~ 		ld (comcnt),a       ; reset compression counter.	
    5111   00:BAC0                    ~ 		ex de,hl	
    5112   00:BAC0                    ~ 		ld bc,MAPSIZE		
    5113   00:BAC0                    ~ .nxtbyte:		
    5114   00:BAC0                    ~ 		ld a,(comcnt)       ; compression counter.
    5115   00:BAC0                    ~ 		and a               ; any more to decompress?
    5116   00:BAC0                    ~ 		jp nz,.flbyt1        ; yes.
    5117   00:BAC0                    ~ 		ld a,(de)           ; fetch next byte.
    5118   00:BAC0                    ~ 		inc de              ; point to next cell.
    5119   00:BAC0                    ~ 		cp 255              ; is this byte a control code?
    5120   00:BAC0                    ~ 		jp nz,.nocom         ; no, this byte is uncompressed.
    5121   00:BAC0                    ~ 		ld a,(de)           ; fetch byte type.
    5122   00:BAC0                    ~ 		ld (combyt),a       ; set up the type.
    5123   00:BAC0                    ~ 		inc de              ; point to quantity.
    5124   00:BAC0                    ~ 		ld a,(de)           ; get quantity.
    5125   00:BAC0                    ~ 		inc de              ; point to next byte.
    5126   00:BAC0                    ~ .flbyt1:
    5127   00:BAC0                    ~ 		dec a               ; one less.
    5128   00:BAC0                    ~ 		ld (comcnt),a       ; store new quantity.
    5129   00:BAC0                    ~ 		ld a,(combyt)       ; byte to expand.
    5130   00:BAC0                    ~ .nocom:
    5131   00:BAC0                    ~ 		ld (hl),a
    5132   00:BAC0                    ~ 		cpi
    5133   00:BAC0                    ~ 		jp pe,.nxtbyte
    5134   00:BAC0                    ~ 		ret
    5135   00:BAC0                    ~ */
    5136   00:BAC0                      	
    5137   00:BAC0                      ; ------------------------------------------------------------------------------------------------------------------------------------------
    5138   00:BAC0                      ; Drawing a MetaBlock (4 tiles 8x8 => 16x16)
    5139   00:BAC0                      ; param in regA tells the block number to use, if 0 use 0,0,0,0  else use 
    5140   00:BAC0                      ; N,N+2 
    5141   00:BAC0                      ; N+1,N+3
    5142   00:BAC0                      ; ------------------------------------------------------------------------------------------------------------------------------------------
    5143   00:BAC0                      	if MBFLAG
    5144   00:BAC0                    ~ drwmeta:
    5145   00:BAC0                    ~ 		ld b,2
    5146   00:BAC0                    ~ drwm01:
    5147   00:BAC0                    ~ 		push bc
    5148   00:BAC0                    ~ 		push af
    5149   00:BAC0                    ~ 		call pattr2		; put block N
    5150   00:BAC0                    ~ 		dec (hl)		; decrement X, back to start column
    5151   00:BAC0                    ~ 		dec hl
    5152   00:BAC0                    ~ 		inc (hl)		; increment y, next line
    5153   00:BAC0                    ~ 		pop af
    5154   00:BAC0                    ~ 		or a
    5155   00:BAC0                    ~ 		jr z, drwm02
    5156   00:BAC0                    ~ 		inc a			; put block N+1
    5157   00:BAC0                    ~ drwm02:
    5158   00:BAC0                    ~ 		push af
    5159   00:BAC0                    ~ 		call pattr2
    5160   00:BAC0                    ~ 		dec hl			
    5161   00:BAC0                    ~ 		dec (hl)		; decrement Y, back to start line
    5162   00:BAC0                    ~ 		pop af
    5163   00:BAC0                    ~ 		or a
    5164   00:BAC0                    ~ 		jr z,drwm03
    5165   00:BAC0                    ~ 		inc a			; put block N+2
    5166   00:BAC0                    ~ drwm03:
    5167   00:BAC0                    ~ 		pop bc
    5168   00:BAC0                    ~ 		djnz drwm01
    5169   00:BAC0                    ~ 		ret
    5170   00:BAC0                    ~ /*
    5171   00:BAC0                    ~ 
    5172   00:BAC0                    ~ drwmeta:
    5173   00:BAC0                    ~ 		ldb	#$02							; columns to be drawn
    5174   00:BAC0                    ~ 		pshs	b,a							; [,S]=block number - [1,S]=column counter
    5175   00:BAC0                    ~ DrwM01:	
    5176   00:BAC0                    ~ 		jsr	PAttr2						; print block number A at dispX,dispY
    5177   00:BAC0                    ~ 		inc	<dispY						; point to next line
    5178   00:BAC0                    ~ 		dec	<dispX						; back one column
    5179   00:BAC0                    ~ 		lda	,s								; get block number
    5180   00:BAC0                    ~ 		beq	DrwM02						; is zero?
    5181   00:BAC0                    ~ 		inca									; no, get next block number (for row two)
    5182   00:BAC0                    ~ 		sta	,s								; update stack variable
    5183   00:BAC0                    ~ DrwM02:	
    5184   00:BAC0                    ~ 		jsr	PAttr2						; print block number A at dispX,dispY
    5185   00:BAC0                    ~ 		dec	<dispY						; point to previous line, column is OK
    5186   00:BAC0                    ~ 		lda	,s								; get block number
    5187   00:BAC0                    ~ 		beq	DrwM03						; is zero?
    5188   00:BAC0                    ~ 		inca									; no, point to next block number: N+2
    5189   00:BAC0                    ~ 		sta	,s								; update stack variable
    5190   00:BAC0                    ~ DrwM03:	
    5191   00:BAC0                    ~ 		dec	1,s							; decrement column counter in stack
    5192   00:BAC0                    ~ 		bne	DrwM01						; if not zero, loop for next Column
    5193   00:BAC0                    ~ 		puls	a,b,pc						; clean stack and return
    5194   00:BAC0                    ~ */
    5195   00:BAC0                    ~ 
    5196   00:BAC0                    ~ 	endif
    5197   00:BAC0                      	
    5198   00:BAC0                      	if LFLAG
    5199   00:BAC0                    ~ 	
    5200   00:BAC0                    ~ ; Ladder down check.
    5201   00:BAC0                    ~ 
    5202   00:BAC0                    ~ laddd:
    5203   00:BAC0                    ~ 		ld l,16
    5204   00:BAC0                    ~ 		jr ladd
    5205   00:BAC0                    ~ 
    5206   00:BAC0                    ~ ; Ladder up check.
    5207   00:BAC0                    ~ 
    5208   00:BAC0                    ~ laddu:
    5209   00:BAC0                    ~ 		ld l,15
    5210   00:BAC0                    ~ ladd:
    5211   00:BAC0                    ~ 		ld a,(ix+3)         ; y coordinate.
    5212   00:BAC0                    ~ 		ld h,(ix+4)         ; x coordinate.
    5213   00:BAC0                    ~ 		add a,l            ; look 2 pixels above feet.
    5214   00:BAC0                    ~ 		ld l,a              ; coords in hl.
    5215   00:BAC0                    ~ 
    5216   00:BAC0                    ~ laddv:
    5217   00:BAC0                    ~ 		ld (dispx),hl       ; set up test coordinates.
    5218   00:BAC0                    ~ 		call tstbl          ; get map address.
    5219   00:BAC0                    ~ 		call ldchk          ; standard ladder check.
    5220   00:BAC0                    ~ 		ret nz              ; no way through.
    5221   00:BAC0                    ~ 		inc hl              ; look right one cell.
    5222   00:BAC0                    ~ 		call ldchk          ; do the check.
    5223   00:BAC0                    ~ 		ret nz              ; impassable.
    5224   00:BAC0                    ~ 		ld a,(dispy)        ; y coordinate.
    5225   00:BAC0                    ~ 		and 7               ; position straddling block cells.
    5226   00:BAC0                    ~ 		ret z               ; no more checks needed.
    5227   00:BAC0                    ~ 		inc hl              ; look to third cell.
    5228   00:BAC0                    ~ 	
    5229   00:BAC0                    ~ ; Check ladder is available.
    5230   00:BAC0                    ~ 
    5231   00:BAC0                    ~ ldchk:
    5232   00:BAC0                    ~ 		ld a,(hl)           ; fetch cell.
    5233   00:BAC0                    ~ 		cp LADDER           ; is it a ladder?
    5234   00:BAC0                    ~ 		ret                 ; return with zero flag set accordingly.
    5235   00:BAC0                    ~ 
    5236   00:BAC0                    ~ 	endif
    5237   00:BAC0                      	
    5238   00:BAC0                      ; Can go up check.
    5239   00:BAC0                      
    5240   00:BAC0                      cangu:
    5241   00:BAC0  DD 7E 03            		ld a,(ix+3)         ; y coordinate.
    5242   00:BAC3  DD 66 04            		ld h,(ix+4)         ; x coordinate.
    5243   00:BAC6  D6 01               		sub 1               ; look up 1 pixels.
    5244   00:BAC8  6F                  		ld l,a              ; coords in hl.
    5245   00:BAC9  22 55 40            		ld (dispx),hl       ; set up test coordinates.
    5246   00:BACC  CD 9C BB            		call tstbl          ; get map address.
    5247   00:BACF  CD 46 BB            		call lrchk          ; standard left/right check.
    5248   00:BAD2  C0                  		ret nz              ; no way through.
    5249   00:BAD3  23                  		inc hl              ; look right one cell.
    5250   00:BAD4  CD 46 BB            		call lrchk          ; do the check.
    5251   00:BAD7  C0                  		ret nz              ; impassable.
    5252   00:BAD8  3A 56 40            		ld a,(dispy)        ; y coordinate.
    5253   00:BADB  E6 07               		and 7               ; position straddling block cells.
    5254   00:BADD  C8                  		ret z               ; no more checks needed.
    5255   00:BADE  23                  		inc hl              ; look to third cell.
    5256   00:BADF  C3 46 BB            		jp lrchk          ; do the check.
    5257   00:BAE2                      
    5258   00:BAE2                      ; Can go down check.
    5259   00:BAE2                      
    5260   00:BAE2                      cangd:
    5261   00:BAE2  DD 7E 03            		ld a,(ix+3)         ; y coordinate.
    5262   00:BAE5  DD 66 04            		ld h,(ix+4)         ; x coordinate.
    5263   00:BAE8                      numsp3:
    5264   00:BAE8  C6 10               		add a,16            ; look down 16 pixels.
    5265   00:BAEA  6F                  		ld l,a              ; coords in hl.
    5266   00:BAEB  22 55 40            		ld (dispx),hl       ; set up test coordinates.
    5267   00:BAEE  CD 9C BB            		call tstbl          ; get map address.
    5268   00:BAF1  CD 01 BB            		call plchk          ; block, platform check.
    5269   00:BAF4  C0                  		ret nz              ; no way through.
    5270   00:BAF5  23                  		inc hl              ; look right one cell.
    5271   00:BAF6  CD 01 BB            		call plchk          ; block, platform check.
    5272   00:BAF9  C0                  		ret nz              ; impassable.
    5273   00:BAFA  3A 56 40            		ld a,(dispy)        ; y coordinate.
    5274   00:BAFD  E6 07               		and 7               ; position straddling block cells.
    5275   00:BAFF  C8                  		ret z               ; no more checks needed.
    5276   00:BB00  23                  		inc hl              ; look to third cell.
    5277   00:BB01                      
    5278   00:BB01                      ; Check platform or solid item is not in way.
    5279   00:BB01                      
    5280   00:BB01                      plchk:
    5281   00:BB01  7E                  		ld a,(hl)           ; fetch map cell.
    5282   00:BB02  FE 02               		cp WALL             ; is it passable?
    5283   00:BB04  28 4B               		jr z,lrchkx         ; no.
    5284   00:BB06                      	if (PFLAG or DFLAG)
    5285   00:BB06  FE 04               		cp FODDER           ; fodder has to be dug.
    5286   00:BB08  28 47               		jr z,lrchkx         ; not passable.
    5287   00:BB0A                      	endif
    5288   00:BB0A  FE 01               		cp PLATFM           ; platform is solid.
    5289   00:BB0C  28 02               		jr z,plchkx         ; not passable.
    5290   00:BB0E                      	if LFLAG
    5291   00:BB0E                    ~ 		cp LADDER           ; is it a ladder?
    5292   00:BB0E                    ~ 		jr z,lrchkx         ; on ladder, deny movement.
    5293   00:BB0E                    ~ 	endif
    5294   00:BB0E                      plchk0:
    5295   00:BB0E  AF                  		xor a               ; report it as okay.
    5296   00:BB0F  C9                  		ret
    5297   00:BB10                      plchkx:
    5298   00:BB10  3A 55 40            		ld a,(dispx)        ; x coordinate.
    5299   00:BB13  E6 07               		and 7               ; position straddling blocks.
    5300   00:BB15  28 3A               		jr z,lrchkx         ; on platform, deny movement.
    5301   00:BB17  18 F5               		jr plchk0
    5302   00:BB19                      
    5303   00:BB19                      
    5304   00:BB19                      ; Can go left check.
    5305   00:BB19                      
    5306   00:BB19                      cangl:
    5307   00:BB19  DD 6E 03            		ld l,(ix+3)         ; y coordinate.
    5308   00:BB1C  DD 7E 04            		ld a,(ix+4)         ; x coordinate.
    5309   00:BB1F  D6 01               		sub 1               ; look left 1 pixels.
    5310   00:BB21  67                  		ld h,a              ; coords in hl.
    5311   00:BB22  18 09               		jr cangh            ; test if we can go there.
    5312   00:BB24                      
    5313   00:BB24                      ; Can go right check.
    5314   00:BB24                      
    5315   00:BB24                      cangr:
    5316   00:BB24  DD 6E 03            		ld l,(ix+3)         ; y coordinate.
    5317   00:BB27  DD 7E 04            		ld a,(ix+4)         ; x coordinate.
    5318   00:BB2A  C6 10               		add a,16            ; look right 16 pixels.
    5319   00:BB2C  67                  		ld h,a              ; coords in hl.
    5320   00:BB2D                      
    5321   00:BB2D                      cangh:
    5322   00:BB2D  22 55 40            		ld (dispx),hl       ; set up test coordinates.
    5323   00:BB30                      cangh2:
    5324   00:BB30  06 03               		ld b,3              ; default rows to write.
    5325   00:BB32  7D                  		ld a,l              ; x position.
    5326   00:BB33  E6 07               		and 7               ; does x straddle cells?
    5327   00:BB35  20 01               		jr nz,cangh0        ; yes, loop counter is good.
    5328   00:BB37  05                  		dec b               ; one less row to write.
    5329   00:BB38                      cangh0:
    5330   00:BB38  CD 9C BB            		call tstbl          ; get map address.
    5331   00:BB3B  11 20 00            		ld de,MSX_MAXCOLS      ; distance to next cell.
    5332   00:BB3E                      cangh1:
    5333   00:BB3E  CD 46 BB            		call lrchk          ; standard left/right check.
    5334   00:BB41  C0                  		ret nz              ; no way through.
    5335   00:BB42  19                  		add hl,de           ; look down.
    5336   00:BB43  10 F9               		djnz cangh1
    5337   00:BB45  C9                  		ret
    5338   00:BB46                      
    5339   00:BB46                      ; Check left/right movement is okay.
    5340   00:BB46                      
    5341   00:BB46                      lrchk:
    5342   00:BB46  7E                  		ld a,(hl)           ; fetch map cell.
    5343   00:BB47  FE 02               		cp WALL             ; is it passable?
    5344   00:BB49  28 06               		jr z,lrchkx         ; no.
    5345   00:BB4B  FE 04               		cp FODDER           ; fodder has to be dug.
    5346   00:BB4D  28 02               		jr z,lrchkx         ; not passable.
    5347   00:BB4F                      always:
    5348   00:BB4F  AF                  		xor a               ; report it as okay.
    5349   00:BB50  C9                  		ret
    5350   00:BB51                      lrchkx:
    5351   00:BB51  AF                  		xor a               ; reset all bits.
    5352   00:BB52  3C                  		inc a
    5353   00:BB53  C9                  		ret
    5354   00:BB54                      
    5355   00:BB54                      	
    5356   00:BB54                      	if CFLAG
    5357   00:BB54                    ~ 	
    5358   00:BB54                    ~ ; Get collectables.
    5359   00:BB54                    ~ 
    5360   00:BB54                    ~ getcol:
    5361   00:BB54                    ~ 		ld b,COLECT         ; collectable blocks.
    5362   00:BB54                    ~ 		call tded           ; test for collectable blocks.
    5363   00:BB54                    ~ 		cp b                ; did we find one?
    5364   00:BB54                    ~ 		ret nz              ; none were found, job done.
    5365   00:BB54                    ~ 		call gtblk          ; get block.
    5366   00:BB54                    ~ 		call evnt20         ; collected block event.
    5367   00:BB54                    ~ 		jr getcol           ; repeat until none left.
    5368   00:BB54                    ~ 
    5369   00:BB54                    ~ ; Get collectable block.
    5370   00:BB54                    ~ 
    5371   00:BB54                    ~ gtblk:
    5372   00:BB54                    ~ 		ld (hl),0           ; make it empty now.
    5373   00:BB54                    ~ 		ld de,MAP           ; map address.
    5374   00:BB54                    ~ 		and a               ; clear carry.
    5375   00:BB54                    ~ 		sbc hl,de           ; find cell number.
    5376   00:BB54                    ~ 		ld a,l              ; get low byte of cell number.
    5377   00:BB54                    ~ 		and MSX_MAXCOLS-1   ; 0 - 31 is column.
    5378   00:BB54                    ~ 		ld d,a              ; store y in d register.
    5379   00:BB54                    ~ 		add hl,hl           ; multiply by 8.
    5380   00:BB54                    ~ 		add hl,hl
    5381   00:BB54                    ~ 		add hl,hl           ; x is now in h.
    5382   00:BB54                    ~ 		ld e,h              ; put x in e.
    5383   00:BB54                    ~ 		ld (dispx),de       ; set display coordinates.
    5384   00:BB54                    ~ 		ld hl,(blkptr)      ; blocks.
    5385   00:BB54                    ~ 		ld (grbase),hl      ; set graphics base.
    5386   00:BB54                    ~ 		xor a
    5387   00:BB54                    ~ 		jp pchr
    5388   00:BB54                    ~ 
    5389   00:BB54                    ~ 	endif
    5390   00:BB54                      	
    5391   00:BB54                      ; Touched deadly block check.
    5392   00:BB54                      ; Returns with DEADLY (must be non-zero) in accumulator if true.
    5393   00:BB54                      
    5394   00:BB54                      tded:
    5395   00:BB54  DD 6E 03            		ld l,(ix+3)         ; x coordinate.
    5396   00:BB57  DD 66 04            		ld h,(ix+4)         ; y coordinate.
    5397   00:BB5A  22 55 40            		ld (dispx),hl       ; set up test coordinates.
    5398   00:BB5D  CD 9C BB            		call tstbl          ; get map address.
    5399   00:BB60  11 1F 00            		ld de,MSX_MAXCOLS-1 ; default distance to next line down.
    5400   00:BB63  B8                  		cp b                ; is this the required block?
    5401   00:BB64  C8                  		ret z               ; yes.
    5402   00:BB65  23                  		inc hl              ; next cell.
    5403   00:BB66  7E                  		ld a,(hl)           ; fetch type.
    5404   00:BB67  B8                  		cp b                ; is this deadly/custom?
    5405   00:BB68  C8                  		ret z               ; yes.
    5406   00:BB69  3A 56 40            		ld a,(dispy)        ; horizontal position.
    5407   00:BB6C  4F                  		ld c,a              ; store column in c register.
    5408   00:BB6D  E6 07               		and 7               ; is it straddling cells?
    5409   00:BB6F  28 05               		jr z,.tded0          ; no.
    5410   00:BB71  23                  		inc hl              ; last cell.
    5411   00:BB72  7E                  		ld a,(hl)           ; fetch type.
    5412   00:BB73  B8                  		cp b                ; is this the block?
    5413   00:BB74  C8                  		ret z               ; yes.
    5414   00:BB75  1B                  		dec de              ; one less cell to next row down.
    5415   00:BB76                      .tded0:  
    5416   00:BB76  19                  		add hl,de           ; point to next row.
    5417   00:BB77  7E                  		ld a,(hl)           ; fetch left cell block.
    5418   00:BB78  B8                  		cp b                ; is this fatal?
    5419   00:BB79  C8                  		ret z               ; yes.
    5420   00:BB7A  23                  		inc hl              ; next cell.
    5421   00:BB7B  7E                  		ld a,(hl)           ; fetch type.
    5422   00:BB7C  B8                  		cp b                ; is this fatal?
    5423   00:BB7D  C8                  		ret z               ; yes.
    5424   00:BB7E  79                  		ld a,c              ; horizontal position.
    5425   00:BB7F  E6 07               		and 7               ; is it straddling cells?
    5426   00:BB81  28 04               		jr z,.tded1          ; no.
    5427   00:BB83  23                  		inc hl              ; last cell.
    5428   00:BB84  7E                  		ld a,(hl)           ; fetch type.
    5429   00:BB85  B8                  		cp b                ; is this fatal?
    5430   00:BB86  C8                  		ret z               ; yes.
    5431   00:BB87                      .tded1:
    5432   00:BB87  3A 55 40            		ld a,(dispx)        ; vertical position.
    5433   00:BB8A  E6 07               		and 7               ; is it straddling cells?
    5434   00:BB8C  C8                  		ret z               ; no, job done.
    5435   00:BB8D  19                  		add hl,de           ; point to next row.
    5436   00:BB8E  7E                  		ld a,(hl)           ; fetch left cell block.
    5437   00:BB8F  B8                  		cp b                ; is this fatal?
    5438   00:BB90  C8                  		ret z               ; yes.
    5439   00:BB91  23                  		inc hl              ; next cell.
    5440   00:BB92  7E                  		ld a,(hl)           ; fetch type.
    5441   00:BB93  B8                  		cp b                ; is this fatal?
    5442   00:BB94  C8                  		ret z               ; yes.
    5443   00:BB95  79                  		ld a,c              ; horizontal position.
    5444   00:BB96  E6 07               		and 7               ; is it straddling cells?
    5445   00:BB98  C8                  		ret z               ; no.
    5446   00:BB99  23                  		inc hl              ; last cell.
    5447   00:BB9A  7E                  		ld a,(hl)           ; fetch final type.
    5448   00:BB9B  C9                  		ret                 ; return with final type in accumulator.
    5449   00:BB9C                      
    5450   00:BB9C                      
    5451   00:BB9C                      ; Fetch block type at (dispx, dispy).
    5452   00:BB9C                      ; Input:
    5453   00:BB9C                      ; 	dispx = Y coord (0-191)
    5454   00:BB9C                      ; 	dispy = X coord (0-255)
    5455   00:BB9C                      ; Output:
    5456   00:BB9C                      ;	A = block code at (dispx, dispy)
    5457   00:BB9C                      ; Modifies:
    5458   00:BB9C                      ;	A,HL
    5459   00:BB9C                      tstbl:
    5460   00:BB9C  3A 55 40            		ld a,(dispx)        ; fetch y coord.
    5461   00:BB9F  07                  		rlca                ; divide by 8,
    5462   00:BBA0  07                  		rlca                ; and multiply by 32.
    5463   00:BBA1  67                  		ld h,a              ; store in d.
    5464   00:BBA2  E6 E0               		and $E0             ; mask off high bits.
    5465   00:BBA4  6F                  		ld l,a              ; low byte.
    5466   00:BBA5  7C                  		ld a,h              ; restore shift result.
    5467   00:BBA6  E6 03               		and 3               ; high bits.
    5468   00:BBA8  C6 46               		add a,MAP>>8
    5469   00:BBAA  67                  		ld h,a              ; got displacement in de.
    5470   00:BBAB  3A 56 40            		ld a,(dispy)        ; x coord.
    5471   00:BBAE  1F                  		rra                 ; divide by 8.
    5472   00:BBAF  1F                  		rra
    5473   00:BBB0  1F                  		rra
    5474   00:BBB1  E6 1F               		and 31              ; only want 0 - 31.
    5475   00:BBB3  85                  		add a,l             ; add to displacement.
    5476   00:BBB4  6F                  		ld l,a              ; displacement in hl.
    5477   00:BBB5  7E                  		ld a,(hl)           ; fetch byte there.
    5478   00:BBB6  C9                  		ret
    5479   00:BBB7                      
    5480   00:BBB7                      
    5481   00:BBB7                      ; Jump - if we can.
    5482   00:BBB7                      ; Requires initial speed to be set up in accumulator prior to call.
    5483   00:BBB7                      
    5484   00:BBB7                      jump:
    5485   00:BBB7  ED 44               		neg                 ; switch sign so we jump up.
    5486   00:BBB9  4F                  		ld c,a              ; store in c register.
    5487   00:BBBA                      jump0:
    5488   00:BBBA  DD 7E 0D            		ld a,(ix+13)        ; jumping flag.
    5489   00:BBBD  A7                  		and a               ; is it set?
    5490   00:BBBE  C0                  		ret nz              ; already in the air.
    5491   00:BBBF  DD 34 0D            		inc (ix+13)         ; set it.
    5492   00:BBC2  DD 71 0E            		ld (ix+14),c        ; set jump height.
    5493   00:BBC5  C9                  		ret
    5494   00:BBC6                      
    5495   00:BBC6                      hop:   
    5496   00:BBC6  DD 7E 0D            		ld a,(ix+13)        ; jumping flag.
    5497   00:BBC9  A7                  		and a               ; is it set?
    5498   00:BBCA  C0                  		ret nz              ; already in the air.
    5499   00:BBCB  DD 36 0D FF         		ld (ix+13),255      ; set it.
    5500   00:BBCF  DD 36 0E 00         		ld (ix+14),0        ; set jump table displacement.
    5501   00:BBD3  C9                  		ret
    5502   00:BBD4                      
    5503   00:BBD4                      ; Random numbers code.
    5504   00:BBD4                      ; Pseudo-random number generator, 8-bit.
    5505   00:BBD4                      
    5506   00:BBD4                      random:
    5507   00:BBD4  21 3E 40            		ld hl,seed          ; set up seed pointer.
    5508   00:BBD7  7E                  		ld a,(hl)           ; get last random number.
    5509   00:BBD8  47                  		ld b,a              ; copy to b register.
    5510   00:BBD9  0F                  		rrca                ; multiply by 32.
    5511   00:BBDA  0F                  		rrca
    5512   00:BBDB  0F                  		rrca
    5513   00:BBDC  EE 1F               		xor 31
    5514   00:BBDE  80                  		add a,b
    5515   00:BBDF  DE FF               		sbc a,255
    5516   00:BBE1  77                  		ld (hl),a           ; store new seed.
    5517   00:BBE2  32 57 40            		ld (varrnd),a       ; return number in variable.
    5518   00:BBE5  C9                  		ret
    5519   00:BBE6                      
    5520   00:BBE6                      ; Keyboard test routine. (returns NC if pressed)
    5521   00:BBE6                      ;
    5522   00:BBE6                      ; Checks if a key is pressed
    5523   00:BBE6                      ;
    5524   00:BBE6                      ; Input:	A=offset
    5525   00:BBE6                      ;		D=mask
    5526   00:BBE6                      ; Output:	Carry=1 if key not pressed
    5527   00:BBE6                      ;		Carry=0 if key is pressed
    5528   00:BBE6                      ; Modifies:	A,C
    5529   00:BBE6                      ;
    5530   00:BBE6                      ktest:
    5531   00:BBE6  C5                  	push bc
    5532   00:BBE7  E5                  	push hl
    5533   00:BBE8  01 00 00            	ld bc,0
    5534   00:BBEB  4A                  	ld c,d
    5535   00:BBEC  21 98 40            	ld hl,CONTROLLER_BUFFER
    5536   00:BBEF  09                  	add hl,bc
    5537   00:BBF0  BE                  	cp (hl)
    5538   00:BBF1  28 04               	jr z,keypressed
    5539   00:BBF3  E1                  	pop hl
    5540   00:BBF4  C1                  	pop bc
    5541   00:BBF5  37                  	scf
    5542   00:BBF6  C9                  	ret
    5543   00:BBF7                      keypressed:
    5544   00:BBF7  E1                  	pop hl
    5545   00:BBF8  C1                  	pop bc
    5546   00:BBF9  A7                  	and a
    5547   00:BBFA  C9                  	ret	
    5548   00:BBFB                      
    5549   00:BBFB                      jtest:
    5550   00:BBFB  C5                  	push bc
    5551   00:BBFC  E5                  	push hl
    5552   00:BBFD  01 00 00            	ld bc,0
    5553   00:BC00  4A                  	ld c,d
    5554   00:BC01  21 98 40            	ld hl,CONTROLLER_BUFFER
    5555   00:BC04  09                  	add hl,bc
    5556   00:BC05  A6                  	and (hl)
    5557   00:BC06  20 04               	jr nz,jkeypressed
    5558   00:BC08  E1                  	pop hl
    5559   00:BC09  C1                  	pop bc
    5560   00:BC0A  37                  	scf
    5561   00:BC0B  C9                  	ret
    5562   00:BC0C                      jkeypressed:
    5563   00:BC0C  E1                  	pop hl
    5564   00:BC0D  C1                  	pop bc
    5565   00:BC0E  A7                  	and a
    5566   00:BC0F  C9                  	ret	
    5567   00:BC10                      
    5568   00:BC10                      ;		call MSX_SNSMAT
    5569   00:BC10                      ;		and d
    5570   00:BC10                      ;		ret z
    5571   00:BC10                      ;		scf					; sets C, key NOT pressed
    5572   00:BC10                      ;		ret
    5573   00:BC10                      ;
    5574   00:BC10                      ;chkselect:
    5575   00:BC10                      ;		ld a,(select)
    5576   00:BC10                      ;		or a
    5577   00:BC10                      ;		jr z,.chghz
    5578   00:BC10                      ;		dec a
    5579   00:BC10                      ;		ld (select),a
    5580   00:BC10                      ;		ret nz
    5581   00:BC10                      ;.chghz:
    5582   00:BC10                      ;		bit 6,e
    5583   00:BC10                      ;		ret nz
    5584   00:BC10                      ;		; SELECT key pressed
    5585   00:BC10                      ;		call swaphz
    5586   00:BC10                      ;		; falls through setticks
    5587   00:BC10                      		
    5588   00:BC10                      ; Sets the number of frames/sec. based on PAL/NTSC setting
    5589   00:BC10                      ; Input:
    5590   00:BC10                      ;	A = (RG9SAV)
    5591   00:BC10                      ; Output:
    5592   00:BC10                      ;	(TICKS) = 50/60
    5593   00:BC10                      ;   (SELECT) = 50/60
    5594   00:BC10                      ;setticks:
    5595   00:BC10                      ;		and 2
    5596   00:BC10                      ;		ld a,50
    5597   00:BC10                      ;		jr nz,.itspal
    5598   00:BC10                      ;		ld a,60
    5599   00:BC10                      ;.itspal:
    5600   00:BC10                      ;		ld (ticks),a
    5601   00:BC10                      ;		ld (select),a
    5602   00:BC10                      ;		ret
    5603   00:BC10                      ;		
    5604   00:BC10                      ;
    5605   00:BC10                      ; Check if STOP key is pressed
    5606   00:BC10                      ;		
    5607   00:BC10                      ;stopselect:
    5608   00:BC10                      ;		ld a,7
    5609   00:BC10                      ;		call MSX_SNSMAT
    5610   00:BC10                      ;		ld e,a
    5611   00:BC10                      ;	ifdef NOBIOS
    5612   00:BC10                      ;		ld a,(biosvars+MSX_MSXVER)      	; version del MSX
    5613   00:BC10                      ;	else
    5614   00:BC10                      ;		ld a,(MSX_MSXVER)      	; version del MSX
    5615   00:BC10                      ;	endif		
    5616   00:BC10                      ;		or a
    5617   00:BC10                      ;		; push de
    5618   00:BC10                      ;		call nz,chkselect
    5619   00:BC10                      ;		; pop de
    5620   00:BC10                      ;		bit 4,e
    5621   00:BC10                      ;		ret nz
    5622   00:BC10                      ;.loop1
    5623   00:BC10                      ;		ld a,7
    5624   00:BC10                      ;		call MSX_SNSMAT
    5625   00:BC10                      ;		and $10
    5626   00:BC10                      ;		jr z,.loop1
    5627   00:BC10                      ;
    5628   00:BC10                      ;.loop2
    5629   00:BC10                      ;		ld a,7
    5630   00:BC10                      ;		call MSX_SNSMAT
    5631   00:BC10                      ;		and $10
    5632   00:BC10                      ;		jr nz,.loop2
    5633   00:BC10                      ;.loop3
    5634   00:BC10                      ;		ld a,7
    5635   00:BC10                      ;		call MSX_SNSMAT
    5636   00:BC10                      ;		and $10
    5637   00:BC10                      ;		jr z,.loop3
    5638   00:BC10                      ;		ret
    5639   00:BC10                      	
    5640   00:BC10                      ; Joystick and keyboard reading routines.
    5641   00:BC10                      ; A/E/joyval = result bits: 0,fire3,fire2,fire,up,down,left,right
    5642   00:BC10                      
    5643   00:BC10                      joykey:
    5644   00:BC10                      ;		call stopselect
    5645   00:BC10                      
    5646   00:BC10                      		ifdef DEBUG
    5647   00:BC10                    ~ 		BORDER 7
    5648   00:BC10                    ~ 		endif
    5649   00:BC10                      
    5650   00:BC10  3A 34 40            		ld a,(contrl)       ; control flag.
    5651   00:BC13  3D                  		dec a               ; is it the keyboard?
    5652   00:BC14  28 08               		jr z,joyjoy1        ; no, it's joystick 1
    5653   00:BC16  3D                  		dec a               ; joystick 2?
    5654   00:BC17  28 0A               		jr z,joyjoy2        ; read joystick 2
    5655   00:BC19                      
    5656   00:BC19                      ; Control was keyboard (CONTROL=0)
    5657   00:BC19                      
    5658   00:BC19  21 8B 40            		ld hl,keys+13       ; address of last key.
    5659   00:BC1C  18 08               		jr readkeys
    5660   00:BC1E                      
    5661   00:BC1E                      ; Control was joystick 1 (CONTROL=1)
    5662   00:BC1E                      
    5663   00:BC1E                      joyjoy1:
    5664   00:BC1E  21 48 BC            		ld hl,joykey1+13    ; address of last key.
    5665   00:BC21  18 03               		jr readkeys
    5666   00:BC23                      
    5667   00:BC23                      ; Control was joystick 2 (CONTROL=2)
    5668   00:BC23                      
    5669   00:BC23                      joyjoy2:
    5670   00:BC23  21 56 BC            		ld hl,joykey2+13    ; address of last key.
    5671   00:BC26                      
    5672   00:BC26                      readkeys:
    5673   00:BC26  1E 00               		ld e,0              ; zero reading.
    5674   00:BC28  06 07               		ld b,7              ; keys to read.
    5675   00:BC2A                      .loop:
    5676   00:BC2A  56                  		ld d,(hl)           ; get key from table.
    5677   00:BC2B  2B                  		dec hl
    5678   00:BC2C  7E                  		ld a,(hl)	    ; get row
    5679   00:BC2D  2B                  		dec hl
    5680   00:BC2E  CD FB BB            		call jtest
    5681   00:BC31  3F                  		ccf                 ; complement the result (0=not pressed,1=pressed).
    5682   00:BC32  CB 13               		rl e                ; rotate into reading.
    5683   00:BC34  10 F4               		djnz .loop          ; repeat for all keys.
    5684   00:BC36                      
    5685   00:BC36  7B                  		ld a,e              ; copy e register to accumulator.
    5686   00:BC37  32 41 40            		ld (joyval),a       ; remember value.
    5687   00:BC3A                      
    5688   00:BC3A                      		ifdef DEBUG
    5689   00:BC3A                    ~ 		BORDER 14
    5690   00:BC3A                    ~ 		endif
    5691   00:BC3A                      
    5692   00:BC3A  C9                  		ret
    5693   00:BC3B                      
    5694   00:BC3B                      joykey1:
    5695   00:BC3B                      	dw $0302,$0308,$0304,$0301	; Direction buttons
    5695   00:BC3B  02 03 08 03 04 03 01 03 
    5696   00:BC43  40 02 40 05 0B 06   	dw $0240,$0540,$060b		; Fire buttons
    5697   00:BC49                      
    5698   00:BC49                      joykey2:
    5699   00:BC49                      	dw $0802,$0808,$0804,$0801	; Direction buttons
    5699   00:BC49  02 08 08 08 04 08 01 08 
    5700   00:BC51  40 07 40 0A 0B 0B   	dw $0740,$0a40,$0b0b		; Fire buttons
    5701   00:BC57                      
    5702   00:BC57                      
    5703   00:BC57                      ; Display message.
    5704   00:BC57                      
    5705   00:BC57                      dmsg:	
    5706   00:BC57  21 44 8B            		ld hl,msgdat        ; pointer to messages.
    5707   00:BC5A  CD C7 BD            		call getwrd         ; get message number.
    5708   00:BC5D                      dmsg3:
    5709   00:BC5D  CD B7 BD            		call preprt         ; pre-printing stuff.
    5710   00:BC60  CD C7 B8            		call checkx         ; make sure we're in a printable range.
    5711   00:BC63                      		
    5712   00:BC63  EB                  		ex de,hl
    5713   00:BC64  CD 92 B9            		call pradd			; find scrmap pointer from dispx,dispy
    5714   00:BC67  E5                  		push hl				; preserves buffer pointer
    5715   00:BC68  EB                  		ex de,hl
    5716   00:BC69  E5                  		push hl				; preserves start of string
    5717   00:BC6A                      		
    5718   00:BC6A  3A 38 40            		ld a,(prtmod)       ; print mode.
    5719   00:BC6D  A7                  		and a               ; standard size?
    5720   00:BC6E  C2 E2 BC            		jp nz,bmsg1         ; no, double-height text.
    5721   00:BC71                      dmsg0:	
    5722   00:BC71  E5                  		push hl             ; store string pointer.
    5723   00:BC72  7E                  		ld a,(hl)           ; fetch byte to display.
    5724   00:BC73  E6 7F               		and 127             ; remove any end marker.
    5725   00:BC75  FE 0D               		cp 13               ; newline character?
    5726   00:BC77  28 59               		jr z,dmsg1
    5727   00:BC79  CD C6 B9            		call ptxt           ; display character.		
    5728   00:BC7C                      		
    5729   00:BC7C  CD A5 BD            		call nexpos         ; display position.
    5730   00:BC7F  20 03               		jr nz,dmsg2         ; not on a new line.
    5731   00:BC81                      		
    5732   00:BC81  CD AF BD            		call nexlin         ; next line down.
    5733   00:BC84                      dmsg2:	
    5734   00:BC84  E1                  		pop hl				
    5735   00:BC85  7E                  		ld a,(hl)           ; fetch last character.
    5736   00:BC86  17                  		rla                 ; was it the end?
    5737   00:BC87  D2 CE BC            		jp nc,.nxtchr
    5738   00:BC8A                      
    5739   00:BC8A  D1                  		pop de				; restores start of string
    5740   00:BC8B  B7                  		or a
    5741   00:BC8C  ED 52               		sbc hl,de			
    5742   00:BC8E  20 0A               		jr nz,.btzero
    5743   00:BC90  21 00 4A            		ld hl,scrmap
    5744   00:BC93  D1                  		pop de				; restores scrmap buffer pointer
    5745   00:BC94  19                  		add hl,de			; start of string in scrmap
    5746   00:BC95  36 FF               		ld (hl),255                     ; mark as dirty in scrmap
    5747   00:BC97  C3 EF B8            		jp dscor2
    5748   00:BC9A                      .btzero:
    5749   00:BC9A                      
    5750   00:BC9A  44                  		ld b,h
    5751   00:BC9B  4D                  		ld c,l				; get string lenght in BC
    5752   00:BC9C  D1                  		pop de				; restores scrmap buffer pointer
    5753   00:BC9D  19                  		add hl,de
    5754   00:BC9E  7C                  		ld a,h
    5755   00:BC9F  FE 03               		cp 3				; check if end of string is higher than length of map
    5756   00:BCA1  30 0E               		jr nc,.wrapped
    5757   00:BCA3                      .strseg:
    5758   00:BCA3  21 00 4A            		ld hl,scrmap
    5759   00:BCA6  19                  		add hl,de			; start of string in scrmap
    5760   00:BCA7  54                  		ld d,h
    5761   00:BCA8  5D                  		ld e,l
    5762   00:BCA9  1C                  		inc e
    5763   00:BCAA  36 FF               		ld (hl),255                     ; mark as dirty in scrmap
    5764   00:BCAC  ED B0               		ldir		
    5765   00:BCAE  C3 EF B8            		jp dscor2         	; job done.
    5766   00:BCB1                      .wrapped:	; half of the message is in the bottom and the rest wraps to coord 0,0
    5767   00:BCB1                      		; upper segment
    5768   00:BCB1  7D                  		ld a,l
    5769   00:BCB2  B7                  		or a
    5770   00:BCB3  28 11               		jr z,.bottom
    5771   00:BCB5  E5                  		push hl
    5772   00:BCB6  D5                  		push de
    5773   00:BCB7  C5                  		push bc
    5774   00:BCB8  4D                  		ld c,l
    5775   00:BCB9  21 00 4A            		ld hl,scrmap
    5776   00:BCBC  11 01 4A            		ld de,scrmap+1
    5777   00:BCBF  36 FF               		ld (hl),255                     ; mark as dirty in scrmap
    5778   00:BCC1  ED B0               		ldir	
    5779   00:BCC3  C1                  		pop bc
    5780   00:BCC4  D1                  		pop de
    5781   00:BCC5  E1                  		pop hl
    5782   00:BCC6                      .bottom:
    5783   00:BCC6                      		; bottom segment
    5784   00:BCC6  79                  		ld a,c
    5785   00:BCC7  95                  		sub l
    5786   00:BCC8  4F                  		ld c,a
    5787   00:BCC9  1C                  		inc e
    5788   00:BCCA  0D                  		dec c
    5789   00:BCCB  0D                  		dec c
    5790   00:BCCC  18 D5               		jr .strseg
    5791   00:BCCE                      		
    5792   00:BCCE                      .nxtchr:
    5793   00:BCCE  23                  		inc hl              ; next character to display.
    5794   00:BCCF  C3 71 BC            		jp dmsg0
    5795   00:BCD2                      dmsg1:
    5796   00:BCD2  21 55 40            		ld hl,dispx         ; y coordinate.
    5797   00:BCD5  34                  		inc (hl)            ; newline.
    5798   00:BCD6  7E                  		ld a,(hl)           ; fetch position.
    5799   00:BCD7  FE 18               		cp MSX_MAXROWS		; past screen edge?
    5800   00:BCD9  38 02               		jr c,dmsg4          ; no, it's okay.
    5801   00:BCDB  36 00               		ld (hl),0           ; restart at top.
    5802   00:BCDD  23                  dmsg4:	inc hl              ; x coordinate.
    5803   00:BCDE  36 00               		ld (hl),0           ; carriage return.
    5804   00:BCE0  18 A2               		jr dmsg2
    5805   00:BCE2                      	   
    5806   00:BCE2                      
    5807   00:BCE2                      
    5808   00:BCE2                      ; Display message in big text.
    5809   00:BCE2                      
    5810   00:BCE2                      bmsg1:
    5811   00:BCE2  7E                  		ld a,(hl)           ; get character to display.
    5812   00:BCE3  E5                  		push hl             ; store pointer to message.
    5813   00:BCE4  E6 7F               		and 127             ; only want 7 bits.
    5814   00:BCE6  FE 0D               		cp 13               ; newline character?
    5815   00:BCE8  28 3B               		jr z,.bmsg2
    5816   00:BCEA  CD 36 BD            		call bchar          ; display big char.
    5817   00:BCED                      .bmsg3:
    5818   00:BCED  E1                  		pop hl              ; retrieve message pointer.
    5819   00:BCEE  7E                  		ld a,(hl)           ; look at last character.
    5820   00:BCEF  23                  		inc hl              ; next character in list.
    5821   00:BCF0  17                  		rla                 ; was terminator flag set?
    5822   00:BCF1  30 EF               		jr nc,bmsg1         ; no, keep going.
    5823   00:BCF3                      
    5824   00:BCF3  D1                  		pop de				; restores start of string
    5825   00:BCF4  B7                  		or a
    5826   00:BCF5  ED 52               		sbc hl,de			
    5827   00:BCF7  20 0E               		jr nz,.btzero
    5828   00:BCF9  21 00 4A            		ld hl,scrmap
    5829   00:BCFC  D1                  		pop de				; restores scrmap buffer pointer
    5830   00:BCFD  19                  		add hl,de			; start of string in scrmap
    5831   00:BCFE  36 FF               		ld (hl),255			; 1st half
    5832   00:BD00  11 20 00            		ld de,32
    5833   00:BD03  19                  		add hl,de
    5834   00:BD04  36 FF               		ld (hl),255			; 2nd half
    5835   00:BD06  C9                  		ret
    5836   00:BD07                      .btzero:
    5837   00:BD07                      		; upper half
    5838   00:BD07  44                  		ld b,h
    5839   00:BD08  4D                  		ld c,l				; get string lenght in BC
    5840   00:BD09  21 00 4A            		ld hl,scrmap
    5841   00:BD0C  D1                  		pop de				; restores scrmap buffer pointer
    5842   00:BD0D  19                  		add hl,de			; start of string in scrmap
    5843   00:BD0E  54                  		ld d,h
    5844   00:BD0F  5D                  		ld e,l
    5845   00:BD10  13                  		inc de
    5846   00:BD11  36 FF               		ld (hl),255
    5847   00:BD13  E5                  		push hl
    5848   00:BD14  C5                  		push bc
    5849   00:BD15  ED B0               		ldir
    5850   00:BD17                      		; bottom half
    5851   00:BD17  C1                  		pop bc
    5852   00:BD18  E1                  		pop hl
    5853   00:BD19  11 20 00            		ld de,32
    5854   00:BD1C  19                  		add hl,de
    5855   00:BD1D  54                  		ld d,h
    5856   00:BD1E  5D                  		ld e,l
    5857   00:BD1F  13                  		inc de
    5858   00:BD20  36 FF               		ld (hl),255
    5859   00:BD22  ED B0               		ldir
    5860   00:BD24  C9                  		ret
    5861   00:BD25                      .bmsg2:
    5862   00:BD25  21 35 40            		ld hl,charx         ; y coordinate.
    5863   00:BD28  34                  		inc (hl)            ; newline.
    5864   00:BD29  34                  		inc (hl)            ; newline.
    5865   00:BD2A  7E                  		ld a,(hl)           ; fetch position.
    5866   00:BD2B  FE 17               		cp MSX_MAXROWS-1		; past screen edge?
    5867   00:BD2D  38 BE               		jr c,.bmsg3          ; no, it's okay.
    5868   00:BD2F  36 00               		ld (hl),0           ; restart at top.
    5869   00:BD31  23                  		inc hl              ; y coordinate.
    5870   00:BD32  36 00               		ld (hl),0           ; carriage return.
    5871   00:BD34  18 B7               		jr .bmsg3
    5872   00:BD36                      
    5873   00:BD36                      
    5874   00:BD36                      ; Big character display.
    5875   00:BD36                      
    5876   00:BD36                      bchar:
    5877   00:BD36  07                  		rlca                ; multiply char by 8.
    5878   00:BD37  07                  		rlca
    5879   00:BD38  07                  		rlca
    5880   00:BD39  5F                  		ld e,a              ; store shift in e.
    5881   00:BD3A  E6 07               		and 7               ; only want high byte bits.
    5882   00:BD3C  57                  		ld d,a              ; store in d.
    5883   00:BD3D  7B                  		ld a,e              ; restore shifted value.
    5884   00:BD3E  E6 F8               		and $F8             ; only want low byte bits.
    5885   00:BD40  5F                  		ld e,a              ; that's the low byte. DE=CHAR*8
    5886   00:BD41  2A 3F 40            		ld hl,(grbase)      ; address of graphics.
    5887   00:BD44  19                  		add hl,de           ; add displacement.
    5888   00:BD45  CD 87 B9            		call gprad          ; get screen address (in DE)
    5889   00:BD48                      
    5890   00:BD48                      /*		
    5891   00:BD48                    ~ 		dec d	
    5892   00:BD48                    ~ 		ld b,2
    5893   00:BD48                    ~ .nxtchar:		
    5894   00:BD48                    ~ 		inc d
    5895   00:BD48                    ~ 		SETWRT de
    5896   00:BD48                    ~ 		ld c,4
    5897   00:BD48                    ~ .nxtrow:
    5898   00:BD48                    ~ 		ld a,(hl)
    5899   00:BD48                    ~ 		out (MSX_VDPDRW),a
    5900   00:BD48                    ~ 		inc hl
    5901   00:BD48                    ~ 		dec c
    5902   00:BD48                    ~ 		nop					; VDP slowdown		
    5903   00:BD48                    ~ 		out (MSX_VDPDRW),a
    5904   00:BD48                    ~ 		jr nz,.nxtrow
    5905   00:BD48                    ~ 		djnz .nxtchar
    5906   00:BD48                    ~ */
    5907   00:BD48                      
    5908   00:BD48  06 02               		ld b,2
    5909   00:BD4A                      .nxtchar:		
    5910   00:BD4A                      
    5911   00:BD4A  7B                  		ld a,e
    5912   00:BD4B  F3                  		di
    5913   00:BD4C  D3 BF               		out (MSX_VDPCW),a
    5914   00:BD4E  7A                  		ld a,d
    5915   00:BD4F  F6 40               		or $40
    5916   00:BD51  D3 BF               		out (MSX_VDPCW),a
    5917   00:BD53  FB                  		ei	
    5918   00:BD54                      
    5919   00:BD54  0E 04               		ld c,4
    5920   00:BD56                      .nxtrow:
    5921   00:BD56  7E                  		ld a,(hl)
    5922   00:BD57  D3 BE               		out (MSX_VDPDRW),a
    5923   00:BD59  23                  		inc hl
    5924   00:BD5A  0D                  		dec c
    5925   00:BD5B  00                  		nop					; VDP slowdown		
    5926   00:BD5C  D3 BE               		out (MSX_VDPDRW),a
    5927   00:BD5E  20 F6               		jr nz,.nxtrow
    5928   00:BD60  14                  		inc d
    5929   00:BD61  10 E7               		djnz .nxtchar
    5930   00:BD63                      		
    5931   00:BD63  15                  		dec d
    5932   00:BD64  15                  		dec d
    5933   00:BD65  7A                  		ld a,d
    5934   00:BD66  F6 60               		or $60
    5935   00:BD68  57                  		ld d,a
    5936   00:BD69                      
    5937   00:BD69  3A 39 40            		ld a,(clratt)
    5938   00:BD6C  0E BF               		ld c,MSX_VDPCW
    5939   00:BD6E  2E 02               		ld l,2
    5940   00:BD70                      nxtchar2:		
    5941   00:BD70  F3                          di
    5942   00:BD71  ED 59                       out (c),e
    5943   00:BD73  FB                          ei		
    5944   00:BD74  ED 51                       out (c),d
    5945   00:BD76  06 08               		ld b,8
    5946   00:BD78                      nxtfile2:
    5947   00:BD78  D3 BE               		out (MSX_VDPDRW),a
    5948   00:BD7A  10 FC               		djnz nxtfile2
    5949   00:BD7C  14                  		inc d
    5950   00:BD7D  2D                  		dec l
    5951   00:BD7E  20 F0               		jr nz,nxtchar2
    5952   00:BD80                      
    5953   00:BD80                      /*
    5954   00:BD80                    ~ 		ld b,2
    5955   00:BD80                    ~ nxtchar2:		
    5956   00:BD80                    ~ 
    5957   00:BD80                    ~ 		ld a,e
    5958   00:BD80                    ~         di
    5959   00:BD80                    ~         out (MSX_VDPCW),a
    5960   00:BD80                    ~         ld a,d
    5961   00:BD80                    ~ 		ld c,8
    5962   00:BD80                    ~         or 64       		;for write, set bit 6 high
    5963   00:BD80                    ~         out (MSX_VDPCW),a
    5964   00:BD80                    ~         ei		
    5965   00:BD80                    ~ 
    5966   00:BD80                    ~ 		ld a,(clratt)
    5967   00:BD80                    ~ nxtfile2:
    5968   00:BD80                    ~ 		out (MSX_VDPDRW),a
    5969   00:BD80                    ~ 		dec c
    5970   00:BD80                    ~ 		jr nz,nxtfile2
    5971   00:BD80                    ~ 		inc d
    5972   00:BD80                    ~ 		djnz nxtchar2	
    5973   00:BD80                    ~ */
    5974   00:BD80                      
    5975   00:BD80                      		
    5976   00:BD80  CD A5 BD            bchar1 call nexpos         ; display position.
    5977   00:BD83  C2 8A BD                   jp nz,bchar2        ; not on a new line.
    5978   00:BD86  34                  bchar3 inc (hl)            ; newline.
    5979   00:BD87  CD AF BD                   call nexlin         ; next line check.
    5980   00:BD8A  C3 EF B8            bchar2 jp dscor2           ; tidy up line and column variables.
    5981   00:BD8D                      
    5982   00:BD8D                      ; Display a character. (MSX:OK)
    5983   00:BD8D                      
    5984   00:BD8D                      achar:
    5985   00:BD8D  47                  		ld b,a              ; copy to b.
    5986   00:BD8E  CD B7 BD            		call preprt         ; get ready to print.
    5987   00:BD91  3A 38 40            		ld a,(prtmod)       ; print mode.
    5988   00:BD94  A7                  		and a               ; standard size?
    5989   00:BD95  78                  		ld a,b              ; character in accumulator.
    5990   00:BD96  C2 36 BD            		jp nz,bchar         ; no, double-height text.
    5991   00:BD99  CD C6 B9            		call ptxt           ; display character.
    5992   00:BD9C                      	   
    5993   00:BD9C  CD A5 BD            		call nexpos         ; display position.
    5994   00:BD9F  CA 86 BD            		jp z,bchar3         ; next line down.
    5995   00:BDA2  C3 8A BD            		jp bchar2           ; tidy up.
    5996   00:BDA5                      
    5997   00:BDA5                      ; Get next print column position.(MSX:OK)
    5998   00:BDA5                      
    5999   00:BDA5                      nexpos:
    6000   00:BDA5  21 56 40            		ld hl,dispy         ; X display position.
    6001   00:BDA8  7E                  		ld a,(hl)           ; get coordinate.
    6002   00:BDA9  3C                  		inc a               ; move along one position.
    6003   00:BDAA  E6 1F               		and MSX_MAXCOLS-1   ; reached edge of screen?
    6004   00:BDAC                      		
    6005   00:BDAC  77                  		ld (hl),a           ; set new position.
    6006   00:BDAD  2B                  		dec hl              ; point to y now.
    6007   00:BDAE  C9                  		ret                 ; return with status in zero flag.
    6008   00:BDAF                      
    6009   00:BDAF                      ; Get next print line position. (MSX:OK)
    6010   00:BDAF                      
    6011   00:BDAF  34                  nexlin inc (hl)            ; newline.
    6012   00:BDB0  7E                         ld a,(hl)           ; vertical position.
    6013   00:BDB1  FE 18                      cp MSX_MAXROWS      ; past screen edge?
    6014   00:BDB3  D8                         ret c               ; no, still okay.
    6015   00:BDB4  36 00                      ld (hl),0           ; restart at top.
    6016   00:BDB6  C9                         ret
    6017   00:BDB7                      
    6018   00:BDB7                      ; Pre-print preliminaries.
    6019   00:BDB7                      
    6020   00:BDB7                      preprt: 
    6021   00:BDB7  11 44 AC            		ld de,font-256		; font pointer, skipping first 32 ASCII codes
    6022   00:BDBA  ED 53 3F 40         		ld (grbase),de      ; set up graphics base.
    6023   00:BDBE                      prescr:
    6024   00:BDBE  ED 5B 35 40         		ld de,(charx)       ; display coordinates.
    6025   00:BDC2  ED 53 55 40         		ld (dispx),de       ; set up general coordinates.
    6026   00:BDC6  C9                  		ret
    6027   00:BDC7                      
    6028   00:BDC7                      ; On entry: hl points to word list
    6029   00:BDC7                      ;           a contains word number.
    6030   00:BDC7                      ; Modifies: b,a,hl
    6031   00:BDC7                      
    6032   00:BDC7                      getwrd:	; (MSX:OK)
    6033   00:BDC7  A7                  		and a               ; first word in list?
    6034   00:BDC8  C8                  		ret z               ; yep, don't search.
    6035   00:BDC9  47                  		ld b,a
    6036   00:BDCA                      getwd0:
    6037   00:BDCA  7E                  		ld a,(hl)
    6038   00:BDCB  23                  		inc hl
    6039   00:BDCC  FE 80               		cp 128              ; found end?
    6040   00:BDCE  38 FA               		jr c,getwd0         ; no, carry on.
    6041   00:BDD0  10 F8               		djnz getwd0         ; until we have right number.
    6042   00:BDD2  C9                  		ret
    6043   00:BDD3                      
    6044   00:BDD3                      ; Process sprites.
    6045   00:BDD3                      		
    6046   00:BDD3                      pspr:
    6047   00:BDD3  3A 4C 40            		ld a,(highslot)
    6048   00:BDD6  A7                  		and a
    6049   00:BDD7  C8                  		ret z				; no sprites, nothing to do
    6050   00:BDD8                      		ifdef DEBUG
    6051   00:BDD8                    ~ 		BORDER 6
    6052   00:BDD8                    ~ 		endif
    6053   00:BDD8  47                  		ld b,a
    6054   00:BDD9  DD 21 B5 40         		ld ix,sprtab        ; sprite table.
    6055   00:BDDD                      .loop:
    6056   00:BDDD  C5                  		push bc
    6057   00:BDDE  DD 7E 00            		ld a,(ix+0)         ; fetch sprite type.
    6058   00:BDE1  FE 09               		cp 9                ; within range of sprite types?
    6059   00:BDE3  DC EF BD            		call c,pspr2        ; yes, process this one.
    6060   00:BDE6  11 11 00            		ld de,TABSIZ        ; distance to next odd/even entry.
    6061   00:BDE9  DD 19               		add ix,de           ; next sprite.
    6062   00:BDEB  C1                  		pop bc
    6063   00:BDEC  10 EF               		djnz .loop
    6064   00:BDEE                      		ifdef DEBUG
    6065   00:BDEE                    ~ 		BORDER 9
    6066   00:BDEE                    ~ 		endif
    6067   00:BDEE  C9                  		ret
    6068   00:BDEF                      pspr2:
    6069   00:BDEF  DD 22 43 40         		ld (ogptr),ix       ; store original sprite pointer.
    6070   00:BDF3  67                  		ld h,a
    6071   00:BDF4  DD 7E 03            		ld a,(ix+3)			; saves sprite coordinates as backup
    6072   00:BDF7  DD 77 08            		ld (ix+8),a
    6073   00:BDFA  DD 7E 04            		ld a,(ix+4)
    6074   00:BDFD  DD 77 09            		ld (ix+9),a
    6075   00:BE00  7C                  		ld a,h
    6076   00:BE01  CD 09 BE            		call pspr3          ; do the routine.
    6077   00:BE04                      ; rtorg:
    6078   00:BE04  DD 2A 43 40         		ld ix,(ogptr)       ; restore original pointer to sprite.
    6079   00:BE08                      ; rtorg0:
    6080   00:BE08  C9                  		ret
    6081   00:BE09                      pspr3:
    6082   00:BE09  21 17 BE            		ld hl,evtyp0        ; sprite type events list.
    6083   00:BE0C                      pspr4:
    6084   00:BE0C  87                  		add a,a             ; double accumulator.
    6085   00:BE0D                      		ADD_HL_A
    6085   00:BE0D  85                >   add a,l
    6085   00:BE0E  6F                >   ld l,a
    6085   00:BE0F  8C                >   adc a,h
    6085   00:BE10  95                >   sub l
    6085   00:BE11  67                >   ld h,a
    6086   00:BE12                      ;
    6087   00:BE12                      ; Makes an indirect jump based on the contents of HL
    6088   00:BE12                      ;
    6089   00:BE12                      jumphl:	
    6090   00:BE12  7E                  		ld a,(hl)
    6091   00:BE13  23                  		inc hl
    6092   00:BE14  66                  		ld h,(hl)
    6093   00:BE15  6F                  		ld l,a
    6094   00:BE16  E9                  		jp (hl)
    6095   00:BE17                      
    6096   00:BE17                      ; Address of each sprite type's routine.
    6097   00:BE17                      
    6098   00:BE17  B3 80               evtyp0:	dw evnt00
    6099   00:BE19  96 83               evtyp1:	dw evnt01
    6100   00:BE1B  F1 83               evtyp2:	dw evnt02
    6101   00:BE1D  58 84               evtyp3:	dw evnt03
    6102   00:BE1F  A5 84               evtyp4:	dw evnt04
    6103   00:BE21  14 85               evtyp5:	dw evnt05
    6104   00:BE23  36 85               evtyp6:	dw evnt06
    6105   00:BE25  37 85               evtyp7:	dw evnt07
    6106   00:BE27  53 85               evtyp8:	dw evnt08
    6107   00:BE29                      
    6108   00:BE29                      ; Look for sprites not mapped yet and map them
    6109   00:BE29                      ; Input:
    6110   00:BE29                      ;	None
    6111   00:BE29                      ; Output:
    6112   00:BE29                      ;	None. Sprites mapped
    6113   00:BE29                      ;
    6114   00:BE29                      chkimg:
    6115   00:BE29  3A 4C 40            		ld a,(highslot)
    6116   00:BE2C  A7                  		and a
    6117   00:BE2D  C8                  		ret z				; no sprites, nothing to do
    6118   00:BE2E                      		ifdef DEBUG
    6119   00:BE2E                    ~ 		BORDER 3
    6120   00:BE2E                    ~ 		endif
    6121   00:BE2E  47                  		ld b,a
    6122   00:BE2F  11 11 00            		ld de,TABSIZ				
    6123   00:BE32                      .loop:		
    6124   00:BE32  DD 7E 00            		ld a,(ix+0)			; get sprite type
    6125   00:BE35  3C                  		inc a
    6126   00:BE36  28 14               		jr z,.nxtspr		; is the sprite active?		
    6127   00:BE38  DD 7E 01            		ld a,(ix+1)		
    6128   00:BE3B  4F                   		ld c,a
    6129   00:BE3C  CD 7B C1            		call gfrm
    6130   00:BE3F  6E                  		ld l,(hl)
    6131   00:BE40  26 4D               		ld h,mapspr>>8		
    6132   00:BE42  7E                  		ld a,(hl)
    6133   00:BE43  3C                  		inc a				; has already been mapped?
    6134   00:BE44  20 06               		jr nz,.nxtspr
    6135   00:BE46  79                  		ld a,c
    6136   00:BE47  EB                  		ex de,hl
    6137   00:BE48  CD 51 C2             		call mapsprite		; the sprite has not been mapped ($FF), do it now
    6138   00:BE4B  EB                  		ex de,hl
    6139   00:BE4C                      .nxtspr:		
    6140   00:BE4C  DD 19               		add ix,de           ; next sprite.
    6141   00:BE4E  10 E2               		djnz .loop          ; repeat for remaining sprites.
    6142   00:BE50                      		ifdef DEBUG
    6143   00:BE50                    ~ 		BORDER 14
    6144   00:BE50                    ~ 		endif
    6145   00:BE50  C9                  		ret
    6146   00:BE51                       
    6147   00:BE51                      disscreen:
    6148   00:BE51  C3 41 00            		jp MSX_DISSCR
    6149   00:BE54                      
    6150   00:BE54                      enascreen:
    6151   00:BE54  C3 44 00            		jp MSX_ENASCR
    6152   00:BE57                      		
    6153   00:BE57                      dissprs:
    6154   00:BE57  3E D0               		ld a,MSX_HIDE_SPRITES	; disable all sprites
    6155   00:BE59  21 00 1B            		ld hl,MSX_SPRATR
    6156   00:BE5C  C3 A3 C7            		jp MSX_WRTVRM
    6157   00:BE5F                      
    6158   00:BE5F                      ;
    6159   00:BE5F                      ; Copy data from RAM to VRAM
    6160   00:BE5F                      ; Input:
    6161   00:BE5F                      ; 	HL: Source in RAM
    6162   00:BE5F                      ; 	DE: VRAM address to copy to
    6163   00:BE5F                      ;	B: bytes to copy (0-255, 0 is 256 bytes)
    6164   00:BE5F                      ; Output:
    6165   00:BE5F                      ;	None. 
    6166   00:BE5F                      
    6167   00:BE5F                      
    6168   00:BE5F                      ;		 
    6169   00:BE5F                      ram2vram:
    6170   00:BE5F  0E BF               		ld c,MSX_VDPCW
    6171   00:BE61  F3                          di
    6172   00:BE62  ED 59                       out (c),e
    6173   00:BE64  CB F2                       set 6,d			; high byte set for write
    6174   00:BE66  FB                          ei	
    6175   00:BE67  ED 51                       out (c),d
    6176   00:BE69  0D                  		dec c 
    6177   00:BE6A                      .loop:		
    6178   00:BE6A                      		[8] outi
    6178   00:BE6A  ED A3 ED A3 ED A3 ED A3 ED A3 ED A3 ED A3 ED A3 
    6179   00:BE7A  C2 6A BE            		jp nz,.loop
    6180   00:BE7D  C9                  		ret
    6181   00:BE7E                      
    6182   00:BE7E                      ;
    6183   00:BE7E                      ; Copy data from RAM to VRAM
    6184   00:BE7E                      ; Input:
    6185   00:BE7E                      ; 	HL: Source in RAM
    6186   00:BE7E                      ; 	DE: VRAM address to copy to
    6187   00:BE7E                      ;	B: bytes to copy (0-255, 0 is 256 bytes)
    6188   00:BE7E                      ; Output:
    6189   00:BE7E                      ;	None. 
    6190   00:BE7E                      ;		 
    6191   00:BE7E                      ram2vram_slow:
    6192   00:BE7E  0E BF               		ld c,MSX_VDPCW
    6193   00:BE80  F3                          di
    6194   00:BE81  ED 59                       out (c),e
    6195   00:BE83  CB F2                       set 6,d			; high byte set for write
    6196   00:BE85  FB                          ei	
    6197   00:BE86  ED 51                       out (c),d
    6198   00:BE88  0D                  		dec c 
    6199   00:BE89                      .loop:		
    6200   00:BE89  ED A3               		outi
    6201   00:BE8B  C2 89 BE            		jp nz,.loop
    6202   00:BE8E  C9                  		ret
    6203   00:BE8F                      
    6204   00:BE8F                       
    6205   00:BE8F                      buildspr:
    6206   00:BE8F  3A 4C 40            		ld a,(highslot)		; max number of sprites being instantiated
    6207   00:BE92  A7                  		and a
    6208   00:BE93  C8                  		ret z				; no sprites, nothing to do
    6209   00:BE94                      		ifdef DEBUG
    6210   00:BE94                    ~ 		BORDER 12
    6211   00:BE94                    ~ 		endif
    6212   00:BE94  DD 21 B5 40         		ld ix,sprtab
    6213   00:BE98  47                  		ld b,a
    6214   00:BE99  21 80 45            		ld hl,spratr
    6215   00:BE9C  22 77 40            		ld (sprptr),hl
    6216   00:BE9F                      .loop:		
    6217   00:BE9F  DD 7E 00            		ld a,(ix+0)			; get sprite type
    6218   00:BEA2  3C                  		inc a
    6219   00:BEA3  20 08               		jr nz,.ison			; is the sprite active?
    6220   00:BEA5  3E D1               		ld a,MSX_HIDE_SPRITE	; not active
    6221   00:BEA7  77                  		ld (hl),a			; Y
    6222   00:BEA8  2C                  		inc l
    6223   00:BEA9  2C                  		inc l
    6224   00:BEAA  2C                  		inc l
    6225   00:BEAB  18 22               		jr .nxtspr		
    6226   00:BEAD                      .ison:		
    6227   00:BEAD  DD 7E 03            		ld a,(ix+3)			
    6228   00:BEB0  3D                  		dec a				; corrects y MSX sprite coordinate		
    6229   00:BEB1  77                  		ld (hl),a			; Y
    6230   00:BEB2  2C                  		inc l		
    6231   00:BEB3                      		
    6232   00:BEB3  DD 7E 04            		ld a,(ix+4)				
    6233   00:BEB6  77                  		ld (hl),a			; X	
    6234   00:BEB7  2C                  		inc l
    6235   00:BEB8                      
    6236   00:BEB8  EB                  		ex de,hl
    6237   00:BEB9  DD 7E 01            		ld a,(ix+1)
    6238   00:BEBC  CD 7B C1            		call gfrm
    6239   00:BEBF  6E                  		ld l,(hl)
    6240   00:BEC0  26 4D               		ld h,mapspr>>8				
    6241   00:BEC2  7E                  		ld a,(hl)			; gets real frame from mapspr table
    6242   00:BEC3  DD 86 02            		add a,(ix+2)
    6243   00:BEC6  87                  		add a,a
    6244   00:BEC7  87                  		add a,a
    6245   00:BEC8  EB                  		ex de,hl
    6246   00:BEC9  77                  		ld (hl),a			; image number * 4
    6247   00:BECA  2C                  		inc l
    6248   00:BECB                      		
    6249   00:BECB  DD 7E 05            		ld a,(ix+5)
    6250   00:BECE  77                  		ld (hl),a
    6251   00:BECF                      .nxtspr:
    6252   00:BECF  2C                  		inc l		
    6253   00:BED0  11 11 00            		ld de,TABSIZ		
    6254   00:BED3  DD 19               		add ix,de           ; next sprite.
    6255   00:BED5  10 C8               		djnz .loop          ; repeat for remaining sprites.
    6256   00:BED7  3E D0               		ld a,MSX_HIDE_SPRITES	; no more sprite from here
    6257   00:BED9  77                  		ld (hl),a
    6258   00:BEDA                      
    6259   00:BEDA                      ; ----------------------------------
    6260   00:BEDA                      
    6261   00:BEDA                      sprflick:	
    6262   00:BEDA  21 80 45            		ld hl,spratr
    6263   00:BEDD  3A E7 53            		ld a,(MSX_STATFL)
    6264   00:BEE0  CB 77               		bit 6,a
    6265   00:BEE2  20 07               		jr nz,.flick
    6266   00:BEE4  3E 80               		ld a,colltab&$FF
    6267   00:BEE6  32 5B 40            		ld (offset),a
    6268   00:BEE9  18 72               		jr .no5th
    6269   00:BEEB                      .flick:
    6270   00:BEEB                      		; sort sprites into two separate lists (aligned with 5th & not aligned)
    6271   00:BEEB  E6 1F               		and 31				; get 5th sprite plane number
    6272   00:BEED  5F                  		ld e,a
    6273   00:BEEE  3A 4C 40            		ld a,(highslot)
    6274   00:BEF1  BB                  		cp e
    6275   00:BEF2  38 69               		jr c,.no5th			; 5th has been removed?, no flicker then...
    6276   00:BEF4                      		;
    6277   00:BEF4  08                  		ex af,af			; save number of sprites in screen
    6278   00:BEF5  7B                  		ld a,e
    6279   00:BEF6  11 00 45            		ld de,spratr2		; new sprite attribute table
    6280   00:BEF9  D5                  		push de
    6281   00:BEFA  54                  		ld d,h
    6282   00:BEFB  5D                  		ld e,l
    6283   00:BEFC  87                  		add a,a
    6284   00:BEFD  87                  		add a,a				; 5th sprite plane * 4
    6285   00:BEFE  83                  		add a,e				; DE now points to 5th sprite plane attributes
    6286   00:BEFF  5F                  		ld e,a
    6287   00:BF00                      		;
    6288   00:BF00  08                  		ex af,af			; restores number of sprites in screen
    6289   00:BF01  47                  		ld b,a				; number of sprites to check
    6290   00:BF02  1A                  		ld a,(de)			; 
    6291   00:BF03  4F                  		ld c,a				; get C=Y-coord of 5th sprite
    6292   00:BF04  11 80 4D            		ld de,colltab		; aligned with 5th list
    6293   00:BF07                      .lp:
    6294   00:BF07  7E                  		ld a,(hl)			; get Y coord of sprite from master sprite attribute table
    6295   00:BF08  91                  		sub c				 
    6296   00:BF09  30 02               		jr nc,.bottom		; compare both Y coords
    6297   00:BF0B  ED 44               		neg					; if 5th Y coord is greater, negate the difference
    6298   00:BF0D                      .bottom:		
    6299   00:BF0D  FE 10               		cp MSX_SPRVS		; compare the difference with sprite vertical size
    6300   00:BF0F  30 0C               		jr nc,.noovlp		; if diff > sprite vertical size, there's no vertical overlapping
    6301   00:BF11  C5                  		push bc					
    6302   00:BF12  ED A0               		ldi
    6303   00:BF14  ED A0               		ldi
    6304   00:BF16  ED A0               		ldi
    6305   00:BF18  ED A0               		ldi					; store sprite attributes in colltab
    6306   00:BF1A  C1                  		pop bc
    6307   00:BF1B  18 10               		jr .nxt
    6308   00:BF1D                      .noovlp:
    6309   00:BF1D                      		EX_SP_DE			; swaps lists colltab<>spratr2
    6309   00:BF1D  EB                >   ex de,hl
    6309   00:BF1E  E3                >   ex (sp),hl
    6309   00:BF1F  EB                >   ex de,hl
    6310   00:BF20  C5                  		push bc
    6311   00:BF21  ED A0               		ldi
    6312   00:BF23  ED A0               		ldi
    6313   00:BF25  ED A0               		ldi
    6314   00:BF27  ED A0               		ldi					; now store sprite attributes in spratr2
    6315   00:BF29  C1                  		pop bc
    6316   00:BF2A                      		EX_SP_DE			; restores lists pointers
    6316   00:BF2A  EB                >   ex de,hl
    6316   00:BF2B  E3                >   ex (sp),hl
    6316   00:BF2C  EB                >   ex de,hl
    6317   00:BF2D                      .nxt:
    6318   00:BF2D  10 D8               		djnz .lp
    6319   00:BF2F                      		; rotate SAT segments (only 5th related sprites)
    6320   00:BF2F  4B                  		ld c,e
    6321   00:BF30  3A 5B 40            		ld a,(offset)
    6322   00:BF33  C6 10               		add a,16
    6323   00:BF35  B9                  		cp c
    6324   00:BF36  38 09               		jr c,.noreset 
    6325   00:BF38  3E 80               		ld a,colltab&$FF
    6326   00:BF3A  32 5B 40            		ld (offset),a		; store offset to split SAT
    6327   00:BF3D  7B                  		ld a,e
    6328   00:BF3E  D1                  		pop de
    6329   00:BF3F  18 0E               		jr .fullsat			; SAT is not splitted, only one copy needed		
    6330   00:BF41                      .noreset:		
    6331   00:BF41  32 5B 40            		ld (offset),a		; store offset to split SAT
    6332   00:BF44  62                  		ld h,d
    6333   00:BF45  6F                  		ld l,a
    6334   00:BF46  79                  		ld a,c
    6335   00:BF47  95                  		sub l
    6336   00:BF48  4F                  		ld c,a
    6337   00:BF49  D1                  		pop de
    6338   00:BF4A  ED B0               		ldir				; copy first half 
    6339   00:BF4C  3A 5B 40            		ld a,(offset)
    6340   00:BF4F                      .fullsat:
    6341   00:BF4F  D6 80               		sub colltab&$FF
    6342   00:BF51  4F                  		ld c,a
    6343   00:BF52  21 80 4D            		ld hl,colltab
    6344   00:BF55  ED B0               		ldir				; copy 2nd half
    6345   00:BF57  3E D0               		ld a,MSX_HIDE_SPRITES	; no more sprite from here
    6346   00:BF59  12                  		ld (de),a
    6347   00:BF5A  21 00 45            		ld hl,spratr2
    6348   00:BF5D                      .no5th:
    6349   00:BF5D  22 77 40            		ld (sprptr),hl
    6350   00:BF60                      
    6351   00:BF60                      		ifdef DEBUG
    6352   00:BF60                    ~ 		BORDER 14
    6353   00:BF60                    ~ 		endif
    6354   00:BF60                      
    6355   00:BF60  C9                  		ret
    6356   00:BF61                      
    6357   00:BF61                      
    6358   00:BF61                      /*
    6359   00:BF61                    ~  ; Could be reworked
    6360   00:BF61                    ~ 		ld hl,spratr
    6361   00:BF61                    ~ 		ld a,(MSX_STATFL)
    6362   00:BF61                    ~ 		bit 6,a
    6363   00:BF61                    ~ 		jp z,.NO5TH
    6364   00:BF61                    ~ 		
    6365   00:BF61                    ~ 		ld e,a
    6366   00:BF61                    ~ 		ld a,(offset)
    6367   00:BF61                    ~ 		or a
    6368   00:BF61                    ~ 		jr z,.NOLDIR
    6369   00:BF61                    ~ 		cp 255
    6370   00:BF61                    ~ 		jr nz,.NOINIT
    6371   00:BF61                    ~ 		ld a,e
    6372   00:BF61                    ~ 		and $3C
    6373   00:BF61                    ~ 		add a,a
    6374   00:BF61                    ~ 		add a,a		
    6375   00:BF61                    ~ .NOINIT:	
    6376   00:BF61                    ~ 		ld b,0
    6377   00:BF61                    ~ 		ld c,a
    6378   00:BF61                    ~ 		ld de,spratr2
    6379   00:BF61                    ~ 		ldir
    6380   00:BF61                    ~ .NOLDIR:	
    6381   00:BF61                    ~ 		add a,16
    6382   00:BF61                    ~ 		and $3F
    6383   00:BF61                    ~ 		jp .NORESET
    6384   00:BF61                    ~ 		
    6385   00:BF61                    ~ .NO5TH:	
    6386   00:BF61                    ~ 		ld a,255
    6387   00:BF61                    ~ .NORESET:	
    6388   00:BF61                    ~ 		ld (offset),a
    6389   00:BF61                    ~ 		ld (sprptr),hl
    6390   00:BF61                    ~ */
    6391   00:BF61                      
    6392   00:BF61                      dumpspr:
    6393   00:BF61  3A 4C 40            		ld a,(highslot)
    6394   00:BF64  A7                  		and a
    6395   00:BF65  C8                  		ret z				; no sprites, nothing to do
    6396   00:BF66                      		ifdef DEBUG
    6397   00:BF66                    ~ 		BORDER 10
    6398   00:BF66                    ~ 		endif		
    6399   00:BF66  87                  		add a,a
    6400   00:BF67  87                  		add a,a		
    6401   00:BF68  C6 08               		add a,8
    6402   00:BF6A  E6 F8               		and $F8				; only send to VRAM multiples of 8 
    6403   00:BF6C  47                  		ld b,a
    6404   00:BF6D  2A 77 40            		ld hl,(sprptr)
    6405   00:BF70  11 00 1B            		ld de,MSX_SPRATR
    6406   00:BF73                      		ifdef FASTVRAMDUMP
    6407   00:BF73                    ~ 		call ram2vram
    6408   00:BF73                    ~ 		else
    6409   00:BF73  CD 7E BE            		call ram2vram_slow
    6410   00:BF76                      		endif
    6411   00:BF76                      		ifdef DEBUG
    6412   00:BF76                    ~ 		BORDER 14
    6413   00:BF76                    ~ 		endif
    6414   00:BF76  C9                  		ret
    6415   00:BF77                      		
    6416   00:BF77                      ; Drop into screen address routine. (MSX:OK)
    6417   00:BF77                      ; This routine returns in HL a screen address for (dispx, dispy). Must not modify DE
    6418   00:BF77                      
    6419   00:BF77                      scadd:
    6420   00:BF77  3A 55 40            		ld a,(dispx)	; 14
    6421   00:BF7A  6F                  		ld l,a			; 5
    6422   00:BF7B  E6 F8               		and $F8			; 7
    6423   00:BF7D  0F                  		rrca			; 5
    6424   00:BF7E  0F                  		rrca			; 5
    6425   00:BF7F  0F                  		rrca			; 5
    6426   00:BF80  67                  		ld h,a			; 5
    6427   00:BF81  7D                  		ld a,l			; 5
    6428   00:BF82  E6 07               		and $07			; 7
    6429   00:BF84  6F                  		ld l,a			; 5 HL= ((y/8)*256+y%8)
    6430   00:BF85  3A 56 40            		ld a,(dispy)	; 14
    6431   00:BF88  E6 F8               		and $F8			; 7 A = (x/8)*8
    6432   00:BF8A                      		ADD_HL_A		; 25
    6432   00:BF8A  85                >   add a,l
    6432   00:BF8B  6F                >   ld l,a
    6432   00:BF8C  8C                >   adc a,h
    6432   00:BF8D  95                >   sub l
    6432   00:BF8E  67                >   ld h,a
    6433   00:BF8F  C9                  		ret	
    6434   00:BF90                      		
    6435   00:BF90                      		
    6436   00:BF90                      ; Animates a sprite.
    6437   00:BF90                      
    6438   00:BF90                      animsp:
    6439   00:BF90  21 4E 40            		ld hl,frmno         ; game frame.
    6440   00:BF93  A6                  		and (hl)            ; is it time to change the frame?
    6441   00:BF94  C0                  		ret nz              ; not this frame.
    6442   00:BF95  DD 7E 01            		ld a,(ix+1)         ; sprite image.
    6443   00:BF98  CD 7B C1            		call gfrm           ; get frame data.
    6444   00:BF9B  23                  		inc hl              ; point to frames.
    6445   00:BF9C  DD 7E 02            		ld a,(ix+2)         ; sprite frame.
    6446   00:BF9F  3C                  		inc a               ; next one along.
    6447   00:BFA0  BE                  		cp (hl)             ; reached the last frame?
    6448   00:BFA1  38 01               		jr c,anims0         ; no, not yet.
    6449   00:BFA3  AF                  		xor a               ; start at first frame.
    6450   00:BFA4                      anims0:
    6451   00:BFA4  DD 77 02            		ld (ix+2),a         ; new frame.
    6452   00:BFA7  C9                  		ret
    6453   00:BFA8                      animbk:
    6454   00:BFA8  21 4E 40            		ld hl,frmno         ; game frame.
    6455   00:BFAB  A6                  		and (hl)            ; is it time to change the frame?
    6456   00:BFAC  C0                  		ret nz              ; not this frame.
    6457   00:BFAD  DD 7E 01            		ld a,(ix+1)         ; sprite image.
    6458   00:BFB0  CD 7B C1            		call gfrm           ; get frame data.
    6459   00:BFB3  23                  		inc hl              ; point to frames.
    6460   00:BFB4  DD 7E 02            		ld a,(ix+2)         ; sprite frame.
    6461   00:BFB7  A7                  		and a               ; first one?
    6462   00:BFB8  20 01               		jr nz,.rtanb0        ; yes, start at end.
    6463   00:BFBA  7E                  		ld a,(hl)           ; last sprite.
    6464   00:BFBB                      .rtanb0:
    6465   00:BFBB  3D                  		dec a               ; next one along.
    6466   00:BFBC  18 E6               		jr anims0           ; set new frame.
    6467   00:BFBE                      
    6468   00:BFBE                      ; Check for collision with other sprite, strict enforcement.
    6469   00:BFBE                      ; Input:
    6470   00:BFBE                      ;	C = NUmber of sprite to check for collision
    6471   00:BFBE                      sktyp:  
    6472   00:BFBE  41                  		ld b,c
    6473   00:BFBF  3A 4C 40            		ld a,(highslot)
    6474   00:BFC2  A7                  		and a
    6475   00:BFC3  C8                  		ret z				; no sprites, nothing to do
    6476   00:BFC4                      		ifdef DEBUG
    6477   00:BFC4                    ~ 		BORDER 4
    6478   00:BFC4                    ~ 		endif
    6479   00:BFC4                      	
    6480   00:BFC4                      	if HCFLAG=1
    6481   00:BFC4                    ~ 		ld a,(MSX_STATFL)
    6482   00:BFC4                    ~ 		and 00100000b		; check hardware sprites collision
    6483   00:BFC4                    ~ 		jr z,.nocoll		; no collisions, skip routine
    6484   00:BFC4                    ~ 	endif
    6485   00:BFC4                      	
    6486   00:BFC4                      		; There's a collision, find it
    6487   00:BFC4                      		
    6488   00:BFC4  21 B5 40            		ld hl,sprtab        ; sprite table.
    6489   00:BFC7                      .loop: 
    6490   00:BFC7  08                  		ex af,af            ; store loop counter.
    6491   00:BFC8  22 4A 40            		ld (skptr),hl       ; store pointer to sprite.
    6492   00:BFCB  7E                  		ld a,(hl)           ; get sprite type.
    6493   00:BFCC  B8                  		cp b                ; is it the type we seek?
    6494   00:BFCD  28 14               		jr z,coltyp         ; yes, we can use this one.
    6495   00:BFCF                      .sktyp1: 
    6496   00:BFCF  2A 4A 40            		ld hl,(skptr)       ; retrieve sprite pointer.
    6497   00:BFD2                      		
    6498   00:BFD2  11 11 00            		ld de,TABSIZ        ; size of each entry.
    6499   00:BFD5  19                  		add hl,de           ; point to next sprite in table.
    6500   00:BFD6                      		
    6501   00:BFD6  08                  		ex af,af           ; restore loop counter.
    6502   00:BFD7  3D                  		dec a               ; one less iteration.
    6503   00:BFD8  C2 C7 BF            		jp nz,.loop        ; keep going until we find a slot.
    6504   00:BFDB                      		
    6505   00:BFDB  21 00 00            		ld hl,0             ; default to ROM address - no sprite.
    6506   00:BFDE  22 4A 40            		ld (skptr),hl       ; store pointer to sprite.
    6507   00:BFE1  B4                  		or h                ; don't return with zero flag set.
    6508   00:BFE2                      .nocoll:
    6509   00:BFE2                      		ifdef DEBUG
    6510   00:BFE2                    ~ 		BORDER 6
    6511   00:BFE2                    ~ 		endif
    6512   00:BFE2  C9                  		ret                 ; didn't find one.
    6513   00:BFE3                      
    6514   00:BFE3                      coltyp:
    6515   00:BFE3  DD 7E 00            		ld a,(ix+0)         ; current sprite type.
    6516   00:BFE6  B8                  		cp b                ; seeking sprite of same type?
    6517   00:BFE7  28 27               		jr z,.colty1        ; yes, need to check we're not detecting ourselves.
    6518   00:BFE9                      .colty0:
    6519   00:BFE9  11 03 00            		ld de,X             ; distance to x position in table.
    6520   00:BFEC  19                  		add hl,de           ; point to coords.
    6521   00:BFED                      		
    6522   00:BFED  5E                  		ld e,(hl)           ; fetch x coordinate.
    6523   00:BFEE  23                  		inc hl              ; now point to y.
    6524   00:BFEF  56                  		ld d,(hl)           ; that's y coordinate.
    6525   00:BFF0                      
    6526   00:BFF0                      ; Drop into collision detection.
    6527   00:BFF0                      ;colc16:
    6528   00:BFF0  DD 7E 03            		ld a,(ix+X)         ; x coord.
    6529   00:BFF3  93                  		sub e               ; subtract x.
    6530   00:BFF4  30 02               		jr nc,.colc1a        ; result is positive.
    6531   00:BFF6  ED 44               		neg                 ; make negative positive.
    6532   00:BFF8                      .colc1a:
    6533   00:BFF8  FE 10               		cp 16               ; within x range?
    6534   00:BFFA  30 D3               		jr nc,sktyp.sktyp1        ; no - they've missed.
    6535   00:BFFC  4F                  		ld c,a              ; store difference.
    6536   00:BFFD  DD 7E 04            		ld a,(ix+Y)         ; y coord.
    6537   00:C000  92                  		sub d               ; subtract y.
    6538   00:C001  30 02               		jr nc,.colc1b        ; result is positive.
    6539   00:C003  ED 44               		neg                 ; make negative positive.
    6540   00:C005                      .colc1b:
    6541   00:C005  FE 10               		cp 16               ; within y range?
    6542   00:C007  30 C6               		jr nc,sktyp.sktyp1        ; no - they've missed.
    6543   00:C009  81                  		add a,c             ; add x difference.
    6544   00:C00A  FE 1A               		cp 26               ; only 5 corner pixels touching?
    6545   00:C00C  D8                  		ret c               ; carry set if there's a collision.
    6546   00:C00D  C3 CF BF            		jp sktyp.sktyp1           ; try next sprite in table.
    6547   00:C010                      .colty1:
    6548   00:C010  DD E5               		push ix             ; base sprite address onto stack.
    6549   00:C012  D1                  		pop de              ; pop it into de.
    6550   00:C013  EB                  		ex de,hl            ; flip hl into de.
    6551   00:C014  ED 52               		sbc hl,de           ; compare the two.
    6552   00:C016  EB                  		ex de,hl            ; restore hl.
    6553   00:C017  28 B6               		jr z,sktyp.sktyp1   ; addresses are identical.
    6554   00:C019  C3 E9 BF            		jp .colty0
    6555   00:C01C                      
    6556   00:C01C                      ; Display number.
    6557   00:C01C                      ;
    6558   00:C01C                      disply:
    6559   00:C01C  01 12 40            		ld bc,displ0        ; display workspace.
    6560   00:C01F  CD 64 B6            		call num2ch         ; convert accumulator to string.
    6561   00:C022                      displ1:
    6562   00:C022  0B                  		dec bc              ; back one character.
    6563   00:C023  0A                  		ld a,(bc)           ; fetch digit.
    6564   00:C024  F6 80               		or 128              ; insert end marker.
    6565   00:C026  02                  		ld (bc),a           ; new value.
    6566   00:C027  21 12 40            		ld hl,displ0        ; display space.
    6567   00:C02A  C3 5D BC            		jp dmsg3            ; display the string.
    6568   00:C02D                      
    6569   00:C02D                      ; Initialise screen.
    6570   00:C02D                      ;
    6571   00:C02D                      initsc:
    6572   00:C02D  3A 4D 40            		ld a,(roomtb)       ; whereabouts in the map are we?
    6573   00:C030  CD 3A C0            		call tstsc          ; find displacement.
    6574   00:C033  FE FF               		cp 255              ; is it valid?
    6575   00:C035  C8                  		ret z               ; no, it's rubbish.
    6576   00:C036  32 42 40            		ld (scno),a         ; store new room number.
    6577   00:C039  C9                  		ret
    6578   00:C03A                      
    6579   00:C03A                      ; Test screen.
    6580   00:C03A                      ;
    6581   00:C03A                      tstsc:
    6582   00:C03A  21 71 80                   ld hl,mapdat-MAPWID ; start of map data, subtract width for negative.
    6583   00:C03D  47                         ld b,a              ; store room in b for now.
    6584   00:C03E  C6 0D                      add a,MAPWID        ; add width in case we're negative.
    6585   00:C040  5F                         ld e,a              ; screen into e.
    6586   00:C041  16 00                      ld d,0              ; zeroise d.
    6587   00:C043  19                         add hl,de           ; add displacement to map data.
    6588   00:C044  7E                         ld a,(hl)           ; find room number there.
    6589   00:C045  C9                         ret
    6590   00:C046                      
    6591   00:C046                      ; Screen left.
    6592   00:C046                      ;
    6593   00:C046                      scrl:
    6594   00:C046  3A 4D 40            		ld a,(roomtb)       ; present room table pointer.
    6595   00:C049  3D                  		dec a               ; room left.
    6596   00:C04A                      scrl0:
    6597   00:C04A  CD 3A C0            		call tstsc          ; test screen.
    6598   00:C04D  3C                  		inc a               ; is there a screen this way?
    6599   00:C04E  C8                  		ret z               ; no, return to loop.
    6600   00:C04F  78                  		ld a,b              ; restore room displacement.
    6601   00:C050  32 4D 40            		ld (roomtb),a       ; new room table position.
    6602   00:C053                      scrl1:
    6603   00:C053  CD 2D C0            		call initsc         ; set new screen.
    6604   00:C056  21 52 40            		ld hl,restfl        ; restart screen flag.
    6605   00:C059  36 02               		ld (hl),2           ; set it.
    6606   00:C05B  C9                  		ret
    6607   00:C05C                      scrr:
    6608   00:C05C  3A 4D 40            		ld a,(roomtb)       ; room table pointer.
    6609   00:C05F  3C                  		inc a               ; room right.
    6610   00:C060  18 E8               		jr scrl0
    6611   00:C062                      scru:
    6612   00:C062  3A 4D 40            		ld a,(roomtb)       ; room table pointer.
    6613   00:C065  D6 0D               		sub MAPWID          ; room up.
    6614   00:C067  18 E1               		jr scrl0
    6615   00:C069                      scrd:
    6616   00:C069  3A 4D 40            		ld a,(roomtb)       ; room table pointer.
    6617   00:C06C  C6 0D               		add a,MAPWID        ; room down.
    6618   00:C06E  18 DA               		jr scrl0
    6619   00:C070                      		
    6620   00:C070                      ; Jump to new screen.
    6621   00:C070                      ;
    6622   00:C070                      nwscr:
    6623   00:C070  21 7E 80            		ld hl,mapdat        ; start of map data.
    6624   00:C073  01 00 50            		ld bc,256*80        ; zero room count, 80 to search.
    6625   00:C076                      nwscr0:
    6626   00:C076  BE                  		cp (hl)             ; have we found a match for screen?
    6627   00:C077  28 05               		jr z,nwscr1         ; yes, set new point in map.
    6628   00:C079  23                  		inc hl              ; next room.
    6629   00:C07A  0C                  		inc c               ; count rooms.
    6630   00:C07B  10 F9               		djnz nwscr0         ; keep looking.
    6631   00:C07D  C9                  		ret
    6632   00:C07E                      nwscr1:
    6633   00:C07E  79                  		ld a,c              ; room displacement.
    6634   00:C07F  32 4D 40            		ld (roomtb),a       ; set the map position.
    6635   00:C082  18 CF               		jr scrl1            ; draw new room.
    6636   00:C084                      
    6637   00:C084                      
    6638   00:C084                      ; Gravity processing.
    6639   00:C084                      ;
    6640   00:C084                      grav:
    6641   00:C084  3A 4E 40             		ld a,(frmno)
    6642   00:C087  0F                  		rrca
    6643   00:C088  D8                  		ret c				; only 1/2 of frames		
    6644   00:C089  DD 7E 0D            		ld a,(ix+13)        ; in-air flag.
    6645   00:C08C  A7                  		and a               ; are we in the air?
    6646   00:C08D  C8                  		ret z               ; no we are not.
    6647   00:C08E  3C                  		inc a               ; increment it.
    6648   00:C08F  CA D9 C0            		jp z,ogrv           ; set to 255, use old gravity.
    6649   00:C092  DD 77 0D            		ld (ix+13),a        ; write new setting.
    6650   00:C095  1F                  		rra                 ; every other frame.
    6651   00:C096  30 0A               		jr nc,grav0         ; don't apply gravity this time.
    6652   00:C098  DD 7E 0E            		ld a,(ix+14)        ; pixels to move.
    6653   00:C09B  FE 10               		cp 16               ; reached maximum?
    6654   00:C09D  28 03               		jr z,grav0          ; yes, continue.
    6655   00:C09F  DD 34 0E            		inc (ix+14)         ; slow down ascent/speed up fall.
    6656   00:C0A2                      grav0:
    6657   00:C0A2  DD 7E 0E            		ld a,(ix+14)        ; get distance to move.
    6658   00:C0A5  CB 2F               		sra a               ; divide by 2.
    6659   00:C0A7  A7                  		and a               ; any movement required?
    6660   00:C0A8  C8                  		ret z               ; no, not this time.
    6661   00:C0A9  FE 80               		cp 128              ; is it up or down?
    6662   00:C0AB  30 0C               		jr nc,gravu         ; it's up.
    6663   00:C0AD                      gravd:
    6664   00:C0AD  47                  		ld b,a              ; set pixels to move.
    6665   00:C0AE                      gravd0:
    6666   00:C0AE  CD E2 BA            		call cangd          ; can we go down?
    6667   00:C0B1  20 15               		jr nz,gravst        ; can't move down, so stop.
    6668   00:C0B3  DD 34 03            		inc (ix+3)          ; adjust new y coord.
    6669   00:C0B6  10 F6               		djnz gravd0
    6670   00:C0B8  C9                  		ret
    6671   00:C0B9                      gravu:
    6672   00:C0B9  ED 44               		neg                 ; flip the sign so it's positive.
    6673   00:C0BB  47                  		ld b,a              ; set pixels to move.
    6674   00:C0BC                      gravu0:
    6675   00:C0BC  CD C0 BA            		call cangu          ; can we go up?
    6676   00:C0BF  C2 60 C1            		jp nz,ifalls        ; can't move up, go down next.
    6677   00:C0C2  DD 35 03            		dec (ix+3)          ; adjust new y coord.
    6678   00:C0C5  10 F5               		djnz gravu0
    6679   00:C0C7  C9                  		ret
    6680   00:C0C8                      gravst:
    6681   00:C0C8  DD 7E 0E            		ld a,(ix+14)        ; jump pointer high.
    6682   00:C0CB  DD 36 0D 00         		ld (ix+13),0        ; reset falling flag.
    6683   00:C0CF  DD 36 0E 00         		ld (ix+14),0        ; store new speed.
    6684   00:C0D3  FE 08               		cp 8                ; was speed the maximum?
    6685   00:C0D5                      evftf:
    6686   00:C0D5  CA 5A 8A            		jp z,evnt15         ; yes, fallen too far.
    6687   00:C0D8  C9                  		ret
    6688   00:C0D9                      
    6689   00:C0D9                      ; Old gravity processing for compatibility with 4.6 and 4.7.
    6690   00:C0D9                      ;
    6691   00:C0D9                      ogrv:   
    6692   00:C0D9  DD 5E 0E            		ld e,(ix+14)        ; get index to table.
    6693   00:C0DC  16 00               		ld d,0              ; no high byte.
    6694   00:C0DE  21 44 B0            		ld hl,jtab          ; jump table.
    6695   00:C0E1  19                  		add hl,de           ; hl points to jump value.
    6696   00:C0E2  7E                  		ld a,(hl)           ; pixels to move.
    6697   00:C0E3  FE 63               		cp 99               ; reached the end?
    6698   00:C0E5  20 04               		jr nz,ogrv0         ; no, continue.
    6699   00:C0E7  2B                  		dec hl              ; go back to previous value.
    6700   00:C0E8  7E                  		ld a,(hl)           ; fetch that from table.
    6701   00:C0E9  18 03               		jr ogrv1
    6702   00:C0EB  DD 34 0E            ogrv0  inc (ix+14)         ; point to next table entry.
    6703   00:C0EE  A7                  ogrv1  and a               ; any movement required?
    6704   00:C0EF  C8                         ret z               ; no, not this time.
    6705   00:C0F0  FE 80                      cp 128              ; is it up or down?
    6706   00:C0F2  30 0C                      jr nc,ogrvu         ; bigger than 128, it's up.	   
    6707   00:C0F4  47                  ogrvd  ld b,a              ; less than 128, go down. Set pixels to move.
    6708   00:C0F5  CD E2 BA            ogrvd0 call cangd          ; can we go down?
    6709   00:C0F8  20 14                      jr nz,ogrvst        ; can't move down, so stop.
    6710   00:C0FA  DD 34 03                   inc (ix+3)          ; adjust new y coord.
    6711   00:C0FD  10 F6                      djnz ogrvd0
    6712   00:C0FF  C9                         ret	   
    6713   00:C100  ED 44               ogrvu  neg                 ; flip the sign so it's positive.
    6714   00:C102  47                         ld b,a              ; set pixels to move.
    6715   00:C103  CD C0 BA            ogrvu0 call cangu          ; can we go up?
    6716   00:C106  20 1D                      jr nz,ogrv2         ; can't move up, go down next.
    6717   00:C108  DD 35 03                   dec (ix+3)          ; adjust new y coord.
    6718   00:C10B  10 F6                      djnz ogrvu0
    6719   00:C10D  C9                         ret	   
    6720   00:C10E  DD 5E 0E            ogrvst ld e,(ix+14)        ; get index to table.
    6721   00:C111  16 00                      ld d,0              ; no high byte.
    6722   00:C113  21 44 B0                   ld hl,jtab          ; jump table.
    6723   00:C116  19                         add hl,de           ; hl points to jump value.
    6724   00:C117  7E                         ld a,(hl)           ; fetch byte from table.
    6725   00:C118  FE 63                      cp 99               ; is it the end marker?
    6726   00:C11A  DD 36 0D 00                ld (ix+13),0        ; reset jump flag.
    6727   00:C11E  DD 36 0E 00                ld (ix+14),0        ; reset pointer.
    6728   00:C122  C3 D5 C0                   jp evftf	   
    6729   00:C125  21 44 B0            ogrv2  ld hl,jtab          ; jump table.
    6730   00:C128  06 00                      ld b,0              ; offset into table.
    6731   00:C12A  7E                  ogrv4  ld a,(hl)           ; fetch table byte.
    6732   00:C12B  FE 64                      cp 100              ; hit end or downward move?
    6733   00:C12D  38 04                      jr c,ogrv3          ; yes.
    6734   00:C12F  23                         inc hl              ; next byte of table.
    6735   00:C130  04                         inc b               ; next offset.
    6736   00:C131  18 F7                      jr ogrv4            ; keep going until we find crest/end of table.
    6737   00:C133  DD 70 0E            ogrv3  ld (ix+14),b        ; set next table offset.
    6738   00:C136  C9                         ret
    6739   00:C137                      
    6740   00:C137                      ; Initiate fall check.
    6741   00:C137                      ;
    6742   00:C137                      ifall:
    6743   00:C137  DD 7E 0D            		ld a,(ix+13)        ; jump pointer flag.
    6744   00:C13A  A7                  		and a               ; are we in the air?
    6745   00:C13B  C0                  		ret nz              ; if set, we're already in the air.
    6746   00:C13C  DD 66 04            		ld h,(ix+4)         ; y coordinate.
    6747   00:C13F  3E 10               		ld a,16             ; look down 16 pixels.
    6748   00:C141  DD 86 03            		add a,(ix+3)        ; add x coordinate.
    6749   00:C144  6F                  		ld l,a              ; coords in hl.
    6750   00:C145  22 55 40            		ld (dispx),hl       ; set up test coordinates.
    6751   00:C148  CD 9C BB            		call tstbl          ; get map address.
    6752   00:C14B  CD 01 BB            		call plchk          ; block, platform check.
    6753   00:C14E  C0                  		ret nz              ; it's solid, don't fall.
    6754   00:C14F  23                  		inc hl              ; look right one cell.
    6755   00:C150  CD 01 BB            		call plchk          ; block, platform check.
    6756   00:C153  C0                  		ret nz              ; it's solid, don't fall.
    6757   00:C154  3A 56 40            		ld a,(dispy)        ; x coordinate.
    6758   00:C157  E6 07               		and 7               ; position straddling block cells.
    6759   00:C159  28 05               		jr z,ifalls         ; no more checks needed.
    6760   00:C15B  23                  		inc hl              ; look to third cell.
    6761   00:C15C  CD 01 BB            		call plchk          ; block, platform check.
    6762   00:C15F  C0                  		ret nz              ; it's solid, don't fall.
    6763   00:C160                      ifalls:
    6764   00:C160  DD 34 0D            		inc (ix+13)         ; set in air flag.
    6765   00:C163  DD 36 0E 00         		ld (ix+14),0        ; initial speed = 0.
    6766   00:C167  C9                  		ret
    6767   00:C168                      
    6768   00:C168                      tfall:
    6769   00:C168  DD 7E 0D            		ld a,(ix+13)        ; jump pointer flag.
    6770   00:C16B  A7                  		and a               ; are we in the air?
    6771   00:C16C  C0                  		ret nz              ; if set, we're already in the air.
    6772   00:C16D  CD 37 C1            		call ifall          ; do fall test.
    6773   00:C170  DD 7E 0D            		ld a,(ix+13)        ; get falling flag.
    6774   00:C173  A7                  		and a               ; is it set?
    6775   00:C174  C8                  		ret z               ; no.
    6776   00:C175  DD 36 0D FF         		ld (ix+13),255      ; we're using the table.
    6777   00:C179  18 AA               		jr ogrv2            ; find position in table.
    6778   00:C17B                      
    6779   00:C17B                      
    6780   00:C17B                      ; Get frame data for a particular sprite.
    6781   00:C17B                      ;
    6782   00:C17B                      gfrm:
    6783   00:C17B  07                  		rlca                ; multiple of 2.
    6784   00:C17C  2A DD B0            		ld hl,(frmptr)      ; table of sprite frames used by game.
    6785   00:C17F                      		ADD_HL_A
    6785   00:C17F  85                >   add a,l
    6785   00:C180  6F                >   ld l,a
    6785   00:C181  8C                >   adc a,h
    6785   00:C182  95                >   sub l
    6785   00:C183  67                >   ld h,a
    6786   00:C184  C9                  		ret
    6787   00:C185                      
    6788   00:C185                      ; Find sprite list for current room.
    6789   00:C185                      ;
    6790   00:C185                      sprlst:
    6791   00:C185  3A 42 40            		ld a,(scno)         ; screen number.
    6792   00:C188  2A E5 B0            		ld hl,(nmeptr)      ; pointer to enemies.
    6793   00:C18B  47                  		ld b,a              ; loop counter in b register.
    6794   00:C18C  A7                  		and a               ; is it the first screen?
    6795   00:C18D  C8                  		ret z               ; yes, don't need to search data.
    6796   00:C18E  11 05 00            		ld de,NMESIZ        ; bytes to skip.
    6797   00:C191                      .loop:
    6798   00:C191  7E                  		ld a,(hl)           ; fetch type of sprite.
    6799   00:C192  3C                  		inc a               ; is it an end marker?
    6800   00:C193  28 03               		jr z,.nxtscr        ; yes, end of this room.
    6801   00:C195  19                  		add hl,de           ; point to next sprite in list.
    6802   00:C196  18 F9               		jr .loop            ; continue until end of room.
    6803   00:C198                      .nxtscr:
    6804   00:C198  23                  		inc hl              ; point to start of next screen.
    6805   00:C199  10 F6               		djnz .loop          ; continue until room found.
    6806   00:C19B  C9                  		ret
    6807   00:C19C                      
    6808   00:C19C                      ; Clear all but a single player sprite.
    6809   00:C19C                      ;
    6810   00:C19C                      nspr:
    6811   00:C19C  06 20               		ld b,NUMSPR         ; sprite slots in table.
    6812   00:C19E  DD 21 B5 40         		ld ix,sprtab        ; sprite table.
    6813   00:C1A2  11 11 00            		ld de,TABSIZ        ; distance to next odd/even entry.
    6814   00:C1A5                      .loop:
    6815   00:C1A5  DD 7E 00            		ld a,(ix+0)         ; fetch sprite type.
    6816   00:C1A8  A7                  		and a               ; is it a player?
    6817   00:C1A9  28 04               		jr z,.loop1         ; yes, keep this one.
    6818   00:C1AB  DD 36 00 FF         		ld (ix+0),255       ; remove next type.
    6819   00:C1AF                      .loop1:
    6820   00:C1AF  DD 19               		add ix,de           ; next sprite.
    6821   00:C1B1  10 F2               		djnz .loop          ; one less space in the table.
    6822   00:C1B3  C9                  		ret
    6823   00:C1B4                      		
    6824   00:C1B4                      ; Two initialisation routines.
    6825   00:C1B4                      
    6826   00:C1B4                      ; HL is already pointing to start of sprites for this screen (nmedat / SPRITEPOSITIONS)
    6827   00:C1B4                      ; Initialise sprites - copy everything from list to table.
    6828   00:C1B4                      ;
    6829   00:C1B4                      ispr:	
    6830   00:C1B4  AF                  		xor a
    6831   00:C1B5  32 45 40            		ld (nsprite),a		; reset first sprite frame number in VRAM
    6832   00:C1B8  06 20               		ld b,NUMSPR         ; sprite slots in table.
    6833   00:C1BA  DD 21 B5 40         		ld ix,sprtab        ; sprite table.
    6834   00:C1BE                      .loop2:
    6835   00:C1BE  7E                  		ld a,(hl)
    6836   00:C1BF  3C                  		inc a
    6837   00:C1C0  28 14               		jr z,.exit
    6838   00:C1C2                      .loop1:  
    6839   00:C1C2  DD 7E 00            		ld a,(ix+0)         ; next type.
    6840   00:C1C5  3C                  		inc a
    6841   00:C1C6  28 09               		jr z,.copyspr       ; no, process this one.
    6842   00:C1C8  11 11 00            		ld de,TABSIZ        ; distance to next entry.
    6843   00:C1CB  DD 19               		add ix,de           ; next sprite.
    6844   00:C1CD  10 F3               		djnz .loop1         ; repeat for remaining sprites.
    6845   00:C1CF  18 05               		jr .exit
    6846   00:C1D1                      .copyspr:
    6847   00:C1D1  CD 13 C2            		call cpsp           ; initialise a sprite.
    6848   00:C1D4  10 E8               		djnz .loop2         ; one less space in the table.
    6849   00:C1D6                      .exit:
    6850   00:C1D6  C3 B2 B8            		jp hslot
    6851   00:C1D9                      
    6852   00:C1D9                      ; HL is already pointing to start of sprites for this screen (nmedat)		
    6853   00:C1D9                      ; Initialise sprites - but not player, we're keeping the old one.
    6854   00:C1D9                      ;
    6855   00:C1D9                      kspr:	
    6856   00:C1D9  AF                  		xor a
    6857   00:C1DA  32 45 40            		ld (nsprite),a		; reset first sprite frame number in VRAM		
    6858   00:C1DD  EB                  		ex de,hl
    6859   00:C1DE  CD 57 BE            		call dissprs		; hide all sprites
    6860   00:C1E1  EB                  		ex de,hl		
    6861   00:C1E2  06 20               		ld b,NUMSPR         ; sprite slots in table.
    6862   00:C1E4  DD 21 B5 40         		ld ix,sprtab        ; sprite table.
    6863   00:C1E8                      .loop2:  
    6864   00:C1E8  7E                  		ld a,(hl)           ; fetch byte.
    6865   00:C1E9  FE FF               		cp 255              ; is it an end marker?
    6866   00:C1EB  28 23               		jr z,.exit          ; yes, no more to do.
    6867   00:C1ED  A7                  		and a               ; is it a player sprite?
    6868   00:C1EE  20 0C               		jr nz,.loop1        ; no, add to table as normal.		
    6869   00:C1F0  23                  		inc hl
    6870   00:C1F1  7E                  		ld a,(hl)			; sprite image number from SPRITEPOSITIONS
    6871   00:C1F2  CD 51 C2            		call mapsprite		; no player set but sprite pattern mapped to VRAM
    6872   00:C1F5  2B                  		dec hl		
    6873   00:C1F6  11 05 00            		ld de,NMESIZ        ; distance to next item in list.
    6874   00:C1F9  19                  		add hl,de           ; point to next one.
    6875   00:C1FA  18 EC               		jr .loop2
    6876   00:C1FC                      .loop1:
    6877   00:C1FC  DD 7E 00            		ld a,(ix+0)         ; next type.
    6878   00:C1FF  3C                  		inc a               ; is it enabled yet?
    6879   00:C200  28 09               		jr z,.copyspr       ; no, process this one.
    6880   00:C202  11 11 00            		ld de,TABSIZ        ; distance to next odd/even entry.
    6881   00:C205  DD 19               		add ix,de           ; next sprite.
    6882   00:C207  10 F3               		djnz .loop1         ; repeat for remaining sprites.
    6883   00:C209  18 05               		jr .exit            ; no more room in table.
    6884   00:C20B                      .copyspr:
    6885   00:C20B  CD 13 C2            		call cpsp           ; copy sprite to table.
    6886   00:C20E  10 D8               		djnz .loop2         ; one less space in the table.
    6887   00:C210                      .exit:
    6888   00:C210  C3 B2 B8            		jp hslot
    6889   00:C213                      
    6890   00:C213                      ; Copy sprite from list to table.
    6891   00:C213                      
    6892   00:C213                      cpsp:
    6893   00:C213  7E                  		ld a,(hl)           ; fetch byte from table.
    6894   00:C214  DD 77 00            		ld (ix+0),a         ; set up type.
    6895   00:C217  23                  		inc hl              ; move to next byte.
    6896   00:C218  7E                  		ld a,(hl)           ; fetch byte from table.
    6897   00:C219  DD 77 01            		ld (ix+1),a         ; set up sprite number.		
    6898   00:C21C  23                  		inc hl              ; move to next byte.
    6899   00:C21D  CD 51 C2            		call mapsprite		; remaps RAM sprite number in A to a new VRAM sprite
    6900   00:C220  7E                  		ld a,(hl)           ; fetch byte from table (color).
    6901   00:C221  DD 77 05            		ld (ix+5),a         ; set up color.
    6902   00:C224  23                  		inc hl              ; move to next byte.
    6903   00:C225  7E                  		ld a,(hl)           ; fetch byte from table.
    6904   00:C226  DD 77 03            		ld (ix+3),a         ; set up coordinate.
    6905   00:C229  23                  		inc hl              ; move to next byte.
    6906   00:C22A  7E                  		ld a,(hl)           ; fetch byte from table.
    6907   00:C22B  DD 77 04            		ld (ix+4),a         ; set up coordinate.
    6908   00:C22E  23                  		inc hl		
    6909   00:C22F  AF                  		xor a               ; zeroes in accumulator.
    6910   00:C230  DD 77 02            		ld (ix+2),a         ; reset frame number.
    6911   00:C233  DD 77 0A            		ld (ix+10),a        ; reset direction.
    6912   00:C236  DD 77 0D            		ld (ix+13),a        ; reset jump pointer low.
    6913   00:C239  DD 77 0E            		ld (ix+14),a        ; reset jump pointer high.
    6914   00:C23C  DD 36 10 FF         		ld (ix+16),255      ; reset data pointer to auto-restore.
    6915   00:C240  DD E5               		push ix             ; store ix pair.
    6916   00:C242  E5                  		push hl             ; store hl pair.
    6917   00:C243  C5                  		push bc
    6918   00:C244  CD D7 87            		call evnt09         ; perform event.
    6919   00:C247  C1                  		pop bc
    6920   00:C248  E1                  		pop hl              ; restore hl.
    6921   00:C249  DD E1               		pop ix              ; restore ix.
    6922   00:C24B  11 11 00            		ld de,TABSIZ        ; distance to next entry.
    6923   00:C24E  DD 19               		add ix,de           ; next sprite.
    6924   00:C250  C9                  		ret
    6925   00:C251                      
    6926   00:C251                      		; A=image number from SPRITEPOSITION
    6927   00:C251                      mapsprite:					; initialize mapspr table
    6928   00:C251  E5                  		push hl
    6929   00:C252  C5                  		push bc
    6930   00:C253  CD 7B C1            		call gfrm			; HL = real sprite frames pointer in RAM for sprite number A
    6931   00:C256  7E                  		ld a,(hl)			; get real frame in RAM
    6932   00:C257  E6 7F               		and 127				; maximum 128 frames in RAM (correct?)
    6933   00:C259  5F                  		ld e,a
    6934   00:C25A  16 4D               		ld d,mapspr>>8		
    6935   00:C25C  1A                  		ld a,(de)
    6936   00:C25D  3C                  		inc a
    6937   00:C25E  20 19               		jr nz,nomap
    6938   00:C260  3A 45 40            		ld a,(nsprite)		; gets available sprite frame pointer
    6939   00:C263  12                  		ld (de),a			; maps this to the old image from SPRITEPOSITION
    6940   00:C264  23                  		inc hl
    6941   00:C265  86                  		add a,(hl)			; next sprite frame available after adding frames size
    6942   00:C266  32 45 40            		ld (nsprite),a		; stores it as new available sprite frame
    6943   00:C269  2B                  		dec hl				; restore HL pointer to start of frmlst
    6944   00:C26A  CD 7C C2            		call spradr			; HL = sprite frame list position, DE = pointer to actual sprite frame in VRAM, BC = lenght of data		
    6945   00:C26D  CD 96 C7            		call MSX_SETWRT
    6946   00:C270  EB                  		ex de,hl			; HL = sprite RAM data address, DE = spriVte RAM data address, BC = lenght of data
    6947   00:C271                      nxtsprbyt:		
    6948   00:C271  7E                  		ld a,(hl)
    6949   00:C272  D3 BE               		out (MSX_VDPDRW),a
    6950   00:C274  ED A1               		cpi					; 18
    6951   00:C276  EA 71 C2            		jp pe,nxtsprbyt		; 11 = 29
    6952   00:C279                      nomap:		
    6953   00:C279  C1                  		pop bc
    6954   00:C27A  E1                  		pop hl
    6955   00:C27B  C9                  		ret
    6956   00:C27C                      		
    6957   00:C27C                      ; Inputs
    6958   00:C27C                      ; HL = sprite frame list position
    6959   00:C27C                      ; DE = pointer to actual sprite frame in VRAM
    6960   00:C27C                      spradr:
    6961   00:C27C  7E                  		ld a,(hl)			; get initial image frame in RAM
    6962   00:C27D  CD 91 C2            		call mult32			; BC= A * 32
    6963   00:C280  23                  		inc hl				; next frmlst position (num framesS)
    6964   00:C281  7E                  		ld a,(hl)			; get num frames		
    6965   00:C282  08                  		ex af,af			; saves num frames
    6966   00:C283  21 E1 9E            		ld hl,sprgfx
    6967   00:C286  09                  		add hl,bc			; HL = sprite RAM data address
    6968   00:C287  1A                  		ld a,(de)			; gets destination VRAM sprite frame
    6969   00:C288  EB                  		ex de,hl			; DE = now sprite RAM source data address
    6970   00:C289  CD 91 C2            		call mult32		
    6971   00:C28C  21 00 38            		ld hl,MSX_SPRTBL
    6972   00:C28F  09                  		add hl,bc			; HL = sprite VRAM destination data address
    6973   00:C290  08                  		ex af,af			; restore num frames		
    6974   00:C291                      mult32:		
    6975   00:C291  0F                  		rrca                
    6976   00:C292  0F                  		rrca
    6977   00:C293  0F                  		rrca
    6978   00:C294  4F                  		ld c,a              
    6979   00:C295  E6 1F               		and $1F              
    6980   00:C297  47                  		ld b,a              
    6981   00:C298  79                  		ld a,c              
    6982   00:C299  E6 E0               		and $E0             
    6983   00:C29B  4F                  		ld c,a				; BC = A * 32		
    6984   00:C29C  C9                  		ret
    6985   00:C29D                      
    6986   00:C29D                      	if OFLAG
    6987   00:C29D                      	
    6988   00:C29D                      clrobjlst:
    6989   00:C29D  21 00 49            		ld hl,objlist
    6990   00:C2A0  0E 01               		ld c,1     			; 1 * 256 bytes
    6991   00:C2A2  3E FF               		ld a,255			; fill value
    6992   00:C2A4  C3 AE C2            		jp fastfill
    6993   00:C2A7                      	
    6994   00:C2A7                      	endif
    6995   00:C2A7                      		
    6996   00:C2A7                      clrscrmap:
    6997   00:C2A7  21 00 4A            		ld hl,scrmap
    6998   00:C2AA  0E 03               		ld c,3     			; 3 * 256 bytes
    6999   00:C2AC  3E FF               		ld a,255			; fill value
    7000   00:C2AE                      ;
    7001   00:C2AE                      ; fast fills RAM areas starting in addresses multiple of 4 
    7002   00:C2AE                      ; Input:	C=number of 256 bytes blocks to fill
    7003   00:C2AE                      ;			HL=starting address
    7004   00:C2AE                      ;			A=byte for fill			
    7005   00:C2AE                      ;
    7006   00:C2AE                      fastfill:
    7007   00:C2AE  06 40               		ld b,64              ;set B to 64 (64 * 4 sets = 256 bytes initiaized)
    7008   00:C2B0                      .loop1:
    7009   00:C2B0  77                  		ld (hl), a           ;set byte to 255
    7010   00:C2B1  2C                  		inc l                ;move to the next byte
    7011   00:C2B2  77                  		ld (hl), a
    7012   00:C2B3  2C                  		inc l
    7013   00:C2B4  77                  		ld (hl), a
    7014   00:C2B5  2C                  		inc l
    7015   00:C2B6  77                  		ld (hl), a
    7016   00:C2B7  23                  		inc hl               ;this time we are not sure that inc l will not cause overflow
    7017   00:C2B8  10 F6               		djnz .loop1          ;repeat for next 4 bytes
    7018   00:C2BA  0D                  		dec c
    7019   00:C2BB  20 F1               		jr nz,fastfill       ;outer loop. repeat for next c*256 bytes.
    7020   00:C2BD  C9                  		ret		
    7021   00:C2BE                      	 
    7022   00:C2BE                      ; Clear the play area window.
    7023   00:C2BE                      
    7024   00:C2BE                      clw:
    7025   00:C2BE                      	if PFLAG
    7026   00:C2BE                      	
    7027   00:C2BE  CD 26 B5            		call inishr
    7028   00:C2C1                      		
    7029   00:C2C1                      	endif
    7030   00:C2C1                      	
    7031   00:C2C1  2A 94 40            		ld hl,(wintop)
    7032   00:C2C4  22 55 40            		ld (dispx),hl
    7033   00:C2C7  CD 87 B9            		call gprad          ; get print address in DE.
    7034   00:C2CA  EB                  		ex de,hl
    7035   00:C2CB  3A 96 40            		ld a,(winhgt)       ; height of window.
    7036   00:C2CE  47                  		ld b,a
    7037   00:C2CF  3A 97 40            		ld a,(winwid)
    7038   00:C2D2  87                  		add a,a
    7039   00:C2D3  87                  		add a,a
    7040   00:C2D4  87                  		add a,a
    7041   00:C2D5  4F                  		ld c,a
    7042   00:C2D6                      .loop3   
    7043   00:C2D6  CD 96 C7            		call MSX_SETWRT
    7044   00:C2D9  C5                  		push bc
    7045   00:C2DA  AF                  		xor a
    7046   00:C2DB                      .loop1:
    7047   00:C2DB  D3 BE               		out (MSX_VDPDRW),a
    7048   00:C2DD  0D                  		dec c
    7049   00:C2DE  20 FB               		jr nz,.loop1
    7050   00:C2E0  CB EC               		set 5,h
    7051   00:C2E2  CD 96 C7            		call MSX_SETWRT
    7052   00:C2E5  C1                  		pop bc
    7053   00:C2E6  C5                  		push bc
    7054   00:C2E7  3A 39 40            		ld a,(clratt)
    7055   00:C2EA                      .loop2:
    7056   00:C2EA  D3 BE               		out (MSX_VDPDRW),a
    7057   00:C2EC  0D                  		dec c
    7058   00:C2ED  20 FB               		jr nz,.loop2
    7059   00:C2EF  C1                  		pop bc
    7060   00:C2F0  CB AC               		res 5,h
    7061   00:C2F2  24                  		inc h
    7062   00:C2F3  10 E1               		djnz .loop3
    7063   00:C2F5  2A 94 40            		ld hl,(wintop)      ; get coordinates of window.
    7064   00:C2F8  22 35 40            		ld (charx),hl       ; put into display position.
    7065   00:C2FB  CD A7 C2            		call clrscrmap
    7066   00:C2FE  C3 57 BE            		jp dissprs
    7067   00:C301                      
    7068   00:C301                      
    7069   00:C301                      	if SFLAG
    7070   00:C301                    ~ 	
    7071   00:C301                    ~ ; Effects code.
    7072   00:C301                    ~ ; Ticker routine is called 25 times per second (MSX:50fps).
    7073   00:C301                    ~ 
    7074   00:C301                    ~ scrly:
    7075   00:C301                    ~  	ifdef DEBUG
    7076   00:C301                    ~ 		BORDER 7
    7077   00:C301                    ~ 	endif
    7078   00:C301                    ~ 		ld a,(scrlyoff)
    7079   00:C301                    ~ 		or a
    7080   00:C301                    ~ 		ret nz
    7081   00:C301                    ~ 		ld hl,scrbuf
    7082   00:C301                    ~ 		ld de,(txtbeg)         ; get screen address.
    7083   00:C301                    ~ 		ld a,(txtwid)       
    7084   00:C301                    ~ 		add a,a
    7085   00:C301                    ~ 		add a,a
    7086   00:C301                    ~ 		add a,a					; characters*8 wide.
    7087   00:C301                    ~ 		ld b,a
    7088   00:C301                    ~ 		ifdef FASTVRAMDUMP
    7089   00:C301                    ~ 		call ram2vram
    7090   00:C301                    ~ 		else
    7091   00:C301                    ~ 		call ram2vram_slow
    7092   00:C301                    ~ 		endif
    7093   00:C301                    ~  	ifdef DEBUG
    7094   00:C301                    ~ 		BORDER 14
    7095   00:C301                    ~ 	endif
    7096   00:C301                    ~ 		ret
    7097   00:C301                    ~ 		
    7098   00:C301                    ~ scrltxt:
    7099   00:C301                    ~  	ifdef DEBUG
    7100   00:C301                    ~ 		BORDER 2
    7101   00:C301                    ~ 	endif
    7102   00:C301                    ~ 		ld a,(scrlyoff)
    7103   00:C301                    ~ 		or a
    7104   00:C301                    ~ 		ret nz
    7105   00:C301                    ~ 		
    7106   00:C301                    ~ 		ld a,(txtbit)
    7107   00:C301                    ~ 		rlca
    7108   00:C301                    ~ 		jr nc,.nonewchr
    7109   00:C301                    ~ 		
    7110   00:C301                    ~ 		ld hl,(txtpos)      ; get text pointer.
    7111   00:C301                    ~ 		ld a,(hl)           ; find character we're displaying.
    7112   00:C301                    ~ 		push hl
    7113   00:C301                    ~ 		and 127             ; remove end marker bit if applicable.
    7114   00:C301                    ~ 		cp 13               ; is it newline?
    7115   00:C301                    ~ 		jr nz,.scrly5       ; no, it's okay.
    7116   00:C301                    ~ 		ld a,32             ; convert to a space instead.
    7117   00:C301                    ~ .scrly5:
    7118   00:C301                    ~ 		rlca
    7119   00:C301                    ~ 		rlca
    7120   00:C301                    ~ 		rlca                ; multiply by 8 to find char.
    7121   00:C301                    ~ 		ld b,a              ; store shift in b.
    7122   00:C301                    ~ 		and 3               ; keep within 768-byte range of font.
    7123   00:C301                    ~ 		ld d,a              ; that's our high byte.
    7124   00:C301                    ~ 		ld a,b              ; restore the shift.
    7125   00:C301                    ~ 		and 248
    7126   00:C301                    ~ 		ld e,a
    7127   00:C301                    ~ 		ld hl,font-256      ; font.
    7128   00:C301                    ~ 		add hl,de           ; point to image of character.
    7129   00:C301                    ~ 		ld de,(txtend)
    7130   00:C301                    ~ 		ld bc,8
    7131   00:C301                    ~ 		ldir
    7132   00:C301                    ~ 		pop hl
    7133   00:C301                    ~ 		ld a,(hl)
    7134   00:C301                    ~ 		inc hl
    7135   00:C301                    ~ 		rla
    7136   00:C301                    ~ 		jr nc,.scrly6        ; not yet - continue.
    7137   00:C301                    ~ .scrly4:
    7138   00:C301                    ~ 		ld hl,(txtini)      ; start of scrolling message.		
    7139   00:C301                    ~ .scrly6:
    7140   00:C301                    ~ 		ld (txtpos),hl      ; new text pointer position.
    7141   00:C301                    ~ 		ld a,1
    7142   00:C301                    ~ .nonewchr:
    7143   00:C301                    ~ 		ld (txtbit),a
    7144   00:C301                    ~ 
    7145   00:C301                    ~ 		; Scroll a char row
    7146   00:C301                    ~ 		ld hl,(txtend)
    7147   00:C301                    ~ 		ld d,254
    7148   00:C301                    ~ 		ld c,8
    7149   00:C301                    ~ 		ld a,(txtwid)       ; characters wide.
    7150   00:C301                    ~ 		inc a
    7151   00:C301                    ~ 		ld b,a              ; put into the loop counter.
    7152   00:C301                    ~ .rowloop:
    7153   00:C301                    ~ 		push bc
    7154   00:C301                    ~ 		push hl
    7155   00:C301                    ~ 		ld c,0
    7156   00:C301                    ~ .colloop:	   
    7157   00:C301                    ~ 		ld a,(hl)
    7158   00:C301                    ~ 		rlca
    7159   00:C301                    ~ 		ld e,a
    7160   00:C301                    ~ 		and d
    7161   00:C301                    ~ 		or c
    7162   00:C301                    ~ 		ld (hl),a
    7163   00:C301                    ~ 		ld a,e
    7164   00:C301                    ~ 		and 1
    7165   00:C301                    ~ 		ld c,a
    7166   00:C301                    ~ 		
    7167   00:C301                    ~ 		ld a,l
    7168   00:C301                    ~ 		sub 8
    7169   00:C301                    ~ 		jr nc,$+3
    7170   00:C301                    ~ 		dec	h
    7171   00:C301                    ~ 		ld l,a
    7172   00:C301                    ~ 
    7173   00:C301                    ~ 		djnz .colloop
    7174   00:C301                    ~ 		pop hl
    7175   00:C301                    ~ 		inc l
    7176   00:C301                    ~ 		pop bc
    7177   00:C301                    ~ 		dec c
    7178   00:C301                    ~ 		jr nz,.rowloop
    7179   00:C301                    ~ 		
    7180   00:C301                    ~  		ifdef DEBUG
    7181   00:C301                    ~ 		BORDER 14
    7182   00:C301                    ~ 		endif
    7183   00:C301                    ~ 		ret
    7184   00:C301                    ~ 				
    7185   00:C301                    ~ 	   ; bc= width*256+msg.number
    7186   00:C301                    ~ iscrly: 
    7187   00:C301                    ~ 		call prescr         ; set up display position.
    7188   00:C301                    ~ 		ld a,b              ; width.
    7189   00:C301                    ~ 		dec a               ; subtract one.
    7190   00:C301                    ~ 		cp MSX_MAXCOLS      ; is it between 1 and 32?
    7191   00:C301                    ~ 		ret nc              ; TODO:no, disable messages.
    7192   00:C301                    ~ 		ld d,b
    7193   00:C301                    ~ 		ld a,c              ; message number.
    7194   00:C301                    ~ 		ld hl,msgdat        ; text messages.
    7195   00:C301                    ~ 		call getwrd         ; find message start.
    7196   00:C301                    ~ 		ld (txtini),hl      ; set initial text position.
    7197   00:C301                    ~ 		ld (txtpos),hl      ; set initial text position.
    7198   00:C301                    ~ 		ld a,d
    7199   00:C301                    ~ 		ld (txtwid),a
    7200   00:C301                    ~ 		add a,a
    7201   00:C301                    ~ 		add a,a
    7202   00:C301                    ~ 		add a,a				; *8
    7203   00:C301                    ~ 		ld c,a
    7204   00:C301                    ~ 		ld b,0
    7205   00:C301                    ~ 		jr nc,.nocarry
    7206   00:C301                    ~ 		inc b
    7207   00:C301                    ~ .nocarry:		
    7208   00:C301                    ~ 		call gprad          ; get hires print address in DE.
    7209   00:C301                    ~ 		ld (txtbeg),de
    7210   00:C301                    ~ 		ld hl,scrbuf
    7211   00:C301                    ~ 		ex de,hl
    7212   00:C301                    ~ 		call MSX_LDIRMV
    7213   00:C301                    ~ 		ld (txtend),de      ; set text screen address.
    7214   00:C301                    ~         ld a,128
    7215   00:C301                    ~         ld (txtbit),a
    7216   00:C301                    ~ 		xor a	
    7217   00:C301                    ~ 		ld (scrlyoff),a 
    7218   00:C301                    ~         ret
    7219   00:C301                    ~ 
    7220   00:C301                    ~ 	endif
    7221   00:C301                      
    7222   00:C301                      
    7223   00:C301                      	if DFLAG
    7224   00:C301                    ~ 
    7225   00:C301                    ~ dig:
    7226   00:C301                    ~        and 3
    7227   00:C301                    ~        jr z,digl
    7228   00:C301                    ~        dec a
    7229   00:C301                    ~        jr z,digr
    7230   00:C301                    ~        dec a
    7231   00:C301                    ~        jr z,digu
    7232   00:C301                    ~        ld h,(ix+4)
    7233   00:C301                    ~        ld a,16
    7234   00:C301                    ~        add a,(ix+3)
    7235   00:C301                    ~        ld l,a
    7236   00:C301                    ~        jr digv
    7237   00:C301                    ~ digu   ld a,(ix+3)
    7238   00:C301                    ~        ld h,(ix+4)
    7239   00:C301                    ~        sub 2
    7240   00:C301                    ~        ld l,a
    7241   00:C301                    ~ digv   ld (dispx),hl
    7242   00:C301                    ~        call tstbl
    7243   00:C301                    ~        call fdchk
    7244   00:C301                    ~        inc hl
    7245   00:C301                    ~        call fdchk
    7246   00:C301                    ~        ld a,(dispy)
    7247   00:C301                    ~        and 7
    7248   00:C301                    ~        ret z
    7249   00:C301                    ~        inc hl
    7250   00:C301                    ~        jp fdchk
    7251   00:C301                    ~ digl   ld l,(ix+3)
    7252   00:C301                    ~        ld a,(ix+4)
    7253   00:C301                    ~        sub 2
    7254   00:C301                    ~        ld h,a
    7255   00:C301                    ~ digh   ld (dispx),hl
    7256   00:C301                    ~        ld a,l
    7257   00:C301                    ~        and 7
    7258   00:C301                    ~        ld a,3
    7259   00:C301                    ~        jr nz,digh1
    7260   00:C301                    ~        dec a
    7261   00:C301                    ~ digh1  ld b,a
    7262   00:C301                    ~        call tstbl
    7263   00:C301                    ~ digh0  push bc
    7264   00:C301                    ~        call fdchk
    7265   00:C301                    ~        ld de,MSX_MAXCOLS
    7266   00:C301                    ~        add hl,de
    7267   00:C301                    ~        pop bc
    7268   00:C301                    ~        djnz digh0
    7269   00:C301                    ~        ret
    7270   00:C301                    ~ digr   ld l,(ix+3)
    7271   00:C301                    ~        ld a,(ix+4)
    7272   00:C301                    ~        add a,16
    7273   00:C301                    ~        ld h,a
    7274   00:C301                    ~        jr digh 
    7275   00:C301                    ~ 
    7276   00:C301                    ~ 	endif
    7277   00:C301                      
    7278   00:C301                      	if CRFLAG
    7279   00:C301                    ~ 
    7280   00:C301                    ~ ;
    7281   00:C301                    ~ ; Crumbling blocks routine
    7282   00:C301                    ~ ; Input:	None
    7283   00:C301                    ~ ; Output:	None
    7284   00:C301                    ~ ; Modifies: AF,BC,HL,DE
    7285   00:C301                    ~ ;
    7286   00:C301                    ~ 
    7287   00:C301                    ~ crumble:	
    7288   00:C301                    ~  		ld a,(frmno)
    7289   00:C301                    ~ 		and CRUMBLING_SPEED
    7290   00:C301                    ~ 		ret nz				; executed only every 1/8 of frames		
    7291   00:C301                    ~ 		ld h,(ix+4)			; x coordinate
    7292   00:C301                    ~ 		ld a,(ix+3)			; y coordinate
    7293   00:C301                    ~ 		add a,16
    7294   00:C301                    ~ 		ld l,a
    7295   00:C301                    ~ 		ld (dispx),hl		
    7296   00:C301                    ~ 		and 6
    7297   00:C301                    ~ 		ret nz
    7298   00:C301                    ~ 		call gp2tp			; dispx/y now has text coords
    7299   00:C301                    ~ 		call pradd
    7300   00:C301                    ~ 		ld de,scrmap
    7301   00:C301                    ~ 		add hl,de	
    7302   00:C301                    ~ 		ex de,hl
    7303   00:C301                    ~ 		ld hl,dispy
    7304   00:C301                    ~ 		ld a,(de)
    7305   00:C301                    ~ 		cp 9
    7306   00:C301                    ~ 		call nc,.crumb
    7307   00:C301                    ~ 		inc (hl)
    7308   00:C301                    ~ 		inc de
    7309   00:C301                    ~ 		ld a,(de)
    7310   00:C301                    ~ 		cp 9
    7311   00:C301                    ~ 		call nc,.crumb
    7312   00:C301                    ~ 		inc (hl)
    7313   00:C301                    ~ 		inc de
    7314   00:C301                    ~ 		ld a,(ix+4)			; get x coord
    7315   00:C301                    ~ 		and 7				; multiple of 8?
    7316   00:C301                    ~ 		ret z				; return (only two blocks crumb) 
    7317   00:C301                    ~ 		ld a,(de)
    7318   00:C301                    ~ 		cp 9
    7319   00:C301                    ~ 		ret c
    7320   00:C301                    ~ .crumb:	
    7321   00:C301                    ~ 		push de
    7322   00:C301                    ~ 		inc a
    7323   00:C301                    ~ 		cp 17
    7324   00:C301                    ~ 		jr c,.noblank		; if block < 17, update it 
    7325   00:C301                    ~ 		xor a				; else, empty block
    7326   00:C301                    ~ .noblank:
    7327   00:C301                    ~ 		call pattr
    7328   00:C301                    ~ 		dec (hl)			; undo x+1 position
    7329   00:C301                    ~ 		pop de
    7330   00:C301                    ~ 		ret
    7331   00:C301                    ~ 
    7332   00:C301                    ~ 	endif
    7333   00:C301                      
    7334   00:C301                      	if RTFLAG
    7335   00:C301                    ~ 	
    7336   00:C301                    ~ ; User routine for rotational controls.
    7337   00:C301                    ~ ; To use, set up the angle (0-255) of travel in DIRECTION, then call THRUST with a single parameter for speed (eg THRUST 4).
    7338   00:C301                    ~ ; This routine uses AIRBORNE and JUMPHEIGHT to store fractional coordinates but leaves SETTINGA and SETTINGB free. 
    7339   00:C301                    ~ ; Jonathan Cauldwell, 22nd October 2020.
    7340   00:C301                    ~ 
    7341   00:C301                    ~ thrust:
    7342   00:C301                    ~ 		ld b,a                      ; speed in b for now.
    7343   00:C301                    ~ 		ld (usrspd),a               ; store speed.
    7344   00:C301                    ~ 		ld l,(ix+13)                ; y fraction.
    7345   00:C301                    ~ 		ld h,(ix+14)                ; x fraction.
    7346   00:C301                    ~ 		push hl                     ; store old fractions.
    7347   00:C301                    ~ 
    7348   00:C301                    ~ 		/*
    7349   00:C301                    ~ 		ld h,(sintab>>8)&$FF
    7350   00:C301                    ~ 		ld l,(ix+10)
    7351   00:C301                    ~ 		ld a,(hl)
    7352   00:C301                    ~ 		*/
    7353   00:C301                    ~ 		
    7354   00:C301                    ~ 		ld hl,sintab                ; sine table.
    7355   00:C301                    ~ 		ld e,(ix+10)                ; direction.
    7356   00:C301                    ~ 		ld d,0                      ; no high byte.
    7357   00:C301                    ~ 		add hl,de                   ; point to entry.
    7358   00:C301                    ~ 		ld a,(hl)                   ; get the sine.
    7359   00:C301                    ~ 
    7360   00:C301                    ~ 		ld (usrsgn),a               ; store sign.
    7361   00:C301                    ~ 		and 127                     ; remove sign.
    7362   00:C301                    ~ 		ld h,a                      ; copy to first multiplier.
    7363   00:C301                    ~ 		ld d,b                      ; get speed.
    7364   00:C301                    ~ 		call imul                   ; multiply together.
    7365   00:C301                    ~ 		ld e,(ix+13)                ; y fraction.
    7366   00:C301                    ~ 		ld d,(ix+3)                 ; y integer.
    7367   00:C301                    ~ 		ld a,(usrsgn)               ; get sign.
    7368   00:C301                    ~ 		rla                         ; is it negative?
    7369   00:C301                    ~ 		jr nc,thrust0               ; yes.
    7370   00:C301                    ~ 		add hl,de                   ; just add.
    7371   00:C301                    ~ 		jr thrust1                  ; skip subtraction.
    7372   00:C301                    ~ thrust0:
    7373   00:C301                    ~ 		ex de,hl                    ; inertia in hl, force in de.
    7374   00:C301                    ~ 		sbc hl,de                   ; subtract force.
    7375   00:C301                    ~ thrust1:
    7376   00:C301                    ~ 		ld (ix+3),h                 ; set integer.
    7377   00:C301                    ~ 		ld (ix+13),l                ; set fraction.
    7378   00:C301                    ~ 		ld a,(ix+10)                ; direction.
    7379   00:C301                    ~ 		add a,64                    ; shift 90 degrees to get cosine.
    7380   00:C301                    ~ 		
    7381   00:C301                    ~ 		
    7382   00:C301                    ~ 		/*
    7383   00:C301                    ~ 		ld h,(sintab>>8)&$FF
    7384   00:C301                    ~ 		ld l,a
    7385   00:C301                    ~ 		ld a,(hl)
    7386   00:C301                    ~ 		*/
    7387   00:C301                    ~ 		
    7388   00:C301                    ~ 		ld e,a                      ; displacement to value.
    7389   00:C301                    ~ 		ld d,0                      ; no high byte.
    7390   00:C301                    ~ 		ld hl,sintab                ; sine table.
    7391   00:C301                    ~ 		add hl,de                   ; point to entry.
    7392   00:C301                    ~ 		ld a,(hl)                   ; get the cosine.
    7393   00:C301                    ~ 		
    7394   00:C301                    ~ 		ld (usrsgn),a               ; store sign.
    7395   00:C301                    ~ 		and 127                     ; remove sign.
    7396   00:C301                    ~ 		ld h,a                      ; copy to first multiplier.
    7397   00:C301                    ~ 		ld a,(usrspd)               ; get speed.
    7398   00:C301                    ~ 		ld d,a                      ; second multiplier.
    7399   00:C301                    ~ 		call imul                   ; multiply together.
    7400   00:C301                    ~ 		ld e,(ix+14)                ; x fraction.
    7401   00:C301                    ~ 		ld d,(ix+4)                 ; x integer.
    7402   00:C301                    ~ 		ld a,(usrsgn)               ; get sign.
    7403   00:C301                    ~ 		rla                         ; is it negative?
    7404   00:C301                    ~ 		jr nc,thrust2               ; yes.
    7405   00:C301                    ~ 		add hl,de                   ; just add.
    7406   00:C301                    ~ 		jr thrust3                  ; skip subtraction.
    7407   00:C301                    ~ thrust2:
    7408   00:C301                    ~ 		ex de,hl                    ; inertia in hl, force in de.
    7409   00:C301                    ~ 		sbc hl,de                   ; subtract force.
    7410   00:C301                    ~ thrust3:
    7411   00:C301                    ~ 		ld (ix+4),h                 ; x set integer.
    7412   00:C301                    ~ 		ld (ix+14),l                ; x set fraction.
    7413   00:C301                    ~ 		ld a,4                      ; displacement.
    7414   00:C301                    ~ 		add a,h                     ; add to integer.
    7415   00:C301                    ~ 		ld h,a                      ; set horizontal.
    7416   00:C301                    ~ 		ld a,(ix+3)                 ; get y.
    7417   00:C301                    ~ 		add a,4                     ; add displacement.
    7418   00:C301                    ~ 		ld l,a                      ; copy to second coordinate register.
    7419   00:C301                    ~ 		ld (dispx),hl               ; set coordinates to find.
    7420   00:C301                    ~ 		call tstbl                  ; check block.
    7421   00:C301                    ~ 		ld b,2                      ; cells to test vertically.
    7422   00:C301                    ~ 		ld de,MSX_MAXCOLS-1         ; distance between cell lines minus one.
    7423   00:C301                    ~ thrust5:
    7424   00:C301                    ~ 		ld a,(hl)                   ; get block there.
    7425   00:C301                    ~ 		cp WALL                     ; is it a wall?
    7426   00:C301                    ~ 		jr z,thrust4                ; yes, can't move there.
    7427   00:C301                    ~ 		inc l                       ; next cell.
    7428   00:C301                    ~ 		ld a,(hl)                   ; get block there.
    7429   00:C301                    ~ 		cp WALL                     ; is it a wall?
    7430   00:C301                    ~ 		jr z,thrust4                ; yes, can't move there.
    7431   00:C301                    ~ 		add hl,de                   ; next row down.
    7432   00:C301                    ~ 		djnz thrust5                ; repeat for all rows.
    7433   00:C301                    ~ 		pop hl                      ; restore old fractions.
    7434   00:C301                    ~ 		ret
    7435   00:C301                    ~ thrust4:
    7436   00:C301                    ~ 		pop hl                      ; restore old fractions.
    7437   00:C301                    ~ 		ld (ix+13),l                ; reset y.
    7438   00:C301                    ~ 		ld (ix+14),h                ; reset x.
    7439   00:C301                    ~ 		ld a,(ix+8)                 ; previous y.
    7440   00:C301                    ~ 		ld (ix+3),a                 ; restore it.
    7441   00:C301                    ~ 		ld a,(ix+9)                 ; previous x.
    7442   00:C301                    ~ 		ld (ix+4),a                 ; restore that too.
    7443   00:C301                    ~ 		ret
    7444   00:C301                    ~ 	   
    7445   00:C301                    ~ sintab:
    7446   00:C301                    ~ 		db 0,3,6,9,12,15,18,21,24,27,30,33,36,39,42,45
    7447   00:C301                    ~ 		db 48,51,54,57,59,62,65,67,70,73,75,78,80,82,85,87
    7448   00:C301                    ~ 		db 89,91,94,96,98,100,102,103,105,107,108,110,112,113,114,116
    7449   00:C301                    ~ 		db 117,118,119,120,121,122,123,123,124,125,125,126,126,126,126,126
    7450   00:C301                    ~ 		db 127,126,126,126,126,126,125,125,124,123,123,122,121,120,119,118
    7451   00:C301                    ~ 		db 117,116,114,113,112,110,108,107,105,103,102,100,98,96,94,91
    7452   00:C301                    ~ 		db 89,87,85,82,80,78,75,73,70,67,65,62,59,57,54,51
    7453   00:C301                    ~ 		db 48,45,42,39,36,33,30,27,24,21,18,15,12,9,6,3
    7454   00:C301                    ~ 		db 128,131,134,137,140,143,146,149,152,155,158,161,164,167,170,173
    7455   00:C301                    ~ 		db 176,179,182,185,187,190,193,195,198,201,203,206,208,210,213,215
    7456   00:C301                    ~ 		db 217,219,222,224,226,228,230,231,233,235,236,238,240,241,242,244
    7457   00:C301                    ~ 		db 245,246,247,248,249,250,251,251,252,253,253,254,254,254,254,254
    7458   00:C301                    ~ 		db 255,254,254,254,254,254,253,253,252,251,251,250,249,248,247,246
    7459   00:C301                    ~ 		db 245,244,242,241,240,238,236,235,233,231,230,228,226,224,222,219
    7460   00:C301                    ~ 		db 217,215,213,210,208,206,203,201,198,195,193,190,187,185,182,179
    7461   00:C301                    ~ 		db 176,173,170,167,164,161,158,155,152,149,146,143,140,137,134,131
    7462   00:C301                    ~ 	
    7463   00:C301                    ~ 	endif
    7464   00:C301                      	
    7465   00:C301                      	if PFLAG
    7466   00:C301                      
    7467   00:C301                      ; some aligned data (256+88 bytes)
    7468   00:C301                      
    7469   00:C301  (00FF)              	   ALIGN 256
    7470   00:C400                      	
    7471   00:C400                      dots:		db 128,64,32,16,8,4,2,1   
    7471   00:C400  80 40 20 10 08 04 02 01 
    7472   00:C408  8B B3               shrptr:		dw laser          ; laser.
    7473   00:C40A  64 B3               			dw trail          ; vapour trail.
    7474   00:C40C  D0 B2               			dw shrap          ; shrapnel from explosion.
    7475   00:C40E  F0 B2               			dw dotl           ; horizontal starfield left.
    7476   00:C410  F4 B2               			dw dotr           ; horizontal starfield right.
    7477   00:C412  F8 B2               			dw dotu           ; vertical starfield up.
    7478   00:C414  FC B2               			dw dotd           ; vertical starfield down.
    7479   00:C416  43 8B               			dw ptcusr         ; user particle.			
    7480   00:C418                      shrsin: 	dw 0,1024,391,946,724,724,946,391
    7480   00:C418  00 00 00 04 87 01 B2 03 D4 02 D4 02 B2 03 87 01 
    7481   00:C428                      			dw 1024,0,946,65144,724,64811,391,64589
    7481   00:C428  00 04 00 00 B2 03 78 FE D4 02 2B FD 87 01 4D FC 
    7482   00:C438                      			dw 0,64512,65144,64589,64811,64811,64589,65144
    7482   00:C438  00 00 00 FC 78 FE 4D FC 2B FD 2B FD 4D FC 78 FE 
    7483   00:C448                      			dw 64512,0,64589,391,64811,724,65144,946
    7483   00:C448  00 FC 00 00 4D FC 87 01 2B FD D4 02 78 FE B2 03 
    7484   00:C458                      
    7485   00:C458                      
    7486   00:C458                      	endif
    7487   00:C458                      
    7488   00:C458                      
    7489   00:C458                      ; User routine.  Put your own code inside user.asm file to be called with USER instruction.
    7490   00:C458                      ; if USER has an argument it will be passed in the accumulator.
    7491   00:C458                      	if UFLAG
    7492   00:C458                    ~ 	
    7493   00:C458                    ~ 		include "User.asm"
    7494   00:C458                    ~ 
    7495   00:C458                    ~ 	endif
    7496   00:C458                      	
    7497   00:C458                      	include "Pletter_unpack.asm"
       1.  00:C458                      ; pletter v0.5c msx unpacker
       2.  00:C458                      
       3.  00:C458                      ; call unpack with hl pointing to some pletter5 data, and de pointing to the destination.
       4.  00:C458                      ; changes all registers
       5.  00:C458                      
       6.  00:C458                      ; define lengthindata when the original size is written in the pletter data
       7.  00:C458                      
       8.  00:C458                      ;  define LENGTHINDATA
       9.  00:C458                      
      10.  00:C458                        module pletter
      11.  00:C458                      
      12.  00:C458                        macro GETBIT
      13.  00:C458                    <   add a,a
      14.  00:C458                    <   call z,getbit
      15.  00:C458                    <   endmacro
      16.  00:C458                      
      17.  00:C458                        macro GETBITEXX
      18.  00:C458                    <   add a,a
      19.  00:C458                    <   call z,getbitexx
      20.  00:C458                    <   endmacro
      21.  00:C458                      
      22.  00:C458                      @unpack
      23.  00:C458                      
      24.  00:C458                        ifdef LENGTHINDATA
      25.  00:C458                    ~   inc hl
      26.  00:C458                    ~   inc hl
      27.  00:C458                    ~   endif
      28.  00:C458                      
      29.  00:C458  7E                    ld a,(hl)
      30.  00:C459  23                    inc hl
      31.  00:C45A  D9                    exx
      32.  00:C45B  11 00 00              ld de,0
      33.  00:C45E  87                    add a,a
      34.  00:C45F  3C                    inc a
      35.  00:C460  CB 13                 rl e
      36.  00:C462  87                    add a,a
      37.  00:C463  CB 13                 rl e
      38.  00:C465  87                    add a,a
      39.  00:C466  CB 13                 rl e
      40.  00:C468  CB 13                 rl e
      41.  00:C46A  21 F6 C4              ld hl,modes
      42.  00:C46D  19                    add hl,de
      43.  00:C46E  5E                    ld e,(hl)
      44.  00:C46F  DD 6B                 ld ixl,e
      45.  00:C471  23                    inc hl
      46.  00:C472  5E                    ld e,(hl)
      47.  00:C473  DD 63                 ld ixh,e
      48.  00:C475  1E 01                 ld e,1
      49.  00:C477  D9                    exx
      50.  00:C478  FD 21 7E C4           ld iy,loop
      51.  00:C47C                      literal
      52.  00:C47C  ED A0                 ldi
      53.  00:C47E                      loop
      54.  00:C47E                        GETBIT
      54.  00:C47E  87                >   add a,a
      54.  00:C47F  CC EC C4          >   call z,getbit
      55.  00:C482  30 F8                 jr nc,literal
      56.  00:C484  D9                    exx
      57.  00:C485  62                    ld h,d
      58.  00:C486  6B                    ld l,e
      59.  00:C487                      getlen
      60.  00:C487                        GETBITEXX
      60.  00:C487  87                >   add a,a
      60.  00:C488  CC F0 C4          >   call z,getbitexx
      61.  00:C48B  30 1B                 jr nc,.lenok
      62.  00:C48D                      .lus
      63.  00:C48D                        GETBITEXX
      63.  00:C48D  87                >   add a,a
      63.  00:C48E  CC F0 C4          >   call z,getbitexx
      64.  00:C491  ED 6A                 adc hl,hl
      65.  00:C493  D8                    ret c
      66.  00:C494                        GETBITEXX
      66.  00:C494  87                >   add a,a
      66.  00:C495  CC F0 C4          >   call z,getbitexx
      67.  00:C498  30 0E                 jr nc,.lenok
      68.  00:C49A                        GETBITEXX
      68.  00:C49A  87                >   add a,a
      68.  00:C49B  CC F0 C4          >   call z,getbitexx
      69.  00:C49E  ED 6A                 adc hl,hl
      70.  00:C4A0  D8                    ret c
      71.  00:C4A1                        GETBITEXX
      71.  00:C4A1  87                >   add a,a
      71.  00:C4A2  CC F0 C4          >   call z,getbitexx
      72.  00:C4A5  DA 8D C4              jp c,.lus
      73.  00:C4A8                      .lenok
      74.  00:C4A8  23                    inc hl
      75.  00:C4A9  D9                    exx
      76.  00:C4AA  4E                    ld c,(hl)
      77.  00:C4AB  23                    inc hl
      78.  00:C4AC  06 00                 ld b,0
      79.  00:C4AE  CB 79                 bit 7,c
      80.  00:C4B0  CA DD C4              jp z,offsok
      81.  00:C4B3  DD E9                 jp ix
      82.  00:C4B5                      
      83.  00:C4B5                      mode6
      84.  00:C4B5                        GETBIT
      84.  00:C4B5  87                >   add a,a
      84.  00:C4B6  CC EC C4          >   call z,getbit
      85.  00:C4B9  CB 10                 rl b
      86.  00:C4BB                      mode5
      87.  00:C4BB                        GETBIT
      87.  00:C4BB  87                >   add a,a
      87.  00:C4BC  CC EC C4          >   call z,getbit
      88.  00:C4BF  CB 10                 rl b
      89.  00:C4C1                      mode4
      90.  00:C4C1                        GETBIT
      90.  00:C4C1  87                >   add a,a
      90.  00:C4C2  CC EC C4          >   call z,getbit
      91.  00:C4C5  CB 10                 rl b
      92.  00:C4C7                      mode3
      93.  00:C4C7                        GETBIT
      93.  00:C4C7  87                >   add a,a
      93.  00:C4C8  CC EC C4          >   call z,getbit
      94.  00:C4CB  CB 10                 rl b
      95.  00:C4CD                      mode2
      96.  00:C4CD                        GETBIT
      96.  00:C4CD  87                >   add a,a
      96.  00:C4CE  CC EC C4          >   call z,getbit
      97.  00:C4D1  CB 10                 rl b
      98.  00:C4D3                        GETBIT
      98.  00:C4D3  87                >   add a,a
      98.  00:C4D4  CC EC C4          >   call z,getbit
      99.  00:C4D7  30 04                 jr nc,offsok
     100.  00:C4D9  B7                    or a
     101.  00:C4DA  04                    inc b
     102.  00:C4DB  CB B9                 res 7,c
     103.  00:C4DD                      offsok
     104.  00:C4DD  03                    inc bc
     105.  00:C4DE  E5                    push hl
     106.  00:C4DF  D9                    exx
     107.  00:C4E0  E5                    push hl
     108.  00:C4E1  D9                    exx
     109.  00:C4E2  6B                    ld l,e
     110.  00:C4E3  62                    ld h,d
     111.  00:C4E4  ED 42                 sbc hl,bc
     112.  00:C4E6  C1                    pop bc
     113.  00:C4E7  ED B0                 ldir
     114.  00:C4E9  E1                    pop hl
     115.  00:C4EA  FD E9                 jp iy
     116.  00:C4EC                      
     117.  00:C4EC                      getbit
     118.  00:C4EC  7E                    ld a,(hl)
     119.  00:C4ED  23                    inc hl
     120.  00:C4EE  17                    rla
     121.  00:C4EF  C9                    ret
     122.  00:C4F0                      
     123.  00:C4F0                      getbitexx
     124.  00:C4F0  D9                    exx
     125.  00:C4F1  7E                    ld a,(hl)
     126.  00:C4F2  23                    inc hl
     127.  00:C4F3  D9                    exx
     128.  00:C4F4  17                    rla
     129.  00:C4F5  C9                    ret
     130.  00:C4F6                      
     131.  00:C4F6                      modes
     132.  00:C4F6  DD C4                 word offsok
     133.  00:C4F8  CD C4                 word mode2
     134.  00:C4FA  C7 C4                 word mode3
     135.  00:C4FC  C1 C4                 word mode4
     136.  00:C4FE  BB C4                 word mode5
     137.  00:C500  B5 C4                 word mode6
     138.  00:C502                      
     139.  00:C502                        endmodule
     140.  00:C502                      
     141.  00:C502                      ;eof
    7498   00:C502                      	; Music & SFX routines
    7499   00:C502                      	include "PT3-ROM.asm"
       1.  00:C502                      		; --- PT3 REPLAYER WORKING ON ROM ---
       2.  00:C502                      		; --- Can be assembled with asMSX ---
       3.  00:C502                      		; --- ROM version: MSX-KUN        ---
       4.  00:C502                      		; --- asMSX version: SapphiRe     ---
       5.  00:C502                      		; --- tniasm version: theNestruo  ---
       6.  00:C502                      
       7.  00:C502                      ; Based on MSX version of PT3 by Dioniso
       8.  00:C502                      ;
       9.  00:C502                      ; This version of the replayer uses a fixed volume and note table, if you need a 
      10.  00:C502                      ; different note table you can copy it from TABLES.TXT file, distributed with the
      11.  00:C502                      ; original PT3 distribution. This version also allows the use of PT3 commands.
      12.  00:C502                      ;
      13.  00:C502                      ; PLAY and PSG WRITE routines seperated to allow independent calls
      14.  00:C502                      ;
      15.  00:C502                      ; ROM LENGTH: 1528 bytes
      16.  00:C502                      ; RAM LENGTH:  382 bytes
      17.  00:C502                      
      18.  00:C502                      		; --- CONSTANT VALUES DEFINITION ---
      19.  00:C502                      
      20.  00:C502                      ;ChannelsVars
      21.  00:C502                      ;struc	CHNPRM
      22.  00:C502                      ;reset group
      23.  00:C502  (00:0000)           CHNPRM_PsInOr:	equ 0	;RESB 1
      24.  00:C502  (00:0001)           CHNPRM_PsInSm:	equ 1	;RESB 1
      25.  00:C502  (00:0002)           CHNPRM_CrAmSl:	equ 2	;RESB 1
      26.  00:C502  (00:0003)           CHNPRM_CrNsSl:	equ 3	;RESB 1
      27.  00:C502  (00:0004)           CHNPRM_CrEnSl:	equ 4	;RESB 1
      28.  00:C502  (00:0005)           CHNPRM_TSlCnt:	equ 5	;RESB 1
      29.  00:C502  (00:0006)           CHNPRM_CrTnSl:	equ 6	;RESW 1
      30.  00:C502  (00:0008)           CHNPRM_TnAcc:	equ 8	;RESW 1
      31.  00:C502  (00:000A)           CHNPRM_COnOff:	equ 10	;RESB 1
      32.  00:C502                      ;reset group
      33.  00:C502                      
      34.  00:C502  (00:000B)           CHNPRM_OnOffD:	equ 11	;RESB 1
      35.  00:C502                      
      36.  00:C502                      ;IX for PTDECOD here [+12]
      37.  00:C502  (00:000C)           CHNPRM_OffOnD:	equ 12	;RESB 1
      38.  00:C502  (00:000D)           CHNPRM_OrnPtr:	equ 13	;RESW 1
      39.  00:C502  (00:000F)           CHNPRM_SamPtr:	equ 15	;RESW 1
      40.  00:C502  (00:0011)           CHNPRM_NNtSkp:	equ 17	;RESB 1
      41.  00:C502  (00:0012)           CHNPRM_Note:	equ 18	;RESB 1
      42.  00:C502  (00:0013)           CHNPRM_SlToNt:	equ 19	;RESB 1
      43.  00:C502  (00:0014)           CHNPRM_Env_En:	equ 20	;RESB 1
      44.  00:C502  (00:0015)           CHNPRM_Flags:	equ 21	;RESB 1
      45.  00:C502                       ;Enabled - 0,SimpleGliss - 2
      46.  00:C502  (00:0016)           CHNPRM_TnSlDl:	equ 22	;RESB 1
      47.  00:C502  (00:0017)           CHNPRM_TSlStp:	equ 23	;RESW 1
      48.  00:C502  (00:0019)           CHNPRM_TnDelt:	equ 25	;RESW 1
      49.  00:C502  (00:001B)           CHNPRM_NtSkCn:	equ 27	;RESB 1
      50.  00:C502  (00:001C)           CHNPRM_Volume:	equ 28	;RESB 1
      51.  00:C502  (00:001D)           CHNPRM_Size:	equ 29	;RESB 1
      52.  00:C502                      ;endstruc
      53.  00:C502                      
      54.  00:C502                      ;struc	AR
      55.  00:C502  (00:0000)           AR_TonA:	equ 0	;RESW 1
      56.  00:C502  (00:0002)           AR_TonB:	equ 2	;RESW 1
      57.  00:C502  (00:0004)           AR_TonC:	equ 4	;RESW 1
      58.  00:C502  (00:0006)           AR_Noise:	equ 6	;RESB 1
      59.  00:C502  (00:0007)           AR_Mixer:	equ 7	;RESB 1
      60.  00:C502  (00:0008)           AR_AmplA:	equ 8	;RESB 1
      61.  00:C502  (00:0009)           AR_AmplB:	equ 9	;RESB 1
      62.  00:C502  (00:000A)           AR_AmplC:	equ 10	;RESB 1
      63.  00:C502  (00:000B)           AR_Env:		equ 11	;RESW 1
      64.  00:C502  (00:000D)           AR_EnvTp:	equ 13	;RESB 1
      65.  00:C502                      ;endstruc
      66.  00:C502                      
      67.  00:C502                      		; --- CODE STARTS HERE ---
      68.  00:C502                      
      69.  00:C502                      	if YFLAG
      70.  00:C502                    ~ 
      71.  00:C502                    ~ CHECKLP:	
      72.  00:C502                    ~ 		ld hl,PT3_SETUP
      73.  00:C502                    ~ 		set	7,(hl)
      74.  00:C502                    ~ 		bit	0,(hl)
      75.  00:C502                    ~ 		ret z
      76.  00:C502                    ~ 		pop hl
      77.  00:C502                    ~ 		ld hl,DelyCnt
      78.  00:C502                    ~ 		inc	(hl)
      79.  00:C502                    ~ 		ld hl,ChanA+CHNPRM_NtSkCn
      80.  00:C502                    ~ 		inc	(hl)
      81.  00:C502                    ~ 		jp music_mute
      82.  00:C502                    ~ 
      83.  00:C502                    ~ ; -------------------------------------------------------
      84.  00:C502                    ~ 		
      85.  00:C502                    ~ PT3_INIT:	;HL - AddressOfModule - 100
      86.  00:C502                    ~ 		LD [PT3_MODADDR],HL
      87.  00:C502                    ~ 		PUSH HL
      88.  00:C502                    ~ 		LD DE,100
      89.  00:C502                    ~ 		ADD HL,DE
      90.  00:C502                    ~ 		LD A,[HL]
      91.  00:C502                    ~ 		LD [PT3_Delay],A
      92.  00:C502                    ~ 		PUSH HL
      93.  00:C502                    ~ 		POP IX
      94.  00:C502                    ~ 		ADD HL,DE
      95.  00:C502                    ~ 		LD [PT3_CrPsPtr],HL
      96.  00:C502                    ~ 		LD E,[IX+102-100]
      97.  00:C502                    ~ 		ADD HL,DE
      98.  00:C502                    ~ 		INC HL
      99.  00:C502                    ~ 		LD [PT3_LPosPtr],HL
     100.  00:C502                    ~ 		POP DE
     101.  00:C502                    ~ 		LD L,[IX+103-100]
     102.  00:C502                    ~ 		LD H,[IX+104-100]
     103.  00:C502                    ~ 		ADD HL,DE
     104.  00:C502                    ~ 		LD [PT3_PatsPtr],HL
     105.  00:C502                    ~ 		LD HL,169
     106.  00:C502                    ~ 		ADD HL,DE
     107.  00:C502                    ~ 		LD [PT3_OrnPtrs],HL
     108.  00:C502                    ~ 		LD HL,105
     109.  00:C502                    ~ 		ADD HL,DE
     110.  00:C502                    ~ 		LD [PT3_SAMPTRS],HL
     111.  00:C502                    ~ 		LD HL,PT3_SETUP
     112.  00:C502                    ~ 		RES 7,[HL]
     113.  00:C502                    ~ 
     114.  00:C502                    ~ 		; --- CREATE PT3 VOLUME TABLE (c) Ivan Roshin, adapted by SapphiRe ---
     115.  00:C502                    ~ 		ld	hl,$11
     116.  00:C502                    ~ 		ld	d,h
     117.  00:C502                    ~ 		ld	e,h
     118.  00:C502                    ~ 		ld	IX,VT_+16
     119.  00:C502                    ~ 		ld	b,15
     120.  00:C502                    ~ .INITV1:	push	hl
     121.  00:C502                    ~ 		add	hl,de
     122.  00:C502                    ~ 		ex	de,hl
     123.  00:C502                    ~ 		sbc	hl,hl
     124.  00:C502                    ~ 		ld	c,b
     125.  00:C502                    ~ 		ld	b,16
     126.  00:C502                    ~ .INITV2:	ld	a,l
     127.  00:C502                    ~ 		rla
     128.  00:C502                    ~ 		ld	a,h
     129.  00:C502                    ~ 		adc	a,0
     130.  00:C502                    ~ 		ld	[ix],a
     131.  00:C502                    ~ 		inc	ix
     132.  00:C502                    ~ 		add	hl,de
     133.  00:C502                    ~ 		djnz	.INITV2
     134.  00:C502                    ~ 		pop	hl
     135.  00:C502                    ~ 		ld	a,e
     136.  00:C502                    ~ 		cp	$77
     137.  00:C502                    ~ 		jr	nz,.INITV3
     138.  00:C502                    ~ 		inc	e
     139.  00:C502                    ~ .INITV3:	ld	b,c
     140.  00:C502                    ~ 		djnz	.INITV1
     141.  00:C502                    ~ 
     142.  00:C502                    ~ 		; --- INITIALIZE PT3 VARIABLES ---
     143.  00:C502                    ~ 		XOR A
     144.  00:C502                    ~ 		LD HL,VARS
     145.  00:C502                    ~ 		LD [HL],A
     146.  00:C502                    ~ 		LD DE,VARS+1
     147.  00:C502                    ~ 		LD BC,VAR0END-VARS-1
     148.  00:C502                    ~ 		LDIR
     149.  00:C502                    ~ 
     150.  00:C502                    ~ 		INC A
     151.  00:C502                    ~ 		LD [DelyCnt],A
     152.  00:C502                    ~ 		LD HL,$F001 ;H - CHNPRM_Volume, L - CHNPRM_NtSkCn
     153.  00:C502                    ~ 		LD [ChanA+CHNPRM_NtSkCn],HL
     154.  00:C502                    ~ 		LD [ChanB+CHNPRM_NtSkCn],HL
     155.  00:C502                    ~ 		LD [ChanC+CHNPRM_NtSkCn],HL
     156.  00:C502                    ~ 
     157.  00:C502                    ~ 		LD HL,EMPTYSAMORN
     158.  00:C502                    ~ 		LD [PT3_AdInPtA],HL ;ptr to zero
     159.  00:C502                    ~ 		LD [ChanA+CHNPRM_OrnPtr],HL ;ornament 0 is "0,1,0"
     160.  00:C502                    ~ 		LD [ChanB+CHNPRM_OrnPtr],HL ;in all versions from
     161.  00:C502                    ~ 		LD [ChanC+CHNPRM_OrnPtr],HL ;3.xx to 3.6x and VTII
     162.  00:C502                    ~ 
     163.  00:C502                    ~ 		LD [ChanA+CHNPRM_SamPtr],HL ;S1 There is no default
     164.  00:C502                    ~ 		LD [ChanB+CHNPRM_SamPtr],HL ;S2 sample in PT3, so, you
     165.  00:C502                    ~ 		LD [ChanC+CHNPRM_SamPtr],HL ;S3 can comment S1,2,3; see
     166.  00:C502                    ~ 					    ;also EMPTYSAMORN comment
     167.  00:C502                    ~ 						
     168.  00:C502                    ~ 		RET
     169.  00:C502                    ~ 
     170.  00:C502                    ~ 		;pattern decoder
     171.  00:C502                    ~ PD_OrSm:	LD [IX+(CHNPRM_Env_En-12)],0
     172.  00:C502                    ~ 		CALL SETORN
     173.  00:C502                    ~ 		LD A,[BC]
     174.  00:C502                    ~ 		INC BC
     175.  00:C502                    ~ 		RRCA
     176.  00:C502                    ~ 
     177.  00:C502                    ~ PD_SAM:		ADD A,A
     178.  00:C502                    ~ PD_SAM_:	LD E,A
     179.  00:C502                    ~ 		LD D,0
     180.  00:C502                    ~ 		LD HL,[PT3_SAMPTRS]
     181.  00:C502                    ~ 		ADD HL,DE
     182.  00:C502                    ~ 		LD E,[HL]
     183.  00:C502                    ~ 		INC HL
     184.  00:C502                    ~ 		LD D,[HL]
     185.  00:C502                    ~ 		LD HL,[PT3_MODADDR]
     186.  00:C502                    ~ 		ADD HL,DE
     187.  00:C502                    ~ 		LD [IX+(CHNPRM_SamPtr-12)],L
     188.  00:C502                    ~ 		LD [IX+(CHNPRM_SamPtr+1-12)],H
     189.  00:C502                    ~ 		JR PD_LOOP
     190.  00:C502                    ~ 
     191.  00:C502                    ~ PD_VOL:		RLCA
     192.  00:C502                    ~ 		RLCA
     193.  00:C502                    ~ 		RLCA
     194.  00:C502                    ~ 		RLCA
     195.  00:C502                    ~ 		LD [IX+(CHNPRM_Volume-12)],A
     196.  00:C502                    ~ 		JR PD_LP2
     197.  00:C502                    ~ 	
     198.  00:C502                    ~ PD_EOff:	LD [IX+(CHNPRM_Env_En-12)],A
     199.  00:C502                    ~ 		LD [IX+(CHNPRM_PsInOr-12)],A
     200.  00:C502                    ~ 		JR PD_LP2
     201.  00:C502                    ~ 
     202.  00:C502                    ~ PD_SorE:	DEC A
     203.  00:C502                    ~ 		JR NZ,PD_ENV
     204.  00:C502                    ~ 		LD A,[BC]
     205.  00:C502                    ~ 		INC BC
     206.  00:C502                    ~ 		LD [IX+(CHNPRM_NNtSkp-12)],A
     207.  00:C502                    ~ 		JR PD_LP2
     208.  00:C502                    ~ 
     209.  00:C502                    ~ PD_ENV:		CALL SETENV
     210.  00:C502                    ~ 		JR PD_LP2
     211.  00:C502                    ~ 
     212.  00:C502                    ~ PD_ORN:		CALL SETORN
     213.  00:C502                    ~ 		JR PD_LOOP
     214.  00:C502                    ~        
     215.  00:C502                    ~ PD_ESAM:	LD [IX+(CHNPRM_Env_En-12)],A
     216.  00:C502                    ~ 		LD [IX+(CHNPRM_PsInOr-12)],A
     217.  00:C502                    ~ 		CALL NZ,SETENV
     218.  00:C502                    ~ 		LD A,[BC]
     219.  00:C502                    ~ 		INC BC
     220.  00:C502                    ~ 		JR PD_SAM_
     221.  00:C502                    ~ 
     222.  00:C502                    ~ PTDECOD:	LD A,[IX+(CHNPRM_Note-12)]
     223.  00:C502                    ~ 		LD [PT3_PrNote],A
     224.  00:C502                    ~ 		LD L,[IX+(CHNPRM_CrTnSl-12)]
     225.  00:C502                    ~ 		LD H,[IX+(CHNPRM_CrTnSl+1-12)]
     226.  00:C502                    ~ 		LD [PT3_PrSlide],HL
     227.  00:C502                    ~ 
     228.  00:C502                    ~ PD_LOOP:	LD DE,$2010
     229.  00:C502                    ~ PD_LP2:		LD A,[BC]
     230.  00:C502                    ~ 		INC BC
     231.  00:C502                    ~ 		ADD A,E
     232.  00:C502                    ~ 		JR C,PD_OrSm
     233.  00:C502                    ~ 		ADD A,D
     234.  00:C502                    ~ 		JR Z,PD_FIN
     235.  00:C502                    ~ 		JR C,PD_SAM
     236.  00:C502                    ~ 		ADD A,E
     237.  00:C502                    ~ 		JR Z,PD_REL
     238.  00:C502                    ~ 		JR C,PD_VOL
     239.  00:C502                    ~ 		ADD A,E
     240.  00:C502                    ~ 		JR Z,PD_EOff
     241.  00:C502                    ~ 		JR C,PD_SorE
     242.  00:C502                    ~ 		ADD A,96
     243.  00:C502                    ~ 		JR C,PD_NOTE
     244.  00:C502                    ~ 		ADD A,E
     245.  00:C502                    ~ 		JR C,PD_ORN
     246.  00:C502                    ~ 		ADD A,D
     247.  00:C502                    ~ 		JR C,PD_NOIS
     248.  00:C502                    ~ 		ADD A,E
     249.  00:C502                    ~ 		JR C,PD_ESAM
     250.  00:C502                    ~ 		ADD A,A
     251.  00:C502                    ~ 		LD E,A
     252.  00:C502                    ~ 		LD HL,SPCCOMS.HL_VALUE
     253.  00:C502                    ~ 		ADD HL,DE
     254.  00:C502                    ~ 		LD E,[HL]
     255.  00:C502                    ~ 		INC HL
     256.  00:C502                    ~ 		LD D,[HL]
     257.  00:C502                    ~ 		PUSH DE
     258.  00:C502                    ~ 		JR PD_LOOP
     259.  00:C502                    ~ 
     260.  00:C502                    ~ PD_NOIS:	LD [Ns_Base],A
     261.  00:C502                    ~ 		JR PD_LP2
     262.  00:C502                    ~ 
     263.  00:C502                    ~ PD_REL:		RES 0,[IX+(CHNPRM_Flags-12)]
     264.  00:C502                    ~ 		JR PD_RES
     265.  00:C502                    ~ 	
     266.  00:C502                    ~ PD_NOTE:	LD [IX+(CHNPRM_Note-12)],A
     267.  00:C502                    ~ 		SET 0,[IX+(CHNPRM_Flags-12)]
     268.  00:C502                    ~ 		XOR A
     269.  00:C502                    ~ 
     270.  00:C502                    ~ PD_RES:		LD [PT3_PDSP],SP
     271.  00:C502                    ~ 		LD SP,IX
     272.  00:C502                    ~ 		LD H,A
     273.  00:C502                    ~ 		LD L,A
     274.  00:C502                    ~ 		PUSH HL
     275.  00:C502                    ~ 		PUSH HL
     276.  00:C502                    ~ 		PUSH HL
     277.  00:C502                    ~ 		PUSH HL
     278.  00:C502                    ~ 		PUSH HL
     279.  00:C502                    ~ 		PUSH HL
     280.  00:C502                    ~ 		LD SP,[PT3_PDSP]
     281.  00:C502                    ~ 
     282.  00:C502                    ~ PD_FIN:		LD A,[IX+(CHNPRM_NNtSkp-12)]
     283.  00:C502                    ~ 		LD [IX+(CHNPRM_NtSkCn-12)],A
     284.  00:C502                    ~ 		RET
     285.  00:C502                    ~ 
     286.  00:C502                    ~ C_PORTM:	RES 2,[IX+(CHNPRM_Flags-12)]
     287.  00:C502                    ~ 		LD A,[BC]
     288.  00:C502                    ~ 		INC BC
     289.  00:C502                    ~ 		;SKIP PRECALCULATED TONE DELTA [BECAUSE
     290.  00:C502                    ~ 		;CANNOT BE RIGHT AFTER PT3 COMPILATION]
     291.  00:C502                    ~ 		INC BC
     292.  00:C502                    ~ 		INC BC
     293.  00:C502                    ~ 		LD [IX+(CHNPRM_TnSlDl-12)],A
     294.  00:C502                    ~ 		LD [IX+(CHNPRM_TSlCnt-12)],A
     295.  00:C502                    ~ 		LD DE,NT_
     296.  00:C502                    ~ 		LD A,[IX+(CHNPRM_Note-12)]
     297.  00:C502                    ~ 		LD [IX+(CHNPRM_SlToNt-12)],A
     298.  00:C502                    ~ 		ADD A,A
     299.  00:C502                    ~ 		LD L,A
     300.  00:C502                    ~ 		LD H,0
     301.  00:C502                    ~ 		ADD HL,DE
     302.  00:C502                    ~ 		LD A,[HL]
     303.  00:C502                    ~ 		INC HL
     304.  00:C502                    ~ 		LD H,[HL]
     305.  00:C502                    ~ 		LD L,A
     306.  00:C502                    ~ 		PUSH HL
     307.  00:C502                    ~ 		LD A,[PT3_PrNote]
     308.  00:C502                    ~ 		LD [IX+(CHNPRM_Note-12)],A
     309.  00:C502                    ~ 		ADD A,A
     310.  00:C502                    ~ 		LD L,A
     311.  00:C502                    ~ 		LD H,0
     312.  00:C502                    ~ 		ADD HL,DE
     313.  00:C502                    ~ 		LD E,[HL]
     314.  00:C502                    ~ 		INC HL
     315.  00:C502                    ~ 		LD D,[HL]
     316.  00:C502                    ~ 		POP HL
     317.  00:C502                    ~ 		SBC HL,DE
     318.  00:C502                    ~ 		LD [IX+(CHNPRM_TnDelt-12)],L
     319.  00:C502                    ~ 		LD [IX+(CHNPRM_TnDelt+1-12)],H
     320.  00:C502                    ~ 		LD DE,[PT3_PrSlide]
     321.  00:C502                    ~ 		LD [IX+(CHNPRM_CrTnSl-12)],E
     322.  00:C502                    ~ 		LD [IX+(CHNPRM_CrTnSl+1-12)],D
     323.  00:C502                    ~ 		LD A,[BC] ;SIGNED TONE STEP
     324.  00:C502                    ~ 		INC BC
     325.  00:C502                    ~ 		EX AF,AF
     326.  00:C502                    ~ 		LD A,[BC]
     327.  00:C502                    ~ 		INC BC
     328.  00:C502                    ~ 		AND A
     329.  00:C502                    ~ 		JR Z,.NOSIG
     330.  00:C502                    ~ 		EX DE,HL
     331.  00:C502                    ~ .NOSIG:	SBC HL,DE
     332.  00:C502                    ~ 		JP P,SET_STP
     333.  00:C502                    ~ 		CPL
     334.  00:C502                    ~ 		EX AF,AF
     335.  00:C502                    ~ 		NEG
     336.  00:C502                    ~ 		EX AF,AF
     337.  00:C502                    ~ SET_STP:	LD [IX+(CHNPRM_TSlStp+1-12)],A
     338.  00:C502                    ~ 		EX AF,AF
     339.  00:C502                    ~ 		LD [IX+(CHNPRM_TSlStp-12)],A
     340.  00:C502                    ~ 		LD [IX+(CHNPRM_COnOff-12)],0
     341.  00:C502                    ~ 		RET
     342.  00:C502                    ~ 
     343.  00:C502                    ~ C_GLISS:	SET 2,[IX+(CHNPRM_Flags-12)]
     344.  00:C502                    ~ 		LD A,[BC]
     345.  00:C502                    ~ 		INC BC
     346.  00:C502                    ~ 		LD [IX+(CHNPRM_TnSlDl-12)],A
     347.  00:C502                    ~ 		LD [IX+(CHNPRM_TSlCnt-12)],A
     348.  00:C502                    ~ 		LD A,[BC]
     349.  00:C502                    ~ 		INC BC
     350.  00:C502                    ~ 		EX AF,AF
     351.  00:C502                    ~ 		LD A,[BC]
     352.  00:C502                    ~ 		INC BC
     353.  00:C502                    ~ 		JR SET_STP
     354.  00:C502                    ~ 
     355.  00:C502                    ~ C_SMPOS:	LD A,[BC]
     356.  00:C502                    ~ 		INC BC
     357.  00:C502                    ~ 		LD [IX+(CHNPRM_PsInSm-12)],A
     358.  00:C502                    ~ 		RET
     359.  00:C502                    ~ 
     360.  00:C502                    ~ C_ORPOS:	LD A,[BC]
     361.  00:C502                    ~ 		INC BC
     362.  00:C502                    ~ 		LD [IX+(CHNPRM_PsInOr-12)],A
     363.  00:C502                    ~ 		RET
     364.  00:C502                    ~ 
     365.  00:C502                    ~ C_VIBRT:	LD A,[BC]
     366.  00:C502                    ~ 		INC BC
     367.  00:C502                    ~ 		LD [IX+(CHNPRM_OnOffD-12)],A
     368.  00:C502                    ~ 		LD [IX+(CHNPRM_COnOff-12)],A
     369.  00:C502                    ~ 		LD A,[BC]
     370.  00:C502                    ~ 		INC BC
     371.  00:C502                    ~ 		LD [IX+(CHNPRM_OffOnD-12)],A
     372.  00:C502                    ~ 		XOR A
     373.  00:C502                    ~ 		LD [IX+(CHNPRM_TSlCnt-12)],A
     374.  00:C502                    ~ 		LD [IX+(CHNPRM_CrTnSl-12)],A
     375.  00:C502                    ~ 		LD [IX+(CHNPRM_CrTnSl+1-12)],A
     376.  00:C502                    ~ 		RET
     377.  00:C502                    ~ 
     378.  00:C502                    ~ C_ENGLS:	LD A,[BC]
     379.  00:C502                    ~ 		INC BC
     380.  00:C502                    ~ 		LD [PT3_Env_Del],A
     381.  00:C502                    ~ 		LD [CurEDel],A
     382.  00:C502                    ~ 		LD A,[BC]
     383.  00:C502                    ~ 		INC BC
     384.  00:C502                    ~ 		LD L,A
     385.  00:C502                    ~ 		LD A,[BC]
     386.  00:C502                    ~ 		INC BC
     387.  00:C502                    ~ 		LD H,A
     388.  00:C502                    ~ 		LD [PT3_ESldAdd],HL
     389.  00:C502                    ~ 		RET
     390.  00:C502                    ~ 
     391.  00:C502                    ~ C_DELAY:	LD A,[BC]
     392.  00:C502                    ~ 		INC BC
     393.  00:C502                    ~ 		LD [PT3_Delay],A
     394.  00:C502                    ~ 		RET
     395.  00:C502                    ~ 	
     396.  00:C502                    ~ SETENV:		LD [IX+(CHNPRM_Env_En-12)],E
     397.  00:C502                    ~ 		LD [AYREGS+AR_EnvTp],A
     398.  00:C502                    ~ 		LD A,[BC]
     399.  00:C502                    ~ 		INC BC
     400.  00:C502                    ~ 		LD H,A
     401.  00:C502                    ~ 		LD A,[BC]
     402.  00:C502                    ~ 		INC BC
     403.  00:C502                    ~ 		LD L,A
     404.  00:C502                    ~ 		LD [EnvBase],HL
     405.  00:C502                    ~ 		XOR A
     406.  00:C502                    ~ 		LD [IX+(CHNPRM_PsInOr-12)],A
     407.  00:C502                    ~ 		LD [CurEDel],A
     408.  00:C502                    ~ 		LD H,A
     409.  00:C502                    ~ 		LD L,A
     410.  00:C502                    ~ 		LD [CurESld],HL
     411.  00:C502                    ~ C_NOP:		RET
     412.  00:C502                    ~ 
     413.  00:C502                    ~ SETORN:		ADD A,A
     414.  00:C502                    ~ 		LD E,A
     415.  00:C502                    ~ 		LD D,0
     416.  00:C502                    ~ 		LD [IX+(CHNPRM_PsInOr-12)],D
     417.  00:C502                    ~ 		LD HL,[PT3_OrnPtrs]
     418.  00:C502                    ~ 		ADD HL,DE
     419.  00:C502                    ~ 		LD E,[HL]
     420.  00:C502                    ~ 		INC HL
     421.  00:C502                    ~ 		LD D,[HL]
     422.  00:C502                    ~ 		LD HL,[PT3_MODADDR]
     423.  00:C502                    ~ 		ADD HL,DE
     424.  00:C502                    ~ 		LD [IX+(CHNPRM_OrnPtr-12)],L
     425.  00:C502                    ~ 		LD [IX+(CHNPRM_OrnPtr+1-12)],H
     426.  00:C502                    ~ 		RET
     427.  00:C502                    ~ 
     428.  00:C502                    ~ 		;ALL 16 ADDRESSES TO PROTECT FROM BROKEN PT3 MODULES
     429.  00:C502                    ~ SPCCOMS:	dw C_NOP
     430.  00:C502                    ~ 		dw C_GLISS
     431.  00:C502                    ~ 		dw C_PORTM
     432.  00:C502                    ~ 		dw C_SMPOS
     433.  00:C502                    ~ 		dw C_ORPOS
     434.  00:C502                    ~ 		dw C_VIBRT
     435.  00:C502                    ~ 		dw C_NOP
     436.  00:C502                    ~ 		dw C_NOP
     437.  00:C502                    ~ 		dw C_ENGLS
     438.  00:C502                    ~ 		dw C_DELAY
     439.  00:C502                    ~ 		dw C_NOP
     440.  00:C502                    ~ 		dw C_NOP
     441.  00:C502                    ~ 		dw C_NOP
     442.  00:C502                    ~ 		dw C_NOP
     443.  00:C502                    ~ 		dw C_NOP
     444.  00:C502                    ~ 		dw C_NOP
     445.  00:C502                    ~ .HL_VALUE:	equ (SPCCOMS+$DF20) MOD 65536; Adapted from original Speccy version (saves 6 bytes)
     446.  00:C502                    ~ 
     447.  00:C502                    ~ CHREGS:		XOR A
     448.  00:C502                    ~ 		LD [AYREGS+AR_AmplC],A
     449.  00:C502                    ~ 		BIT 0,[IX+CHNPRM_Flags]
     450.  00:C502                    ~ 		PUSH HL
     451.  00:C502                    ~ 		JP Z,.CH_EXIT
     452.  00:C502                    ~ 		LD [PT3_CSP],SP
     453.  00:C502                    ~ 		LD L,[IX+CHNPRM_OrnPtr]
     454.  00:C502                    ~ 		LD H,[IX+CHNPRM_OrnPtr+1]
     455.  00:C502                    ~ 		LD SP,HL
     456.  00:C502                    ~ 		POP DE
     457.  00:C502                    ~ 		LD H,A
     458.  00:C502                    ~ 		LD A,[IX+CHNPRM_PsInOr]
     459.  00:C502                    ~ 		LD L,A
     460.  00:C502                    ~ 		ADD HL,SP
     461.  00:C502                    ~ 		INC A
     462.  00:C502                    ~ 		CP D
     463.  00:C502                    ~ 		JR C,.CH_ORPS
     464.  00:C502                    ~ 		LD A,E
     465.  00:C502                    ~ .CH_ORPS:	LD [IX+CHNPRM_PsInOr],A
     466.  00:C502                    ~ 		LD A,[IX+CHNPRM_Note]
     467.  00:C502                    ~ 		ADD A,[HL]
     468.  00:C502                    ~ 		JP P,.CH_NTP
     469.  00:C502                    ~ 		XOR A
     470.  00:C502                    ~ .CH_NTP:	CP 96
     471.  00:C502                    ~ 		JR C,.CH_NOK
     472.  00:C502                    ~ 		LD A,95
     473.  00:C502                    ~ .CH_NOK:	ADD A,A
     474.  00:C502                    ~ 		EX AF,AF
     475.  00:C502                    ~ 		LD L,[IX+CHNPRM_SamPtr]
     476.  00:C502                    ~ 		LD H,[IX+CHNPRM_SamPtr+1]
     477.  00:C502                    ~ 		LD SP,HL
     478.  00:C502                    ~ 		POP DE
     479.  00:C502                    ~ 		LD H,0
     480.  00:C502                    ~ 		LD A,[IX+CHNPRM_PsInSm]
     481.  00:C502                    ~ 		LD B,A
     482.  00:C502                    ~ 		ADD A,A
     483.  00:C502                    ~ 		ADD A,A
     484.  00:C502                    ~ 		LD L,A
     485.  00:C502                    ~ 		ADD HL,SP
     486.  00:C502                    ~ 		LD SP,HL
     487.  00:C502                    ~ 		LD A,B
     488.  00:C502                    ~ 		INC A
     489.  00:C502                    ~ 		CP D
     490.  00:C502                    ~ 		JR C,.CH_SMPS
     491.  00:C502                    ~ 		LD A,E
     492.  00:C502                    ~ .CH_SMPS:	LD [IX+CHNPRM_PsInSm],A
     493.  00:C502                    ~ 		POP BC
     494.  00:C502                    ~ 		POP HL
     495.  00:C502                    ~ 		LD E,[IX+CHNPRM_TnAcc]
     496.  00:C502                    ~ 		LD D,[IX+CHNPRM_TnAcc+1]
     497.  00:C502                    ~ 		ADD HL,DE
     498.  00:C502                    ~ 		BIT 6,B
     499.  00:C502                    ~ 		JR Z,.CH_NOAC
     500.  00:C502                    ~ 		LD [IX+CHNPRM_TnAcc],L
     501.  00:C502                    ~ 		LD [IX+CHNPRM_TnAcc+1],H
     502.  00:C502                    ~ .CH_NOAC:	EX DE,HL
     503.  00:C502                    ~ 		EX AF,AF
     504.  00:C502                    ~ 		LD L,A
     505.  00:C502                    ~ 		LD H,0
     506.  00:C502                    ~ 		LD SP,NT_
     507.  00:C502                    ~ 		ADD HL,SP
     508.  00:C502                    ~ 		LD SP,HL
     509.  00:C502                    ~ 		POP HL
     510.  00:C502                    ~ 		ADD HL,DE
     511.  00:C502                    ~ 		LD E,[IX+CHNPRM_CrTnSl]
     512.  00:C502                    ~ 		LD D,[IX+CHNPRM_CrTnSl+1]
     513.  00:C502                    ~ 		ADD HL,DE
     514.  00:C502                    ~ 		LD SP,[PT3_CSP]
     515.  00:C502                    ~ 		EX [SP],HL
     516.  00:C502                    ~ 		XOR A
     517.  00:C502                    ~ 		OR [IX+CHNPRM_TSlCnt]
     518.  00:C502                    ~ 		JR Z,.CH_AMP
     519.  00:C502                    ~ 		DEC [IX+CHNPRM_TSlCnt]
     520.  00:C502                    ~ 		JR NZ,.CH_AMP
     521.  00:C502                    ~ 		LD A,[IX+CHNPRM_TnSlDl]
     522.  00:C502                    ~ 		LD [IX+CHNPRM_TSlCnt],A
     523.  00:C502                    ~ 		LD L,[IX+CHNPRM_TSlStp]
     524.  00:C502                    ~ 		LD H,[IX+CHNPRM_TSlStp+1]
     525.  00:C502                    ~ 		LD A,H
     526.  00:C502                    ~ 		ADD HL,DE
     527.  00:C502                    ~ 		LD [IX+CHNPRM_CrTnSl],L
     528.  00:C502                    ~ 		LD [IX+CHNPRM_CrTnSl+1],H
     529.  00:C502                    ~ 		BIT 2,[IX+CHNPRM_Flags]
     530.  00:C502                    ~ 		JR NZ,.CH_AMP
     531.  00:C502                    ~ 		LD E,[IX+CHNPRM_TnDelt]
     532.  00:C502                    ~ 		LD D,[IX+CHNPRM_TnDelt+1]
     533.  00:C502                    ~ 		AND A
     534.  00:C502                    ~ 		JR Z,.CH_STPP
     535.  00:C502                    ~ 		EX DE,HL
     536.  00:C502                    ~ .CH_STPP:	SBC HL,DE
     537.  00:C502                    ~ 		JP M,.CH_AMP
     538.  00:C502                    ~ 		LD A,[IX+CHNPRM_SlToNt]
     539.  00:C502                    ~ 		LD [IX+CHNPRM_Note],A
     540.  00:C502                    ~ 		XOR A
     541.  00:C502                    ~ 		LD [IX+CHNPRM_TSlCnt],A
     542.  00:C502                    ~ 		LD [IX+CHNPRM_CrTnSl],A
     543.  00:C502                    ~ 		LD [IX+CHNPRM_CrTnSl+1],A
     544.  00:C502                    ~ .CH_AMP:	LD A,[IX+CHNPRM_CrAmSl]
     545.  00:C502                    ~ 		BIT 7,C
     546.  00:C502                    ~ 		JR Z,.CH_NOAM
     547.  00:C502                    ~ 		BIT 6,C
     548.  00:C502                    ~ 		JR Z,.CH_AMIN
     549.  00:C502                    ~ 		CP 15
     550.  00:C502                    ~ 		JR Z,.CH_NOAM
     551.  00:C502                    ~ 		INC A
     552.  00:C502                    ~ 		JR .CH_SVAM
     553.  00:C502                    ~ .CH_AMIN:	CP -15
     554.  00:C502                    ~ 		JR Z,.CH_NOAM
     555.  00:C502                    ~ 		DEC A
     556.  00:C502                    ~ .CH_SVAM:	LD [IX+CHNPRM_CrAmSl],A
     557.  00:C502                    ~ .CH_NOAM:	LD L,A
     558.  00:C502                    ~ 		LD A,B
     559.  00:C502                    ~ 		AND 15
     560.  00:C502                    ~ 		ADD A,L
     561.  00:C502                    ~ 		JP P,.CH_APOS
     562.  00:C502                    ~ 		XOR A
     563.  00:C502                    ~ .CH_APOS:	CP 16
     564.  00:C502                    ~ 		JR C,.CH_VOL
     565.  00:C502                    ~ 		LD A,15
     566.  00:C502                    ~ .CH_VOL:	OR [IX+CHNPRM_Volume]
     567.  00:C502                    ~ 		LD L,A
     568.  00:C502                    ~ 		LD H,0
     569.  00:C502                    ~ 		LD DE,VT_
     570.  00:C502                    ~ 		ADD HL,DE
     571.  00:C502                    ~ 		LD A,[HL]
     572.  00:C502                    ~ .CH_ENV:	BIT 0,C
     573.  00:C502                    ~ 		JR NZ,.CH_NOEN
     574.  00:C502                    ~ 		OR [IX+CHNPRM_Env_En]
     575.  00:C502                    ~ .CH_NOEN:	LD [AYREGS+AR_AmplC],A
     576.  00:C502                    ~ 		BIT 7,B
     577.  00:C502                    ~ 		LD A,C
     578.  00:C502                    ~ 		JR Z,.NO_ENSL
     579.  00:C502                    ~ 		RLA
     580.  00:C502                    ~ 		RLA
     581.  00:C502                    ~ 		SRA A
     582.  00:C502                    ~ 		SRA A
     583.  00:C502                    ~ 		SRA A
     584.  00:C502                    ~ 		ADD A,[IX+CHNPRM_CrEnSl] ;SEE COMMENT BELOW
     585.  00:C502                    ~ 		BIT 5,B
     586.  00:C502                    ~ 		JR Z,.NO_ENAC
     587.  00:C502                    ~ 		LD [IX+CHNPRM_CrEnSl],A
     588.  00:C502                    ~ .NO_ENAC:	LD HL,PT3_AddToEn
     589.  00:C502                    ~ 		ADD A,[HL] ;BUG IN PT3 - NEED WORD HERE.
     590.  00:C502                    ~ 			   ;FIX IT IN NEXT VERSION?
     591.  00:C502                    ~ 		LD [HL],A
     592.  00:C502                    ~ 		JR .CH_MIX
     593.  00:C502                    ~ .NO_ENSL:	RRA
     594.  00:C502                    ~ 		ADD A,[IX+CHNPRM_CrNsSl]
     595.  00:C502                    ~ 		LD [AddToNs],A
     596.  00:C502                    ~ 		BIT 5,B
     597.  00:C502                    ~ 		JR Z,.CH_MIX
     598.  00:C502                    ~ 		LD [IX+CHNPRM_CrNsSl],A
     599.  00:C502                    ~ .CH_MIX:	LD A,B
     600.  00:C502                    ~ 		RRA
     601.  00:C502                    ~ 		AND $48
     602.  00:C502                    ~ .CH_EXIT:	LD HL,AYREGS+AR_Mixer
     603.  00:C502                    ~ 		OR [HL]
     604.  00:C502                    ~ 		RRCA
     605.  00:C502                    ~ 		LD [HL],A
     606.  00:C502                    ~ 		POP HL
     607.  00:C502                    ~ 		XOR A
     608.  00:C502                    ~ 		OR [IX+CHNPRM_COnOff]
     609.  00:C502                    ~ 		RET Z
     610.  00:C502                    ~ 		DEC [IX+CHNPRM_COnOff]
     611.  00:C502                    ~ 		RET NZ
     612.  00:C502                    ~ 		XOR [IX+CHNPRM_Flags]
     613.  00:C502                    ~ 		LD [IX+CHNPRM_Flags],A
     614.  00:C502                    ~ 		RRA
     615.  00:C502                    ~ 		LD A,[IX+CHNPRM_OnOffD]
     616.  00:C502                    ~ 		JR C,.CH_ONDL
     617.  00:C502                    ~ 		LD A,[IX+CHNPRM_OffOnD]
     618.  00:C502                    ~ .CH_ONDL:	LD [IX+CHNPRM_COnOff],A
     619.  00:C502                    ~ 		RET
     620.  00:C502                    ~ 
     621.  00:C502                    ~ PT3_PLAY:
     622.  00:C502                    ~ 		ld a,(mutesong)
     623.  00:C502                    ~ 		or a
     624.  00:C502                    ~ 		ret nz
     625.  00:C502                    ~ 		
     626.  00:C502                    ~ 		LD [PT3_AddToEn],A
     627.  00:C502                    ~ 		LD [AYREGS+AR_Mixer],A
     628.  00:C502                    ~ 		DEC A
     629.  00:C502                    ~ 		LD [AYREGS+AR_EnvTp],A
     630.  00:C502                    ~ 		LD HL,DelyCnt
     631.  00:C502                    ~ 		DEC [HL]
     632.  00:C502                    ~ 		JP NZ,.PL2
     633.  00:C502                    ~ 		LD HL,ChanA+CHNPRM_NtSkCn
     634.  00:C502                    ~ 		DEC [HL]
     635.  00:C502                    ~ 		JR NZ,.PL1B
     636.  00:C502                    ~ 		LD BC,[PT3_AdInPtA]
     637.  00:C502                    ~ 		LD A,[BC]
     638.  00:C502                    ~ 		AND A
     639.  00:C502                    ~ 		JR NZ,.PL1A
     640.  00:C502                    ~ 		LD D,A
     641.  00:C502                    ~ 		LD [Ns_Base],A
     642.  00:C502                    ~ 		LD HL,[PT3_CrPsPtr]
     643.  00:C502                    ~ 		INC HL
     644.  00:C502                    ~ 		LD A,[HL]
     645.  00:C502                    ~ 		INC A
     646.  00:C502                    ~ 		JR NZ,.PLNLP
     647.  00:C502                    ~ 		CALL CHECKLP
     648.  00:C502                    ~ 		LD HL,[PT3_LPosPtr]
     649.  00:C502                    ~ 		LD A,[HL]
     650.  00:C502                    ~ 		INC A
     651.  00:C502                    ~ .PLNLP:	LD [PT3_CrPsPtr],HL
     652.  00:C502                    ~ 		DEC A
     653.  00:C502                    ~ 		ADD A,A
     654.  00:C502                    ~ 		LD E,A
     655.  00:C502                    ~ 		RL D
     656.  00:C502                    ~ 		LD HL,[PT3_PatsPtr]
     657.  00:C502                    ~ 		ADD HL,DE
     658.  00:C502                    ~ 		LD DE,[PT3_MODADDR]
     659.  00:C502                    ~ 		LD [PT3_PSP],SP
     660.  00:C502                    ~ 		LD SP,HL
     661.  00:C502                    ~ 		POP HL
     662.  00:C502                    ~ 		ADD HL,DE
     663.  00:C502                    ~ 		LD B,H
     664.  00:C502                    ~ 		LD C,L
     665.  00:C502                    ~ 		POP HL
     666.  00:C502                    ~ 		ADD HL,DE
     667.  00:C502                    ~ 		LD [PT3_AdInPtB],HL
     668.  00:C502                    ~ 		POP HL
     669.  00:C502                    ~ 		ADD HL,DE
     670.  00:C502                    ~ 		LD [PT3_AdInPtC],HL
     671.  00:C502                    ~ 		LD SP,[PT3_PSP]
     672.  00:C502                    ~ 
     673.  00:C502                    ~ .PL1A:		LD IX,ChanA+12
     674.  00:C502                    ~ 		CALL PTDECOD
     675.  00:C502                    ~ 		LD [PT3_AdInPtA],BC
     676.  00:C502                    ~ 
     677.  00:C502                    ~ .PL1B:		LD HL,ChanB+CHNPRM_NtSkCn
     678.  00:C502                    ~ 		DEC [HL]
     679.  00:C502                    ~ 		JR NZ,.PL1C
     680.  00:C502                    ~ 		LD IX,ChanB+12
     681.  00:C502                    ~ 		LD BC,[PT3_AdInPtB]
     682.  00:C502                    ~ 		CALL PTDECOD
     683.  00:C502                    ~ 		LD [PT3_AdInPtB],BC
     684.  00:C502                    ~ 
     685.  00:C502                    ~ .PL1C:		LD HL,ChanC+CHNPRM_NtSkCn
     686.  00:C502                    ~ 		DEC [HL]
     687.  00:C502                    ~ 		JR NZ,.PL1D
     688.  00:C502                    ~ 		LD IX,ChanC+12
     689.  00:C502                    ~ 		LD BC,[PT3_AdInPtC]
     690.  00:C502                    ~ 		CALL PTDECOD
     691.  00:C502                    ~ 		LD [PT3_AdInPtC],BC
     692.  00:C502                    ~ 
     693.  00:C502                    ~ .PL1D:		LD A,[PT3_Delay]
     694.  00:C502                    ~ 		LD [DelyCnt],A
     695.  00:C502                    ~ 
     696.  00:C502                    ~ .PL2:		LD IX,ChanA
     697.  00:C502                    ~ 		LD HL,[AYREGS+AR_TonA]
     698.  00:C502                    ~ 		CALL CHREGS
     699.  00:C502                    ~ 		LD [AYREGS+AR_TonA],HL
     700.  00:C502                    ~ 		LD A,[AYREGS+AR_AmplC]
     701.  00:C502                    ~ 		LD [AYREGS+AR_AmplA],A
     702.  00:C502                    ~ 		LD IX,ChanB
     703.  00:C502                    ~ 		LD HL,[AYREGS+AR_TonB]
     704.  00:C502                    ~ 		CALL CHREGS
     705.  00:C502                    ~ 		LD [AYREGS+AR_TonB],HL
     706.  00:C502                    ~ 		LD A,[AYREGS+AR_AmplC]
     707.  00:C502                    ~ 		LD [AYREGS+AR_AmplB],A
     708.  00:C502                    ~ 		LD IX,ChanC
     709.  00:C502                    ~ 		LD HL,[AYREGS+AR_TonC]
     710.  00:C502                    ~ 		CALL CHREGS
     711.  00:C502                    ~ 		LD [AYREGS+AR_TonC],HL
     712.  00:C502                    ~ 
     713.  00:C502                    ~ 		LD HL,[Ns_Base_AddToNs]
     714.  00:C502                    ~ 		LD A,H
     715.  00:C502                    ~ 		ADD A,L
     716.  00:C502                    ~ 		LD [AYREGS+AR_Noise],A
     717.  00:C502                    ~ 
     718.  00:C502                    ~ 		LD A,[PT3_AddToEn]
     719.  00:C502                    ~ 		LD E,A
     720.  00:C502                    ~ 		ADD A,A
     721.  00:C502                    ~ 		SBC A,A
     722.  00:C502                    ~ 		LD D,A
     723.  00:C502                    ~ 		LD HL,[EnvBase]
     724.  00:C502                    ~ 		ADD HL,DE
     725.  00:C502                    ~ 		LD DE,[CurESld]
     726.  00:C502                    ~ 		ADD HL,DE
     727.  00:C502                    ~ 		LD [AYREGS+AR_Env],HL
     728.  00:C502                    ~ 
     729.  00:C502                    ~ 		XOR A
     730.  00:C502                    ~ 		LD HL,CurEDel
     731.  00:C502                    ~ 		OR [HL]
     732.  00:C502                    ~ 		RET Z
     733.  00:C502                    ~ 		DEC [HL]
     734.  00:C502                    ~ 		RET NZ
     735.  00:C502                    ~ 		LD A,[PT3_Env_Del]
     736.  00:C502                    ~ 		LD [HL],A
     737.  00:C502                    ~ 		LD HL,[PT3_ESldAdd]
     738.  00:C502                    ~ 		ADD HL,DE
     739.  00:C502                    ~ 		LD [CurESld],HL
     740.  00:C502                    ~ 		RET
     741.  00:C502                    ~ 
     742.  00:C502                    ~ EMPTYSAMORN: 	db 0,1,0,$90 ;delete $90 if you don't need default sample
     743.  00:C502                    ~ 
     744.  00:C502                    ~ NT_:	;Note table 2 [if you use another in Vortex Tracker II copy it and paste
     745.  00:C502                    ~ 	;it from TABLES.TXT]
     746.  00:C502                    ~ 
     747.  00:C502                    ~ 		dw $0D10,$0C55,$0BA4,$0AFC,$0A5F,$09CA,$093D,$08B8,$083B,$07C5,$0755,$06EC
     748.  00:C502                    ~ 		dw $0688,$062A,$05D2,$057E,$052F,$04E5,$049E,$045C,$041D,$03E2,$03AB,$0376
     749.  00:C502                    ~ 		dw $0344,$0315,$02E9,$02BF,$0298,$0272,$024F,$022E,$020F,$01F1,$01D5,$01BB
     750.  00:C502                    ~ 		dw $01A2,$018B,$0174,$0160,$014C,$0139,$0128,$0117,$0107,$00F9,$00EB,$00DD
     751.  00:C502                    ~ 		dw $00D1,$00C5,$00BA,$00B0,$00A6,$009D,$0094,$008C,$0084,$007C,$0075,$006F
     752.  00:C502                    ~ 		dw $0069,$0063,$005D,$0058,$0053,$004E,$004A,$0046,$0042,$003E,$003B,$0037
     753.  00:C502                    ~ 		dw $0034,$0031,$002F,$002C,$0029,$0027,$0025,$0023,$0021,$001F,$001D,$001C
     754.  00:C502                    ~ 		dw $001A,$0019,$0017,$0016,$0015,$0014,$0012,$0011,$0010,$000F,$000E,$000D
     755.  00:C502                    ~ 
     756.  00:C502                    ~ ;
     757.  00:C502                    ~ ; WARNING: This routine must always exist
     758.  00:C502                    ~ ; Enables music looping
     759.  00:C502                    ~ ;	
     760.  00:C502                    ~ music_loopon:
     761.  00:C502                    ~ 		xor a
     762.  00:C502                    ~  		ld (PT3_SETUP),a  ; loop enabled!
     763.  00:C502                    ~ 		ret
     764.  00:C502                    ~ 
     765.  00:C502                    ~ ;
     766.  00:C502                    ~ ; WARNING: This routine must always exist
     767.  00:C502                    ~ ; Disables music looping
     768.  00:C502                    ~ ;	
     769.  00:C502                    ~ music_loopoff:
     770.  00:C502                    ~ 		ld a,1
     771.  00:C502                    ~  		ld (PT3_SETUP),a  ; no loop!
     772.  00:C502                    ~ 		ret
     773.  00:C502                    ~ 		
     774.  00:C502                    ~ ;
     775.  00:C502                    ~ ; WARNING: This routine must always exist
     776.  00:C502                    ~ ; Sets the music to be played
     777.  00:C502                    ~ ;	
     778.  00:C502                    ~ music_set:
     779.  00:C502                    ~ 		or a
     780.  00:C502                    ~ 		jr z,music_mute
     781.  00:C502                    ~ 		dec a
     782.  00:C502                    ~ 		ld hl,songtab
     783.  00:C502                    ~ 		add a,a             ; double accumulator.
     784.  00:C502                    ~ 		add a,l			
     785.  00:C502                    ~ 		ld l,a			
     786.  00:C502                    ~ 		adc a,h			
     787.  00:C502                    ~ 		sub l			
     788.  00:C502                    ~ 		ld h,a			
     789.  00:C502                    ~ 		ld a,(hl)
     790.  00:C502                    ~ 		inc	hl
     791.  00:C502                    ~ 		ld h,(hl)
     792.  00:C502                    ~ 		ld l,a				; HL=song pointer	
     793.  00:C502                    ~ 		xor a
     794.  00:C502                    ~ 		ld (mutesong),a	
     795.  00:C502                    ~ 		jp PT3_INIT
     796.  00:C502                    ~ ;
     797.  00:C502                    ~ ; WARNING: This routine must always exist
     798.  00:C502                    ~ ; Plays a music frame. To be called from an interrupt
     799.  00:C502                    ~ ;	
     800.  00:C502                    ~ music_play:
     801.  00:C502                    ~ 		jp PT3_PLAY
     802.  00:C502                    ~ 
     803.  00:C502                    ~ ;
     804.  00:C502                    ~ ; WARNING: This routine must always exist
     805.  00:C502                    ~ ; Mutes music playing (in this engine it also works as a way to initialize)
     806.  00:C502                    ~ ;
     807.  00:C502                    ~ music_init:	
     808.  00:C502                    ~ music_mute:	
     809.  00:C502                    ~ 		ld a,1
     810.  00:C502                    ~ 		ld (mutesong),a
     811.  00:C502                    ~ 
     812.  00:C502                    ~ resetregs:
     813.  00:C502                    ~ 		ld hl,AYREGS
     814.  00:C502                    ~ 		ld de,AYREGS+1
     815.  00:C502                    ~ 		ld bc,13
     816.  00:C502                    ~ 		ld (hl),0
     817.  00:C502                    ~ 		ldir
     818.  00:C502                    ~ 		ret
     819.  00:C502                    ~ 		; needs to continue with psgrout
     820.  00:C502                    ~ ;
     821.  00:C502                    ~ ; WARNING: This routine must always exist
     822.  00:C502                    ~ ; Dumps buffer content (AYREGS) to PSG registers (0-13)
     823.  00:C502                    ~ ;		
     824.  00:C502                    ~ 		
     825.  00:C502                    ~ psgrout:	
     826.  00:C502                    ~ 		xor a
     827.  00:C502                    ~ ; --- fixes bits 6 and 7 of mixer ---
     828.  00:C502                    ~ 		ld	hl,AYREGS+AR_Mixer
     829.  00:C502                    ~ 		set	7,(hl)
     830.  00:C502                    ~ 		res	6,(hl)
     831.  00:C502                    ~ 
     832.  00:C502                    ~ 		ld c,MSX_PSGDW
     833.  00:C502                    ~ 		ld hl,AYREGS
     834.  00:C502                    ~ .lout:		
     835.  00:C502                    ~ 		out (MSX_PSGLW),a
     836.  00:C502                    ~ 		outi 
     837.  00:C502                    ~ 		inc a
     838.  00:C502                    ~ 		cp 13
     839.  00:C502                    ~ 		jr nz,.lout
     840.  00:C502                    ~ 		out (MSX_PSGLW),a
     841.  00:C502                    ~ 		ld a,(hl)
     842.  00:C502                    ~ 		and a
     843.  00:C502                    ~ 		ret m
     844.  00:C502                    ~ 		out (MSX_PSGDW),a
     845.  00:C502                    ~ 		ret
     846.  00:C502                    ~ 			
     847.  00:C502                    ~ 	endif
     848.  00:C502                      	
    7500   00:C502                      	include "ayFX-ROM.asm"
       1.  00:C502                      		; --- ayFX REPLAYER v1.31 ---
       2.  00:C502                      
       3.  00:C502                      		; --- v1.31	Fixed bug on previous version, only PSG channel C worked
       4.  00:C502                      		; --- v1.3	Fixed volume and Relative volume versions on the same file, conditional compilation
       5.  00:C502                      		; ---		Support for dynamic or fixed channel allocation
       6.  00:C502                      		; --- v1.2f/r	ayFX bank support
       7.  00:C502                      		; --- v1.11f/r	If a frame volume is zero then no AYREGS update
       8.  00:C502                      		; --- v1.1f/r	Fixed volume for all ayFX streams
       9.  00:C502                      		; --- v1.1	Explicit priority (as suggested by AR)
      10.  00:C502                      		; --- v1.0f	Bug fixed (error when using noise)
      11.  00:C502                      		; --- v1.0	Initial release
      12.  00:C502                      
      13.  00:C502                      		; --- DEFINE FX_RELATIVE AS 0 FOR FIXED VOLUME VERSION ---
      14.  00:C502                      		; --- DEFINE FX_RELATIVE AS 1 FOR RELATIVE VOLUME VERSION ---
      15.  00:C502                      		
      16.  00:C502                      		if XFLAG
      17.  00:C502                      
      18.  00:C502                      ;
      19.  00:C502                      ; WARNING: This routine must always exist
      20.  00:C502                      ; Setups the SFX playing routine (if needed)
      21.  00:C502                      ;					
      22.  00:C502                      sfx_init:
      23.  00:C502  21 17 C6            		ld hl,sfxbank
      24.  00:C505  CD 0B C5            		call ayFX_SETUP
      25.  00:C508  C3 EB C5            		jp resetregs
      26.  00:C50B                      
      27.  00:C50B                      ;
      28.  00:C50B                      ; WARNING: This routine must always exist
      29.  00:C50B                      ; Plays a frame of an ayFX stream. To be called from interrupt
      30.  00:C50B                      ;			
      31.  00:C50B  (00:C555)           sfx_play:	equ ayFX_PLAY
      32.  00:C50B                      		
      33.  00:C50B                      ;
      34.  00:C50B                      ; core routines
      35.  00:C50B                      ;
      36.  00:C50B                      ayFX_SETUP:	; ---          ayFX replayer setup          ---
      37.  00:C50B                      		; --- INPUT: HL -> pointer to the ayFX bank ---
      38.  00:C50B  22 5F 40            		ld	[ayFX_BANK],hl			; Current ayFX bank
      39.  00:C50E  3E 00               		ld a,FX_MODE				; a:=0
      40.  00:C510  32 5E 40            		ld	[ayFX_MODE],a			; Initial mode: fixed channel
      41.  00:C513  3E 01               		ld a,FX_CHANNEL				; Starting channel (=1=C)
      42.  00:C515  32 68 40            		ld	[ayFX_CHANNEL],a		; Updated
      43.  00:C518                      
      44.  00:C518                      ;ayFX_END:	; --- End of an ayFX stream ---
      45.  00:C518                      
      46.  00:C518                      ;
      47.  00:C518                      ; WARNING: This routine must always exist
      48.  00:C518                      ; Stops & mute a SFX playing
      49.  00:C518                      ;					
      50.  00:C518                      sfx_mute:
      51.  00:C518  3E FF               		ld	a,255				; Lowest ayFX priority		
      52.  00:C51A  32 61 40            		ld	[ayFX_PRIORITY],a	; Priority saved (not playing ayFX stream)
      53.  00:C51D                      	if ( YFLAG = 0 )	
      54.  00:C51D  C3 EB C5            		jp resetregs
      55.  00:C520                      	else
      56.  00:C520                    ~ 		ld a,(mutesong)
      57.  00:C520                    ~ 		or a
      58.  00:C520                    ~ 		jp nz,resetregs
      59.  00:C520                    ~ 		ld a,(ayFX_MODE)
      60.  00:C520                    ~ 		or a
      61.  00:C520                    ~ 		jp nz,resetregs
      62.  00:C520                    ~ 
      63.  00:C520                    ~ 		ld a,(ayFX_CHANNEL)
      64.  00:C520                    ~ 		ld b,a
      65.  00:C520                    ~ 		ld a,11
      66.  00:C520                    ~ 		sub b
      67.  00:C520                    ~ 		ld c,a
      68.  00:C520                    ~ 		ld hl,AYREGS
      69.  00:C520                    ~ 		ADD_HL_A
      70.  00:C520                    ~ 		ld (hl),0
      71.  00:C520                    ~ 		;
      72.  00:C520                    ~ 		ld b,9
      73.  00:C520                    ~ 		ld a,c
      74.  00:C520                    ~ 		sub 8
      75.  00:C520                    ~ 		ld c,a
      76.  00:C520                    ~ 		or a
      77.  00:C520                    ~ 		jr z,reset
      78.  00:C520                    ~ 		rlc b
      79.  00:C520                    ~ 		dec a
      80.  00:C520                    ~ 		jr z,reset
      81.  00:C520                    ~ 		rlc b
      82.  00:C520                    ~ reset:
      83.  00:C520                    ~ 		ld a,b
      84.  00:C520                    ~ 		ld	[AYREGS+7],a
      85.  00:C520                    ~ 		;
      86.  00:C520                    ~ 		ld hl,AYREGS
      87.  00:C520                    ~ 		ld a,c
      88.  00:C520                    ~ 		add a,a
      89.  00:C520                    ~ 		ADD_HL_A
      90.  00:C520                    ~ 		ld (hl),0
      91.  00:C520                    ~ 		inc hl
      92.  00:C520                    ~ 		ld (hl),0
      93.  00:C520                    ~ 		ret
      94.  00:C520                    ~ 	endif
      95.  00:C520                      
      96.  00:C520                      ;
      97.  00:C520                      ; WARNING: This routine must always exist
      98.  00:C520                      ; Initialize a SFX for playing
      99.  00:C520                      ;			
     100.  00:C520                      sfx_set:
     101.  00:C520                      		; ld c,0				; always maximum priority (no variable supported)
     102.  00:C520                      		
     103.  00:C520                      ayFX_INIT:	; ---     INIT A NEW ayFX STREAM     ---
     104.  00:C520                      		; --- INPUT: A -> sound to be played ---
     105.  00:C520                      		; ---        C -> sound priority     ---
     106.  00:C520  C5                  		push	bc				; Store bc in stack
     107.  00:C521  D5                  		push	de				; Store de in stack
     108.  00:C522  E5                  		push	hl				; Store hl in stack
     109.  00:C523                      		; --- Check if the index is in the bank ---
     110.  00:C523  47                  		ld	b,a					; b:=a (new ayFX stream index)
     111.  00:C524  2A 5F 40            		ld	hl,[ayFX_BANK]			; Current ayFX BANK
     112.  00:C527  7E                  		ld	a,[hl]				; Number of samples in the bank
     113.  00:C528  B7                  		or	a					; If zero (means 256 samples)...
     114.  00:C529  28 06               		jr	z,.CHECK_PRI			; ...goto .CHECK_PRI
     115.  00:C52B                      		; The bank has less than 256 samples
     116.  00:C52B  78                  		ld	a,b					; a:=b (new ayFX stream index)
     117.  00:C52C  BE                  		cp	[hl]				; If new index is not in the bank...
     118.  00:C52D  3E 02               		ld	a,2					; a:=2 (error 2: Sample not in the bank)
     119.  00:C52F  30 20               		jr	nc,.INIT_END			; ...we can't init it
     120.  00:C531                      .CHECK_PRI:	; --- Check if the new priority is lower than the current one ---
     121.  00:C531                      		; ---   Remember: 0 = highest priority, 15 = lowest priority  ---
     122.  00:C531  3A 61 40            		ld	a,[ayFX_PRIORITY]	; a:=Current ayFX stream priority
     123.  00:C534  B9                  		cp	c					; If new ayFX stream priority is lower than current one...
     124.  00:C535  3E 01               		ld	a,1					; a:=1 (error 1: A sample with higher priority is being played)
     125.  00:C537  38 18               		jr	c,.INIT_END			; ...we don't start the new ayFX stream
     126.  00:C539                      		; --- Set new priority ---
     127.  00:C539  79                  		ld	a,c					; a:=New priority
     128.  00:C53A  E6 0F               		and	$0F					; We mask the priority
     129.  00:C53C  32 61 40            		ld	[ayFX_PRIORITY],a	; new ayFX stream priority saved in RAM
     130.  00:C53F                      
     131.  00:C53F                       	if FX_RELATIVE			   
     132.  00:C53F                    ~ 		; --- Volume adjust using PT3 volume table ---
     133.  00:C53F                    ~ 		ld	c,a					; c:=New priority (fixed)
     134.  00:C53F                    ~ 		ld	a,15				; a:=15
     135.  00:C53F                    ~ 		sub	c					; a:=15-New priority = relative volume
     136.  00:C53F                    ~ 		jr	z,.INIT_NOSOUND		; If priority is 15 -> no sound output (volume is zero)
     137.  00:C53F                    ~ 		add	a,a					; a:=a*2
     138.  00:C53F                    ~ 		add	a,a					; a:=a*4
     139.  00:C53F                    ~ 		add	a,a					; a:=a*8
     140.  00:C53F                    ~ 		add	a,a					; a:=a*16
     141.  00:C53F                    ~ 		ld	e,a					; e:=a
     142.  00:C53F                    ~ 		ld	d,0					; de:=a
     143.  00:C53F                    ~ 		ld	hl,VT_				; hl:=PT3 volume table
     144.  00:C53F                    ~ 		add	hl,de				; hl is a pointer to the relative volume table
     145.  00:C53F                    ~ 		ld	[ayFX_VT],hl		; Save pointer
     146.  00:C53F                    ~ 	endif
     147.  00:C53F                      
     148.  00:C53F                      		; --- Calculate the pointer to the new ayFX stream ---
     149.  00:C53F  ED 5B 5F 40         		ld	de,[ayFX_BANK]		; de:=Current ayFX bank
     150.  00:C543  13                  		inc	de					; de points to the increments table of the bank
     151.  00:C544  68                  		ld	l,b					; l:=b (new ayFX stream index)
     152.  00:C545  26 00               		ld	h,0					; hl:=b (new ayFX stream index)
     153.  00:C547  29                  		add	hl,hl				; hl:=hl*2
     154.  00:C548  19                  		add	hl,de				; hl:=hl+de (hl points to the correct increment)
     155.  00:C549  5E                  		ld	e,[hl]				; e:=lower byte of the increment
     156.  00:C54A  23                  		inc	hl					; hl points to the higher byte of the correct increment
     157.  00:C54B  56                  		ld	d,[hl]				; de:=increment
     158.  00:C54C  19                  		add	hl,de				; hl:=hl+de (hl points to the new ayFX stream)		
     159.  00:C54D  22 62 40            		ld	[ayFX_POINTER],hl	; Pointer saved in RAM
     160.  00:C550  AF                  		xor	a					; a:=0 (no errors)
     161.  00:C551  E1                  .INIT_END:	pop	hl				; Retrieve hl from stack
     162.  00:C552  D1                  		pop	de					; Retrieve de from stack
     163.  00:C553  C1                  		pop	bc					; Retrieve bc from stack
     164.  00:C554  C9                  		ret						; Return
     165.  00:C555                      
     166.  00:C555                       	if FX_RELATIVE			   
     167.  00:C555                    ~ .INIT_NOSOUND:	; --- Init a sample with relative volume zero -> no sound output ---
     168.  00:C555                    ~ 		ld	a,255				; Lowest ayFX priority
     169.  00:C555                    ~ 		ld	[ayFX_PRIORITY],a	; Priority saved (not playing ayFX stream)
     170.  00:C555                    ~ 		jr	.INIT_END			; Jumps to .INIT_END
     171.  00:C555                    ~ 	endif
     172.  00:C555                      
     173.  00:C555                      ayFX_PLAY:	; --- PLAY A FRAME OF AN ayFX STREAM ---
     174.  00:C555  3A 61 40            		ld	a,[ayFX_PRIORITY]	; a:=Current ayFX stream priority
     175.  00:C558  B7                  		or	a					; If priority has bit 7 on...
     176.  00:C559  F8                  		ret	m					; ...return
     177.  00:C55A                      		; --- Calculate next ayFX channel (if needed) ---
     178.  00:C55A  3A 5E 40            		ld	a,[ayFX_MODE]		; ayFX mode
     179.  00:C55D  E6 01               		and	1					; If bit0=0 (fixed channel)...
     180.  00:C55F  28 08               		jr	z,.TAKECB			; ...skip channel changing
     181.  00:C561  21 68 40            		ld	hl,ayFX_CHANNEL		; Old ayFX playing channel
     182.  00:C564  35                  		dec	[hl]				; New ayFX playing channel
     183.  00:C565  20 02               		jr	nz,.TAKECB			; If not zero jump to .TAKECB
     184.  00:C567  36 03               		ld	[hl],3				; If zero -> set channel 3
     185.  00:C569                      .TAKECB:	; --- Extract control byte from stream ---
     186.  00:C569  2A 62 40            		ld	hl,[ayFX_POINTER]	; Pointer to the current ayFX stream
     187.  00:C56C  4E                  		ld	c,[hl]				; c:=Control byte
     188.  00:C56D  23                  		inc	hl					; Increment pointer
     189.  00:C56E                      		; --- Check if there's new tone on stream ---
     190.  00:C56E  CB 69               		bit	5,c					; If bit 5 c is off...
     191.  00:C570  28 08               		jr	z,.CHECK_NN			; ...jump to .CHECK_NN (no new tone)
     192.  00:C572                      		; --- Extract new tone from stream ---
     193.  00:C572  5E                  		ld	e,[hl]				; e:=lower byte of new tone
     194.  00:C573  23                  		inc	hl					; Increment pointer
     195.  00:C574  56                  		ld	d,[hl]				; d:=higher byte of new tone
     196.  00:C575  23                  		inc	hl					; Increment pointer
     197.  00:C576  ED 53 64 40         		ld	[ayFX_TONE],de		; ayFX tone updated
     198.  00:C57A                      .CHECK_NN:	; --- Check if there's new noise on stream ---
     199.  00:C57A  CB 71               		bit	6,c					; if bit 6 c is off...
     200.  00:C57C  28 0A               		jr	z,.SETPOINTER		; ...jump to .SETPOINTER (no new noise)
     201.  00:C57E                      		; --- Extract new noise from stream ---
     202.  00:C57E  7E                  		ld	a,[hl]				; a:=New noise
     203.  00:C57F  23                  		inc	hl					; Increment pointer
     204.  00:C580  FE 20               		cp	$20					; If it's an illegal value of noise (used to mark end of stream)...
     205.  00:C582  CA 18 C5            		jp	z,sfx_mute			; ...jump to sfx_mute/ayFX_END
     206.  00:C585  32 66 40            		ld	[ayFX_NOISE],a		; ayFX noise updated
     207.  00:C588                      .SETPOINTER:	; --- Update ayFX pointer ---
     208.  00:C588  22 62 40            		ld	[ayFX_POINTER],hl	; Update ayFX stream pointer
     209.  00:C58B                      		; --- Extract volume ---
     210.  00:C58B  79                  		ld	a,c					; a:=Control byte
     211.  00:C58C  E6 0F               		and	$0F					; lower nibble
     212.  00:C58E                      
     213.  00:C58E                       	if FX_RELATIVE
     214.  00:C58E                    ~ 		; --- Fix the volume using PT3 Volume Table ---
     215.  00:C58E                    ~ 		ld	hl,[ayFX_VT]		; hl:=Pointer to relative volume table
     216.  00:C58E                    ~ 		ld	e,a					; e:=a (ayFX volume)
     217.  00:C58E                    ~ 		ld	d,0					; d:=0
     218.  00:C58E                    ~ 		add	hl,de				; hl:=hl+de (hl points to the relative volume of this frame
     219.  00:C58E                    ~ 		ld	a,[hl]				; a:=ayFX relative volume
     220.  00:C58E                    ~ 		or	a					; If relative volume is zero...
     221.  00:C58E                    ~ 	endif
     222.  00:C58E                      
     223.  00:C58E  32 67 40            		ld	[ayFX_VOLUME],a		; ayFX volume updated
     224.  00:C591  C8                  		ret	z					; ...return (don't copy ayFX values in to AYREGS)
     225.  00:C592                      		; -------------------------------------
     226.  00:C592                      		; --- COPY ayFX VALUES IN TO AYREGS ---
     227.  00:C592                      		; -------------------------------------
     228.  00:C592                      		; --- Set noise channel ---
     229.  00:C592  CB 79               		bit	7,c					; If noise is off...
     230.  00:C594  20 06               		jr	nz,.SETMASKS		; ...jump to .SETMASKS
     231.  00:C596  3A 66 40            		ld	a,[ayFX_NOISE]		; ayFX noise value
     232.  00:C599  32 6F 40            		ld	[AYREGS+6],a		; copied in to AYREGS (noise channel)
     233.  00:C59C                      .SETMASKS:	; --- Set mixer masks ---
     234.  00:C59C  79                  		ld	a,c					; a:=Control byte
     235.  00:C59D  E6 90               		and	$90					; Only bits 7 and 4 (noise and tone mask for psg reg 7)
     236.  00:C59F  FE 90               		cp	$90					; If no noise and no tone...
     237.  00:C5A1  C8                  		ret	z					; ...return (don't copy ayFX values in to AYREGS)
     238.  00:C5A2                      		; --- Copy ayFX values in to ARYREGS ---
     239.  00:C5A2  0F                  		rrca					; Rotate a to the right (1 TIME)
     240.  00:C5A3  0F                  		rrca					; Rotate a to the right (2 TIMES) (OR mask)
     241.  00:C5A4  16 DB               		ld	d,$DB				; d:=Mask for psg mixer (AND mask)
     242.  00:C5A6                      		; --- Dump to correct channel ---
     243.  00:C5A6  21 68 40            		ld	hl,ayFX_CHANNEL		; Next ayFX playing channel
     244.  00:C5A9  46                  		ld	b,[hl]				; Channel counter
     245.  00:C5AA                      .CHK1:		; --- Check if playing channel was 1 ---
     246.  00:C5AA  10 0D               		djnz	.CHK2			; Decrement and jump if channel was not 1
     247.  00:C5AC                      .PLAY_C:	; --- Play ayFX stream on channel C ---
     248.  00:C5AC  CD DB C5            		call	.SETMIXER		; Set PSG mixer value (returning a=ayFX volume and hl=ayFX tone)
     249.  00:C5AF  32 73 40            		ld	[AYREGS+10],a		; Volume copied in to AYREGS (channel C volume)
     250.  00:C5B2  CB 51               		bit	2,c					; If tone is off...
     251.  00:C5B4  C0                  		ret	nz					; ...return
     252.  00:C5B5  22 6D 40            		ld	[AYREGS+4],hl		; copied in to AYREGS (channel C tone)
     253.  00:C5B8  C9                  		ret						; Return
     254.  00:C5B9                      .CHK2:		; --- Check if playing channel was 2 ---
     255.  00:C5B9  CB 0A               		rrc	d					; Rotate right AND mask
     256.  00:C5BB  0F                  		rrca					; Rotate right OR mask
     257.  00:C5BC  10 0D               		djnz	.CHK3			; Decrement and jump if channel was not 2
     258.  00:C5BE                      .PLAY_B:	; --- Play ayFX stream on channel B ---
     259.  00:C5BE  CD DB C5            		call .SETMIXER			; Set PSG mixer value (returning a=ayFX volume and hl=ayFX tone)
     260.  00:C5C1  32 72 40            		ld	[AYREGS+9],a		; Volume copied in to AYREGS (channel B volume)
     261.  00:C5C4  CB 49               		bit	1,c					; If tone is off...
     262.  00:C5C6  C0                  		ret	nz				; ...return
     263.  00:C5C7  22 6B 40            		ld [AYREGS+2],hl		; copied in to AYREGS (channel B tone)
     264.  00:C5CA  C9                  		ret						; Return
     265.  00:C5CB                      .CHK3:		; --- Check if playing channel was 3 ---
     266.  00:C5CB  CB 0A               		rrc	d					; Rotate right AND mask
     267.  00:C5CD  0F                  		rrca					; Rotate right OR mask
     268.  00:C5CE                      .PLAY_A:	; --- Play ayFX stream on channel A ---
     269.  00:C5CE  CD DB C5            		call .SETMIXER			; Set PSG mixer value (returning a=ayFX volume and hl=ayFX tone)
     270.  00:C5D1  32 71 40            		ld	[AYREGS+8],a		; Volume copied in to AYREGS (channel A volume)
     271.  00:C5D4  CB 41               		bit	0,c					; If tone is off...
     272.  00:C5D6  C0                  		ret	nz					; ...return
     273.  00:C5D7  22 69 40            		ld	[AYREGS+0],hl		; copied in to AYREGS (channel A tone)
     274.  00:C5DA  C9                  		ret					; Return
     275.  00:C5DB                      .SETMIXER:	; --- Set PSG mixer value ---
     276.  00:C5DB  4F                  		ld	c,a					; c:=OR mask
     277.  00:C5DC  3A 70 40            		ld	a,[AYREGS+7]		; a:=PSG mixer value
     278.  00:C5DF  A2                  		and	d					; AND mask
     279.  00:C5E0  B1                  		or	c					; OR mask
     280.  00:C5E1  32 70 40            		ld	[AYREGS+7],a		; PSG mixer value updated
     281.  00:C5E4  3A 67 40            		ld	a,[ayFX_VOLUME]		; a:=ayFX volume value
     282.  00:C5E7  2A 64 40            		ld	hl,[ayFX_TONE]		; ayFX tone value
     283.  00:C5EA  C9                  		ret						; Return
     284.  00:C5EB                      
     285.  00:C5EB                      
     286.  00:C5EB                      	if ( YFLAG = 0 )	
     287.  00:C5EB                      
     288.  00:C5EB                      	; If there's no PSG player we need to provide these routines
     289.  00:C5EB                      resetregs:
     290.  00:C5EB  21 69 40            		ld hl,AYREGS
     291.  00:C5EE  11 6A 40            		ld de,AYREGS+1
     292.  00:C5F1  01 0D 00            		ld bc,13
     293.  00:C5F4  36 00               		ld (hl),0
     294.  00:C5F6  ED B0               		ldir
     295.  00:C5F8  C9                  		ret
     296.  00:C5F9                      psgrout:	
     297.  00:C5F9  AF                  		xor a
     298.  00:C5FA                      ; --- fixes bits 6 and 7 of mixer ---
     299.  00:C5FA  21 70 40            		ld	hl,AYREGS+AR_Mixer
     300.  00:C5FD  CB FE               		set	7,(hl)
     301.  00:C5FF  CB B6               		res	6,(hl)
     302.  00:C601                      
     303.  00:C601  0E A1               		ld c,MSX_PSGDW
     304.  00:C603  21 69 40            		ld hl,AYREGS
     305.  00:C606                      .lout:		
     306.  00:C606  D3 A0               		out (MSX_PSGLW),a
     307.  00:C608  ED A3               		outi 
     308.  00:C60A  3C                  		inc a
     309.  00:C60B  FE 0D               		cp 13
     310.  00:C60D  20 F7               		jr nz,.lout
     311.  00:C60F  D3 A0               		out (MSX_PSGLW),a
     312.  00:C611  7E                  		ld a,(hl)
     313.  00:C612  A7                  		and a
     314.  00:C613  F8                  		ret m
     315.  00:C614  D3 A1               		out (MSX_PSGDW),a
     316.  00:C616  C9                  		ret
     317.  00:C617                      		
     318.  00:C617                      	if FX_RELATIVE
     319.  00:C617                    ~ 
     320.  00:C617                    ~ 		; --- UNCOMMENT THIS BLOCK if YOU DON'T USE THIS REPLAYER WITH PT3 REPLAYER ---
     321.  00:C617                    ~ VT_:	db 000h,000h,000h,000h,000h,000h,000h,000h,001h,001h,001h,001h,001h,001h,001h,001h
     322.  00:C617                    ~ 		db 000h,000h,000h,000h,001h,001h,001h,001h,001h,001h,001h,001h,002h,002h,002h,002h
     323.  00:C617                    ~ 		db 000h,000h,000h,001h,001h,001h,001h,001h,002h,002h,002h,002h,002h,003h,003h,003h
     324.  00:C617                    ~ 		db 000h,000h,001h,001h,001h,001h,002h,002h,002h,002h,003h,003h,003h,003h,004h,004h
     325.  00:C617                    ~ 		db 000h,000h,001h,001h,001h,002h,002h,002h,003h,003h,003h,004h,004h,004h,005h,005h
     326.  00:C617                    ~ 		db 000h,000h,001h,001h,002h,002h,002h,003h,003h,004h,004h,004h,005h,005h,006h,006h
     327.  00:C617                    ~ 		db 000h,000h,001h,001h,002h,002h,003h,003h,004h,004h,005h,005h,006h,006h,007h,007h
     328.  00:C617                    ~ 		db 000h,001h,001h,002h,002h,003h,003h,004h,004h,005h,005h,006h,006h,007h,007h,008h
     329.  00:C617                    ~ 		db 000h,001h,001h,002h,002h,003h,004h,004h,005h,005h,006h,007h,007h,008h,008h,009h
     330.  00:C617                    ~ 		db 000h,001h,001h,002h,003h,003h,004h,005h,005h,006h,007h,007h,008h,009h,009h,00Ah
     331.  00:C617                    ~ 		db 000h,001h,001h,002h,003h,004h,004h,005h,006h,007h,007h,008h,009h,00Ah,00Ah,00Bh
     332.  00:C617                    ~ 		db 000h,001h,002h,002h,003h,004h,005h,006h,006h,007h,008h,009h,00Ah,00Ah,00Bh,00Ch
     333.  00:C617                    ~ 		db 000h,001h,002h,003h,003h,004h,005h,006h,007h,008h,009h,00Ah,00Ah,00Bh,00Ch,00Dh
     334.  00:C617                    ~ 		db 000h,001h,002h,003h,004h,005h,006h,007h,007h,008h,009h,00Ah,00Bh,00Ch,00Dh,00Eh
     335.  00:C617                    ~ 		db 000h,001h,002h,003h,004h,005h,006h,007h,008h,009h,00Ah,00Bh,00Ch,00Dh,00Eh,00Fh 
     336.  00:C617                    ~ 		; --- UNCOMMENT THIS if YOU DON'T USE THIS REPLAYER WITH PT3 REPLAYER ---
     337.  00:C617                    ~ 
     338.  00:C617                    ~ 	endif
     339.  00:C617                      	
     340.  00:C617                      	endif
     341.  00:C617                      
     342.  00:C617                      	endif
     343.  00:C617                      		
    7501   00:C617                      
    7502   00:C617                      	if XFLAG
    7503   00:C617                      	
    7504   00:C617  (0116)              sfxbank:	incbin "..\resources\sfx.afb"
    7505   00:C72D                      	
    7506   00:C72D                      	endif	
    7507   00:C72D                      
    7508   00:C72D                      ; Game-specific data and events code generated by the compiler ------------------
    7509   00:C72D                      
    7510   00:C72D                      ; ======================================================================================
    7511   00:C72D                      ;
    7512   00:C72D                      ; BEGINNING OF RAM AREA: The following data needs to be located in RAM!!!
    7513   00:C72D                      ;
    7514   00:C72D                      ; ======================================================================================
    7515   00:C72D                      
    7516   00:C72D                      ; Variables that NEED to be initialized and when in RAM mode can be autoinitialized for free
    7517   00:C72D                      
    7518   00:C72D                      	if DISTYPE!=ROM
    7519   00:C72D                    ~ 
    7520   00:C72D                    ~ score:		db "000000" 		; player's score  000000 .
    7521   00:C72D                    ~ hiscor:		db "000000" 		; high score  000000 .
    7522   00:C72D                    ~ bonus:		db "000000" 		; bonus  000000 .
    7523   00:C72D                    ~ displ0:		db 0,0,0,13+128
    7524   00:C72D                    ~ 
    7525   00:C72D                    ~ 	if EFLAG
    7526   00:C72D                    ~ 
    7527   00:C72D                    ~ sndtyp:		db 0
    7528   00:C72D                    ~ 
    7529   00:C72D                    ~ 	endif
    7530   00:C72D                    ~ 
    7531   00:C72D                    ~ 	if PFLAG
    7532   00:C72D                    ~ 
    7533   00:C72D                    ~ shrplot:	dw prosh1
    7534   00:C72D                    ~ 
    7535   00:C72D                    ~ 	endif
    7536   00:C72D                    ~ 
    7537   00:C72D                    ~ 	if SFLAG
    7538   00:C72D                    ~ 	
    7539   00:C72D                    ~ scrlyoff:	db 1
    7540   00:C72D                    ~ 	
    7541   00:C72D                    ~ 	endif
    7542   00:C72D                    ~ 	
    7543   00:C72D                    ~ 	if MFLAG
    7544   00:C72D                    ~ 	
    7545   00:C72D                    ~ mod0:	db $C3,0,0
    7546   00:C72D                    ~ mod1:	db $C3,0,0
    7547   00:C72D                    ~ mod2:	db $C3,0,0
    7548   00:C72D                    ~ 
    7549   00:C72D                    ~ 	endif
    7550   00:C72D                    ~ 
    7551   00:C72D                    ~ 	ifdef DATA00
    7552   00:C72D                    ~ rptr00:		dw rdat00
    7553   00:C72D                    ~ 	endif
    7554   00:C72D                    ~ 	ifdef DATA01
    7555   00:C72D                    ~ rptr01:		dw rdat01
    7556   00:C72D                    ~ 	endif
    7557   00:C72D                    ~ 	ifdef DATA02
    7558   00:C72D                    ~ rptr02:		dw rdat02
    7559   00:C72D                    ~ 	endif
    7560   00:C72D                    ~ 	ifdef DATA03
    7561   00:C72D                    ~ rptr03:		dw rdat03
    7562   00:C72D                    ~ 	endif
    7563   00:C72D                    ~ 	ifdef DATA04
    7564   00:C72D                    ~ rptr04:		dw rdat04
    7565   00:C72D                    ~ 	endif
    7566   00:C72D                    ~ 	ifdef DATA05
    7567   00:C72D                    ~ rptr05:		dw rdat05
    7568   00:C72D                    ~ 	endif
    7569   00:C72D                    ~ 	ifdef DATA06
    7570   00:C72D                    ~ rptr06:		dw rdat06
    7571   00:C72D                    ~ 	endif
    7572   00:C72D                    ~ 	ifdef DATA07
    7573   00:C72D                    ~ rptr07:		dw rdat07
    7574   00:C72D                    ~ 	endif
    7575   00:C72D                    ~ 	ifdef DATA08
    7576   00:C72D                    ~ rptr08:		dw rdat08
    7577   00:C72D                    ~ 	endif
    7578   00:C72D                    ~ 	ifdef DATA09
    7579   00:C72D                    ~ rptr09:		dw rdat09
    7580   00:C72D                    ~ 	endif
    7581   00:C72D                    ~ 	ifdef DATA10
    7582   00:C72D                    ~ rptr10:		dw rdat10
    7583   00:C72D                    ~ 	endif
    7584   00:C72D                    ~ 	ifdef DATA11
    7585   00:C72D                    ~ rptr11:		dw rdat11
    7586   00:C72D                    ~ 	endif
    7587   00:C72D                    ~ 	ifdef DATA12
    7588   00:C72D                    ~ rptr12:		dw rdat12
    7589   00:C72D                    ~ 	endif
    7590   00:C72D                    ~ 	ifdef DATA13
    7591   00:C72D                    ~ rptr13:		dw rdat13
    7592   00:C72D                    ~ 	endif
    7593   00:C72D                    ~ 	ifdef DATA14
    7594   00:C72D                    ~ rptr14:		dw rdat14
    7595   00:C72D                    ~ 	endif
    7596   00:C72D                    ~ 	ifdef DATA15
    7597   00:C72D                    ~ rptr15:		dw rdat15
    7598   00:C72D                    ~ 	endif
    7599   00:C72D                    ~ 	ifdef DATA16
    7600   00:C72D                    ~ rptr16:		dw rdat16
    7601   00:C72D                    ~ 	endif
    7602   00:C72D                    ~ 	ifdef DATA17
    7603   00:C72D                    ~ rptr17:		dw rdat17
    7604   00:C72D                    ~ 	endif
    7605   00:C72D                    ~ 	ifdef DATA18
    7606   00:C72D                    ~ rptr18:		dw rdat18
    7607   00:C72D                    ~ 	endif
    7608   00:C72D                    ~ 	ifdef DATA19
    7609   00:C72D                    ~ rptr19:		dw rdat19
    7610   00:C72D                    ~ 	endif
    7611   00:C72D                    ~ 	ifdef DATA20
    7612   00:C72D                    ~ rptr20:		dw rdat20
    7613   00:C72D                    ~ 	endif
    7614   00:C72D                    ~ 
    7615   00:C72D                    ~ ; Don't change the order of these four.  Menu routine relies on winlft following wintop.
    7616   00:C72D                    ~ 
    7617   00:C72D                    ~ wintop		db WINDOWTOP		; top of window.
    7618   00:C72D                    ~ winlft		db WINDOWLFT		; left edge.
    7619   00:C72D                    ~ winhgt		db WINDOWHGT		; window height.
    7620   00:C72D                    ~ winwid		db WINDOWWID		; window width.
    7621   00:C72D                    ~ 
    7622   00:C72D                    ~ 	endif
    7623   00:C72D                      
    7624   00:C72D                      	if DISTYPE=ROM		
    7625   00:C72D                      
    7626   00:C72D  (00:C72D)           endprogram:	equ $
    7627   00:C72D                      
    7628   00:C72D                      	else
    7629   00:C72D                    ~ 	
    7630   00:C72D                    ~ endprogram:	equ main + ::0
    7631   00:C72D                    ~ 
    7632   00:C72D                    ~ 	endif
    7633   00:C72D                      	
    7634   00:C72D                      ; Fill the rest of the page
    7635   00:C72D                      
    7636   00:C72D                      ;~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~
    7637   00:C72D                      	include "CV_BIOS.asm"
       1.  00:C72D                      ;-----------------------------------------------------------
       2.  00:C72D                      ; Colecovision BIOS calls
       3.  00:C72D                      ;-----------------------------------------------------------
       4.  00:C72D                      
       5.  00:C72D  (00:1FD9)           WRITE_REGISTER:		equ $1fd9
       6.  00:C72D  (00:0055)           PATSIZE:		equ (sprgfx-chgfx)/8
       7.  00:C72D  (00:1105)           CONTROLLER_INIT:	equ $1105
       8.  00:C72D  (00:1FEB)           POLLER:			equ $1feb
       9.  00:C72D  (00:5C9E)           clock:			equ MSX_JIFFY
      10.  00:C72D                      
      11.  00:C72D                      ;-----------------------------------------------------------
      12.  00:C72D                      ; - Setup Screen 2,2
      13.  00:C72D                      ; - Interrupts are disabled
      14.  00:C72D                      ; - Fill screen 3x with chars 0-255
      15.  00:C72D                      ; - Clear char table
      16.  00:C72D                      ;-----------------------------------------------------------
      17.  00:C72D                      
      18.  00:C72D                      CV_INIGRP:
      19.  00:C72D  01 02 00            	ld bc,0002h		; Reg 0: Mode 2
      20.  00:C730  CD D9 1F            	call WRITE_REGISTER
      21.  00:C733  01 06 02            	ld bc,0206h        	; Name table 1800h
      22.  00:C736  CD D9 1F            	call WRITE_REGISTER
      23.  00:C739  01 FF 03            	ld bc,03ffh        	; Colour table 2000h
      24.  00:C73C  CD D9 1F            	call WRITE_REGISTER
      25.  00:C73F  01 03 04            	ld bc,0403h        	; Pattern table 0000h
      26.  00:C742  CD D9 1F            	call WRITE_REGISTER
      27.  00:C745  01 36 05            	ld bc,0536h        	; Sprite attribute table 1b00h
      28.  00:C748  CD D9 1F            	call WRITE_REGISTER
      29.  00:C74B  01 07 06            	ld bc,0607h        	; Sprite pattern table 3800h
      30.  00:C74E  CD D9 1F            	call WRITE_REGISTER
      31.  00:C751  01 00 07            	ld bc,0700h        	; Base colours
      32.  00:C754  CD D9 1F            	call WRITE_REGISTER
      33.  00:C757  01 E2 01            	ld bc,01e2h		; Reg 1: Mode 2, 16k, no interrupts, 16x16 sprites
      34.  00:C75A  CD D9 1F            	call WRITE_REGISTER
      35.  00:C75D                      
      36.  00:C75D                      ; Fill screen 3x 0-255
      37.  00:C75D                      
      38.  00:C75D  21 00 18            	ld hl,MSX_NAMTBL		
      39.  00:C760  CD 96 C7            	call CV_SETWRT
      40.  00:C763  AF                          xor a
      41.  00:C764  06 03               	ld b,3
      42.  00:C766                      nxtblk:
      43.  00:C766  D3 BE               	out (MSX_VDPDRW),a
      44.  00:C768  3C                  	inc a
      45.  00:C769  20 FB               	jr nz,nxtblk
      46.  00:C76B  10 F9               	djnz nxtblk
      47.  00:C76D                      
      48.  00:C76D                      ; Clear char table
      49.  00:C76D                      
      50.  00:C76D  CD 71 C7            	call CV_CLS		
      51.  00:C770  C9                  	ret
      52.  00:C771                      
      53.  00:C771                      ;-----------------------------------------------------------
      54.  00:C771                      ; Clear the VDP Pattern table (clears screen)
      55.  00:C771                      ;-----------------------------------------------------------
      56.  00:C771                      
      57.  00:C771                      CV_CLS:
      58.  00:C771  01 00 18            	ld bc,256/8*192
      59.  00:C774  C5                  	push bc
      60.  00:C775  21 00 00            	ld hl,MSX_CHRTBL		; Clear char table
      61.  00:C778  AF                          xor a
      62.  00:C779  CD 87 C7            	call CV_FILVRM
      63.  00:C77C                      
      64.  00:C77C  21 00 20            	ld hl,MSX_CLRTBL		; Clear colour tabel
      65.  00:C77F  3A EA 53            	ld a,(MSX_BAKCLR)
      66.  00:C782  C1                  	pop bc
      67.  00:C783  CD 87 C7            	call CV_FILVRM
      68.  00:C786                      
      69.  00:C786  C9                  	ret
      70.  00:C787                      
      71.  00:C787                      ;-----------------------------------------------------------
      72.  00:C787                      ; Fill a section of VRAM with value in A
      73.  00:C787                      ; HL = VRAM Address
      74.  00:C787                      ; BC = Length
      75.  00:C787                      ;-----------------------------------------------------------
      76.  00:C787                      
      77.  00:C787                      CV_FILVRM:
      78.  00:C787  5F                  	ld e,a
      79.  00:C788  CD 96 C7            	call CV_SETWRT
      80.  00:C78B                      FLOOP:
      81.  00:C78B  7B                  	ld a,e
      82.  00:C78C  D3 BE               	out (MSX_VDPDRW),a
      83.  00:C78E  0B                  	dec bc
      84.  00:C78F  79                  	ld a,c
      85.  00:C790  B0                  	or b
      86.  00:C791  FE 00               	cp 0
      87.  00:C793  20 F6               	jr nz,FLOOP
      88.  00:C795  C9                  	ret
      89.  00:C796                      
      90.  00:C796                      ;-----------------------------------------------------------
      91.  00:C796                      ; Set write to Video Ram
      92.  00:C796                      ; HL = VRAM Address
      93.  00:C796                      ;-----------------------------------------------------------
      94.  00:C796                      
      95.  00:C796                      CV_SETWRT:
      96.  00:C796  F3                  	di
      97.  00:C797  7D                  	ld a,l
      98.  00:C798  D3 BF               	out (MSX_VDPCW),a
      99.  00:C79A  7C                  	ld a,h
     100.  00:C79B  E6 3F               	and 3Fh
     101.  00:C79D  F6 40               	or 40h
     102.  00:C79F  D3 BF               	out (MSX_VDPCW),a
     103.  00:C7A1  FB                  	ei
     104.  00:C7A2  C9                  	ret
     105.  00:C7A3                      
     106.  00:C7A3                      ;-----------------------------------------------------------
     107.  00:C7A3                      ; Write data in VRAM
     108.  00:C7A3                      ; HL = VRAM Address
     109.  00:C7A3                      ; A  = data
     110.  00:C7A3                      ;-----------------------------------------------------------
     111.  00:C7A3                      
     112.  00:C7A3                      CV_WRTVRM:
     113.  00:C7A3  F5                  	push af
     114.  00:C7A4  CD 96 C7            	call CV_SETWRT
     115.  00:C7A7  F1                  	pop af
     116.  00:C7A8  D3 BE               	out (MSX_VDPDRW),a
     117.  00:C7AA  C9                  	ret
     118.  00:C7AB                      
     119.  00:C7AB                      ;-----------------------------------------------------------
     120.  00:C7AB                      ; Read data from VRAM
     121.  00:C7AB                      ; HL = VRAM Address
     122.  00:C7AB                      ; A  = data
     123.  00:C7AB                      ;-----------------------------------------------------------
     124.  00:C7AB                      
     125.  00:C7AB                      CV_RDVRM:
     126.  00:C7AB  7D                  	ld a,l
     127.  00:C7AC  D3 BF               	out (MSX_VDPCW),a 
     128.  00:C7AE  7C                  	ld a,h
     129.  00:C7AF  E6 3F               	and 3Fh
     130.  00:C7B1  D3 BF               	out (MSX_VDPCW),a
     131.  00:C7B3  DB BF               	in a,(MSX_VDPSR)
     132.  00:C7B5  C9                  	ret
    7638   00:C7B6                      ;~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~
    7639   00:C7B6                      	
    7640   00:C7B6                      /*
    7641   00:C7B6                    ~ 	if DISTYPE=ROM
    7642   00:C7B6                    ~ 
    7643   00:C7B6                    ~ 	output rom_filler.bin
    7644   00:C7B6                    ~ 
    7645   00:C7B6                    ~ 	org endprogram
    7646   00:C7B6                    ~ 	
    7647   00:C7B6                    ~ 
    7648   00:C7B6                    ~ 		if ($ & $8000)!=0
    7649   00:C7B6                    ~ 			block $4000-($-8000h),255
    7650   00:C7B6                    ~ 		else
    7651   00:C7B6                    ~ 			block $4000-($-4000h),255
    7652   00:C7B6                    ~ 		endif
    7653   00:C7B6                    ~ 		
    7654   00:C7B6                    ~ 	endif
    7655   00:C7B6                    ~ 	*/
    7656   00:C7B6                      ;
    7657   00:C7B6                      ;
    7658   00:C7B6                      ;
    7659   00:C7B6                      	output ram_vars.tmp
    7660   00:0000                      
    7661   00:0000                      ;~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~
    7662   00:0000                      ;	defpage 0, $8080	
    7663   00:0000                      ;~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~
    7664   00:0000                      		
    7665   00:0000                      	if DISTYPE=ROM	
    7666   00:0000                      
    7667   00:0000  (4000)              		phase $4000 ; ROM model variables that need to be initialized. Minimum 8KB RAM needed
    7668   00:4000                      
    7669   00:4000  (00:4000)           varbegin: equ $	
    7670   00:4000                      
    7671   00:4000                      ; Don't change the order of these 5 variables.
    7672   00:4000  00 (6)              score:		ds 6		; player's score  000000 .
    7673   00:4006  00 (6)              hiscor:		ds 6		; high score  000000 .
    7674   00:400C  00 (6)              bonus:		ds 6		; bonus  000000 .
    7675   00:4012  00 (4)              displ0:		ds 4
    7676   00:4016                      
    7677   00:4016                      ;	if EFLAG
    7678   00:4016                      
    7679   00:4016  00 (1)              sndtyp:		ds 1		; sound type. don't move!
    7680   00:4017                      
    7681   00:4017                      ;	endif
    7682   00:4017                      
    7683   00:4017                      	if PFLAG
    7684   00:4017                      
    7685   00:4017  00 (2)              shrplot:	ds 2
    7686   00:4019                      
    7687   00:4019                      	endif
    7688   00:4019                      
    7689   00:4019                      	if SFLAG
    7690   00:4019                    ~ 	
    7691   00:4019                    ~ scrlyoff:	ds 1
    7692   00:4019                    ~ 	
    7693   00:4019                    ~ 	endif
    7694   00:4019                      
    7695   00:4019                      	if MFLAG
    7696   00:4019                    ~ 	
    7697   00:4019                    ~ mod0:	ds 3
    7698   00:4019                    ~ mod1:	ds 3
    7699   00:4019                    ~ mod2:	ds 3
    7700   00:4019                    ~ 
    7701   00:4019                    ~ 	endif
    7702   00:4019                      
    7703   00:4019                      	ifdef DATA00
    7704   00:4019                    ~ rptr00:		ds 2
    7705   00:4019                    ~ 	endif
    7706   00:4019                      	ifdef DATA01
    7707   00:4019                    ~ rptr01:		ds 2
    7708   00:4019                    ~ 	endif
    7709   00:4019                      	ifdef DATA02
    7710   00:4019                    ~ rptr02:		ds 2
    7711   00:4019                    ~ 	endif
    7712   00:4019                      	ifdef DATA03
    7713   00:4019                    ~ rptr03:		ds 2
    7714   00:4019                    ~ 	endif
    7715   00:4019                      	ifdef DATA04
    7716   00:4019                    ~ rptr04:		ds 2
    7717   00:4019                    ~ 	endif
    7718   00:4019                      	ifdef DATA05
    7719   00:4019                    ~ rptr05:		ds 2
    7720   00:4019                    ~ 	endif
    7721   00:4019                      	ifdef DATA06
    7722   00:4019                    ~ rptr06:		ds 2
    7723   00:4019                    ~ 	endif
    7724   00:4019                      	ifdef DATA07
    7725   00:4019                    ~ rptr07:		ds 2
    7726   00:4019                    ~ 	endif
    7727   00:4019                      	ifdef DATA08
    7728   00:4019                    ~ rptr08:		ds 2
    7729   00:4019                    ~ 	endif
    7730   00:4019                      	ifdef DATA09
    7731   00:4019                    ~ rptr09:		ds 2
    7732   00:4019                    ~ 	endif
    7733   00:4019                      	ifdef DATA10
    7734   00:4019                    ~ rptr10:		ds 2
    7735   00:4019                    ~ 	endif
    7736   00:4019                      	ifdef DATA11
    7737   00:4019                    ~ rptr11:		ds 2
    7738   00:4019                    ~ 	endif
    7739   00:4019                      	ifdef DATA12
    7740   00:4019                    ~ rptr12:		ds 2
    7741   00:4019                    ~ 	endif
    7742   00:4019                      	ifdef DATA13
    7743   00:4019                    ~ rptr13:		ds 2
    7744   00:4019                    ~ 	endif
    7745   00:4019                      	ifdef DATA14
    7746   00:4019                    ~ rptr14:		ds 2
    7747   00:4019                    ~ 	endif
    7748   00:4019                      	ifdef DATA15
    7749   00:4019                    ~ rptr15:		ds 2
    7750   00:4019                    ~ 	endif
    7751   00:4019                      	ifdef DATA16
    7752   00:4019                    ~ rptr16:		ds 2
    7753   00:4019                    ~ 	endif
    7754   00:4019                      	ifdef DATA17
    7755   00:4019                    ~ rptr17:		ds 2
    7756   00:4019                    ~ 	endif
    7757   00:4019                      ifdef DATA18
    7758   00:4019                    ~ rptr18:		ds 2
    7759   00:4019                    ~ 	endif
    7760   00:4019                      	ifdef DATA19
    7761   00:4019                    ~ rptr19:		ds 2
    7762   00:4019                    ~ 	endif
    7763   00:4019                      	ifdef DATA20
    7764   00:4019                    ~ rptr20:		ds 2
    7765   00:4019                    ~ 	endif
    7766   00:4019                      
    7767   00:4019                      	else
    7768   00:4019                    ~ 	
    7769   00:4019                    ~ 		phase endprogram ; ; if DISTYPE=ROM RAM model variables	
    7770   00:4019                    ~ 		
    7771   00:4019                    ~ varbegin: equ $	
    7772   00:4019                    ~ 	
    7773   00:4019                    ~ 	endif 
    7774   00:4019                      
    7775   00:4019                      ; RAM variables (initialization not needed)
    7776   00:4019                      
    7777   00:4019  00 (1)              loopa:		ds 1			; loop counter system variable. (23681)
    7778   00:401A  00 (1)              loopb:		ds 1			; loop counter system variable. (23728)
    7779   00:401B  00 (1)              loopc:		ds 1			; loop counter system variable. (23729)	
    7780   00:401C  00 (1)              vara:		ds 1			; general-purpose variable.
    7781   00:401D  00 (1)              varb:		ds 1			; general-purpose variable.
    7782   00:401E  00 (1)              varc:		ds 1			; general-purpose variable.
    7783   00:401F  00 (1)              vard:		ds 1			; general-purpose variable.
    7784   00:4020  00 (1)              vare:		ds 1			; general-purpose variable.
    7785   00:4021  00 (1)              varf:		ds 1			; general-purpose variable.
    7786   00:4022  00 (1)              varg:		ds 1			; general-purpose variable.
    7787   00:4023  00 (1)              varh:		ds 1			; general-purpose variable.
    7788   00:4024  00 (1)              vari:		ds 1			; general-purpose variable.
    7789   00:4025  00 (1)              varj:		ds 1			; general-purpose variable.
    7790   00:4026  00 (1)              vark:		ds 1			; general-purpose variable.
    7791   00:4027  00 (1)              varl:		ds 1			; general-purpose variable.
    7792   00:4028  00 (1)              varm:		ds 1			; general-purpose variable.
    7793   00:4029  00 (1)              varn:		ds 1			; general-purpose variable.
    7794   00:402A  00 (1)              varo:		ds 1			; general-purpose variable.
    7795   00:402B  00 (1)              varp:		ds 1			; general-purpose variable.
    7796   00:402C  00 (1)              varq:		ds 1			; general-purpose variable.
    7797   00:402D  00 (1)              varr:		ds 1			; general-purpose variable.
    7798   00:402E  00 (1)              vars:		ds 1			; general-purpose variable.
    7799   00:402F  00 (1)              vart:		ds 1			; general-purpose variable.
    7800   00:4030  00 (1)              varu:		ds 1			; general-purpose variable.
    7801   00:4031  00 (1)              varv:		ds 1			; general-purpose variable.
    7802   00:4032  00 (1)              varw:		ds 1			; general-purpose variable.
    7803   00:4033  00 (1)              varz:		ds 1			; general-purpose variable.
    7804   00:4034  00 (1)              contrl:		ds 1            ; control, 0 = keyboard, 1 = Kempston, 2 = Sinclair, 3 = Mouse.
    7805   00:4035  00 (1)              charx:		ds 1            ; cursor y position.
    7806   00:4036  00 (1)              chary:		ds 1            ; cursor x position.
    7807   00:4037  00 (1)              colpat:		ds 1	
    7808   00:4038  00 (1)              prtmod:		ds 1			; print mode, 0 = standard, 1 = double-height.	
    7809   00:4039  00 (1)              clratt:		ds 1			; color attributes
    7810   00:403A                      	
    7811   00:403A                      ; Scrolly text and puzzle variables.
    7812   00:403A                      
    7813   00:403A                      	if SFLAG
    7814   00:403A                    ~ txtbit:		ds 1			; bit to write.
    7815   00:403A                    ~ txtwid:		ds 1			; width of ticker message.
    7816   00:403A                    ~ txtpos:		ds 2			; 
    7817   00:403A                    ~ txtini:		ds 2			; 
    7818   00:403A                    ~ txtend:		ds 2			; 
    7819   00:403A                    ~ txtbeg:		ds 2			; 
    7820   00:403A                    ~ 	endif
    7821   00:403A                      
    7822   00:403A                      ; beeper variable
    7823   00:403A                      	if EFLAG
    7824   00:403A  00 (1)              snddelay:	ds 1
    7825   00:403B  00 (1)              beepVolume	ds 1
    7826   00:403C                      	endif
    7827   00:403C                      	
    7828   00:403C  00 (2)              spptr:		ds 2			; spawned sprite pointer.
    7829   00:403E  00 (1)              seed:		ds 1			; seed for random numbers.
    7830   00:403F  00 (2)              grbase:		ds 2			; graphics base address.
    7831   00:4041  00 (1)              joyval:		ds 1			; joystick reading.		
    7832   00:4042  00 (1)              scno:		ds 1            ; present screen number.
    7833   00:4043  00 (2)              ogptr:		ds 2            ; original sprite pointer.
    7834   00:4045  00 (1)              nsprite:	ds 1
    7835   00:4046  00 (1)              numlif:		ds 1            ; number of lives.
    7836   00:4047  00 (1)              curobj:		ds 1
    7837   00:4048  00 (2)              dirthig:	ds 2		
    7838   00:404A  00 (2)              skptr:  	ds 2            ; search pointer.
    7839   00:404C  00 (1)              highslot:	ds 1            ; highest free sprite number
    7840   00:404D  00 (1)              roomtb:		ds 1 	        ; room number.
    7841   00:404E                      
    7842   00:404E                      	if MFLAG
    7843   00:404E                    ~ bwid:		ds 1            ; box/menu width.
    7844   00:404E                    ~ blen:		ds 1            ; box/menu height.
    7845   00:404E                    ~ btop:		ds 1            ; box coordinates.
    7846   00:404E                    ~ blft:		ds 1
    7847   00:404E                    ~ 	endif
    7848   00:404E                      	
    7849   00:404E  00 (1)              frmno:		ds 1            ; current game frame.
    7850   00:404F  00 (1)              combyt:		ds 1			; byte type compressed.
    7851   00:4050                      ;comcnt: 	ds 1            ; compression counter.
    7852   00:4050                      
    7853   00:4050  00 (1)              seed3:		ds 1
    7854   00:4051  00 (1)              nexlev:		ds 1			; db 0               next level flag.
    7855   00:4052  00 (1)              restfl:		ds 1			; db 0               restart screen flag.
    7856   00:4053  00 (1)              deadf:		ds 1			; db 0              dead flag.
    7857   00:4054  00 (1)              gamwon:		ds 1			; db 0               game won flag.
    7858   00:4055  00 (1)              dispx:		ds 1			; db 0              cursor y position.
    7859   00:4056  00 (1)              dispy:		ds 1			; db 0              cursor x position.
    7860   00:4057  00 (1)              varrnd:		ds 1			; db 255             last random number.
    7861   00:4058  00 (1)              varobj:		ds 1			; db 254             last object number.
    7862   00:4059  00 (1)              varopt:		ds 1			; db 255             last option chosen from menu.
    7863   00:405A  00 (1)              varblk:		ds 1			; db 255             block type.
    7864   00:405B  00 (1)              offset:		ds 1
    7865   00:405C  00 (1)              select:		ds 1			; frames to wait until next SELECT key is accepted
    7866   00:405D  00 (1)              ticks:		ds 1			; PAL=50, NTSC=60
    7867   00:405E                      ; nohide:		ds 1
    7868   00:405E                      
    7869   00:405E                      	if RTFLAG
    7870   00:405E                    ~ usrsgn:		ds 1            ; sign.
    7871   00:405E                    ~ usrspd:		ds 1            ; speed.
    7872   00:405E                    ~ 	endif
    7873   00:405E                      	
    7874   00:405E  (00:405E)           varend:		equ $
    7875   00:405E                      
    7876   00:405E                      	include "PT3-RAM.asm"
       1.  00:405E                      	if YFLAG
       2.  00:405E                    ~ 	
       3.  00:405E                    ~ 		; --- THIS FILE MUST BE COMPILED IN RAM ---
       4.  00:405E                    ~ 
       5.  00:405E                    ~ 		; --- PT3 WORKAREA [self-modifying code patched] ---
       6.  00:405E                    ~ 
       7.  00:405E                    ~ PT3_MODADDR:	ds 2
       8.  00:405E                    ~ PT3_CrPsPtr:	ds 2
       9.  00:405E                    ~ PT3_SAMPTRS:	ds 2
      10.  00:405E                    ~ PT3_OrnPtrs:	ds 2
      11.  00:405E                    ~ PT3_PDSP:		ds 2
      12.  00:405E                    ~ PT3_CSP:		ds 2
      13.  00:405E                    ~ PT3_PSP:		ds 2
      14.  00:405E                    ~ PT3_PrNote:		ds 1
      15.  00:405E                    ~ PT3_PrSlide:	ds 2
      16.  00:405E                    ~ PT3_AdInPtA:	ds 2
      17.  00:405E                    ~ PT3_AdInPtB:	ds 2
      18.  00:405E                    ~ PT3_AdInPtC:	ds 2
      19.  00:405E                    ~ PT3_LPosPtr:	ds 2
      20.  00:405E                    ~ PT3_PatsPtr:	ds 2
      21.  00:405E                    ~ PT3_Delay:		ds 1
      22.  00:405E                    ~ PT3_AddToEn:	ds 1
      23.  00:405E                    ~ PT3_Env_Del:	ds 1
      24.  00:405E                    ~ PT3_ESldAdd:	ds 2
      25.  00:405E                    ~ 
      26.  00:405E                    ~ mutesong:		ds 1
      27.  00:405E                    ~ 
      28.  00:405E                    ~ PT3_SETUP:		ds 1	;set bit0 to 1, if you want to play without looping
      29.  00:405E                    ~ 						;bit7 is set each time, when loop point is passed
      30.  00:405E                    ~ 
      31.  00:405E                    ~ VARS:
      32.  00:405E                    ~ 
      33.  00:405E                    ~ ChanA:			ds 29			;CHNPRM_Size
      34.  00:405E                    ~ ChanB:			ds 29			;CHNPRM_Size
      35.  00:405E                    ~ ChanC:			ds 29			;CHNPRM_Size
      36.  00:405E                    ~ ;GlobalVars
      37.  00:405E                    ~ DelyCnt:		ds 1
      38.  00:405E                    ~ CurESld:		ds 2
      39.  00:405E                    ~ CurEDel:		ds 1
      40.  00:405E                    ~ Ns_Base_AddToNs:
      41.  00:405E                    ~ Ns_Base:		ds 1
      42.  00:405E                    ~ AddToNs:		ds 1
      43.  00:405E                    ~ 
      44.  00:405E                    ~ AYREGS:
      45.  00:405E                    ~ VT_:			ds 14
      46.  00:405E                    ~ EnvBase:		ds 2
      47.  00:405E                    ~ 
      48.  00:405E                    ~ VAR0END:		ds 240
      49.  00:405E                    ~ 
      50.  00:405E                    ~ 
      51.  00:405E                    ~ 	endif
      52.  00:405E                      	
    7877   00:405E                      	include "ayFX-RAM.asm"
       1.  00:405E                      		; --- ayFX REPLAYER v1.31 ---
       2.  00:405E                      
       3.  00:405E                      		; --- THIS FILE MUST BE COMPILED IN RAM ---
       4.  00:405E                      	if XFLAG
       5.  00:405E                      	
       6.  00:405E  00 (1)              ayFX_MODE:		ds 1			; ayFX mode
       7.  00:405F  00 (2)              ayFX_BANK:		ds 2			; Current ayFX Bank
       8.  00:4061  00 (1)              ayFX_PRIORITY:	ds 1			; Current ayFX stream priotity
       9.  00:4062  00 (2)              ayFX_POINTER:	ds 2			; Pointer to the current ayFX stream
      10.  00:4064  00 (2)              ayFX_TONE:		ds 2			; Current tone of the ayFX stream
      11.  00:4066  00 (1)              ayFX_NOISE:		ds 1			; Current noise of the ayFX stream
      12.  00:4067  00 (1)              ayFX_VOLUME:	ds 1			; Current volume of the ayFX stream
      13.  00:4068  00 (1)              ayFX_CHANNEL:	ds 1			; PSG channel to play the ayFX stream
      14.  00:4069                      
      15.  00:4069                       	if FX_RELATIVE
      16.  00:4069                    ~ 
      17.  00:4069                    ~ ayFX_VT:		ds 2			; ayFX relative volume table pointer
      18.  00:4069                    ~ 
      19.  00:4069                    ~ 	endif
      20.  00:4069                      
      21.  00:4069                      	if ( YFLAG = 0 )	
      22.  00:4069                      		
      23.  00:4069  00 (14)             AYREGS:			ds 14
      24.  00:4077                      
      25.  00:4077                      	endif
      26.  00:4077                      	
      27.  00:4077                      	endif
    7878   00:4077                      
    7879   00:4077  00 (2)              sprptr:		ds 2
    7880   00:4079  00 (2)              pblkptr:	ds 2
    7881   00:407B  00 (2)              stack:		ds 2
    7882   00:407D  00 (1)              time:		ds 1
    7883   00:407E                      
    7884   00:407E                      
    7885   00:407E                      	if DISTYPE=ROM
    7886   00:407E                      
    7887   00:407E  00 (22)             keys:		ds 22
    7888   00:4094                      
    7889   00:4094                      ; Don't change the order of these four.  Menu routine relies on winlft following wintop.
    7890   00:4094  00 (1)              wintop		ds 1		; top of window.
    7891   00:4095  00 (1)              winlft		ds 1		; left edge.
    7892   00:4096  00 (1)              winhgt		ds 1		; window height.
    7893   00:4097  00 (1)              winwid		ds 1		; window width.
    7894   00:4098                      
    7895   00:4098                      	endif
    7896   00:4098                      
    7897   00:4098                      CONTROLLER_BUFFER:
    7898   00:4098  00 (12)             	ds 12
    7899   00:40A4                      	
    7900   00:40A4                      
    7901   00:40A4                      ; Sprite table.
    7902   00:40A4                      ;
    7903   00:40A4                      ; ix+0  = type.	(TYPE)
    7904   00:40A4                      ; ix+1  = sprite image number. (IMAGE)
    7905   00:40A4                      ; ix+2  = frame. (FRAME)
    7906   00:40A4                      ; ix+3  = y coord. (Y)
    7907   00:40A4                      ; ix+4  = x coord. (X)
    7908   00:40A4                      
    7909   00:40A4                      ; ix+5  = color
    7910   00:40A4                      ; ix+6  = Not used
    7911   00:40A4                      ; ix+7  = Not used
    7912   00:40A4                      ; ix+8  = y coord backup
    7913   00:40A4                      ; ix+9  = x coord backup
    7914   00:40A4                      
    7915   00:40A4                      ; ix+10 = direction.
    7916   00:40A4                      ; ix+11 = parameter 1. (SETTINGA)
    7917   00:40A4                      ; ix+12 = parameter 2. (SETTINGB)
    7918   00:40A4                      ; ix+13 = jump pointer low. (AIRBORNE)
    7919   00:40A4                      ; ix+14 = jump pointer high. (JUMPSPEED)
    7920   00:40A4                      ; ix+15 = data pointer low.
    7921   00:40A4                      ; ix+16 = data pointer high.
    7922   00:40A4                      
    7923   00:40A4  00 (17)             ssprit:		ds TABSIZ
    7924   00:40B5  00 (544)            sprtab:		ds SPRBUF	   
    7925   00:42D5                      		
    7926   00:42D5                      	if (MAPSIZE > 128)
    7927   00:42D5  00 (432)            mapbuf:		ds MAPSIZE - 128	; spratr2+unaligned bytes are recycled
    7928   00:4485                      	else
    7929   00:4485                    ~ mapbuf:		equ $				; spratr2 is enough
    7930   00:4485                    ~ 	endif
    7931   00:4485                      ;
    7932   00:4485                      ; aligned tables
    7933   00:4485                      ;
    7934   00:4485                      ; move wisely!
    7935   00:4485                      ;
    7936   00:4485  (007B)              		ALIGN 256
    7937   00:4500                      		
    7938   00:4500  00 (128)            spratr2:	ds 128			; secondary sprite attribute table
    7939   00:4580  00 (128)            spratr:		ds 128			; full sprite attribute table. Cannot cross a 256 byte boundary
    7940   00:4600  00 (768)            MAP:		ds 768			; main attributes map. Stores tile attributes		
    7941   00:4900                      	
    7942   00:4900                      	if OFLAG
    7943   00:4900  00 (256)            objlist:	ds 256			; Objects coords list (max. 128 objects). Needs exact 256 alignment
    7944   00:4A00                      	endif
    7945   00:4A00                      
    7946   00:4A00  00 (768)            scrmap:		ds 768			; Blocks map. Keeps tile codes
    7947   00:4D00                      
    7948   00:4D00  00 (128)            mapspr:		ds 128			; Sprite mapping list (max. 64 sprites). Needs exact 256 alignment		
    7949   00:4D80                      
    7950   00:4D80  00 (64)             colltab:	ds 16*4			; Support till 16 Y-aligned sprites. Must not cross a 256 byte boundary
    7951   00:4DC0                      
    7952   00:4DC0                      ; end of aligned tables or data areas
    7953   00:4DC0                      
    7954   00:4DC0                      	if SFLAG
    7955   00:4DC0                    ~ scrbuf:		ds 256+8
    7956   00:4DC0                    ~ 	endif
    7957   00:4DC0                      	
    7958   00:4DC0                      	if PFLAG
    7959   00:4DC0  00 (2)              shraddr:	ds 2
    7960   00:4DC2  00 (486)            SHRAPN:		ds NUMSHR*SHRSIZ
    7961   00:4FA8                      	endif
    7962   00:4FA8                      		
    7963   00:4FA8                      	if (OFLAG and DISTYPE=ROM)
    7964   00:4FA8  00 (93)             objatr:		ds NUMOBJ*3
    7965   00:5005                      	endif
    7966   00:5005                      
    7967   00:5005                      	; if (DISTYPE=ROM and DISSIZE=48) or (DISTYPE!=ROM and DISSIZE=64)
    7968   00:5005                      	ifdef NOBIOS
    7969   00:5005                    ~ biosvars:	ds $38	
    7970   00:5005                    ~ 	endif
    7971   00:5005                      	
    7972   00:5005                      frames_passed:
    7973   00:5005  00                  	db 0
    7974   00:5006                      
    7975   00:5006  (00:5006)           eop:		equ $
    7976   00:5006                      
    7977   00:5006  (1006)              	dephase
    7978   00:1006                      
    7979   00:1006                      ;
    7980   00:1006                      ; Extra binary. Loaders for disk/tape versions
    7981   00:1006                      ;
    7982   00:1006                      /*
    7983   00:1006                    ~ 	if (DISTYPE!=ROM and DISSIZE>32)
    7984   00:1006                    ~ 	
    7985   00:1006                    ~ 		output loader.bin
    7986   00:1006                    ~ 
    7987   00:1006                    ~ 		db $FE
    7988   00:1006                    ~ 		dw slots
    7989   00:1006                    ~ 		dw endslots-1
    7990   00:1006                    ~ 		dw slots
    7991   00:1006                    ~ 
    7992   00:1006                    ~ 		org $F41F				; KBUF F41F-F55C(318 bytes available)
    7993   00:1006                    ~ 		
    7994   00:1006                    ~ slots:	equ $
    7995   00:1006                    ~ 	
    7996   00:1006                    ~ mvpage0:
    7997   00:1006                    ~ 		di
    7998   00:1006                    ~ 		call saveslots
    7999   00:1006                    ~ 		push de
    8000   00:1006                    ~ 		call enapage1
    8001   00:1006                    ~ 		call enapage0
    8002   00:1006                    ~ 		ld de,$0000
    8003   00:1006                    ~ 		jr putram
    8004   00:1006                    ~ mvpage1:  
    8005   00:1006                    ~ 		di
    8006   00:1006                    ~ 		call saveslots
    8007   00:1006                    ~ 		push de
    8008   00:1006                    ~ 		call enapage1
    8009   00:1006                    ~ 		ld de,$4000
    8010   00:1006                    ~ putram:
    8011   00:1006                    ~ 		ld hl,$8080
    8012   00:1006                    ~ 		ld bc,$4000
    8013   00:1006                    ~ 		ldir 
    8014   00:1006                    ~ 		pop de
    8015   00:1006                    ~ 		call loadslots
    8016   00:1006                    ~ 		ei
    8017   00:1006                    ~ 		ret
    8018   00:1006                    ~ 
    8019   00:1006                    ~ runpage0:
    8020   00:1006                    ~ 		jp runpage0a
    8021   00:1006                    ~ 
    8022   00:1006                    ~ runpage1:
    8023   00:1006                    ~ 		jp runpage1a
    8024   00:1006                    ~ 				
    8025   00:1006                    ~ saveslots:
    8026   00:1006                    ~ 		ld a,(MSX_SSSREG)
    8027   00:1006                    ~ 		cpl			; reverse all bits
    8028   00:1006                    ~ 		ld d,a		; Store the current secondary slots register
    8029   00:1006                    ~ 		in a,(MSX_PPIA)
    8030   00:1006                    ~ 		ld e,a		; Store the current primary slots register
    8031   00:1006                    ~ 		ret
    8032   00:1006                    ~ 		
    8033   00:1006                    ~ loadslots:		
    8034   00:1006                    ~ 		ld a,e
    8035   00:1006                    ~ 		out	(MSX_PPIA),a	; Restore the register as at start
    8036   00:1006                    ~ 		ld a,d
    8037   00:1006                    ~ 		ld (MSX_SSSREG),a	; Restore the register as at start				
    8038   00:1006                    ~ 		ret
    8039   00:1006                    ~ 
    8040   00:1006                    ~ runpage1a:
    8041   00:1006                    ~ 		di
    8042   00:1006                    ~ 		call inipage1
    8043   00:1006                    ~ 		jr run				
    8044   00:1006                    ~ 		
    8045   00:1006                    ~ runpage0a:
    8046   00:1006                    ~ 		di
    8047   00:1006                    ~ 		call inipage1
    8048   00:1006                    ~ 	if DISSIZE=64
    8049   00:1006                    ~ 		call cpbiosvars
    8050   00:1006                    ~ 	endif
    8051   00:1006                    ~ 		call enapage0
    8052   00:1006                    ~ run:		
    8053   00:1006                    ~ 		jp $4000
    8054   00:1006                    ~ 
    8055   00:1006                    ~ turboon:		
    8056   00:1006                    ~ 		ld a,(MSX_CHGCPU)
    8057   00:1006                    ~ 		cp $C3
    8058   00:1006                    ~ 		ld a,$81
    8059   00:1006                    ~ 		jp z,MSX_CHGCPU
    8060   00:1006                    ~ 		ret
    8061   00:1006                    ~ 		
    8062   00:1006                    ~ 	if DISTYPE=DISK
    8063   00:1006                    ~ drvmotoff:
    8064   00:1006                    ~ 		ld a,(MSX_MSLOT)	; motor off entry present?
    8065   00:1006                    ~ 		ld hl,MSX_MTOFF
    8066   00:1006                    ~ 		call MSX_RDSLT
    8067   00:1006                    ~ 		and	a
    8068   00:1006                    ~ 		ret	z				; no, no way....
    8069   00:1006                    ~ 		ld iy,(MSX_MSLOT-1)	; we have it! call it now
    8070   00:1006                    ~ 		ld ix,MSX_MTOFF
    8071   00:1006                    ~ 		jp MSX_CALSLT
    8072   00:1006                    ~ 	endif
    8073   00:1006                    ~ 
    8074   00:1006                    ~ 	if DISSIZE=64
    8075   00:1006                    ~ cpbiosvars:		
    8076   00:1006                    ~ 		ld hl,0
    8077   00:1006                    ~ 		ld de,biosvars
    8078   00:1006                    ~ 		ld bc,$0038
    8079   00:1006                    ~ 		ldir
    8080   00:1006                    ~ 		ret		
    8081   00:1006                    ~ 	endif
    8082   00:1006                    ~ 
    8083   00:1006                    ~ enapage0:
    8084   00:1006                    ~ 		ld d,$00
    8085   00:1006                    ~ 		ld hl,MSX_ENASLT
    8086   00:1006                    ~ 		jr setcall
    8087   00:1006                    ~ 
    8088   00:1006                    ~ inipage1:
    8089   00:1006                    ~ 	if DISTYPE=DISK
    8090   00:1006                    ~ 		call drvmotoff
    8091   00:1006                    ~ 	endif
    8092   00:1006                    ~ 		call turboon
    8093   00:1006                    ~ 		; falls through to enapage1
    8094   00:1006                    ~ enapage1:
    8095   00:1006                    ~ 		ld d,$40
    8096   00:1006                    ~ 		ld hl,($0025)
    8097   00:1006                    ~ setcall:
    8098   00:1006                    ~ 		ld (VEC_ENASLT+1),hl
    8099   00:1006                    ~ 
    8100   00:1006                    ~ 	
    8101   00:1006                    ~ ;	find a valid RAM page with the aid of BIOS
    8102   00:1006                    ~ ;	Input:
    8103   00:1006                    ~ ;		D = MSB of page address
    8104   00:1006                    ~ ;
    8105   00:1006                    ~ putRAMpgX:
    8106   00:1006                    ~ 		ld b,4
    8107   00:1006                    ~ sl_loop:
    8108   00:1006                    ~ 		ld c,b
    8109   00:1006                    ~ 		dec	c
    8110   00:1006                    ~ 		push de
    8111   00:1006                    ~ 		push bc
    8112   00:1006                    ~ 		call chkExp	;modifies B,AF,HL
    8113   00:1006                    ~ 		jp p,isNotExp
    8114   00:1006                    ~ 		call sub_chk
    8115   00:1006                    ~ 		jr nz,found
    8116   00:1006                    ~ 		jr sl_end
    8117   00:1006                    ~ isNotExp:            	
    8118   00:1006                    ~ 		;ld	h,#80
    8119   00:1006                    ~ 		ld	h,d
    8120   00:1006                    ~ 		ld	a,c
    8121   00:1006                    ~ 		push	hl
    8122   00:1006                    ~ 		push	af	
    8123   00:1006                    ~ 		call	VEC_ENASLT	;select unexpanded slot
    8124   00:1006                    ~ 		pop	de	;D contains the slot/subslot/expn bit
    8125   00:1006                    ~ 		pop	hl
    8126   00:1006                    ~ 		call	chkWrite
    8127   00:1006                    ~ 		jr	nz,found	;is RAM
    8128   00:1006                    ~ sl_end:	
    8129   00:1006                    ~ 		pop	bc
    8130   00:1006                    ~ 		pop	de
    8131   00:1006                    ~ 		djnz	sl_loop
    8132   00:1006                    ~ 		;if nothing jumped to "found", then A must be -1
    8133   00:1006                    ~ 		ld	a,-1
    8134   00:1006                    ~ 		jr	found2
    8135   00:1006                    ~ 
    8136   00:1006                    ~ found:
    8137   00:1006                    ~ 		pop	hl	;balance stack
    8138   00:1006                    ~ 		pop	hl
    8139   00:1006                    ~ 		;D = slot/sub/slot/expand bit
    8140   00:1006                    ~ found2:			;exit if stack is balanced
    8141   00:1006                    ~ 		ret
    8142   00:1006                    ~ 
    8143   00:1006                    ~ sub_chk:
    8144   00:1006                    ~ 		ld	a,c
    8145   00:1006                    ~ 		or	#80	;set expanded bit
    8146   00:1006                    ~ 		ld	b,4
    8147   00:1006                    ~ 		ld	h,d	;prepare page address in H
    8148   00:1006                    ~ sub_loop:
    8149   00:1006                    ~ 		push	bc
    8150   00:1006                    ~ 		ld	c,b
    8151   00:1006                    ~ 		dec	c
    8152   00:1006                    ~ 		rl	c
    8153   00:1006                    ~ 		rl	c
    8154   00:1006                    ~ 		or	c
    8155   00:1006                    ~ 		;ld	h,#80
    8156   00:1006                    ~ 		push	hl
    8157   00:1006                    ~ 		push	af
    8158   00:1006                    ~ 		call	VEC_ENASLT
    8159   00:1006                    ~ 		pop	af
    8160   00:1006                    ~ 		ld	d,a	;save slot/subslot/exp on D register
    8161   00:1006                    ~ 		and	#f3	;clean subslot bits for next iteration
    8162   00:1006                    ~ 		ld	e,a
    8163   00:1006                    ~ 		pop	hl
    8164   00:1006                    ~ 		call	chkWrite
    8165   00:1006                    ~ 		jr	nz,sub_end	;is RAM
    8166   00:1006                    ~ 		ld	a,e
    8167   00:1006                    ~ 		pop	bc
    8168   00:1006                    ~ 		djnz	sub_loop
    8169   00:1006                    ~ 		jr 	sub_end2
    8170   00:1006                    ~ 
    8171   00:1006                    ~ sub_end:
    8172   00:1006                    ~ 		pop	hl; 	balance stack
    8173   00:1006                    ~ 	;	pop	hl
    8174   00:1006                    ~ 
    8175   00:1006                    ~ sub_end2:	;exit if stack is balanced
    8176   00:1006                    ~ 		ret
    8177   00:1006                    ~ 
    8178   00:1006                    ~ chkWrite:
    8179   00:1006                    ~ 		;**********************************************		
    8180   00:1006                    ~ 		;chkWrite
    8181   00:1006                    ~ 		;
    8182   00:1006                    ~ 		;Checks whether address WRTTST is writable or not
    8183   00:1006                    ~ 		;
    8184   00:1006                    ~ 		;Input: none
    8185   00:1006                    ~ 		;Output: flag Z if non writable
    8186   00:1006                    ~ 		;Modified: AF
    8187   00:1006                    ~ 		;
    8188   00:1006                    ~ 
    8189   00:1006                    ~ 		ld	a,(hl)
    8190   00:1006                    ~ 		inc	(hl)
    8191   00:1006                    ~ 		cp	(hl)
    8192   00:1006                    ~ 		ld (hl),a
    8193   00:1006                    ~ 		ret
    8194   00:1006                    ~ 	
    8195   00:1006                    ~ 
    8196   00:1006                    ~ chkExp:
    8197   00:1006                    ~ 		;**********************************************	
    8198   00:1006                    ~ 		;chkExp
    8199   00:1006                    ~ 
    8200   00:1006                    ~ 		;Checks whether slot C is expanded or not
    8201   00:1006                    ~ 		;Result is returned in S flag (jp M or jp P)
    8202   00:1006                    ~ 		;
    8203   00:1006                    ~ 		;Input registers:
    8204   00:1006                    ~ 		;
    8205   00:1006                    ~ 		; C = primary slot
    8206   00:1006                    ~ 		;
    8207   00:1006                    ~ 		;Output:
    8208   00:1006                    ~ 		;
    8209   00:1006                    ~ 		; S flag
    8210   00:1006                    ~ 		;
    8211   00:1006                    ~ 		;Modified:
    8212   00:1006                    ~ 		;
    8213   00:1006                    ~ 		; B,HL,AF
    8214   00:1006                    ~ 		
    8215   00:1006                    ~ 		ld	b,0
    8216   00:1006                    ~ 		ld	hl,MSX_EXPTBL
    8217   00:1006                    ~ 		add	hl,bc
    8218   00:1006                    ~ 		ld	a,(hl)          ;see if this slot is expanded or not
    8219   00:1006                    ~ 		and	#80             
    8220   00:1006                    ~ 		ret
    8221   00:1006                    ~ 	
    8222   00:1006                    ~ VEC_ENASLT:
    8223   00:1006                    ~ 		db $C3
    8224   00:1006                    ~ 		ds 2
    8225   00:1006                    ~ 		
    8226   00:1006                    ~ 		
    8227   00:1006                    ~ endslots:	equ $
    8228   00:1006                    ~ 		
    8229   00:1006                    ~ 	endif
    8230   00:1006                    ~ 
    8231   00:1006                    ~ */
    8232   00:1006                      		end

    LABELS
-------------------------------------------------
00:00000000 X DISTYPE
00:00000020 X DISSIZE
00:00000000 X AFLAG
00:00000000 X MFLAG
00:00000001 X PFLAG
00:00000000 X SFLAG
00:00000000 X DFLAG
00:00000000 X CFLAG
00:00000001 X OFLAG
00:00000000 X LFLAG
00:00000001 X EFLAG
00:00000000 X YFLAG
00:00000001 X XFLAG
00:00000000 X QFLAG
00:00000000 X CRFLAG
00:00000000 X MBFLAG
00:00000000 X UFLAG
00:00000000 X RTFLAG
00:00000000 X HCFLAG
00:00000000 X TVFREQ
00:00000000 X FX_RELATIVE
00:00000000   FX_MODE
00:00000001   FX_CHANNEL
00:00004000 X PageSize
00:0000800C X rst_8
00:0000800F X rst_10
00:00008012 X rst_18
00:00008015 X rst_20
00:00008018 X rst_28
00:0000801B X rst_30
00:0000801E X rst_38
00:00008021 X nmi_vec
00:00001FDC   READ_REGISTER
00:00008041   init
00:0000804D   NMI
00:00000000 X MSX_CHKRAM
00:00000010 X MSX_CHRGTR
00:00000014 X MSX_WRSLT
00:00000018 X MSX_OUTDO
00:00000020 X MSX_DCOMPR
00:00000028 X MSX_GETYPR
00:00000030 X MSX_CALLF
00:00000038 X MSX_KEYINT
00:0000003B X MSX_INITIO
00:0000003E X MSX_INIFNK
00:0000005F X MSX_CHGMOD
00:00000062 X MSX_CHGCLR
00:00000066 X MSX_NMI
00:00000069 X MSX_CLRSPR
00:0000006C X MSX_INITXT
00:0000006F X MSX_INIT32
00:00000075 X MSX_INIMLT
00:00000078 X MSX_SETTXT
00:0000007B X MSX_SETT32
00:0000007E X MSX_SETGRP
00:00000081 X MSX_SETMLT
00:00000084 X MSX_CALPAT
00:00000087 X MSX_CALATR
00:0000008A X MSX_GSPSIZ
00:0000008D X MSX_GRPPRT
00:00000090 X MSX_GICINI
00:00000093 X MSX_WRTPSG
00:00000096 X MSX_RDPSG
00:00000099 X MSX_STRTMS
00:0000009C X MSX_CHSNS
00:0000009F X MSX_CHGET
00:000000A2 X MSX_CHPUT
00:000000A5 X MSX_LPTOUT
00:000000A8 X MSX_LPTSTT
00:000000AB X MSX_CNVCHR
00:000000AE X MSX_PINLIN
00:000000B1 X MSX_INLIN
00:000000B4 X MSX_QINLIN
00:000000B7 X MSX_BREAKX
00:000000BA X MSX_ISCNTC
00:000000BD X MSX_CKCNTC
00:000000C0 X MSX_BEEP
00:000000C6 X MSX_POSIT
00:000000C9 X MSX_FNKSB
00:000000CC X MSX_ERAFNK
00:000000CF X MSX_DSPFNK
00:000000D2 X MSX_TOTEXT
00:000000DB X MSX_GTPAD
00:000000DE X MSX_GTPDL
00:000000E1 X MSX_TAPION
00:000000E4 X MSX_TAPIN
00:000000E7 X MSX_TAPIOF
00:000000EA X MSX_TAPOON
00:000000ED X MSX_TAPOUT
00:000000F0 X MSX_TAPOOF
00:000000F3 X MSX_STMOTR
00:000000F6 X MSX_LFTQ
00:000000F9 X MSX_PUTQ
00:000000FC X MSX_RIGHTC
00:000000FF X MSX_LEFTC
00:00000102 X MSX_UPC
00:00000105 X MSX_TUPC
00:00000108 X MSX_DOWNC
00:0000010B X MSX_TDOWNC
00:0000010E X MSX_SCALXY
00:00000111 X MSX_MAPXY
00:00000114 X MSX_FETCHC
00:00000117 X MSX_STOREC
00:0000011A X MSX_SETATR
00:0000011D X MSX_READC
00:00000120 X MSX_SETC
00:00000123 X MSX_NSETCX
00:00000126 X MSX_GTASPC
00:00000129 X MSX_PNTINI
00:0000012C X MSX_SCANR
00:0000012F X MSX_SCANL
00:00000132 X MSX_CHGCAP
00:00000135 X MSX_CHGSND
00:0000013B X MSX_WSLREG
00:0000013E X MSX_RDVDP
00:00000144 X MSX_PHYDIO
00:00000147 X MSX_FORMAT
00:0000014A X MSX_ISFLIO
00:0000014D X MSX_OUTDLP
00:00000150 X MSX_GETVCP
00:00000153 X MSX_GETVC2
00:00000156 X MSX_KILBUF
00:00000159 X MSX_CALBAS
00:0000000C X MSX_RDSLT
00:0000001C X MSX_CALSLT
00:00000138 X MSX_RSLREG
00:00000180 X MSX_CHGCPU
00:00004029 X MSX_MTOFF
00:00000000   MSX_CHRTBL
00:00001800   MSX_NAMTBL
00:00002000   MSX_CLRTBL
00:00003800   MSX_SPRTBL
00:00001B00   MSX_SPRATR
00:00000007   MSX_VDPPRT
00:0000002D X MSX_MSXVER
00:00005348 X MSX_MSLOT
00:000053C7 X MSX_GRPNAM
00:000053C9 X MSX_GRPCOL
00:000053CB X MSX_GRPCGP
00:000053CD X MSX_GRPATR
00:000053CF X MSX_GRPPAT
00:000053DB X MSX_CLIKSW
00:000053E9   MSX_FORCLR
00:000053EA   MSX_BAKCLR
00:000053EB X MSX_BDRCLR
00:000053DF X MSX_RG0SAV
00:000053E0 X MSX_RG1SAV
00:000053E1 X MSX_RG2SAV
00:000053E2 X MSX_RG3SAV
00:000053E3 X MSX_RG4SAV
00:000053E4 X MSX_RG5SAV
00:000053E5 X MSX_RG6SAV
00:000053E6 X MSX_RG7SAV
00:00005FE7 X MSX_RG8SAV
00:00005FE8   MSX_RG9SAV
00:000053E7   MSX_STATFL
00:000053F6 X MSX_SCNCNT
00:000053F7 X MSX_REPCNT
00:0000587F X MSX_FNKSTR
00:00005BE5 X MSX_NEWKEY
00:00005C4A X MSX_HIMEM
00:00005C9E   MSX_JIFFY
00:00005CA2 X MSX_INTCNT
00:00005CC1 X MSX_EXPTBL
00:00005CC5 X MSX_SLTTBL
00:00005D9A X MSX_HKEYI
00:00005D9F X MSX_HTIMI
00:00005FFF X MSX_SSSREG
00:00003000   MSX_STACK
00:00000040 X MSX_DEVID
00:00000041 X MSX_SWTIO
00:000000A0   MSX_PSGLW
00:000000A1   MSX_PSGDW
00:000000A2 X MSX_PSGDR
00:0000000E X MSX_PSGPA
00:0000000F X MSX_PSGPB
00:000000BE   MSX_VDPDRW
00:000000BF   MSX_VDPCW
00:000000BF   MSX_VDPSR
00:0000009B X MSX_VDPPAL
00:000000A8 X MSX_PPIA
00:000000A9 X MSX_PPIB
00:000000AA X MSX_PPIC
00:000000AB X MSX_PPICM
00:000000FC X MSX_MMAP0
00:000000FD X MSX_MMAP1
00:000000FE X MSX_MMAP2
00:000000FF X MSX_MMAP3
00:000000D0   MSX_HIDE_SPRITES
00:000000D1   MSX_HIDE_SPRITE
00:00000024 X MSX_ENASLT
00:00000041   MSX_DISSCR
00:00000044   MSX_ENASCR
00:00001FD9   MSX_WRTVDP
00:0000C7AB X MSX_RDVRM
00:0000C7A3   MSX_WRTVRM
00:00000050 X MSX_SETRD
00:0000C796   MSX_SETWRT
00:0000C787 X MSX_FILVRM
00:00000059 X MSX_LDIRMV
00:0000005C X MSX_LDIRVM
00:0000C72D   MSX_INIGRP
00:0000C771   MSX_CLS
00:000000D5 X MSX_GTSTCK
00:000000D8 X MSX_GTTRIG
00:00000141 X MSX_SNSMAT
00:00000003   WINDOWTOP
00:00000002   WINDOWLFT
00:00000014   WINDOWHGT
00:0000001C   WINDOWWID
00:0000000D   MAPWID
00:00008071 X mapedge
00:0000807E   mapdat
00:000080B2   stmap
00:000080B3   evnt00
00:000080C1   a00026
00:00008121   a00223
00:00008148   a00292
00:00008165   a00347
00:000081A3   a00467
00:000081A8   a00475
00:000081B6   a00500
00:000081E4   a00581
00:00008206   a00641
00:00008212   a00663
00:0000821E   a00687
00:00008240   a00747
00:00008252   a00778
00:00008264   a00808
00:00008269   a00817
00:00008289   a00872
00:00008295   a00893
00:000082B5   a00948
00:000082C1   a00969
00:000082E1   a01025
00:000082ED   a01046
00:00008302   a01084
00:00008306   a01092
00:0000830F   a01106
00:00008319   a01123
00:0000832E   a01161
00:00008332   a01169
00:0000833B   a01183
00:00008351   a01222
00:00008354   a01226
00:00008362   a01252
00:00008366   a01260
00:00008369   a01264
00:00008388   a01324
00:00008393   a01343
00:00008396   evnt01
00:000083AA   b00038
00:000083BD   b00069
00:000083C2   b00078
00:000083C5   b00082
00:000083D1   b00100
00:000083D5   b00108
00:000083E1   b00133
00:000083EE   b00154
00:000083F1   evnt02
00:00008413   c00064
00:00008426   c00095
00:0000842B   c00103
00:0000842E   c00107
00:0000843A   c00126
00:0000843E   c00134
00:0000844A   c00158
00:00008457   c00180
00:00008458   evnt03
00:00008473   d00051
00:00008478   d00059
00:0000847B   d00064
00:00008487   d00082
00:0000848B   d00090
00:00008497   d00115
00:000084A4   d00136
00:000084A5   evnt04
00:000084C0   e00051
00:000084C5   e00059
00:000084C8   e00064
00:000084D4   e00082
00:000084D8   e00090
00:000084EB   e00121
00:000084F0   e00130
00:000084F3   e00134
00:000084FF   e00152
00:00008503   e00160
00:00008513   e00190
00:00008514   evnt05
00:00008535   f00070
00:00008536   evnt06
00:00008537   evnt07
00:00008552   h00053
00:00008553   evnt08
00:00008573   i00062
00:00008577   i00070
00:000085BD   i00191
00:000085D4   i00230
00:00008601   i00308
00:00008618   i00347
00:00008661   i00477
00:00008697   i00571
00:000086AD   i00610
00:000086DA   i00688
00:000086F0   i00727
00:00008726   i00821
00:0000873C   i00860
00:00008769   i00937
00:0000877F   i00976
00:000087C8   i01106
00:000087D6   i01132
00:000087D7   evnt09
00:00008841   evnt10
00:0000884E   k00030
00:0000884F   evnt11
00:0000885F   l00032
00:00008866   l00045
00:00008876   l00074
00:0000888C   l00116
00:0000889B   l00146
00:0000889C   evnt12
00:00008995   m00509
00:000089AE   m00562
00:000089BF   m00597
00:000089D0   m00632
00:000089DC   m00659
00:000089DF   m00663
00:000089EF   evnt13
00:00008A45   evnt14
00:00008A5A   evnt15
00:00008A5B   evnt16
00:00008A6D   evnt17
00:00008ACB   evnt18
00:00008B41   evnt19
00:00008B42 X evnt20
00:00008B43   ptcusr
00:00008B44   msgdat
00:00008C10 X nummsg
00:00008C11   scdat
00:00009C38   numsc
00:00009C39   chgfx
00:00009EB9   bprop
00:00009EE1   sprgfx
00:0000A1C1   frmlst
00:0000A1D1   nmedat
00:0000001F   NUMOBJ
00:0000A507   objdta
00:0000AD24 X palett
00:0000AD44   font
00:0000B044   jtab
00:0000B05A   keytab
00:00000000 X ROM
00:00000001 X DISK
00:00000002 X TAPE
00:00000001 X PAL
00:00000002 X NTSC
00:00000018   MSX_MAXROWS
00:00000020   MSX_MAXCOLS
00:000000FF X MSX_MAXCX
00:000000BF   MSX_MAXCY
00:00000010   MSX_SPRHS
00:00000010   MSX_SPRVS
00:00000001   PLATFM
00:00000002   WALL
00:00000003   LADDER
00:00000004   FODDER
00:00000005   DEADLY
00:00000006   CUSTOM
00:00000007   WATER
00:00000008   COLECT
00:00000009 X NUMTYP
00:00000007 X CRUMBLING_SPEED
00:00000043   OBJSIZ
00:00000003   ODTSIZ
00:00000020   NUMSPR
00:00000011   TABSIZ
00:00000220   SPRBUF
00:00000005   NMESIZ
00:00000003   X
00:00000004   Y
00:00000005 X PAM1ST
00:00000230   MAPSIZE
00:00000036   NUMSHR
00:00000009   SHRSIZ
00:0000000A   VAPTIM
00:0000B070   start
00:0000B0D8   numob
00:0000B0D9   wntopx
00:0000B0DA   wnlftx
00:0000B0DB   wnbotx
00:0000B0DC   wnrgtx
00:0000B0DD   frmptr
00:0000B0DF   blkptr
00:0000B0E1   proptr
00:0000B0E3   scrptr
00:0000B0E5   nmeptr
00:0000B0E7   chkkey
00:0000B0EC   chkkey.nokey
00:0000B0F5   prskey
00:0000B114   debkey
00:0000B131   delay
00:0000B139   xspr
00:0000B14A   xspr0
00:0000B158   iniob
00:0000B162   iniob.loop
00:0000B173   vsync
00:0000B181   check_if_enough_frames_passed
00:0000B194   beeper
00:0000B1A0   beepLoop
00:0000B1C1   beepWait
00:0000B1DB   sndskip
00:0000B1DC   psgWrite
00:0000B1DF X redraw
00:0000B1FD X rpblc1
00:0000B203 X swaphz
00:0000B211   cls
00:0000B234 X setpal
00:0000B246   fdchk
00:0000B26C   cspr
00:0000B270   proshr
00:0000B273   proshrnoset
00:0000B28B   proshr0
00:0000B291   proshloop
00:0000B2A4   setshr
00:0000B2A7   setshr0
00:0000B2B0   setshr0.shrodd
00:0000B2B4   proshx
00:0000B2B8   prosh1
00:0000B2C7   prosh2
00:0000B2D0   shrap
00:0000B2F0   dotl
00:0000B2F4   dotr
00:0000B2F8   dotu
00:0000B2FC   dotd
00:0000B300   chkxy
00:0000B322   kilshr
00:0000B327   plot
00:0000B336 X plot0
00:0000B348   pltwrt
00:0000B355   plot1
00:0000B364   trail
00:0000B377   trail.traill
00:0000B37B   trail.trailv
00:0000B382   trail.trailu
00:0000B386   trailk
00:0000B38B   laser
00:0000B395   laserl
00:0000B397   laserm
00:0000B3B7   laserm.exit
00:0000B3B8   plotde
00:0000B3BE   shoot
00:0000B3C2 X shoot1
00:0000B3DE   shoot0
00:0000B3E5   shootr
00:0000B3EA X vapour
00:0000B3F2 X vapou3
00:0000B3FB   vapou2
00:0000B3FE   vapou1
00:0000B412   vapou0
00:0000B417 X ptusr
00:0000B428   ptusr.ptusr1
00:0000B439 X star
00:0000B441   star0
00:0000B444   star7
00:0000B453   star8
00:0000B459   star9
00:0000B46A   star1
00:0000B478   star2
00:0000B484   star3
00:0000B48C   fpslot
00:0000B495   fpslt0
00:0000B49F   explod
00:0000B4B1   expld0
00:0000B4B7   expld2
00:0000B4BB   expld3
00:0000B4BE   expld1
00:0000B4E4   qrand
00:0000B4F1   dshrp
00:0000B50D   delshr
00:0000B513   delshr.loop
00:0000B51E   delshr.noshr
00:0000B526   inishr
00:0000B534   lcol
00:0000B53C   lcol.loop
00:0000B540   lcol.nxtshr
00:0000B544   lcol.chkcol
00:0000B55A   lcol.missed
00:0000B55D   lcol.exit
00:0000B55F   game
00:0000B562 X evintr
00:0000B583 X mapst
00:0000B589 X inipbl
00:0000B590 X evini
00:0000B593   rstrt
00:0000B5A1   rstrtn
00:0000B5B0   rstrt0
00:0000B5C3 X rpblc0
00:0000B5C9   mloop
00:0000B5D3 X evlp1
00:0000B5DD X evlp2
00:0000B608 X qoff
00:0000B60B   newlev
00:0000B61B   evwon
00:0000B621   pdead
00:0000B625 X evdie
00:0000B635   tidyup
00:0000B63D   tidyup.tidyu2
00:0000B647   tidyu0
00:0000B64A   tidyu1
00:0000B65D   rsevt
00:0000B661 X evrs
00:0000B664   num2ch
00:0000B669   numdg3
00:0000B66F   numdg2
00:0000B67A   numdg
00:0000B67C   numdg1
00:0000B685   numdg0
00:0000B68C X num2dd
00:0000B69B X num2td
00:0000B6A2   inisc
00:0000B6A4   inisc0
00:0000B6AA X imul
00:0000B6AC X imul0
00:0000B6B2   imul0.loop
00:0000B6B8   imul0.imul2
00:0000B6BF X idiv
00:0000B6C2   idiv.loop
00:0000B6CA   idiv.nodiv
00:0000B6CD   shwob
00:0000B6D4   shwob.loop0
00:0000B6ED   dobj
00:0000B6FC   putobj
00:0000B71F   putrow
00:0000B727   putrow0
00:0000B729   putrow0.loop
00:0000B72F   objimg
00:0000B748 X remob
00:0000B758   getob
00:0000B777   getob.notinscr
00:0000B77A   objptr
00:0000B785   wobj
00:0000B78D   robj
00:0000B7C7   robjs
00:0000B7D1   robjs.loop
00:0000B7DE X drpob
00:0000B807   skobj
00:0000B811   skobj.sk0
00:0000B81E   skobj.sk1
00:0000B83C   skobj.sk3
00:0000B83D   skobj.sk2
00:0000B83F   gotob
00:0000B848   gotob.gotob1
00:0000B84B   gotob.gotob0
00:0000B84F   findob
00:0000B85E X spawn
00:0000B861 X numsp1
00:0000B866   numsp1.nxtslot
00:0000B870   numsp1.spaw1
00:0000B8A9 X rtssp
00:0000B8AD X evis1
00:0000B8B2   hslot
00:0000B8BC   hslot.nxtslot
00:0000B8C2   hslot.found
00:0000B8C7   checkx
00:0000B8CD X dscor
00:0000B8DA   dscor0
00:0000B8EF   dscor2
00:0000B8F6   bscor0
00:0000B904 X addsc
00:0000B926   incsc
00:0000B935   incsc0
00:0000B937   incsc2
00:0000B943 X addbo
00:0000B94D   addbo0
00:0000B958   addbo1
00:0000B95E X swpsb
00:0000B966   swpsb0
00:0000B970   gp2tp
00:0000B987   gprad
00:0000B992   pradd
00:0000B9AB X chradd
00:0000B9C6   ptxt
00:0000B9E5   ldirvm0
00:0000B9F9   ldirvm0.nxtrow
00:0000B9FE   pattr
00:0000B9FE   pattr2
00:0000BA12   pattr1
00:0000BA26   pchr
00:0000BA46   pchr.ldirvm0
00:0000BA57   pchr.loop
00:0000BA5C   pattrnxt
00:0000BA61   groom
00:0000BA64 X groomx
00:0000BA6A   groom1
00:0000BA77   groom0
00:0000BA84   droom
00:0000BA8A X droom2
00:0000BAA0   droom0
00:0000BAAA   droom1
00:0000BAC0   cangu
00:0000BAE2   cangd
00:0000BAE8 X numsp3
00:0000BB01   plchk
00:0000BB0E   plchk0
00:0000BB10   plchkx
00:0000BB19   cangl
00:0000BB24   cangr
00:0000BB2D   cangh
00:0000BB30 X cangh2
00:0000BB38   cangh0
00:0000BB3E   cangh1
00:0000BB46   lrchk
00:0000BB4F X always
00:0000BB51   lrchkx
00:0000BB54   tded
00:0000BB76   tded.tded0
00:0000BB87   tded.tded1
00:0000BB9C   tstbl
00:0000BBB7 X jump
00:0000BBBA X jump0
00:0000BBC6 X hop
00:0000BBD4 X random
00:0000BBE6   ktest
00:0000BBF7   keypressed
00:0000BBFB   jtest
00:0000BC0C   jkeypressed
00:0000BC10   joykey
00:0000BC1E   joyjoy1
00:0000BC23   joyjoy2
00:0000BC26   readkeys
00:0000BC2A   readkeys.loop
00:0000BC3B   joykey1
00:0000BC49   joykey2
00:0000BC57   dmsg
00:0000BC5D   dmsg3
00:0000BC71   dmsg0
00:0000BC84   dmsg2
00:0000BC9A   dmsg2.btzero
00:0000BCA3   dmsg2.strseg
00:0000BCB1   dmsg2.wrapped
00:0000BCC6   dmsg2.bottom
00:0000BCCE   dmsg2.nxtchr
00:0000BCD2   dmsg1
00:0000BCDD   dmsg4
00:0000BCE2   bmsg1
00:0000BCED   bmsg1.bmsg3
00:0000BD07   bmsg1.btzero
00:0000BD25   bmsg1.bmsg2
00:0000BD36   bchar
00:0000BD4A   bchar.nxtchar
00:0000BD56   bchar.nxtrow
00:0000BD70   nxtchar2
00:0000BD78   nxtfile2
00:0000BD80 X bchar1
00:0000BD86   bchar3
00:0000BD8A   bchar2
00:0000BD8D X achar
00:0000BDA5   nexpos
00:0000BDAF   nexlin
00:0000BDB7   preprt
00:0000BDBE X prescr
00:0000BDC7   getwrd
00:0000BDCA   getwd0
00:0000BDD3   pspr
00:0000BDDD   pspr.loop
00:0000BDEF   pspr2
00:0000BE09   pspr3
00:0000BE0C X pspr4
00:0000BE12   jumphl
00:0000BE17   evtyp0
00:0000BE19 X evtyp1
00:0000BE1B X evtyp2
00:0000BE1D X evtyp3
00:0000BE1F X evtyp4
00:0000BE21 X evtyp5
00:0000BE23 X evtyp6
00:0000BE25 X evtyp7
00:0000BE27 X evtyp8
00:0000BE29   chkimg
00:0000BE32   chkimg.loop
00:0000BE4C   chkimg.nxtspr
00:0000BE51 X disscreen
00:0000BE54 X enascreen
00:0000BE57   dissprs
00:0000BE5F   ram2vram
00:0000BE6A   ram2vram.loop
00:0000BE7E   ram2vram_slow
00:0000BE89   ram2vram_slow.loop
00:0000BE8F   buildspr
00:0000BE9F   buildspr.loop
00:0000BEAD   buildspr.ison
00:0000BECF   buildspr.nxtspr
00:0000BEDA X sprflick
00:0000BEEB   sprflick.flick
00:0000BF07   sprflick.lp
00:0000BF0D   sprflick.bottom
00:0000BF1D   sprflick.noovlp
00:0000BF2D   sprflick.nxt
00:0000BF41   sprflick.noreset
00:0000BF4F   sprflick.fullsat
00:0000BF5D   sprflick.no5th
00:0000BF61   dumpspr
00:0000BF77   scadd
00:0000BF90   animsp
00:0000BFA4   anims0
00:0000BFA8   animbk
00:0000BFBB   animbk.rtanb0
00:0000BFBE   sktyp
00:0000BFC7   sktyp.loop
00:0000BFCF   sktyp.sktyp1
00:0000BFE2 X sktyp.nocoll
00:0000BFE3   coltyp
00:0000BFE9   coltyp.colty0
00:0000BFF8   coltyp.colc1a
00:0000C005   coltyp.colc1b
00:0000C010   coltyp.colty1
00:0000C01C   disply
00:0000C022 X displ1
00:0000C02D   initsc
00:0000C03A   tstsc
00:0000C046 X scrl
00:0000C04A   scrl0
00:0000C053   scrl1
00:0000C05C X scrr
00:0000C062 X scru
00:0000C069 X scrd
00:0000C070 X nwscr
00:0000C076   nwscr0
00:0000C07E   nwscr1
00:0000C084   grav
00:0000C0A2   grav0
00:0000C0AD X gravd
00:0000C0AE   gravd0
00:0000C0B9   gravu
00:0000C0BC   gravu0
00:0000C0C8   gravst
00:0000C0D5   evftf
00:0000C0D9   ogrv
00:0000C0EB   ogrv0
00:0000C0EE   ogrv1
00:0000C0F4 X ogrvd
00:0000C0F5   ogrvd0
00:0000C100   ogrvu
00:0000C103   ogrvu0
00:0000C10E   ogrvst
00:0000C125   ogrv2
00:0000C12A   ogrv4
00:0000C133   ogrv3
00:0000C137   ifall
00:0000C160   ifalls
00:0000C168   tfall
00:0000C17B   gfrm
00:0000C185   sprlst
00:0000C191   sprlst.loop
00:0000C198   sprlst.nxtscr
00:0000C19C   nspr
00:0000C1A5   nspr.loop
00:0000C1AF   nspr.loop1
00:0000C1B4   ispr
00:0000C1BE   ispr.loop2
00:0000C1C2   ispr.loop1
00:0000C1D1   ispr.copyspr
00:0000C1D6   ispr.exit
00:0000C1D9   kspr
00:0000C1E8   kspr.loop2
00:0000C1FC   kspr.loop1
00:0000C20B   kspr.copyspr
00:0000C210   kspr.exit
00:0000C213   cpsp
00:0000C251   mapsprite
00:0000C271   nxtsprbyt
00:0000C279   nomap
00:0000C27C   spradr
00:0000C291   mult32
00:0000C29D   clrobjlst
00:0000C2A7   clrscrmap
00:0000C2AE   fastfill
00:0000C2B0   fastfill.loop1
00:0000C2BE X clw
00:0000C2D6   clw.loop3
00:0000C2DB   clw.loop1
00:0000C2EA   clw.loop2
00:0000C400   dots
00:0000C408   shrptr
00:0000C418   shrsin
00:0000C458   unpack
00:0000C47C   pletter.literal
00:0000C47E   pletter.loop
00:0000C487 X pletter.getlen
00:0000C48D   pletter.getlen.lus
00:0000C4A8   pletter.getlen.lenok
00:0000C4B5   pletter.mode6
00:0000C4BB   pletter.mode5
00:0000C4C1   pletter.mode4
00:0000C4C7   pletter.mode3
00:0000C4CD   pletter.mode2
00:0000C4DD   pletter.offsok
00:0000C4EC   pletter.getbit
00:0000C4F0   pletter.getbitexx
00:0000C4F6   pletter.modes
00:00000000 X CHNPRM_PsInOr
00:00000001 X CHNPRM_PsInSm
00:00000002 X CHNPRM_CrAmSl
00:00000003 X CHNPRM_CrNsSl
00:00000004 X CHNPRM_CrEnSl
00:00000005 X CHNPRM_TSlCnt
00:00000006 X CHNPRM_CrTnSl
00:00000008 X CHNPRM_TnAcc
00:0000000A X CHNPRM_COnOff
00:0000000B X CHNPRM_OnOffD
00:0000000C X CHNPRM_OffOnD
00:0000000D X CHNPRM_OrnPtr
00:0000000F X CHNPRM_SamPtr
00:00000011 X CHNPRM_NNtSkp
00:00000012 X CHNPRM_Note
00:00000013 X CHNPRM_SlToNt
00:00000014 X CHNPRM_Env_En
00:00000015 X CHNPRM_Flags
00:00000016 X CHNPRM_TnSlDl
00:00000017 X CHNPRM_TSlStp
00:00000019 X CHNPRM_TnDelt
00:0000001B X CHNPRM_NtSkCn
00:0000001C X CHNPRM_Volume
00:0000001D X CHNPRM_Size
00:00000000 X AR_TonA
00:00000002 X AR_TonB
00:00000004 X AR_TonC
00:00000006 X AR_Noise
00:00000007   AR_Mixer
00:00000008 X AR_AmplA
00:00000009 X AR_AmplB
00:0000000A X AR_AmplC
00:0000000B X AR_Env
00:0000000D X AR_EnvTp
00:0000C502   sfx_init
00:0000C555 X sfx_play
00:0000C50B   ayFX_SETUP
00:0000C518   sfx_mute
00:0000C520   sfx_set
00:0000C520 X ayFX_INIT
00:0000C531   ayFX_INIT.CHECK_PRI
00:0000C551   ayFX_INIT.INIT_END
00:0000C555   ayFX_PLAY
00:0000C569   ayFX_PLAY.TAKECB
00:0000C57A   ayFX_PLAY.CHECK_NN
00:0000C588   ayFX_PLAY.SETPOINTER
00:0000C59C   ayFX_PLAY.SETMASKS
00:0000C5AA X ayFX_PLAY.CHK1
00:0000C5AC X ayFX_PLAY.PLAY_C
00:0000C5B9   ayFX_PLAY.CHK2
00:0000C5BE X ayFX_PLAY.PLAY_B
00:0000C5CB   ayFX_PLAY.CHK3
00:0000C5CE X ayFX_PLAY.PLAY_A
00:0000C5DB   ayFX_PLAY.SETMIXER
00:0000C5EB   resetregs
00:0000C5F9 X psgrout
00:0000C606   psgrout.lout
00:0000C617   sfxbank
00:0000C72D X endprogram
00:00001FD9   WRITE_REGISTER
00:00000055 X PATSIZE
00:00001105   CONTROLLER_INIT
00:00001FEB   POLLER
00:00005C9E X clock
00:0000C72D   CV_INIGRP
00:0000C766   nxtblk
00:0000C771   CV_CLS
00:0000C787   CV_FILVRM
00:0000C78B   FLOOP
00:0000C796   CV_SETWRT
00:0000C7A3   CV_WRTVRM
00:0000C7AB   CV_RDVRM
00:00004000   varbegin
00:00004000   score
00:00004006   hiscor
00:0000400C   bonus
00:00004012   displ0
00:00004016   sndtyp
00:00004017   shrplot
00:00004019   loopa
00:0000401A X loopb
00:0000401B X loopc
00:0000401C   vara
00:0000401D   varb
00:0000401E   varc
00:0000401F   vard
00:00004020   vare
00:00004021   varf
00:00004022   varg
00:00004023   varh
00:00004024   vari
00:00004025 X varj
00:00004026 X vark
00:00004027   varl
00:00004028   varm
00:00004029   varn
00:0000402A X varo
00:0000402B X varp
00:0000402C X varq
00:0000402D X varr
00:0000402E X vars
00:0000402F X vart
00:00004030 X varu
00:00004031 X varv
00:00004032 X varw
00:00004033 X varz
00:00004034   contrl
00:00004035   charx
00:00004036   chary
00:00004037   colpat
00:00004038   prtmod
00:00004039   clratt
00:0000403A X snddelay
00:0000403B X beepVolume
00:0000403C   spptr
00:0000403E   seed
00:0000403F   grbase
00:00004041   joyval
00:00004042   scno
00:00004043   ogptr
00:00004045   nsprite
00:00004046   numlif
00:00004047   curobj
00:00004048 X dirthig
00:0000404A   skptr
00:0000404C   highslot
00:0000404D   roomtb
00:0000404E   frmno
00:0000404F X combyt
00:00004050   seed3
00:00004051   nexlev
00:00004052   restfl
00:00004053   deadf
00:00004054   gamwon
00:00004055   dispx
00:00004056   dispy
00:00004057   varrnd
00:00004058   varobj
00:00004059 X varopt
00:0000405A X varblk
00:0000405B   offset
00:0000405C X select
00:0000405D X ticks
00:0000405E   varend
00:0000405E   ayFX_MODE
00:0000405F   ayFX_BANK
00:00004061   ayFX_PRIORITY
00:00004062   ayFX_POINTER
00:00004064   ayFX_TONE
00:00004066   ayFX_NOISE
00:00004067   ayFX_VOLUME
00:00004068   ayFX_CHANNEL
00:00004069   AYREGS
00:00004077   sprptr
00:00004079 X pblkptr
00:0000407B   stack
00:0000407D   time
00:0000407E   keys
00:00004094   wintop
00:00004095   winlft
00:00004096   winhgt
00:00004097   winwid
00:00004098   CONTROLLER_BUFFER
00:000040A4   ssprit
00:000040B5   sprtab
00:000042D5   mapbuf
00:00004500   spratr2
00:00004580   spratr
00:00004600   MAP
00:00004900   objlist
00:00004A00   scrmap
00:00004D00   mapspr
00:00004D80   colltab
00:00004DC0   shraddr
00:00004DC2   SHRAPN
00:00004FA8   objatr
00:00005005 X frames_passed
00:00005006 X eop


 Output: B-SQUARED.out
-------------------------------------------------

 Page: 00
  Org: 00000000  Size: *  Used: 00000000

    No output

 Output: B-SQUARED.rom
-------------------------------------------------

 Page: 00
  Org: 00008000  Size: 00008000  Used: 000047B6

   Address   Length Align   Label
   00008000   18358     @   rst_8
   0000C7B6   14410       <empty>

 Output: ram_vars.tmp
-------------------------------------------------

 Page: 00
  Org: 00000000  Size: *  Used: 00001006

   Address   Length Align   Label
   00000000    4102         score
